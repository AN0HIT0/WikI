<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>英覇歴代記 Timeline Wiki</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
body { font-family: 'Helvetica Neue', Arial, sans-serif; }
.custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #888; }
</style>
</head>
<body class="bg-[#f0f2f5] text-gray-800">
<div id="root"></div>
<script type="text/babel">

const { useState, useEffect, useMemo, useRef } = React;

// ★ Firebase設定 (ここをご自身のプロジェクトの設定に書き換えてください)
const firebaseConfig = {
  apiKey: "AIzaSyCjj_GvIPi-voXia6ilCQ4ZFNvG8sD3Qmc",
  authDomain: "hellmenea-wiki.firebaseapp.com",
  projectId: "hellmenea-wiki",
  storageBucket: "hellmenea-wiki.firebasestorage.app",
  messagingSenderId: "787258620406",
  appId: "1:787258620406:web:380d00c99618400727efd7"
};


// Firebase初期化
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const googleProvider = new firebase.auth.GoogleAuthProvider();
const ADMIN_EMAIL = "anohitodayoanohito@gmail.com"; 

const DEFAULT_YEAR = 1825;
const AD_OFFSET = 110;

const LOCATIONS = {
    'allugeberno': { label: 'アリュージベルノ大陸', color: '#92400e', order: 1 },
    'grankleberno': { label: 'グランクルベルノ大陸', color: '#92400e', order: 2 },
    'fiageberno': { label: 'フィアージベルノ大陸', color: '#92400e', order: 3 },
    'seabed': { label: '海底', color: '#1e3a8a', order: 4 },
    'unknown': { label: 'その他・不明', color: '#4b5563', order: 99 }
};

const NATION_RANKS = {
    'world_government': { label: '世界政府', order: 1, color: '#000000' },
    'super_power': { label: '大列強', order: 2, color: '#7f1d1d' },
    'great_power': { label: '列強', order: 3, color: '#c2410c' },
    'major_power': { label: '大国', order: 4, color: '#15803d' },
    'regional_power': { label: '地域大国', order: 5, color: '#0f766e' },
    'minor_power': { label: '中小国', order: 6, color: '#374151' },
    'city_state': { label: '都市国家', order: 7, color: '#4b5563' }
};

const ERA_EVENT_TYPES = {
    'none': { label: 'なし', icon: '', relationship: null },
    'regime_change': { label: '政体の変更', icon: '🏛️', relationship: null, counter: null },
    'foundation': { label: '建国・成立', icon: '✨', relationship: null, counter: null },
    'independence': { label: 'より独立', icon: '🚩', relationship: null, counter: 'lose_independence' },
    'splinter': { label: 'より分裂して成立', icon: '⚡', relationship: null, counter: 'lose_splinter' },
    'unification': { label: 'を統合して成立', icon: '🤝', relationship: 'child', counter: 'merger' },
    'foundation_puppet': { label: '傀儡国として成立', icon: '♟️', relationship: 'parent', counter: 'puppet_found' },
    'puppet_found': { label: 'を傀儡として建国', icon: '♟️', relationship: 'child', counter: 'foundation_puppet' },
    'annexation': { label: 'を併合', icon: '➕', relationship: 'child', counter: 'annexed_by' },
    'partition': { label: 'を分割統治', icon: '🍰', relationship: 'child', counter: 'partitioned_by' },
    'puppet': { label: 'を傀儡化', icon: '🧸', relationship: 'child', counter: 'be_puppet' },
    'be_puppet': { label: 'の傀儡になる', icon: '⛓️', relationship: 'parent', counter: 'puppet' },
    'annexed_by': { label: 'に併合される', icon: '🏳️', relationship: 'parent', counter: 'annexation' },
    'partitioned_by': { label: 'により分割される', icon: '🧩', relationship: 'parent', counter: 'partition' },
    'merger': { label: 'に吸収合併される', icon: '🔗', relationship: 'parent', counter: 'unification' },
    'dissolution': { label: '分裂・解体して消滅', icon: '💥', relationship: null, counter: 'splinter' },
    'collapse': { label: '崩壊・滅亡', icon: '💀', relationship: null, counter: null },
    'lose_independence': { label: 'が独立', icon: '👋', relationship: 'null', counter: 'independence' },
    'lose_splinter': { label: 'が分裂', icon: '💔', relationship: 'null', counter: 'splinter' },
};

// --- 既存の定数定義の下あたりに追加 ---

// 種族定義 (ルビ対応)
const RACES = [
    { label: '高人族', ruby: 'トールマン', color: '#fdba74' }, // Gray
    { label: '森人族', ruby: 'エルフ', color: '#86efac' }, // Green
    { label: '鉱人族', ruby: 'ドワーフ', color: '#808080' }, // Red
    { label: '半人族', ruby: 'ハーフフット', color: '#fde047' }, // Yellow
    { label: '獣人族', ruby: 'アニス', color: '#fca5a5' }, // Orange
    { label: '海人族', ruby: 'マリニアン', color: '#93c5fd' }, // Blue
    { label: '魔人族', ruby: 'ハルスモシア', color: '#c084fc' }, // Purple
    { label: '天人族', ruby: 'アシェリ', color: '#fdf5e6 ' }, 
    { label: 'その他・不明', ruby: '', color: '#9ca3af' }
];

// 組織タイプ定義 (設定項目案)
const ORG_TYPES = [
    { key: 'guild', label: 'ギルド・組合', icon: '🛡️' },
    { key: 'military', label: '騎士団・軍事組織', icon: '⚔️' },
    { key: 'corporation', label: '商会・企業', icon: '💰' },
    { key: 'religious', label: '宗教団体・教団', icon: '🙏' },
    { key: 'academic', label: '学術・魔法機関', icon: '📚' },
    { key: 'criminal', label: '犯罪組織・結社', icon: '💀' },
    { key: 'government', label: '政府機関', icon: '🏛️' },
    { key: 'family', label: '名家', icon: '🏠' },
    { key: 'other', label: 'その他', icon: '🚩' }
];


        


const importanceLevels = {
    1: { label: '小事', scale: 'scale-95', badge: 'bg-gray-200 text-gray-700', bg: 'bg-gray-50', color: 'border-gray-200' },
    2: { label: '一般', scale: 'scale-100', badge: 'bg-gray-300 text-gray-800', bg: 'bg-white', color: 'border-gray-300' },
    3: { label: '重要', scale: 'scale-105', badge: 'bg-blue-100 text-blue-800', bg: 'bg-blue-50', color: 'border-blue-400' },
    4: { label: '激動', scale: 'scale-110', badge: 'bg-purple-100 text-purple-800', bg: 'bg-purple-50', color: 'border-purple-500' },
    5: { label: '伝説', scale: 'scale-110 md:scale-115', badge: 'bg-yellow-100 text-yellow-800', bg: 'bg-yellow-50', color: 'border-yellow-500 border-4' },
    6: { label: '神話', scale: 'scale-110 md:scale-115', badge: 'bg-rose-100 text-rose-800', bg: 'bg-rose-50', color: 'border-rose-500 border-4' },
};

const CUSTOM_MONTHS = {1:'創聖月',2:'祈律月',3:'啓光月',4:'天詠月',5:'神華月',6:'洗礼月',7:'熾天月',8:'炎供月',9:'聖穹月',10:'冥祀月',11:'再律月',12:'黙信月'};
// アメリカのGDPを3倍に補正済み (実質価値換算用)
const US_STATS = [
    {year:1680, population:3929000, gdp:60000000000},
    {year:1900, population:76212000, gdp:12000000000000},
    {year:2000, population:281421000, gdp:3150000000000000}
];

const formatDate = (y, m, d) => `英覇暦 ${y}年` + (m ? ` ${CUSTOM_MONTHS[m]}(${m}月)` : '') + (d ? ` ${d}日` : '');
const formatJapaneseNumber = (n, s='', short=false) => { 
    if(!n && n!==0) return '-'; 
    if(n===0) return '0'+s; 
    
    const abs = Math.abs(n);
    let unit = '';
    let num = n;

    if (abs >= 1e16) { unit = '京'; num = n / 1e16; }
    else if (abs >= 1e12) { unit = '兆'; num = n / 1e12; }
    else if (abs >= 1e8) { unit = '億'; num = n / 1e8; }
    else if (abs >= 1e4) { unit = '万'; num = n / 1e4; }

    if (unit) {
        // 単位がある場合は最大小数点2桁（グラフなどでshort=trueの場合は1桁）まで表示
        const formatted = num.toLocaleString(undefined, { maximumFractionDigits: short ? 1 : 2 });
        return formatted + unit + s;
    }
    
    // 万未満はそのまま3桁区切り
    return n.toLocaleString() + s; 
};const calculatePerCapita = (g, p) => (!p ? 0 : Math.round(g/p));

const fileToBase64 = (file) => new Promise((res, rej) => {
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = e => {
        const img = new Image(); img.onload = () => {
            const c = document.createElement('canvas'); let w=img.width, h=img.height;
            if(w>h){ if(w>150){h*=150/w; w=150;} } else { if(h>150){w*=150/h; h=150;} }
            c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/webp',0.8));
        }; img.src = e.target.result;
    }; reader.onerror = rej;
});

// 人物画用：少し高画質 (長辺400px)
const fileToBase64HighRes = (file) => new Promise((res, rej) => {
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = e => {
        const img = new Image(); img.onload = () => {
            const c = document.createElement('canvas'); let w=img.width, h=img.height;
            // サイズ制限を緩和 (150 -> 400)
            if(w>h){ if(w>400){h*=400/w; w=400;} } else { if(h>400){w*=400/h; h=400;} }
            c.width=w; c.height=h; 
            // 画質も少し上げる (0.8 -> 0.9)
            c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/webp',0.9));
        }; img.src = e.target.result;
    }; reader.onerror = rej;
});

const compressBase64Image = (base64) => new Promise(res => {
    const img = new Image(); img.onload = () => {
        const c = document.createElement('canvas'); let w=img.width, h=img.height;
        if(w>h){ if(w>150){h*=150/w; w=150;} } else { if(h>150){w*=150/h; h=150;} }
        c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/webp',0.8));
    }; img.onerror=()=>res(base64); img.src=base64;
});

const getNationInfo = (nation, year) => {
    let info = { name: nation.name, color: nation.color, flag: nation.flag, params: nation.params || {}, isCollapsed: false, isFuture: false, eraEvent: null, eraStartYear: null, eraEndYear: null, nationStartYear: null, nationEndYear: null };
    const sortedEras = (nation.eras || []).sort((a, b) => a.startYear - b.startYear);
    const birthEra = sortedEras.find(e => e.event && ['foundation', 'independence', 'splinter', 'unification', 'foundation_puppet'].includes(e.event.type));
    if (birthEra) info.nationStartYear = birthEra.startYear; else if (sortedEras.length > 0) info.nationStartYear = sortedEras[0].startYear;
    const collapseEra = sortedEras.find(e => e.type === 'collapse' || (e.event && ['annexed_by', 'partitioned_by', 'merger', 'dissolution'].includes(e.event.type)));
    if (collapseEra) info.nationEndYear = collapseEra.startYear;
    if (info.nationStartYear !== null && year < info.nationStartYear) return { ...info, isFuture: true };
    let idx = -1; for (let i = sortedEras.length - 1; i >= 0; i--) { if (sortedEras[i].startYear <= year) { idx = i; break; } }
    if (idx !== -1) {
        const cur = sortedEras[idx]; const next = sortedEras[idx + 1];
        info.eraStartYear = cur.startYear;
        if (next) info.eraEndYear = next.startYear; else if (info.nationEndYear) info.eraEndYear = info.nationEndYear;
        if (cur.type === 'collapse') return { ...info, isCollapsed: true, name: cur.name || `${info.name}(滅亡)`, color: '#9ca3af', flag: null, eraEvent: cur.event };
        return { ...info, name: cur.name, color: cur.color, flag: cur.flag || nation.flag, params: cur.params || {}, isCollapsed: false, eraEvent: cur.event };
    }
    return info;
};

const NATION_PARAMS = [
    { key: 'ideology_gov', label: '統治イデオロギー', defaultColor: '#60a5fa' },
    { key: 'ideology_pol', label: '政治イデオロギー', defaultColor: '#fbbf24' },
    { key: 'ideology_eco', label: '経済イデオロギー', defaultColor: '#4ade80' },
    { key: 'ideology_dip', label: '外交イデオロギー', defaultColor: '#a78bfa' },
    { key: 'suffrage', label: '選挙権', defaultColor: '#f87171' },
    { key: 'religion', label: '宗教', defaultColor: '#fb923c' },
];

const EASING_FUNCTIONS = {
            linear: { name: '直線 (一定)', func: t => t },
            quadIn: { name: '加速 (2乗)', func: t => t * t },
            quadOut: { name: '減速 (2乗)', func: t => t * (2 - t) },
            cubicIn: { name: '急加速 (3乗)', func: t => t * t * t },
            cubicOut: { name: '急減速 (3乗)', func: t => (--t) * t * t + 1 },
            quartIn: { name: '超加速 (4乗)', func: t => t * t * t * t },
            quartOut: { name: '超減速 (4乗)', func: t => 1 - (--t) * t * t * t },
            expoIn: { name: '爆発的 (指数)', func: t => Math.pow(2, 10 * (t - 1)) },
            expoOut: { name: '収束 (指数)', func: t => -Math.pow(2, -10 * t) + 1 },
            sigmoid: { name: 'S字 (滑らか)', func: t => t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t },
        };

const IconWrapper = ({ children, size = 24, className = "", ...props }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
        {children}
    </svg>
);


const Icons = {
    Dagger: p=><IconWrapper {...p}><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><line x1="13" y1="19" x2="19" y2="13"/></IconWrapper>,
    Shield: p=><IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconWrapper>,
    Crosshair: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></IconWrapper>,
    Award: p=><IconWrapper {...p}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconWrapper>,
    Eye: p=><IconWrapper {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
    Swords: p=><IconWrapper {...p}><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><path d="M17.5 14.5L6 3H3v3l11.5 11.5"/></IconWrapper>,
    Zap: p=><IconWrapper {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>,
    Castle: p=><IconWrapper {...p}><path d="M22 20v-7.82a2 2 0 0 0-1.11-1.79l-1.12-.56a.25.25 0 0 1-.13-.23V5a2 2 0 0 0-2-2h-3a2 2 0 0 0-2 2v2h-2V5a2 2 0 0 0-2-2H5.76a2 2 0 0 0-2 2v4.58a.25.25 0 0 1-.12.22l-1.13.57A2 2 0 0 0 1.4 12.18V20h20.2z"/></IconWrapper>,
    Sun: p=><IconWrapper {...p}><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></IconWrapper>,
    Crown: p=><IconWrapper {...p}><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></IconWrapper>,
    Plus: p=><IconWrapper {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
    BookOpen: p=><IconWrapper {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>,
    Trash2: p=><IconWrapper {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconWrapper>,
    Edit2: p=><IconWrapper {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>,
    Save: p=><IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
    ChevronRight: p=><IconWrapper {...p}><polyline points="9 18 15 12 9 6"/></IconWrapper>,
    ChevronDown: p=><IconWrapper {...p}><polyline points="6 9 12 15 18 9"/></IconWrapper>,
    Search: p=><IconWrapper {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconWrapper>,
    Calendar: p=><IconWrapper {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconWrapper>,
    Download: p=><IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>,
    Upload: p=><IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>,
    Filter: p=><IconWrapper {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconWrapper>,
    Tag: p=><IconWrapper {...p}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></IconWrapper>,
    Settings: p=><IconWrapper {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconWrapper>,
    BarChart2: p=><IconWrapper {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconWrapper>,
    TrendingUp: p=><IconWrapper {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>,
    Users: p=><IconWrapper {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>,
    DollarSign: p=><IconWrapper {...p}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>,
    X: p=><IconWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>,
    Activity: p=><IconWrapper {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconWrapper>,
    ArrowLeft: p=><IconWrapper {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconWrapper>,
    History: p=><IconWrapper {...p}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/></IconWrapper>,
    List: p=><IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconWrapper>,
    Flag: p=><IconWrapper {...p}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></IconWrapper>,
    Image: p=><IconWrapper {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconWrapper>,
    Globe: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconWrapper>,
    Skull: p=><IconWrapper {...p}><circle cx="9" cy="12" r="1" /><circle cx="15" cy="12" r="1" /><path d="M8 20v2h8v-2" /><path d="M12.5 17l-.5-4" /><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20" /></IconWrapper>,
    RefreshCw: p=><IconWrapper {...p}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconWrapper>,
    HelpCircle: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>,
    Link: p=><IconWrapper {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconWrapper>,
    CornerDownRight: p=><IconWrapper {...p}><polyline points="15 10 20 15 15 20"/><path d="M4 4v7a4 4 0 0 0 4 4h12"/></IconWrapper>,
    GitMerge: p=><IconWrapper {...p}><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></IconWrapper>,
    Minus: p=><IconWrapper {...p}><line x1="5" y1="12" x2="19" y2="12"/></IconWrapper>,
    LayoutGrid: p=><IconWrapper {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconWrapper>,
    FileText: p=><IconWrapper {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconWrapper>,
    MapPin: p=><IconWrapper {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
    User: p=><IconWrapper {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>, // 追加
    Briefcase: p=><IconWrapper {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconWrapper>, // 追加
    Structure: p=><IconWrapper {...p}><rect x="9" y="3" width="6" height="6" rx="1"/><rect x="2" y="15" width="6" height="6" rx="1"/><rect x="16" y="15" width="6" height="6" rx="1"/><path d="M12 9v3"/><path d="M5 12h14"/><path d="M5 12v3"/><path d="M19 12v3"/></IconWrapper>,
    Lock: p=><IconWrapper {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>,
};

// レベルランク定義 (判定ロジック用)
const LEVEL_RANKS = [
    { max: 7, label: '一般市民', color: 'text-gray-500', bg: 'bg-gray-100', border: 'border-gray-200', icon: Icons.User },
    { max: 14, label: '駆け出し', color: 'text-stone-600', bg: 'bg-stone-100', border: 'border-stone-200', icon: Icons.Dagger },
    { max: 24, label: '正規兵', color: 'text-blue-700', bg: 'bg-blue-100', border: 'border-blue-200', icon: Icons.Shield },
    { max: 39, label: '精鋭', color: 'text-cyan-700', bg: 'bg-cyan-100', border: 'border-cyan-200', icon: Icons.Crosshair },
    { max: 49, label: '古強者', color: 'text-teal-700', bg: 'bg-teal-100', border: 'border-teal-200', icon: Icons.Award },
    { max: 59, label: '達人', color: 'text-emerald-700', bg: 'bg-emerald-100', border: 'border-emerald-200', icon: Icons.Eye },
    { max: 69, label: '猛者', color: 'text-orange-700', bg: 'bg-orange-100', border: 'border-orange-200', icon: Icons.Swords },
    { max: 79, label: '英雄', color: 'text-red-700', bg: 'bg-red-100', border: 'border-red-200', icon: Icons.Zap },
    { max: 89, label: '最高戦力', color: 'text-purple-700', bg: 'bg-purple-100', border: 'border-purple-200', icon: Icons.Castle },
    { max: 99, label: '超越者', color: 'text-fuchsia-700', bg: 'bg-fuchsia-100', border: 'border-fuchsia-200', icon: Icons.Sun },
    { max: 9999, label: '神話', color: 'text-yellow-700', bg: 'bg-yellow-100', border: 'border-yellow-200', icon: Icons.Crown },
];

const getLevelRank = (level) => {
    if (!level) return null;
    return LEVEL_RANKS.find(r => level <= r.max) || LEVEL_RANKS[LEVEL_RANKS.length - 1];
};


const SectionHeader = ({ icon: Icon, title, desc }) => (
    <div className="bg-gray-800 text-white p-6 rounded-lg shadow-md mb-6">
        <h2 className="text-2xl font-bold flex items-center gap-2"><Icon size={28} className="text-yellow-500" />{title}</h2>{desc && <p className="text-gray-400 mt-2 text-sm">{desc}</p>}
    </div>
);

const NationTag = ({ text, nations, year }) => {
    if (text === '世界') return (<span className="text-[10px] bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100 inline-flex items-center gap-1 relative pr-2"><Icons.Globe size={10} /> 世界</span>);
    const matchedNation = nations.find(n => { const info = getNationInfo(n, year); return info.name === text && !info.isCollapsed; });
    let flagSrc = null; if (matchedNation) { const info = getNationInfo(matchedNation, year); flagSrc = info.flag; }
    return (<span className="text-[10px] bg-black/5 text-gray-600 px-1.5 py-0.5 rounded border border-black/5 inline-flex items-center gap-1 relative pr-2">{text}{flagSrc && (<span className="inline-block w-4 h-3 rounded-sm overflow-hidden border border-black/10 ml-1 shadow-sm"><img src={flagSrc} alt="" className="w-full h-full object-cover" /></span>)}</span>);
};

// --- HelpView コンポーネント (Ver1.04 修正版: 統計をMANAGEへ移動) ---
const HelpView = ({ setView }) => {
    const [activeTab, setActiveTab] = useState('index');

    const TabButton = ({ id, icon: Icon, label }) => (
        <button 
            onClick={() => setActiveTab(id)} 
            className={`flex items-center gap-2 px-4 py-3 border-b-4 font-bold transition-colors whitespace-nowrap ${
                activeTab === id ? 'border-yellow-500 text-gray-900 bg-yellow-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
            }`}
        >
            <Icon size={18} /> {label}
        </button>
    );

    const contentClass = "bg-white p-8 rounded-b-lg rounded-r-lg shadow-md border border-gray-200 min-h-[500px]";
    const h3Class = "text-xl font-bold text-gray-800 mb-4 border-b-2 border-gray-100 pb-2 flex items-center gap-2";
    const pClass = "text-sm leading-relaxed text-gray-600 mb-4";
    const highlight = "font-bold bg-gray-100 px-1 rounded text-gray-800";

    return (
        <div className="space-y-6 animate-fade-in pb-20 max-w-6xl mx-auto text-gray-800">

            {/* タブナビゲーション */}
            <div className="flex overflow-x-auto bg-white rounded-t-lg border-b border-gray-200 shadow-sm">
                <TabButton id="index" icon={Icons.List} label="目次・要約" />
                <TabButton id="manage" icon={Icons.Settings} label="MANAGE (設定)" />
                <TabButton id="edit" icon={Icons.Edit2} label="EDIT (記録)" />
                <TabButton id="view" icon={Icons.LayoutGrid} label="VIEW (閲覧)" />
                <TabButton id="data" icon={Icons.Save} label="DATA (保存)" />
                <TabButton id="zoom" icon={Icons.Search} label="ZOOM (表示)" />
            </div>

            {/* コンテンツエリア */}
            <div className={contentClass}>
                
                {/* --- 1. 目次 (Index) --- */}
                {activeTab === 'index' && (
                    <div className="space-y-8">
                        <div className="text-center py-10 border-b border-gray-100">
                            <h2 className="text-3xl font-black text-gray-900 mb-4">英覇歴代記へようこそ</h2>
                            <p className="text-gray-500">このツールは、架空世界の歴史、国家の興亡、統計データ、人物相関図を統合管理するための<br/>ワールドビルディング（世界構築）支援アプリケーションです。</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {[
                                {id:'manage', icon:Icons.Settings, title:'MANAGE', desc:'国家、人物、組織、権力構造の設定、および統計データの編集について。'},
                                {id:'edit', icon:Icons.Edit2, title:'EDIT', desc:'年表への出来事の記録について。'},
                                {id:'view', icon:Icons.LayoutGrid, title:'VIEW', desc:'年表、系譜図、グラフ、プロフィールの閲覧について。'},
                                {id:'data', icon:Icons.Save, title:'DATA', desc:'データの保存(エクスポート)と読み込みについて。'},
                                {id:'zoom', icon:Icons.Search, title:'ZOOM', desc:'画面全体の拡大・縮小操作について。'},
                            ].map(item => (
                                <div key={item.id} onClick={() => setActiveTab(item.id)} className="group p-6 border border-gray-200 rounded-lg hover:shadow-lg hover:border-yellow-400 transition-all cursor-pointer bg-gray-50 hover:bg-white">
                                    <div className="flex items-center gap-3 mb-3">
                                        <div className="p-2 bg-white rounded-full shadow-sm group-hover:bg-yellow-500 group-hover:text-white transition-colors text-gray-400">
                                            <item.icon size={24} />
                                        </div>
                                        <h3 className="font-bold text-lg text-gray-700 group-hover:text-black">{item.title}</h3>
                                    </div>
                                    <p className="text-xs text-gray-500 leading-relaxed">{item.desc}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {/* --- 2. MANAGE (設定) --- */}
                {activeTab === 'manage' && (
                    <div className="space-y-10">
                        <section>
                            <h3 className={h3Class}><Icons.Globe className="text-yellow-600"/> 国家変遷管理 (Settings)</h3>
                            <p className={pClass}>
                                国家の根本的なデータを管理します。
                                <br/>右側の編集パネルで<span className={highlight}>「✨誕生」「💀滅亡」「通常」</span>モードを切り替え、歴史の節目（Era）を作成します。
                                <br/>「A国から独立」「B国を併合」といった関係性を設定することで、興亡系譜図のラインが自動的に結ばれます。
                            </p>
                        </section>

                        <section>
                            <h3 className={h3Class}><Icons.User className="text-blue-500"/> 人物・組織管理</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-gray-50 p-4 rounded border border-gray-200">
                                    <h4 className="font-bold text-sm mb-2 flex items-center gap-2"><Icons.User size={16}/> 人物 (Characters)</h4>
                                    <p className="text-xs text-gray-600 mb-2">
                                        歴史上の重要人物を登録します。「種族」や「レベル（Lv）」の設定が可能です。<br/>
                                        レベルの横にある<span className={highlight}>？</span>ボタンを押すと、この世界の強さの指標（魂位深度）を確認できます。
                                    </p>
                                </div>
                                <div className="bg-gray-50 p-4 rounded border border-gray-200">
                                    <h4 className="font-bold text-sm mb-2 flex items-center gap-2"><Icons.Briefcase size={16}/> 組織 (Organizations)</h4>
                                    <p className="text-xs text-gray-600 mb-2">
                                        騎士団、ギルド、魔法協会などを登録します。ロゴ画像の設定や、主要メンバー（登録人物からの紐付け）が可能です。
                                    </p>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h3 className={h3Class}><Icons.BarChart2 className="text-blue-600"/> 統計データ編集 (Stats)</h3>
                            <p className={pClass}>
                                人口やGDPのデータを入力します。Ver1.04では2つのモードがあります。
                            </p>
                            <div className="space-y-4">
                                <div className="bg-blue-50 p-4 rounded border border-blue-100">
                                    <h4 className="font-bold text-sm text-blue-800 mb-1"><Icons.Calendar size={14} className="inline"/> 年代別入力</h4>
                                    <p className="text-xs text-blue-600">特定の年を指定し、その時点での全国家のデータを一括入力します。定点観測に便利です。</p>
                                </div>
                                <div className="bg-green-50 p-4 rounded border border-green-100">
                                    <h4 className="font-bold text-sm text-green-800 mb-1"><Icons.TrendingUp size={14} className="inline"/> 国家別入力（自動補完）</h4>
                                    <p className="text-xs text-green-600">
                                        特定の国を選び、「1900年に100万人」→「2000年に1億人」のように始点と終点を入力すると、
                                        間のデータを自動計算して生成します。<br/>
                                        変化のカーブ（補完関数）を「直線」「加速」「S字」などから選べるため、急激な経済成長などを表現できます。
                                    </p>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h3 className={h3Class}><Icons.Structure className="text-purple-500"/> 権力構造図 (Power Structure)</h3>
                            <p className={pClass}>
                                国家ごとの統治機構図（組織図）をビジュアルエディタで作成できます。
                            </p>
                            <ul className="list-disc list-inside text-sm text-gray-600 space-y-2 ml-4">
                                <li><span className={highlight}>カード操作</span>: カードにカーソルを合わせるとメニューが出現し、下部組織の追加や削除、人物・組織データの紐付けができます。</li>
                                <li><span className={highlight}>移動・拡大</span>: キャンバスのドラッグで移動、ホイールで拡大縮小が可能です。</li>
                                <li><span className={highlight}>独立組織</span>: 左上の「独立組織を追加」ボタンで、政府とは別のツリー（例：教会、独立ギルド）を作成できます。</li>
                            </ul>
                        </section>

                        <section>
                            <h3 className={h3Class}><Icons.FileText className="text-gray-500"/> 国家概要 (Overview)</h3>
                            <p className={pClass}>
                                文化、地理、歴史詳細などを記述するWiki機能です。文章を選択して「亜/あ」ボタンでルビを振ることができます。
                            </p>
                        </section>
                    </div>
                )}

                {/* --- 3. EDIT (記録) --- */}
                {activeTab === 'edit' && (
                    <div className="space-y-10">
                        <section>
                            <h3 className={h3Class}><Icons.Edit2 className="text-green-600"/> 歴史を刻む (年表作成)</h3>
                            <p className={pClass}>
                                出来事を年表に追加します。タグ欄に国名を入力すると、その国のプロフィールページにも自動的に表示されます。
                            </p>
                        </section>
                    </div>
                )}

                {/* --- 4. VIEW (閲覧) --- */}
                {activeTab === 'view' && (
                    <div className="space-y-10">
                        <section>
                            <h3 className={h3Class}><Icons.LayoutGrid className="text-blue-500"/> 国家一覧 (Nation List)</h3>
                            <p className={pClass}>
                                国力ランク順に並んだ国家カードをクリックすると、詳細プロフィール画面（Wiki）へ移動します。<br/>
                                プロフィール画面では、関連する年表、人物、組織、統計グラフがタブで整理されて表示されます。
                            </p>
                        </section>

                        <section>
                            <h3 className={h3Class}><Icons.GitMerge className="text-purple-500"/> 国家興亡系譜図 (Genealogy)</h3>
                            <p className={pClass}>
                                歴史の流れを縦軸にとり、国家の誕生から滅亡までの流れを「レーン」として可視化します。
                                左上のパネルから「レーンの幅」や「1年あたりの高さ」を調整し、見やすいレイアウトに変更できます。
                            </p>
                        </section>

                        <section>
                            <h3 className={h3Class}><Icons.Activity className="text-green-500"/> グラフ分析 (Graph)</h3>
                            <p className={pClass}>
                                入力された統計データをもとに折れ線グラフを表示します。
                                「基準データに合わせて縮小」をチェックすると、史実のアメリカ合衆国のデータを背景に表示し、国力の規模感を比較できます。
                            </p>
                        </section>
                        
                        <section>
                            <h3 className={h3Class}><Icons.List className="text-gray-500"/> 国家体制一覧 (Table)</h3>
                            <p className={pClass}>
                                指定した年における全国家の統治体制やイデオロギーを一覧表で比較します。
                                「その時代に存在していた国」だけが自動的にリストアップされます。
                            </p>
                        </section>
                    </div>
                )}

                {/* --- 5. DATA (保存) --- */}
                {activeTab === 'data' && (
                    <div className="space-y-8">
                        <section>
                            <h3 className={h3Class}><Icons.Save className="text-gray-600"/> データの保存と読み込み</h3>
                            <p className={pClass}>
                                本ツールはサーバーを持たず、データはお使いのブラウザ内（ローカルストレージ）に保存されます。<br/>
                                ブラウザのキャッシュ削除などでデータが消える可能性があるため、<span className="text-red-500 font-bold">こまめな「エクスポート（JSON保存）」</span>を強く推奨します。
                            </p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                <div className="border p-4 rounded bg-gray-50">
                                    <h4 className="font-bold text-sm flex items-center gap-2 mb-2"><Icons.Upload size={16}/> エクスポート</h4>
                                    <p className="text-xs text-gray-600">現在の全データをJSONファイルとしてダウンロードします。バックアップとして定期的に行ってください。</p>
                                </div>
                                <div className="border p-4 rounded bg-gray-50">
                                    <h4 className="font-bold text-sm flex items-center gap-2 mb-2"><Icons.Download size={16}/> インポート</h4>
                                    <p className="text-xs text-gray-600">JSONファイルを読み込み、現在のデータを<span className="text-red-500 font-bold">完全に上書き</span>して復元します。</p>
                                </div>
                                <div className="border p-4 rounded bg-gray-50">
                                    <h4 className="font-bold text-sm flex items-center gap-2 mb-2"><Icons.RefreshCw size={16}/> コンバート</h4>
                                    <p className="text-xs text-gray-600">JSONファイルを読み込み、現在のデータに「足りない部分だけ」を追加（マージ）します。チーム制作などでデータを統合する際に便利です。</p>
                                </div>
                            </div>
                        </section>
                    </div>
                )}

                {/* --- 6. ZOOM --- */}
                {activeTab === 'zoom' && (
                    <div className="space-y-8">
                        <section>
                            <h3 className={h3Class}><Icons.Search className="text-blue-500"/> 画面表示の拡大・縮小</h3>
                            <p className={pClass}>ヘッダー中央にある <span className={highlight}>ZOOM</span> コントロールを使用して、アプリケーション全体の表示倍率を変更できます。</p>
                            <ul className="list-disc list-inside text-sm text-gray-600 space-y-2 ml-4">
                                <li><span className={highlight}>＋</span> ボタン: 画面を拡大します（最大200%）。細かい文字を読むときに便利です。</li>
                                <li><span className={highlight}>－</span> ボタン: 画面を縮小します（最小30%）。「国家興亡系譜図」など、全体を俯瞰したいときに役立ちます。</li>
                                <li><span className={highlight}>％数値</span> ボタン: クリックすると標準サイズ（100%）にリセットされます。</li>
                            </ul>
                        </section>
                    </div>
                )}

            </div>
        </div>
    );
};

// --- NationListView コンポーネント (スマホ2列表示・レイアウト調整版) ---
const NationListView = ({ setView, nations, onSelectNation }) => {
    // 地域ごとにグループ化
    const groupedNations = useMemo(() => {
        const grouped = {};
        Object.keys(LOCATIONS).forEach(key => grouped[key] = []);
        nations.forEach(n => {
            const loc = n.location || 'unknown';
            if (!grouped[loc]) grouped[loc] = [];
            grouped[loc].push(n);
        });
        return grouped;
    }, [nations]);

    return (
        <div className="space-y-8 animate-fade-in pb-20">
            {/* 年表へ戻るボタンは削除済みのためヘッダーのみ */}
            <SectionHeader icon={Icons.LayoutGrid} title="国家一覧" desc="登録されている全国家のリストです。詳細を確認したい国家を選択してください。" />
            
            {Object.entries(LOCATIONS).sort((a, b) => a[1].order - b[1].order).map(([locKey, locInfo]) => {
                const locNations = groupedNations[locKey];
                if (!locNations || locNations.length === 0) return null;

                // 国力順にソート
                locNations.sort((a, b) => {
                    const rankA = NATION_RANKS[a.rank || 'minor_power']?.order || 99;
                    const rankB = NATION_RANKS[b.rank || 'minor_power']?.order || 99;
                    return rankA - rankB;
                });

                return (
                    <div key={locKey} className="mb-8">
                        <h3 className="text-lg font-bold text-gray-700 mb-4 border-l-4 pl-3 flex items-center gap-2" style={{borderColor: locInfo.color}}>
                            <span className="opacity-70"><Icons.MapPin size={18}/></span> {locInfo.label}
                        </h3>
                        {/* ★修正: grid-cols-2 (スマホ) -> md:grid-cols-3 -> lg:grid-cols-4 */}
                        {/* gapもスマホでは狭く(gap-3)、PCでは広く(gap-6)調整 */}
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6">
                            {locNations.map(nation => {
                                // 期間情報の取得
                                const info = getNationInfo(nation, 2000);
                                const startYear = info.nationStartYear || '????';
                                const endYear = info.nationEndYear;
                                
                                return (
                                    <div key={nation.id} onClick={() => onSelectNation(nation)} 
                                         className="bg-white cursor-pointer group hover:-translate-y-1 transition-transform duration-200 shadow-md hover:shadow-xl overflow-hidden border-2 md:border-4 border-black relative rounded-sm">
                                        {/* 国旗部分 (アスペクト比固定) */}
                                        <div className="w-full aspect-[3/2] bg-gray-100 border-b-2 md:border-b-4 border-black relative">
                                            {nation.flag ? (
                                                <img src={nation.flag} className="w-full h-full object-cover" alt={nation.name} />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-gray-300 bg-gray-50 font-bold text-xs">No Flag</div>
                                            )}
                                            {/* 国力ランクバッジ */}
                                            <div className="absolute top-1 right-1 md:top-2 md:right-2">
                                                <span className="px-1.5 py-0.5 md:px-2 md:py-1 text-[8px] md:text-[10px] font-bold border md:border-2 border-black bg-white text-black shadow-sm">
                                                    {NATION_RANKS[nation.rank || 'minor_power']?.label}
                                                </span>
                                            </div>
                                        </div>
                                        {/* 国名・期間部分 (スマホ用にpaddingと文字サイズを調整) */}
                                        <div className="p-2 md:p-4 text-center bg-white group-hover:bg-yellow-50 transition-colors">
                                            <h4 className="font-black text-xs md:text-lg leading-tight text-gray-900 mb-1 md:mb-2 line-clamp-2 min-h-[1.5em] md:min-h-[auto]">{nation.name}</h4>
                                            <div className="inline-flex items-center gap-1 bg-gray-100 px-2 py-0.5 md:px-3 md:py-1 rounded-full text-[8px] md:text-xs font-mono font-bold text-gray-600 border border-gray-200">
                                                <span className="opacity-50"><Icons.History size={10} className="w-2.5 h-2.5 md:w-3 md:h-3" /></span>
                                                <span>{startYear}</span>
                                                <span className="text-gray-400">～</span>
                                                <span className={endYear ? "" : "text-gray-400"}>{endYear || ''}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            })}
        </div>
    );
};

// --- NationTableView コンポーネント (修正版: 従属国の過去情報表示対応) ---
const NationTableView = ({ setView, nations, stats, onEditNation, onAddNation }) => { 
    const [year, setYear] = useState(DEFAULT_YEAR);
    const [expandedParents, setExpandedParents] = useState({}); 
    const toggleExpand = (nationId) => { setExpandedParents(prev => ({ ...prev, [nationId]: !prev[nationId] })); };
    const getStat = (nationId, targetYear) => { const exactMatch = stats.find(s => s.nationId === nationId && s.year === targetYear); if (exactMatch) return { ...exactMatch, isEstimated: false }; const nationStats = stats.filter(s => s.nationId === nationId).sort((a, b) => a.year - b.year); if (nationStats.length < 2) return null; let prev = null, next = null; for (const s of nationStats) { if (s.year < targetYear) prev = s; else if (s.year > targetYear) { next = s; break; } } if (prev && next) { const timeRatio = (targetYear - prev.year) / (next.year - prev.year); return { nationId, year: targetYear, population: Math.round(prev.population + (next.population - prev.population) * timeRatio), gdp: Math.round(prev.gdp + (next.gdp - prev.gdp) * timeRatio), isEstimated: true }; } return null; };
    const resolveRelationships = () => { const parents = {}; const children = {}; nations.forEach(n => { const info = getNationInfo(n, year); if (info.eraEvent) { const type = ERA_EVENT_TYPES[info.eraEvent.type]; const targets = info.eraEvent.targetIds || (info.eraEvent.targetId ? [info.eraEvent.targetId] : []); if (type) { targets.forEach(targetId => { if (type.relationship === 'child') { if (!parents[targetId]) parents[targetId] = []; parents[targetId].push({ parentId: n.id, type: info.eraEvent.type }); } else if (type.relationship === 'parent') { if (!parents[n.id]) parents[n.id] = []; parents[n.id].push({ parentId: targetId, type: info.eraEvent.type }); } }); } } }); Object.keys(parents).forEach(childId => { parents[childId].forEach(rel => { if (!children[rel.parentId]) children[rel.parentId] = []; if (!children[rel.parentId].includes(childId)) children[rel.parentId].push(childId); }); }); return { parents, children }; };
    const { parents, children } = resolveRelationships();
    
    const renderRow = (nation, depth = 0, parentId = null) => {
        // デフォルトは現在の表示年時点の情報
        let info = getNationInfo(nation, year); 
        const stat = getStat(nation.id, year);

        if (parentId && !expandedParents[parentId]) return null;
        if (depth === 0 && parents[nation.id] && parents[nation.id].length > 0) return null;
        if (depth === 0 && info.isCollapsed) return null;
        if (info.isFuture) return null;

        const statStyle = stat?.isEstimated ? "text-gray-500 italic" : "text-gray-800";
        
        // 変数準備
        let relationLabel = null; 
        let eventYearLabel = null; 
        let targetEvent = null;

        // ★修正: 従属国（過去に併合された国）の場合、その当時の情報を復元して表示する
        if (depth > 0) {
            // 親国に関連するイベント（併合、分割等）を持つEraを探す
            const sortedEras = (nation.eras || []).sort((a, b) => a.startYear - b.startYear);
            const targetEraIndex = sortedEras.findIndex(e => 
                e.startYear <= year &&
                e.event && 
                (e.event.targetId === parentId || (e.event.targetIds && e.event.targetIds.includes(parentId))) && 
                ['annexed_by', 'partitioned_by', 'merger', 'dissolution', 'be_puppet'].includes(e.event.type)
            );

            if (targetEraIndex !== -1) {
                const targetEra = sortedEras[targetEraIndex];
                targetEvent = targetEra.event;
                
                // 期間表示用のラベル (例: "1806年:")
                eventYearLabel = <span className="text-[10px] font-mono bg-gray-200 text-gray-700 px-1 rounded ml-1">{targetEra.startYear}年:</span>;

                // ★情報の書き換え: 滅亡/併合イベントの一つ前のEra（その当時の状態）を取得
                const prevEra = targetEraIndex > 0 ? sortedEras[targetEraIndex - 1] : null;
                
                info = {
                    ...info,
                    // 名前: 前のEraがあればそれ、なければ滅亡時（ただし滅亡Eraなら元の国名）
                    name: prevEra ? prevEra.name : (targetEra.type === 'collapse' ? nation.name : targetEra.name),
                    color: prevEra ? prevEra.color : (targetEra.color || nation.color),
                    flag: prevEra ? (prevEra.flag || nation.flag) : (targetEra.flag || nation.flag),
                    params: prevEra ? (prevEra.params || {}) : (nation.params || {}), // 当時のイデオロギー等
                    
                    // 期間: 前のEraの開始 ～ ターゲットEraの開始（＝滅亡年）
                    eraStartYear: prevEra ? prevEra.startYear : (info.nationStartYear || '不明'),
                    eraEndYear: targetEra.startYear,
                    
                    // リスト上では見やすくするため滅亡グレーアウトを解除（depthで表現されているため）
                    isCollapsed: false 
                };
            } else {
                relationLabel = <span className="ml-2 text-[10px] text-gray-400 border border-gray-200 px-1 rounded">(従属)</span>;
            }
        } else {
            // ルート表示の場合は通常のイベントチェック
            if (info.eraEvent && ['independence', 'splinter'].includes(info.eraEvent.type)) { 
                targetEvent = info.eraEvent; 
            }
        }

        // バッジ生成ロジック（既存のまま）
        if (targetEvent) { 
            const t = ERA_EVENT_TYPES[targetEvent.type]; 
            if (t) { 
                const targetIds = targetEvent.targetIds || (targetEvent.targetId ? [targetEvent.targetId] : []); 
                let targetNames = ''; 
                if (targetIds.length > 0) { 
                    targetNames = targetIds.map(tid => { const tn = nations.find(n => n.id === tid); return tn ? tn.name : '?'; }).join('・'); 
                } 
                let labelText = t.label; 
                let styleClass = "bg-gray-100 text-gray-600 border-gray-200"; 
                if (['annexed_by', 'merger'].includes(targetEvent.type)) { labelText = `${targetNames}に併合`; styleClass = "bg-red-50 text-red-600 border-red-100"; } 
                else if (targetEvent.type === 'partitioned_by') { labelText = `${targetNames}により分割`; styleClass = "bg-red-50 text-red-600 border-red-100"; } 
                else if (targetEvent.type === 'dissolution') { labelText = `${targetNames}へ解体・分裂`; styleClass = "bg-red-50 text-red-600 border-red-100"; } 
                else if (['independence', 'splinter'].includes(targetEvent.type)) { labelText = `${targetNames}${t.label}`; styleClass = "bg-indigo-50 text-indigo-700 border-indigo-100"; } 
                else if (targetEvent.type === 'be_puppet') { labelText = `${targetNames}の傀儡`; } 
                relationLabel = <span className={`ml-2 text-[10px] px-1 rounded border flex items-center gap-1 ${styleClass}`}>{t.icon} {labelText}</span>; 
            } 
        }

        const myChildren = children[nation.id] || []; const hasChildren = myChildren.length > 0; const isExpanded = expandedParents[nation.id]; const isChild = depth > 0; const rowClass = isChild ? "bg-gray-50/80" : "hover:bg-gray-50"; const opacityClass = (info.isCollapsed && depth === 0) ? "opacity-60 grayscale" : ""; const key = `${nation.id}-${parentId || 'root'}`;
        let rankBadge = null; if (depth === 0 && info.params && !info.isCollapsed) { const rankInfo = NATION_RANKS[nation.rank || 'minor_power']; if (rankInfo) { rankBadge = <span className="text-[9px] px-1 rounded border ml-1 whitespace-nowrap" style={{borderColor: rankInfo.color, color: rankInfo.color, backgroundColor: 'white'}}>{rankInfo.label}</span>; } }
        
        return ( <React.Fragment key={key}> <tr className={`${rowClass} transition-colors ${opacityClass}`}> <td className="px-4 py-3 font-bold sticky left-0 bg-white/95 z-10 shadow-sm border-r border-gray-100 align-top"> <div className="flex items-center" style={{ paddingLeft: `${depth * 20}px` }}> {hasChildren ? ( <button onClick={() => toggleExpand(nation.id)} className="mr-2 p-0.5 rounded hover:bg-gray-200 text-gray-500"> {isExpanded ? <Icons.ChevronDown size={14} /> : <Icons.ChevronRight size={14} />} </button> ) : ( <span className="w-4 mr-2"></span> )} {isChild && !hasChildren && <Icons.CornerDownRight size={14} className="text-gray-300 mr-1" />} {info.flag ? ( <img src={info.flag} alt="Flag" className="w-8 h-5 object-cover border border-gray-200 shadow-sm mr-2 flex-shrink-0" /> ) : ( <div className="w-8 h-5 shadow-sm border border-gray-200 flex-shrink-0 flex items-center justify-center text-[8px] text-gray-400 bg-gray-100 mr-2">No</div> )} <div className="flex flex-col justify-center"> <div className="flex items-center gap-1 flex-wrap"> {eventYearLabel} <span className={`text-sm ${info.isCollapsed && depth === 0 ? 'line-through text-gray-400' : ''}`}>{info.name}</span> {rankBadge} {relationLabel} </div> </div> </div> </td> <td className="px-2 py-3 text-center border-l border-gray-100 bg-gray-50/30"><button onClick={() => onEditNation(nation)} className="text-blue-600 hover:bg-blue-100 p-2 rounded transition-colors"><Icons.Edit2 size={16} /></button></td> <td className="px-2 py-3 text-center border-l border-gray-100 bg-gray-50/30"><div className="flex flex-col items-center justify-center leading-tight"><span className="text-xs font-bold text-gray-700">{info.eraStartYear ? info.eraStartYear : '不明'}<span className="text-gray-400 mx-0.5">～</span>{info.eraEndYear ? info.eraEndYear : ''}</span><span className="text-[10px] text-gray-400 mt-0.5">(国: {info.nationStartYear ? info.nationStartYear : '不明'}<span className="mx-0.5">～</span>{info.nationEndYear ? info.nationEndYear : ''})</span></div></td> <td className={`px-4 py-3 text-right font-mono border-l border-gray-100 bg-blue-50/30 ${statStyle} text-xs`}>{stat ? formatJapaneseNumber(stat.population, '人', true) : '-'}</td> <td className={`px-4 py-3 text-right font-mono border-l border-gray-100 bg-green-50/30 ${statStyle} text-xs`}>{stat ? formatJapaneseNumber(stat.gdp, '円', true) : '-'}</td> <td className={`px-4 py-3 text-right font-mono border-l border-gray-100 bg-yellow-50/30 ${statStyle} text-xs`}>{stat ? formatJapaneseNumber(calculatePerCapita(stat.gdp, stat.population), '円', true) : '-'}</td> {NATION_PARAMS.map(p => { const param = info.params?.[p.key] || {}; const bgColor = param.color || '#f3f4f6'; const isLight = parseInt(bgColor.replace('#', ''), 16) > 0xffffff / 2; const textColor = param.color ? (isLight ? '#000' : '#fff') : '#9ca3af'; return ( <td key={p.key} className="px-2 py-2 border-l border-gray-100 align-top"> <div className="h-full w-full rounded p-1 text-center flex flex-col items-center justify-center gap-0.5 min-h-[40px]" style={{backgroundColor: bgColor, color: textColor, border: param.name ? 'none' : '1px dashed #e5e7eb'}}> {param.name ? ( <> <div className="font-bold leading-tight text-[11px]">{param.name}</div> {param.desc && <div className={`text-[8px] leading-tight opacity-80 font-normal mt-0.5`}>{param.desc}</div>} </> ) : <span className="text-[10px]">-</span>} </div> </td> ); })} </tr> {myChildren.map(childId => { const childNation = nations.find(n => n.id === childId); if (childNation) return renderRow(childNation, depth + 1, nation.id); return null; })} </React.Fragment> );
    };

    const rootNations = nations.filter(n => !parents[n.id]);
    
    return ( <div className="space-y-6 animate-fade-in pb-20"> <div className="flex flex-wrap items-center justify-between gap-4"> <div className="flex items-center gap-3 bg-white px-4 py-2 rounded-lg shadow border border-gray-200"> <span className="font-bold text-sm text-gray-600 whitespace-nowrap">表示年:</span> <div className="flex items-center gap-2"><input type="range" min="-3000" max="3000" value={year} onChange={e => setYear(parseInt(e.target.value) || 0)} className="w-32 md:w-48 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-900" /><input type="number" value={year} onChange={e => setYear(parseInt(e.target.value) || 0)} className="w-20 p-1 border rounded font-mono text-lg font-bold text-center text-blue-900" /></div> </div> </div> <SectionHeader icon={Icons.List} title={`国家体制一覧 (${year}年時点)`} desc="各国の統治体制、イデオロギー、宗教などの詳細を比較・確認できます。大陸別に国力ランク順（大列強 > 都市国家）で表示されます。" /> <div className="bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden"> <div className="overflow-x-auto custom-scrollbar"> <table className="w-full text-sm text-left whitespace-nowrap border-collapse"> <thead className="bg-gray-100 text-gray-700 font-bold uppercase border-b-2 border-gray-300"> <tr> <th className="px-4 py-3 sticky left-0 bg-gray-100 z-10 shadow-sm min-w-[240px] border-r border-gray-200">国名・国旗</th> <th className="px-2 py-3 text-center border-l border-gray-200 w-[60px] bg-gray-50">操作</th> <th className="px-4 py-3 text-center border-l border-gray-200 min-w-[140px] bg-gray-50">期間</th> <th className="px-4 py-3 text-center border-l border-gray-200 min-w-[100px] bg-blue-50">人口</th> <th className="px-4 py-3 text-center border-l border-gray-200 min-w-[120px] bg-green-50">GDP</th> <th className="px-4 py-3 text-center border-l border-gray-200 min-w-[100px] bg-yellow-50">一人あたり</th> {NATION_PARAMS.map(p => ( <th key={p.key} className="px-4 py-3 text-center border-l border-gray-200 min-w-[140px]">{p.label}</th> ))} </tr> </thead> <tbody className="divide-y divide-gray-200"> {Object.entries(LOCATIONS).sort((a, b) => a[1].order - b[1].order).map(([locKey, locInfo]) => { const nationsInLoc = rootNations.filter(n => (n.location || 'unknown') === locKey); if (nationsInLoc.length === 0) return null; nationsInLoc.sort((a, b) => { const rankA = NATION_RANKS[a.rank || 'minor_power']?.order || 99; const rankB = NATION_RANKS[b.rank || 'minor_power']?.order || 99; return rankA - rankB; }); return ( <React.Fragment key={locKey}> <tr className="bg-orange-900/10 border-b border-orange-900/20"> <td colSpan={6 + NATION_PARAMS.length} className="px-4 py-2 font-bold text-white text-sm tracking-wider" style={{ backgroundColor: locInfo.color }}> {locInfo.label} </td> </tr> {nationsInLoc.map(nation => renderRow(nation))} </React.Fragment> ); }) } </tbody> </table> </div> </div> <div className="flex justify-end"> <button onClick={onAddNation} className="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow hover:bg-blue-800"><Icons.Plus size={18} /> 新規国家を追加</button> </div> </div> );
};

// --- NationListPanel コンポーネント (修正版: 幅指定を親に委ねる) ---
const NationListPanel = ({ nations, setNations, selectedNationId, onSelect }) => {
    const [newNationName, setNewNationName] = useState('');
    const [newNationColor, setNewNationColor] = useState('#000000');
    const [newNationFlag, setNewNationFlag] = useState(null);
    const newFlagInputRef = useRef(null);

    const handleFlagUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try { const base64 = await fileToBase64(file); setNewNationFlag(base64); } 
        catch (err) { console.error(err); alert("画像の読み込みに失敗しました。"); }
    };

    const addNation = () => {
        if (!newNationName) return;
        const newNation = { id: Date.now().toString(), name: newNationName, color: newNationColor, flag: newNationFlag, eras: [], startYear: null, note: '', location: 'unknown', rank: 'minor_power' };
        setNations([...nations, newNation]);
        setNewNationName(''); setNewNationFlag(null);
        if(newFlagInputRef.current) newFlagInputRef.current.value = '';
        onSelect(newNation);
    };

    const optimizeAllImages = async () => {
        if (!window.confirm('登録済みの全ての国旗画像を軽量化(リサイズ・圧縮)します。\n実行しますか？')) return;
        let count = 0;
        const newNations = await Promise.all(nations.map(async (n) => {
            let updated = { ...n }; let changed = false;
            if (updated.flag && updated.flag.startsWith('data:image')) {
                const compressed = await compressBase64Image(updated.flag);
                if (updated.flag !== compressed) { updated.flag = compressed; changed = true; count++; }
            }
            if (updated.eras && updated.eras.length > 0) {
                const newEras = await Promise.all(updated.eras.map(async (era) => {
                    if (era.flag && era.flag.startsWith('data:image')) {
                        const c = await compressBase64Image(era.flag);
                        if (era.flag !== c) { count++; return { ...era, flag: c }; }
                    }
                    return era;
                }));
                if (JSON.stringify(newEras) !== JSON.stringify(updated.eras)) { updated.eras = newEras; changed = true; }
            }
            return updated;
        }));
        setNations(newNations);
        alert(`完了しました。\n${count} 枚の画像を軽量化しました。`);
    };

    return (
        // ここを変更: md:w-1/3 を削除し、w-full h-full に
        <div className="w-full h-full flex flex-col bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
            <div className="p-4 bg-gray-800 text-white flex justify-between items-center flex-shrink-0">
                <h2 className="text-lg font-bold flex items-center gap-2"><Icons.Globe size={20} className="text-yellow-500"/> 国家リスト</h2>
            </div>
            <div className="p-4 border-b border-gray-100 bg-gray-50 flex-shrink-0">
                <h3 className="font-bold text-xs text-gray-500 mb-2">新規国家追加</h3>
                <div className="flex gap-2 items-center mb-2">
                    <div className="flex-shrink-0">
                        <label className="cursor-pointer block w-10 h-7 bg-white border border-gray-300 flex items-center justify-center text-[8px] text-gray-400 hover:bg-gray-100 overflow-hidden">
                            {newNationFlag ? <img src={newNationFlag} className="w-full h-full object-cover" /> : '画像'}
                            <input type="file" className="hidden" accept="image/*" ref={newFlagInputRef} onChange={handleFlagUpload} />
                        </label>
                    </div>
                    <input type="color" value={newNationColor} onChange={e => setNewNationColor(e.target.value)} className="h-7 w-7 rounded cursor-pointer border border-gray-300" />
                    <input type="text" value={newNationName} onChange={e => setNewNationName(e.target.value)} placeholder="国名" className="flex-grow p-1 border rounded text-sm" />
                </div>
                <button onClick={addNation} className="w-full bg-blue-900 text-white py-1.5 rounded text-sm font-bold hover:bg-blue-800 flex justify-center items-center gap-1"><Icons.Plus size={14} /> 追加</button>
            </div>
            <div className="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-1 min-h-[200px]">
                {nations.map(n => (
                    <div key={n.id} onClick={() => onSelect(n)} className={`flex items-center justify-between p-3 rounded cursor-pointer border transition-all ${selectedNationId === n.id ? 'bg-blue-50 border-blue-300 ring-1 ring-blue-200' : 'bg-white border-transparent hover:bg-gray-50 hover:border-gray-200'}`}>
                        <div className="flex items-center gap-3">
                            {n.flag ? <img src={n.flag} className="w-8 h-5 object-cover border border-gray-200" /> : <div className="w-8 h-5 bg-gray-100 border border-gray-200"></div>}
                            <div className="w-3 h-3 rounded-full" style={{backgroundColor: n.color}}></div>
                            <span className="font-bold text-sm">{n.name}</span>
                        </div>
                        <Icons.ChevronRight size={16} className="text-gray-400" />
                    </div>
                ))}
            </div>
            <div className="p-2 border-t bg-gray-50 flex-shrink-0">
                <button onClick={optimizeAllImages} className="w-full py-2 text-xs text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-100 flex items-center justify-center gap-2"><Icons.Image size={14} /> 全画像の軽量化 (メンテナンス)</button>
            </div>
        </div>
    );
};

// --- SettingsView コンポーネント (修正版: 右側スクロール廃止・物理拡張、左側Sticky・高さ統一) ---
const SettingsView = ({ setView, nations, setNations, targetNation, setTargetNation }) => {
    const [editingNation, setEditingNation] = useState(null); 
    
    // Era編集用のState群
    const [eraStartYear, setEraStartYear] = useState(''); const [eraName, setEraName] = useState(''); const [eraColor, setEraColor] = useState('#000000'); const [eraFlag, setEraFlag] = useState(null); const [eraParams, setEraParams] = useState({}); const [eraMode, setEraMode] = useState('normal'); const [editingEraIndex, setEditingEraIndex] = useState(null); const [eraEventType, setEraEventType] = useState('none'); const [eraRelatedNationId, setEraRelatedNationId] = useState(''); const [eraRelatedNationIds, setEraRelatedNationIds] = useState([]); 
    
    const editFlagInputRef = useRef(null); const eraFlagInputRef = useRef(null);

    useEffect(() => { if (targetNation) { setEditingNation(targetNation); } else { setEditingNation(null); } }, [targetNation]);
    
    const handleClose = () => { if (setTargetNation) setTargetNation(null); setView('timeline'); };
    const handleFlagUpload = async (e, setter) => { const file = e.target.files[0]; if (!file) return; try { const base64 = await fileToBase64(file); setter(base64); } catch (err) { console.error("Image upload failed", err); alert("画像の読み込みに失敗しました。"); } };
    
    const deleteNation = (id) => { if (window.confirm('削除しますか？')) { setNations(nations.filter(n => n.id !== id)); if (editingNation && editingNation.id === id) setEditingNation(null); } };
    const updateNationBase = (id, key, value) => { const updated = { ...editingNation, [key]: value }; setEditingNation(updated); setNations(nations.map(n => n.id === id ? updated : n)); };
    
    const updateEraParam = (key, field, value) => { setEraParams(prev => ({ ...prev, [key]: { ...prev[key], [field]: value } })); };
    const toggleRelatedNationId = (id) => { setEraRelatedNationIds(prev => prev.includes(id) ? prev.filter(pid => pid !== id) : [...prev, id]); };
    const saveEra = () => { if (!eraStartYear) return; let targetId = eraRelatedNationId; let targetIds = []; const multiTargetEvents = ['partitioned_by', 'dissolution', 'unification', 'annexation', 'partition']; if (multiTargetEvents.includes(eraEventType)) { targetIds = eraRelatedNationIds; targetId = null; } else if (eraRelatedNationId) { targetIds = [eraRelatedNationId]; } let type = 'default'; if (eraMode === 'collapse') type = 'collapse'; const newEraData = { startYear: parseInt(eraStartYear), name: eraName || (eraMode === 'collapse' ? '滅亡' : editingNation.name), color: eraColor, flag: eraFlag, params: eraParams, type: type, event: { type: eraEventType, targetId: targetId, targetIds: targetIds } }; let updatedEras; if (editingEraIndex !== null) { updatedEras = [...editingNation.eras]; updatedEras[editingEraIndex] = newEraData; } else { updatedEras = [ ...(editingNation.eras || []), newEraData]; } const updatedNation = { ...editingNation, eras: updatedEras }; let updatedNations = nations.map(n => n.id === editingNation.id ? updatedNation : n); setEditingNation(updatedNation); setNations(updatedNations); resetEraForm(); };
    const resetEraForm = () => { setEraStartYear(''); setEraName(''); setEraParams({}); setEraFlag(null); setEraColor('#000000'); setEraMode('normal'); setEraEventType('none'); setEraRelatedNationId(''); setEraRelatedNationIds([]); if(eraFlagInputRef.current) eraFlagInputRef.current.value = ''; setEditingEraIndex(null); };
    const startEditEra = (index) => { const era = editingNation.eras[index]; setEraStartYear(era.startYear); setEraName(era.name); setEraColor(era.color); setEraFlag(era.flag); setEraParams(era.params || {}); if (era.type === 'collapse') setEraMode('collapse'); else if (['foundation', 'independence', 'splinter', 'unification', 'foundation_puppet'].includes(era.event?.type)) setEraMode('birth'); else setEraMode('normal'); if (era.event) { setEraEventType(era.event.type || 'none'); setEraRelatedNationId(era.event.targetId || ''); setEraRelatedNationIds(era.event.targetIds || []); } else { setEraEventType('none'); setEraRelatedNationId(''); setEraRelatedNationIds([]); } setEditingEraIndex(index); };
    const deleteEra = (index) => { const updatedEras = editingNation.eras.filter((_, i) => i !== index); const updatedNation = { ...editingNation, eras: updatedEras }; setEditingNation(updatedNation); setNations(nations.map(n => n.id === editingNation.id ? updatedNation : n)); if (editingEraIndex === index) resetEraForm(); };

    const jumpToOverview = () => {
        setTargetNation(editingNation);
        setView('nation_overview');
    };

    return ( 
        // ★修正点: 高さ固定を廃止し、min-hに変更。overflow指定も削除してページ全体のスクロールに委ねる。
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20"> 
            <SectionHeader icon={Icons.Globe} title="国家変遷管理" desc="国家の新規登録、歴史的変遷（Era）の管理、国旗やテーマカラーの設定を行います。" /> 
            
            {/* ★修正点: items-stretch ではなく items-start に変更し、左カラムのStickyを有効化 */}
            <div className="flex gap-6 items-start flex-grow"> 
                {/* 左側リスト: Sticky配置 + 高さ指定 (NationOverviewViewと統一) */}
                <div 
                    className="w-full md:w-80 flex-shrink-0 sticky top-4"
                    style={{ height: 'calc(100vh - 320px)', minHeight: '400px' }}
                >
                    <NationListPanel nations={nations} setNations={setNations} selectedNationId={editingNation?.id} onSelect={(n) => { setEditingNation(n); resetEraForm(); }} />
                </div>

                {/* 右側コンテンツ: 高さ制限・内部スクロール(overflow-y-auto)を削除し、物理的に伸びるようにする */}
                <div className="flex-grow w-full min-w-[300px]"> 
                    {editingNation ? ( 
                        <div className="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden animate-fade-in"> 
                            {/* ヘッダー部分はStickyにして、縦に長くなっても操作できるようにする */}
                            <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 sticky top-0 z-30 shadow-sm">
                                <h3 className="font-bold text-lg flex items-center gap-2">
                                    <span className="w-4 h-4 rounded-full inline-block" style={{backgroundColor: editingNation.color}}></span>"{editingNation.name}" の設定
                                </h3>
                                <button onClick={() => deleteNation(editingNation.id)} className="text-red-500 text-xs flex items-center gap-1 hover:underline bg-red-50 px-2 py-1 rounded border border-red-100">
                                    <Icons.Trash2 size={12} /> 削除
                                </button>
                            </div> 
                            <div className="p-6 space-y-8"> 
                                <section> 
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b pb-1">基本情報 (初期状態)</h4> 
                                    <div className="flex gap-6 items-start"> 
                                        <div className="flex-shrink-0 text-center"> 
                                            <label className="block cursor-pointer group relative"> 
                                                {editingNation.flag ? <img src={editingNation.flag} className="w-24 h-16 object-cover border border-gray-300 shadow-sm" /> : <div className="w-24 h-16 bg-gray-100 border border-gray-300 flex items-center justify-center text-gray-400 text-xs">No Image</div>} 
                                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">変更</div> 
                                                <input type="file" className="hidden" accept="image/*" ref={editFlagInputRef} onChange={(e) => handleFlagUpload(e, (val) => updateNationBase(editingNation.id, 'flag', val))} /> 
                                            </label> 
                                        </div> 
                                        <div className="flex-grow grid grid-cols-2 gap-4"> 
                                            <div><label className="block text-xs font-bold text-gray-600 mb-1">国名</label><input type="text" value={editingNation.name} onChange={e => updateNationBase(editingNation.id, 'name', e.target.value)} className="w-full p-2 border rounded shadow-sm font-bold" /></div> 
                                            <div> <label className="block text-xs font-bold text-gray-600 mb-1">テーマカラー</label> <div className="flex items-center gap-2"> <input type="color" value={editingNation.color} onChange={e => updateNationBase(editingNation.id, 'color', e.target.value)} className="h-9 w-12 rounded cursor-pointer border border-gray-300 shadow-sm" /> <span className="text-xs text-gray-500 font-mono">{editingNation.color}</span> </div> </div> 
                                            <div> <label className="block text-xs font-bold text-gray-600 mb-1">所在・地域</label> <select value={editingNation.location || 'unknown'} onChange={e => updateNationBase(editingNation.id, 'location', e.target.value)} className="w-full p-2 border rounded shadow-sm text-sm bg-white"> {Object.entries(LOCATIONS).sort((a,b) => a[1].order - b[1].order).map(([key, info]) => ( <option key={key} value={key}>{info.label}</option> ))} </select> </div> 
                                            <div> <label className="block text-xs font-bold text-gray-600 mb-1">国力ランク</label> <select value={editingNation.rank || 'minor_power'} onChange={e => updateNationBase(editingNation.id, 'rank', e.target.value)} className="w-full p-2 border rounded shadow-sm text-sm bg-white font-bold" style={{color: NATION_RANKS[editingNation.rank || 'minor_power']?.color}}> {Object.entries(NATION_RANKS).sort((a,b) => a[1].order - b[1].order).map(([key, info]) => ( <option key={key} value={key} style={{color: info.color}}>{info.label}</option> ))} </select> </div> 
                                        </div> 
                                    </div> 
                                </section> 
                                
                                <section> 
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b pb-1">国家概要</h4> 
                                    <div className="bg-gray-50 p-4 rounded border border-gray-200 text-center">
                                        <p className="text-sm text-gray-500 mb-3 font-bold">
                                            国家の文化、歴史、地理などの詳細な設定は<br/>
                                            「国家概要管理」でリッチテキスト形式で記述できます。
                                        </p>
                                        <button 
                                            onClick={jumpToOverview}
                                            className="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold py-2 px-4 rounded shadow flex items-center gap-2 mx-auto transition-colors"
                                        >
                                            <Icons.FileText size={18} /> 概要エディタを開く
                                        </button>
                                    </div>
                                </section> 
                                
                                <section> 
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b pb-1">歴史的変遷 (Era)</h4> 
                                    <div className="flex flex-col lg:flex-row gap-6"> 
                                        <div className={`flex-grow p-4 rounded-lg border transition-colors ${eraMode === 'collapse' ? 'bg-red-50 border-red-300' : eraMode === 'birth' ? 'bg-green-50 border-green-300' : (editingEraIndex !== null ? 'bg-yellow-50 border-yellow-300' : 'bg-blue-50 border-blue-200')}`}> 
                                            <div className="flex justify-between items-center mb-4"> 
                                                <div className="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"> 
                                                    <button onClick={() => setEraMode('normal')} className={`px-3 py-1 text-xs font-bold rounded ${eraMode === 'normal' ? 'bg-blue-100 text-blue-800' : 'text-gray-500 hover:bg-gray-50'}`}>通常(変更)</button> 
                                                    <button onClick={() => setEraMode('birth')} className={`px-3 py-1 text-xs font-bold rounded ${eraMode === 'birth' ? 'bg-green-100 text-green-800' : 'text-gray-500 hover:bg-gray-50'}`}>✨ 誕生</button> 
                                                    <button onClick={() => setEraMode('collapse')} className={`px-3 py-1 text-xs font-bold rounded ${eraMode === 'collapse' ? 'bg-red-100 text-red-800' : 'text-gray-500 hover:bg-gray-50'}`}>💀 滅亡</button> 
                                                </div> 
                                                {editingEraIndex !== null && <button onClick={resetEraForm} className="text-xs text-gray-500 hover:underline">キャンセル</button>} 
                                            </div> 
                                            <div className="mb-4"><label className="block text-xs font-bold text-gray-600 mb-1">開始年 (発生年)</label><input type="number" value={eraStartYear} onChange={e => setEraStartYear(e.target.value)} className="w-full p-2 border rounded text-lg font-bold" placeholder="例: 1900" required /></div> 
                                            {eraMode === 'collapse' ? ( 
                                                <div className="animate-fade-in space-y-4"> 
                                                    <div className="p-3 bg-white rounded border border-red-100"> 
                                                        <label className="block text-xs font-bold text-red-600 mb-1">滅亡の理由</label> 
                                                        <select value={eraEventType} onChange={e => setEraEventType(e.target.value)} className="w-full p-2 border rounded text-sm bg-white"> 
                                                            <option value="none">自然消滅 / 不明</option> <option value="annexed_by">他国に併合される</option> <option value="merger">他国と合併して消滅</option> <option value="dissolution">分裂・解体して消滅 (複数国へ)</option> <option value="partitioned_by">複数国により分割統治される</option> 
                                                        </select> 
                                                    </div> 
                                                    {(eraEventType === 'partitioned_by' || eraEventType === 'dissolution') ? ( 
                                                        <div> 
                                                            <label className="block text-xs font-bold text-gray-600 mb-1">{eraEventType === 'dissolution' ? '分裂後に生まれた国 (複数可)' : '分割した国 (複数可)'}</label> 
                                                            <div className="border rounded bg-white p-2 max-h-32 overflow-y-auto custom-scrollbar"> {nations.filter(n => n.id !== editingNation.id).map(n => ( <label key={n.id} className="flex items-center gap-2 p-1 hover:bg-gray-50 cursor-pointer"><input type="checkbox" checked={eraRelatedNationIds.includes(n.id)} onChange={() => toggleRelatedNationId(n.id)} className="rounded text-red-600" />{n.flag && <img src={n.flag} className="w-4 h-3 object-cover border border-gray-200" />}<span className="text-xs">{n.name}</span></label> ))} </div> 
                                                        </div> 
                                                    ) : eraEventType !== 'none' && ( 
                                                        <div> 
                                                            <label className="block text-xs font-bold text-gray-600 mb-1">対象国</label> 
                                                            <select value={eraRelatedNationId} onChange={e => setEraRelatedNationId(e.target.value)} className="w-full p-2 border rounded text-sm bg-white"> 
                                                                <option value="">-- 国を選択 --</option> {nations.filter(n => n.id !== editingNation.id).map(n => <option key={n.id} value={n.id}>{n.name}</option>)} 
                                                            </select> 
                                                        </div> 
                                                    )} 
                                                    <p className="text-[10px] text-red-400">※滅亡を設定すると、以降の年表には表示されなくなります。</p> 
                                                </div> 
                                            ) : ( 
                                                <div className="animate-fade-in space-y-4"> 
                                                    <div className="flex gap-3"> 
                                                        <label className="cursor-pointer flex-shrink-0 w-16 h-10 bg-white border border-gray-300 flex items-center justify-center hover:bg-gray-50 relative group"> {eraFlag ? <img src={eraFlag} className="w-full h-full object-cover" /> : <span className="text-[10px] text-gray-400">Flag</span>} <input type="file" className="hidden" accept="image/*" ref={eraFlagInputRef} onChange={(e) => handleFlagUpload(e, setEraFlag)} /> </label> 
                                                        <div className="flex-grow grid grid-cols-1 gap-2"> <input type="text" value={eraName} onChange={e => setEraName(e.target.value)} className="w-full p-2 border rounded text-sm font-bold" placeholder={eraMode === 'birth' ? "建国時の国名" : "変更後の国名"} /> <div className="flex items-center gap-2"> <input type="color" value={eraColor} onChange={e => setEraColor(e.target.value)} className="h-8 w-12 rounded cursor-pointer border border-gray-300" /> <span className="text-xs text-gray-500">テーマカラー</span> </div> </div> 
                                                    </div> 
                                                    <div className="p-3 bg-white rounded border border-blue-100"> 
                                                        <label className="block text-[10px] font-bold text-blue-600 mb-1 flex items-center gap-1"><Icons.Link size={10}/> {eraMode === 'birth' ? '成立の経緯' : '関連イベント (任意)'}</label> 
                                                        <div className="flex flex-col gap-2"> 
                                                            <div className="flex gap-2"> 
                                                                <select value={eraEventType} onChange={e => setEraEventType(e.target.value)} className="w-1/2 p-1.5 border rounded text-xs"> 
                                                                    <option value="none">-- なし --</option> {eraMode === 'birth' ? ( <> <option value="foundation">建国・成立 (単独)</option> <option value="independence">より独立</option> <option value="splinter">より分裂して成立</option> <option value="unification">を統合して成立</option> <option value="foundation_puppet">の傀儡国として成立</option> </> ) : ( <> <option value="regime_change">政体の変更</option> <option value="annexation">を併合</option> <option value="partition">を分割統治</option> <option value="puppet">を傀儡化</option> <option value="be_puppet">の傀儡になる</option></> )} 
                                                                </select> 
                                                                {!['unification', 'annexation', 'partition'].includes(eraEventType) && ( <select value={eraRelatedNationId} onChange={e => setEraRelatedNationId(e.target.value)} disabled={['none', 'foundation', 'regime_change'].includes(eraEventType)} className="w-1/2 p-1.5 border rounded text-xs disabled:opacity-50"> <option value="">-- 対象国 --</option> {nations.filter(n => n.id !== editingNation.id).map(n => <option key={n.id} value={n.id}>{n.name}</option>)} </select> )} 
                                                            </div> 
                                                            {['unification', 'annexation', 'partition'].includes(eraEventType) && ( <div className="mt-2"> <label className="block text-xs font-bold text-gray-600 mb-1"> {eraEventType === 'unification' ? '統合する国 (複数可)' : eraEventType === 'annexation' ? '併合する国 (複数可)' : '分割する国 (複数可)'} </label> <div className="border rounded bg-white p-2 max-h-32 overflow-y-auto custom-scrollbar"> {nations.filter(n => n.id !== editingNation.id).map(n => ( <label key={n.id} className="flex items-center gap-2 p-1 hover:bg-gray-50 cursor-pointer"><input type="checkbox" checked={eraRelatedNationIds.includes(n.id)} onChange={() => toggleRelatedNationId(n.id)} className="rounded text-blue-600" />{n.flag && <img src={n.flag} className="w-4 h-3 object-cover border border-gray-200" />}<span className="text-xs">{n.name}</span></label> ))} </div> </div> )} 
                                                        </div> 
                                                    </div> 
                                                    <div className="space-y-2"> 
                                                        <p className="text-[10px] font-bold text-gray-500">体制詳細</p> 
                                                        <div className="grid grid-cols-2 gap-2"> {NATION_PARAMS.map(param => ( <div key={param.key} className="bg-white p-1.5 rounded border border-gray-200 text-xs"> <div className="flex justify-between items-center mb-1"><span className="font-bold text-[10px] text-gray-600">{param.label}</span><input type="color" value={eraParams[param.key]?.color || param.defaultColor} onChange={e => updateEraParam(param.key, 'color', e.target.value)} className="w-3 h-3 rounded cursor-pointer border-none" /></div> <input type="text" placeholder="名称 (例: 立憲君主制)" value={eraParams[param.key]?.name || ''} onChange={e => updateEraParam(param.key, 'name', e.target.value)} className="w-full p-1 border rounded mb-1 text-[10px] font-bold" /> <input type="text" placeholder="一言メモ (例: 王は法の下に...)" value={eraParams[param.key]?.desc || ''} onChange={e => updateEraParam(param.key, 'desc', e.target.value)} className="w-full p-1 border-b border-gray-100 text-[9px] text-gray-500 outline-none bg-transparent" /> </div> ))} </div> 
                                                    </div> 
                                                </div> 
                                            )} 
                                            <div className="text-right mt-4"> <button onClick={saveEra} className={`w-full text-white px-4 py-2 rounded font-bold shadow transition-colors flex justify-center items-center gap-2 text-sm ${eraMode === 'collapse' ? 'bg-red-700 hover:bg-red-800' : eraMode === 'birth' ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-900 hover:bg-blue-800'}`}> {editingEraIndex !== null ? <Icons.Save size={14} /> : <Icons.Plus size={14} />} {editingEraIndex !== null ? '更新する' : (eraMode === 'collapse' ? '滅亡を記録' : eraMode === 'birth' ? '誕生を記録' : '変遷を追加')} </button> </div> 
                                        </div> 
                                        <div className="w-full lg:w-1/3 space-y-4"> <h5 className="font-bold text-xs text-gray-500">変遷リスト</h5> <div className="space-y-2"> {editingNation.eras && editingNation.eras.length > 0 ? ( editingNation.eras.sort((a,b) => b.startYear - a.startYear).map((era, index) => { const eventType = era.event?.type || 'none'; const eventDef = ERA_EVENT_TYPES[eventType]; const targetIds = era.event?.targetIds || (era.event?.targetId ? [era.event.targetId] : []); const targetNames = targetIds.map(tid => { const n = nations.find(nav => nav.id === tid); return n ? n.name : ''; }).filter(n => n).join('・'); let badgeLabel = "改称・変更"; let badgeClass = "bg-gray-100 text-gray-600 border-gray-200"; if (era.type === 'collapse') { const baseLabel = (eventDef && eventType !== 'none') ? eventDef.label : "滅亡"; badgeLabel = targetNames ? `${targetNames}${baseLabel}` : baseLabel; badgeClass = "bg-red-100 text-red-600 border-red-200"; } else if (['foundation', 'independence', 'splinter', 'unification', 'foundation_puppet'].includes(eventType)) { const baseLabel = eventDef ? eventDef.label : "誕生"; badgeLabel = targetNames ? `${targetNames}${baseLabel}` : baseLabel; badgeClass = "bg-green-100 text-green-800 border-green-200"; } else if (['puppet', 'be_puppet', 'annexation', 'partition', 'regime_change'].includes(eventType)) { const baseLabel = eventDef ? eventDef.label : "変遷"; badgeLabel = targetNames ? `${targetNames}${baseLabel}` : baseLabel; badgeClass = "bg-indigo-50 text-indigo-700 border-indigo-100"; } return ( <div key={index} className="bg-white border rounded p-2 flex justify-between items-center text-sm"> <div className="flex items-center gap-2"> <span className="font-mono font-bold text-gray-600 w-10 text-right text-xs">{era.startYear}年</span> {(era.flag || editingNation.flag) ? ( <img src={era.flag || editingNation.flag} className="w-8 h-5 object-cover border border-gray-200 shadow-sm flex-shrink-0" alt="flag" /> ) : ( <div className="w-8 h-5 bg-gray-100 border border-gray-200 flex-shrink-0"></div> )} <div className="flex flex-col"> <span className={`leading-tight text-xs font-bold ${era.type === 'collapse' ? 'text-gray-400 line-through' : ''}`}>{era.name}</span> <div className="mt-0.5"> <span className={`text-[9px] px-1.5 py-0.5 rounded border ${badgeClass} inline-flex items-center gap-0.5`}> {eventDef && eventDef.icon} {badgeLabel} </span> </div> </div> </div> <div className="flex gap-1"><button onClick={() => startEditEra(index)} className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icons.Edit2 size={14} /></button><button onClick={() => deleteEra(index)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Icons.Trash2 size={14} /></button></div> </div> ); }) ) : ( <p className="text-gray-400 text-xs text-center py-4">記録なし</p> )} </div> </div> </div> </section> 
                            </div> 
                        </div> 
                    ) : ( 
                        <div className="bg-white p-12 rounded-lg shadow-lg border border-gray-200 text-center text-gray-400 flex flex-col justify-center items-center min-h-[500px]"> 
                            <Icons.Globe size={48} className="mx-auto mb-4 text-gray-300"/> 
                            <p>左のリストから国家を選択するか、<br/>新規追加してください。</p> 
                        </div> 
                    )} 
                </div> 
            </div> 
        </div> 
    );
};

// --- CharacterManager コンポーネント (修正版: レベル設定・説明モーダル対応) ---
const CharacterManager = ({ setView, nations, characters, setCharacters, organizations, setOrganizations }) => {
    const [editingChar, setEditingChar] = useState(null);
    const [name, setName] = useState('');
    const [portrait, setPortrait] = useState(null);
    const [race, setRace] = useState(RACES[0].label);
    const [level, setLevel] = useState(''); // ★追加: レベル
    const [birthYear, setBirthYear] = useState('');
    const [deathYear, setDeathYear] = useState('');
    
    const [affiliations, setAffiliations] = useState([]); 
    const [affilInput, setAffilInput] = useState('');
    const [affilRole, setAffilRole] = useState('');

    const [note, setNote] = useState('');
    const [showLevelInfo, setShowLevelInfo] = useState(false); // ★追加: モーダル表示用
    const fileInputRef = useRef(null);

    const affiliationOptions = useMemo(() => {
        const list = [];
        organizations.forEach(o => list.push({ type: 'org', name: o.name }));
        nations.forEach(n => {
            list.push({ type: 'nation', name: n.name });
            (n.eras || []).forEach(e => {
                if (e.name && e.name !== n.name) list.push({ type: 'era', name: e.name });
            });
        });
        return list;
    }, [organizations, nations]);

    const resetForm = () => {
        setEditingChar(null);
        setName('');
        setPortrait(null);
        setRace(RACES[0].label);
        setLevel(''); // ★リセット
        setBirthYear('');
        setDeathYear('');
        setAffiliations([]);
        setAffilInput('');
        setAffilRole('');
        setNote('');
        if(fileInputRef.current) fileInputRef.current.value = '';
    };

    const handleImageUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try { const base64 = await fileToBase64HighRes(file); setPortrait(base64); } 
        catch (err) { console.error(err); alert("画像の読み込みに失敗しました。"); }
    };

    const addAffiliation = () => {
        const text = affilInput.trim();
        if (text) {
            const newItem = { name: text, role: affilRole.trim() };
            const exists = affiliations.some(a => (typeof a === 'string' ? a : a.name) === text);
            if (exists) {
                setAffiliations(affiliations.map(a => (typeof a === 'string' ? a : a.name) === text ? newItem : a));
            } else {
                setAffiliations([...affiliations, newItem]);
            }
            setAffilInput('');
            setAffilRole('');
        }
    };

    const removeAffiliation = (idx) => {
        setAffiliations(affiliations.filter((_, i) => i !== idx));
    };

    const handleSave = () => {
        if (!name) return;
        const newChar = {
            id: editingChar ? editingChar.id : Date.now().toString(),
            name, portrait, race, 
            level: level ? parseInt(level) : null, // ★保存
            birthYear, deathYear, affiliations, note
        };

        if (editingChar) {
            setCharacters(characters.map(c => c.id === editingChar.id ? newChar : c));
        } else {
            setCharacters([...characters, newChar]);
        }

        if (organizations && setOrganizations) {
            const updatedOrgs = organizations.map(org => {
                const matchingAffil = newChar.affiliations.find(a => (typeof a === 'string' ? a : a.name) === org.name);
                let newKeyPeople = Array.isArray(org.keyPeople) ? [...org.keyPeople] : [];
                const namesToRemove = [newChar.name];
                if (editingChar && editingChar.name !== newChar.name) namesToRemove.push(editingChar.name);
                newKeyPeople = newKeyPeople.filter(p => !namesToRemove.includes(typeof p === 'string' ? p : p.name));
                if (matchingAffil) {
                    newKeyPeople.push({
                        name: newChar.name,
                        role: typeof matchingAffil === 'string' ? '' : matchingAffil.role
                    });
                }
                return { ...org, keyPeople: newKeyPeople };
            });
            setOrganizations(updatedOrgs);
        }
        resetForm();
    };

    const handleEdit = (char) => {
        setEditingChar(char);
        setName(char.name);
        setPortrait(char.portrait);
        setRace(char.race);
        setLevel(char.level || ''); // ★セット
        setBirthYear(char.birthYear);
        setDeathYear(char.deathYear);
        if (char.affiliations) {
            const normalized = char.affiliations.map(item => {
                if (typeof item === 'string') return { name: item, role: '' };
                return item;
            });
            setAffiliations(normalized);
        } else {
            setAffiliations([]);
        }
        setNote(char.note);
    };

    const handleDelete = (id) => {
        if (window.confirm('削除しますか？')) {
            if (editingChar && organizations && setOrganizations) {
                const updatedOrgs = organizations.map(org => {
                    let newKeyPeople = Array.isArray(org.keyPeople) ? [...org.keyPeople] : [];
                    newKeyPeople = newKeyPeople.filter(p => (typeof p === 'string' ? p : p.name) !== editingChar.name);
                    return { ...org, keyPeople: newKeyPeople };
                });
                setOrganizations(updatedOrgs);
            }
            setCharacters(characters.filter(c => c.id !== id));
            if (editingChar && editingChar.id === id) resetForm();
        }
    };

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">
            <LevelInfoModal isOpen={showLevelInfo} onClose={() => setShowLevelInfo(false)} />
           
            <SectionHeader icon={Icons.User} title="人物管理" desc="歴史上の重要人物を登録します。肖像画や関連組織を設定できます。" />

            <div className="flex gap-6 items-start flex-grow">
                {/* 左側リスト */}
                <div className="w-80 flex-shrink-0 h-[calc(100vh-320px)] min-h-[400px] bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col sticky top-4">
                    <div className="p-3 bg-gray-50 border-b font-bold text-gray-600 text-sm flex justify-between items-center">
                        登録人物一覧 <span className="bg-gray-200 px-2 rounded-full text-xs">{characters.length}</span>
                    </div>
                    <div className="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-2">
                        {characters.map(char => {
                            const raceInfo = RACES.find(r => r.label === char.race);
                            return (
                                <div key={char.id} onClick={() => handleEdit(char)} className={`p-2 rounded border cursor-pointer transition-colors flex gap-3 ${editingChar?.id === char.id ? 'bg-blue-50 border-blue-300' : 'bg-white hover:bg-gray-50'}`}>
                                    <div className="w-10 h-10 bg-gray-200 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                                        {char.portrait ? <img src={char.portrait} className="w-full h-full object-cover" /> : <Icons.User className="w-full h-full p-2 text-gray-400" />}
                                    </div>
                                    <div className="flex-grow overflow-hidden">
                                        <div className="font-bold text-sm truncate">{char.name}</div>
                                        <div className="text-xs flex items-center gap-2 mt-0.5">
                                            <span className="px-1.5 py-0.5 rounded text-[10px] text-white whitespace-nowrap" style={{backgroundColor: raceInfo?.color || '#9ca3af'}}>{char.race}</span>
                                            {char.level && <span className="text-[10px] font-mono font-bold text-gray-500">Lv.{char.level}</span>}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        <button onClick={resetForm} className="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-400 hover:border-blue-400 hover:text-blue-500 font-bold text-sm flex items-center justify-center gap-2">
                            <Icons.Plus size={16}/> 新規作成
                        </button>
                    </div>
                </div>

                {/* 右側編集フォーム */}
                <div className="flex-grow bg-white rounded-lg shadow-lg border border-gray-200 p-6">
                    <h3 className="font-bold text-lg mb-6 border-b pb-2">{editingChar ? '人物を編集' : '新規人物登録'}</h3>
                    <div className="flex flex-col gap-6">
                        
                        {/* 画像エリア */}
                        <div className="w-full flex flex-col items-center gap-2">
                            <div className="relative group cursor-pointer w-40 h-40 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 overflow-hidden flex items-center justify-center shadow-inner">
                                {portrait ? <img src={portrait} className="w-full h-full object-contain" /> : <div className="text-center p-2 text-gray-400"><Icons.User size={40} className="mx-auto mb-1"/><span className="text-[10px] font-bold">肖像画を設定</span></div>}
                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" ref={fileInputRef} onChange={handleImageUpload} />
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none text-xs">画像を変更</div>
                            </div>
                            {portrait && <button onClick={() => setPortrait(null)} className="text-xs text-red-500 hover:underline">画像を削除</button>}
                        </div>

                        {/* 入力フィールド */}
                        <div className="space-y-5">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="col-span-2">
                                    <label className="block text-xs font-bold text-gray-600 mb-1">名前</label>
                                    <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border rounded font-bold text-lg" placeholder="例: 英覇 王太郎" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-1">種族</label>
                                    <select value={race} onChange={e => setRace(e.target.value)} className="w-full p-2 border rounded bg-white">
                                        {RACES.map(r => <option key={r.label} value={r.label}>{r.label} ({r.ruby})</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-1 flex items-center gap-1">
                                        レベル (Lv) 
                                        <button onClick={() => setShowLevelInfo(true)} className="bg-gray-200 text-gray-500 rounded-full w-4 h-4 flex items-center justify-center hover:bg-blue-500 hover:text-white transition-colors" title="レベルとは？"><Icons.HelpCircle size={10}/></button>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="number" min="1" max="120" value={level} onChange={e => setLevel(e.target.value)} className="w-20 p-2 border rounded font-mono text-center" placeholder="Lv" />
                                        <input type="range" min="1" max="120" value={level || 1} onChange={e => setLevel(e.target.value)} className="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="w-1/2">
                                        <label className="block text-xs font-bold text-gray-600 mb-1">生年</label>
                                        <input type="number" value={birthYear} onChange={e => setBirthYear(e.target.value)} className="w-full p-2 border rounded" placeholder="1800" />
                                    </div>
                                    <div className="w-1/2">
                                        <label className="block text-xs font-bold text-gray-600 mb-1">没年</label>
                                        <input type="number" value={deathYear} onChange={e => setDeathYear(e.target.value)} className="w-full p-2 border rounded" placeholder="1880" />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-gray-50 p-3 rounded border border-gray-200">
                                <label className="block text-xs font-bold text-gray-600 mb-2 flex items-center gap-1"><Icons.Briefcase size={12}/> 関連組織・所属と役職</label>
                                <div className="flex flex-col sm:flex-row gap-2 mb-2">
                                    <select className="p-1.5 border rounded text-sm bg-white sm:w-40 flex-shrink-0" onChange={(e) => { if(e.target.value) setAffilInput(e.target.value); e.target.value=''; }}>
                                        <option value="">組織・国家を選択...</option>
                                        {affiliationOptions.map((opt, idx) => <option key={idx} value={opt.name}>{opt.name}</option>)}
                                    </select>
                                    <input type="text" value={affilInput} onChange={e => setAffilInput(e.target.value)} className="flex-grow p-1.5 border rounded text-sm" placeholder="組織名 (入力可)" />
                                    <input type="text" value={affilRole} onChange={e => setAffilRole(e.target.value)} onKeyDown={e => { if(e.key === 'Enter'){ e.preventDefault(); addAffiliation(); } }} className="sm:w-32 p-1.5 border rounded text-sm" placeholder="役職 (例: 団長)" />
                                    <button onClick={addAffiliation} className="bg-gray-200 px-3 py-1.5 rounded hover:bg-gray-300 text-gray-600 font-bold text-sm flex-shrink-0">+</button>
                                </div>
                                <div className="flex flex-wrap gap-1.5 min-h-[30px]">
                                    {affiliations.map((item, idx) => {
                                        const orgName = typeof item === 'string' ? item : item.name;
                                        const orgRole = typeof item === 'string' ? '' : item.role;
                                        return (
                                            <span key={idx} className="inline-flex items-center gap-1 px-2 py-1 bg-white border border-gray-300 rounded-full text-xs text-gray-700 shadow-sm">
                                                <span className="font-bold">{orgName}</span>
                                                {orgRole && <span className="text-gray-500 border-l pl-1 ml-1 border-gray-300">{orgRole}</span>}
                                                <button onClick={() => removeAffiliation(idx)} className="text-gray-400 hover:text-red-500 ml-1"><Icons.X size={12}/></button>
                                            </span>
                                        );
                                    })}
                                    {affiliations.length === 0 && <span className="text-xs text-gray-400 italic p-1">所属なし</span>}
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-600 mb-1">備考・メモ</label>
                                <textarea value={note} onChange={e => setNote(e.target.value)} className="w-full p-2 border rounded h-24 text-sm" placeholder="人物の背景や役割など..." />
                            </div>

                            <div className="flex justify-end gap-3 pt-2">
                                {editingChar && <button onClick={() => handleDelete(editingChar.id)} className="text-red-500 text-sm hover:bg-red-50 px-3 py-2 rounded mr-auto">削除</button>}
                                <button onClick={resetForm} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                <button onClick={handleSave} className="bg-blue-900 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-800 flex items-center gap-2"><Icons.Save size={18}/> 保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- OrganizationManager コンポーネント (修正版: ロゴを上部に配置) ---
const OrganizationManager = ({ setView, nations, organizations, setOrganizations, characters, setCharacters }) => {
    const [editingOrg, setEditingOrg] = useState(null);
    const [name, setName] = useState('');
    const [logo, setLogo] = useState(null);
    const [type, setType] = useState(ORG_TYPES[0].key);
    
    const [keyPeople, setKeyPeople] = useState([]);
    const [personInput, setPersonInput] = useState('');
    const [personRole, setPersonRole] = useState('');

    const [affiliationId, setAffiliationId] = useState('');
    const [activeStart, setActiveStart] = useState('');
    const [activeEnd, setActiveEnd] = useState('');
    const [note, setNote] = useState('');
    const fileInputRef = useRef(null);

    const charOptions = useMemo(() => {
        return characters.map(c => ({ id: c.id, name: c.name }));
    }, [characters]);

    const nationOptions = useMemo(() => {
        const options = [];
        nations.forEach(n => {
            options.push({ value: n.id, label: n.name, isEra: false });
            (n.eras || []).forEach((era, idx) => {
                if (era.name && era.name !== n.name) {
                    options.push({ value: `${n.id}_era_${idx}`, label: `${era.name} (${era.startYear}年～)`, isEra: true });
                }
            });
        });
        return options;
    }, [nations]);

    const resetForm = () => {
        setEditingOrg(null);
        setName('');
        setLogo(null);
        setType(ORG_TYPES[0].key);
        setKeyPeople([]);
        setPersonInput('');
        setPersonRole('');
        setAffiliationId('');
        setActiveStart('');
        setActiveEnd('');
        setNote('');
        if(fileInputRef.current) fileInputRef.current.value = '';
    };

    const handleImageUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try { const base64 = await fileToBase64(file); setLogo(base64); } 
        catch (err) { console.error(err); alert("画像の読み込みに失敗しました。"); }
    };

    const addPerson = () => {
        const text = personInput.trim();
        if (text) {
            const newItem = { name: text, role: personRole.trim() };
            const exists = keyPeople.some(p => (typeof p === 'string' ? p : p.name) === text);
            if (exists) {
                setKeyPeople(keyPeople.map(p => (typeof p === 'string' ? p : p.name) === text ? newItem : p));
            } else {
                setKeyPeople([...keyPeople, newItem]);
            }
            setPersonInput('');
            setPersonRole('');
        }
    };

    const removePerson = (idx) => {
        setKeyPeople(keyPeople.filter((_, i) => i !== idx));
    };

    const handleSave = () => {
        if (!name) return;
        const newOrg = {
            id: editingOrg ? editingOrg.id : Date.now().toString(),
            name, logo, type, 
            keyPeople,
            affiliationId, activeStart, activeEnd, note
        };

        if (editingOrg) {
            setOrganizations(organizations.map(o => o.id === editingOrg.id ? newOrg : o));
        } else {
            setOrganizations([...organizations, newOrg]);
        }

        if (characters && setCharacters) {
            const updatedChars = characters.map(char => {
                const matchingPerson = newOrg.keyPeople.find(p => (typeof p === 'string' ? p : p.name) === char.name);
                let newAffiliations = Array.isArray(char.affiliations) ? [...char.affiliations] : [];
                const namesToRemove = [newOrg.name];
                if (editingOrg && editingOrg.name !== newOrg.name) namesToRemove.push(editingOrg.name);
                newAffiliations = newAffiliations.filter(a => !namesToRemove.includes(typeof a === 'string' ? a : a.name));
                if (matchingPerson) {
                    newAffiliations.push({
                        name: newOrg.name,
                        role: typeof matchingPerson === 'string' ? '' : matchingPerson.role
                    });
                }
                return { ...char, affiliations: newAffiliations };
            });
            setCharacters(updatedChars);
        }
        resetForm();
    };

    const handleEdit = (org) => {
        setEditingOrg(org);
        setName(org.name);
        setLogo(org.logo);
        setType(org.type);
        if (org.keyPeople) {
            const normalized = org.keyPeople.map(item => {
                if (typeof item === 'string') return { name: item, role: '' };
                return item;
            });
            setKeyPeople(normalized);
        } else if (org.leader) {
            setKeyPeople([{ name: org.leader, role: '代表' }]);
        } else {
            setKeyPeople([]);
        }
        setAffiliationId(org.affiliationId);
        setActiveStart(org.activeStart);
        setActiveEnd(org.activeEnd);
        setNote(org.note);
    };

    const handleDelete = (id) => {
        if (window.confirm('削除しますか？')) {
            if (editingOrg && characters && setCharacters) {
                const updatedChars = characters.map(char => {
                    let newAffiliations = Array.isArray(char.affiliations) ? [...char.affiliations] : [];
                    newAffiliations = newAffiliations.filter(a => (typeof a === 'string' ? a : a.name) !== editingOrg.name);
                    return { ...char, affiliations: newAffiliations };
                });
                setCharacters(updatedChars);
            }
            setOrganizations(organizations.filter(o => o.id !== id));
            if (editingOrg && editingOrg.id === id) resetForm();
        }
    };

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">

            <SectionHeader icon={Icons.Briefcase} title="組織管理" desc="国家内のギルド、騎士団、企業、宗教団体などを登録します。" />

            <div className="flex gap-6 items-start flex-grow">
                {/* 左側リスト */}
                <div className="w-80 flex-shrink-0 h-[calc(100vh-320px)] min-h-[400px] bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col sticky top-4">
                    <div className="p-3 bg-gray-50 border-b font-bold text-gray-600 text-sm flex justify-between items-center">
                        登録組織一覧 <span className="bg-gray-200 px-2 rounded-full text-xs">{organizations.length}</span>
                    </div>
                    <div className="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-2">
                        {organizations.map(org => {
                            const typeInfo = ORG_TYPES.find(t => t.key === org.type);
                            return (
                                <div key={org.id} onClick={() => handleEdit(org)} className={`p-2 rounded border cursor-pointer transition-colors flex gap-3 items-center ${editingOrg?.id === org.id ? 'bg-blue-50 border-blue-300' : 'bg-white hover:bg-gray-50'}`}>
                                    <div className="w-8 h-8 bg-gray-100 rounded flex-shrink-0 border border-gray-200 flex items-center justify-center overflow-hidden">
                                        {org.logo ? <img src={org.logo} className="w-full h-full object-cover"/> : <span>{typeInfo?.icon}</span>}
                                    </div>
                                    <div className="flex-grow overflow-hidden">
                                        <div className="font-bold text-sm truncate">{org.name}</div>
                                        <div className="text-xs text-gray-500">{typeInfo?.label}</div>
                                    </div>
                                </div>
                            );
                        })}
                        <button onClick={resetForm} className="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-400 hover:border-blue-400 hover:text-blue-500 font-bold text-sm flex items-center justify-center gap-2">
                            <Icons.Plus size={16}/> 新規作成
                        </button>
                    </div>
                </div>

                {/* 右側編集フォーム (修正: 上下配置) */}
                <div className="flex-grow bg-white rounded-lg shadow-lg border border-gray-200 p-6">
                    <h3 className="font-bold text-lg mb-6 border-b pb-2">{editingOrg ? '組織を編集' : '新規組織登録'}</h3>
                    
                    {/* ★修正: flex-colのみにし、ロゴを最初に配置 */}
                    <div className="flex flex-col gap-6">
                        
                        {/* ロゴアップロードエリア (中央配置) */}
                        <div className="w-full flex flex-col items-center gap-2">
                            <div className="relative group cursor-pointer w-32 h-32 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 overflow-hidden flex items-center justify-center shadow-inner">
                                {logo ? (
                                    <img src={logo} className="w-full h-full object-contain" />
                                ) : (
                                    <div className="text-center p-2 text-gray-400">
                                        <Icons.Briefcase size={32} className="mx-auto mb-1"/>
                                        <span className="text-[10px] font-bold">ロゴ設定</span>
                                    </div>
                                )}
                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" ref={fileInputRef} onChange={handleImageUpload} />
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none text-xs">変更</div>
                            </div>
                            {logo && <button onClick={() => setLogo(null)} className="text-xs text-red-500 hover:underline">画像を削除</button>}
                        </div>

                        {/* 入力フィールドエリア */}
                        <div className="space-y-5">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="col-span-2">
                                    <label className="block text-xs font-bold text-gray-600 mb-1">組織名</label>
                                    <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border rounded font-bold" placeholder="例: 王立魔導研究所" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-1">種別</label>
                                    <select value={type} onChange={e => setType(e.target.value)} className="w-full p-2 border rounded bg-white">
                                        {ORG_TYPES.map(t => (
                                            <option key={t.key} value={t.key}>{t.icon} {t.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-1">拠点・所属国家</label>
                                    <select value={affiliationId} onChange={e => setAffiliationId(e.target.value)} className="w-full p-2 border rounded bg-white text-sm">
                                        <option value="">-- 特になし --</option>
                                        {nationOptions.map(opt => (
                                            <option key={opt.value} value={opt.value}>
                                                {opt.isEra ? '└ ' : ''}{opt.label}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div className="bg-gray-50 p-3 rounded border border-gray-200">
                                <label className="block text-xs font-bold text-gray-600 mb-2 flex items-center gap-1">
                                    <Icons.User size={12}/> 主要人物・構成員
                                </label>
                                <div className="flex flex-col sm:flex-row gap-2 mb-2">
                                    <select 
                                        className="p-1.5 border rounded text-sm bg-white sm:w-40 flex-shrink-0"
                                        onChange={(e) => { if(e.target.value) setPersonInput(e.target.value); e.target.value=''; }}
                                    >
                                        <option value="">登録人物から選択...</option>
                                        {charOptions.map(c => (
                                            <option key={c.id} value={c.name}>{c.name}</option>
                                        ))}
                                    </select>
                                    <input 
                                        type="text" 
                                        value={personInput} 
                                        onChange={e => setPersonInput(e.target.value)} 
                                        className="flex-grow p-1.5 border rounded text-sm" 
                                        placeholder="人物名 (入力可)" 
                                    />
                                    <input 
                                        type="text" 
                                        value={personRole} 
                                        onChange={e => setPersonRole(e.target.value)} 
                                        onKeyDown={e => { if(e.key === 'Enter'){ e.preventDefault(); addPerson(); } }}
                                        className="sm:w-32 p-1.5 border rounded text-sm" 
                                        placeholder="役職 (例: 代表)" 
                                    />
                                    <button onClick={addPerson} className="bg-gray-200 px-3 py-1.5 rounded hover:bg-gray-300 text-gray-600 font-bold text-sm flex-shrink-0">+</button>
                                </div>
                                <div className="flex flex-wrap gap-1.5 min-h-[30px]">
                                    {keyPeople.map((item, idx) => {
                                        const pName = typeof item === 'string' ? item : item.name;
                                        const pRole = typeof item === 'string' ? '' : item.role;
                                        return (
                                            <span key={idx} className="inline-flex items-center gap-1 px-2 py-1 bg-white border border-gray-300 rounded-full text-xs text-gray-700 shadow-sm">
                                                <span className="font-bold">{pName}</span>
                                                {pRole && <span className="text-gray-500 border-l pl-1 ml-1 border-gray-300">{pRole}</span>}
                                                <button onClick={() => removePerson(idx)} className="text-gray-400 hover:text-red-500 ml-1"><Icons.X size={12}/></button>
                                            </span>
                                        );
                                    })}
                                    {keyPeople.length === 0 && <span className="text-xs text-gray-400 italic p-1">人物なし</span>}
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <div className="w-1/2">
                                    <label className="block text-xs font-bold text-gray-600 mb-1">設立年</label>
                                    <input type="number" value={activeStart} onChange={e => setActiveStart(e.target.value)} className="w-full p-2 border rounded" placeholder="1800" />
                                </div>
                                <div className="w-1/2">
                                    <label className="block text-xs font-bold text-gray-600 mb-1">解散年</label>
                                    <input type="number" value={activeEnd} onChange={e => setActiveEnd(e.target.value)} className="w-full p-2 border rounded" placeholder="" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-600 mb-1">概要・目的</label>
                                <textarea value={note} onChange={e => setNote(e.target.value)} className="w-full p-2 border rounded h-24 text-sm" placeholder="組織の目的や活動内容..." />
                            </div>

                            <div className="flex justify-end gap-3 pt-2 border-t">
                                {editingOrg && (
                                    <button onClick={() => handleDelete(editingOrg.id)} className="text-red-500 text-sm hover:bg-red-50 px-3 py-2 rounded mr-auto">削除</button>
                                )}
                                <button onClick={resetForm} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                <button onClick={handleSave} className="bg-blue-900 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-800 flex items-center gap-2">
                                    <Icons.Save size={18}/> 保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- 1. エディタ部分 (修正版: フォント選択・ルビ入力対応) ---
const QuillEditor = ({ initialContent, onSave, nationName, nationFlag }) => {
    const editorRef = useRef(null);
    const quillInstanceRef = useRef(null);

    // カスタムフォントとルビ用のCSSスタイル定義
    const injectCustomStyles = () => {
        if (document.getElementById('quill-custom-styles')) return;
        const style = document.createElement('style');
        style.id = 'quill-custom-styles';
        style.innerHTML = `
            /* --- エディタ基本設定 --- */
            .ql-container { height: auto !important; min-height: 600px; font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; font-size: 16px; border: none !important; }
            .ql-editor { height: auto; min-height: 600px; overflow-y: visible; padding-bottom: 50px; }
            .ql-toolbar { position: sticky; top: 0; z-index: 30; background: #f9fafb; border-top: none !important; border-left: none !important; border-right: none !important; border-bottom: 1px solid #e5e7eb !important; }

            /* --- フォント定義 (表示用クラス) --- */
            .ql-font-gothic { font-family: "Yu Gothic", "YuGothic", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; }
            .ql-font-mincho { font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "HGS Mincho E", "MS PMincho", serif; }
            .ql-font-serif { font-family: "Times New Roman", "YuMincho", serif; }
            .ql-font-sans-serif { font-family: Arial, Helvetica, sans-serif; }
            .ql-font-monospace { font-family: "Courier New", Courier, monospace; }

            /* --- ツールバーのプルダウン表示名設定 --- */
            /* 明朝体 */
            .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="mincho"]::before,
            .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="mincho"]::before { content: "明朝体"; font-family: "Yu Mincho", serif; }
            /* ゴシック体 */
            .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="gothic"]::before,
            .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="gothic"]::before { content: "ゴシック体"; font-family: "Yu Gothic", sans-serif; }
            /* デフォルト(未選択) */
            .ql-snow .ql-picker.ql-font .ql-picker-label:not([data-value])::before,
            .ql-snow .ql-picker.ql-font .ql-picker-item:not([data-value])::before { content: "標準"; }
            /* その他 */
            .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="serif"]::before,
            .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="serif"]::before { content: "Serif (欧文)"; font-family: serif; }
            .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="sans-serif"]::before,
            .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="sans-serif"]::before { content: "Sans Serif (欧文)"; font-family: sans-serif; }
            .ql-snow .ql-picker.ql-font .ql-picker-label[data-value="monospace"]::before,
            .ql-snow .ql-picker.ql-font .ql-picker-item[data-value="monospace"]::before { content: "等幅"; font-family: monospace; }
        `;
        document.head.appendChild(style);
    };

    useEffect(() => {
        if (!editorRef.current) return;
        editorRef.current.innerHTML = ''; 

        // スタイル注入
        injectCustomStyles();
        
        if (window.Quill) {
            // フォントのホワイトリスト登録
            const Font = window.Quill.import('formats/font');
            Font.whitelist = ['gothic', 'mincho', 'serif', 'sans-serif', 'monospace'];
            window.Quill.register(Font, true);

            const quill = new window.Quill(editorRef.current, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        // フォント選択を追加
                        [{ 'font': Font.whitelist }],
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'blockquote', 'code-block'],
                        ['clean']
                    ]
                },
                placeholder: '詳細な設定を記述します。\n\n【ルビの振り方】\n選択して「亜/あ」ボタン、または [漢字|かんじ] で記述。\n\n【フォント変更】\nツールバー左端のプルダウンから明朝体などを選択可能。'
            });

            if (initialContent) {
                quill.clipboard.dangerouslyPasteHTML(initialContent);
            }
            quillInstanceRef.current = quill;
        }
    }, []);

    const insertRuby = () => {
        const quill = quillInstanceRef.current;
        if (!quill) return;

        const range = quill.getSelection();
        if (range) {
            if (range.length > 0) {
                const text = quill.getText(range.index, range.length);
                const reading = prompt(`「${text}」のルビを入力してください:`);
                if (reading) {
                    const rubyText = `[${text}|${reading}]`;
                    quill.deleteText(range.index, range.length);
                    quill.insertText(range.index, rubyText);
                    quill.setSelection(range.index + rubyText.length);
                }
            } else {
                const text = prompt("ルビを振りたい文字(漢字)を入力してください:");
                if (!text) return;
                const reading = prompt(`「${text}」のルビを入力してください:`);
                if (reading) {
                    const rubyText = `[${text}|${reading}]`;
                    quill.insertText(range.index, rubyText);
                    quill.setSelection(range.index + rubyText.length);
                }
            }
        } else {
            alert('エディタ内をクリックしてからボタンを押してください。');
        }
    };

    const handleSaveClick = () => {
        if (quillInstanceRef.current) {
            onSave(quillInstanceRef.current.root.innerHTML);
        }
    };

    return (
        <div className="w-full bg-white rounded-lg shadow-lg border border-gray-200 overflow-visible relative">
             <div className="p-3 border-b bg-gray-50 flex justify-between items-center z-40 relative">
                <div className="flex items-center gap-2">
                    {nationFlag && <img src={nationFlag} className="w-8 h-5 object-cover border border-gray-300" />}
                    <span className="font-black text-lg text-gray-800 hidden sm:inline">{nationName}</span>
                    <span className="text-xs text-gray-500 ml-2">の概要編集</span>
                </div>
                <div className="flex items-center gap-3">
                    <button onClick={insertRuby} className="bg-white hover:bg-gray-100 text-gray-700 border border-gray-300 px-3 py-1.5 rounded shadow-sm text-xs font-bold flex items-center gap-1 transition-colors" title="選択した文字にルビを振ります">
                        <span className="text-[10px] bg-gray-200 px-1 rounded text-gray-500">亜/あ</span> ルビ
                    </button>
                    <button onClick={handleSaveClick} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded shadow text-sm font-bold flex items-center gap-2 transition-colors">
                        <Icons.Save size={16} /> 保存
                    </button>
                </div>
            </div>
            <div className="bg-white relative">
                <div ref={editorRef}></div>
            </div>
        </div>
    );
};

// --- 権力構造図ビュー (修正版: パネル開閉機能付き) ---
const PowerStructureView = ({ setView, nations, setNations, organizations, characters }) => {
    // 選択中の国ID
    const [targetNationId, setTargetNationId] = useState(nations.length > 0 ? nations[0].id : '');
    
    // --- パネル開閉用ステート (追加) ---
    const [isPanelOpen, setIsPanelOpen] = useState(true);

    // --- ビューポート操作用ステート ---
    const [zoom, setZoom] = useState(1.0);
    const [pan, setPan] = useState({ x: 0, y: 0 });
    const [isDragging, setIsDragging] = useState(false);
    const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

    // ピンチズーム用ステート
    const [isPinching, setIsPinching] = useState(false);
    const [pinchStartDist, setPinchStartDist] = useState(0);
    const [pinchStartZoom, setPinchStartZoom] = useState(1.0);

    const containerRef = useRef(null);
    const targetNation = nations.find(n => n.id === targetNationId);

    // データ構造の正規化
    const structure = useMemo(() => {
        let raw = targetNation?.powerStructure;
        if (!raw) {
            return [
                { id: 'legis', name: '立法府', title: '議会', type: 'root', children: [] },
                { id: 'exec', name: '行政府', title: '内閣/大統領府', type: 'root', children: [] },
                { id: 'judic', name: '司法府', title: '最高裁判所', type: 'root', children: [] }
            ];
        }
        return Array.isArray(raw) ? raw : [raw];
    }, [targetNation]);

    const updateStructure = (newStructure) => {
        const newNations = nations.map(n => n.id === targetNationId ? { ...n, powerStructure: newStructure } : n);
        setNations(newNations);
    };

    // 再帰探索・更新用関数
    const findNode = (nodes, id) => {
        for (let node of nodes) {
            if (node.id === id) return node;
            if (node.children) {
                const found = findNode(node.children, id);
                if (found) return found;
            }
        }
        return null;
    };
    
    const updateNodeField = (id, field, value) => {
        const newRoots = JSON.parse(JSON.stringify(structure));
        const node = findNode(newRoots, id);
        if (node) { node[field] = value; updateStructure(newRoots); }
    };

    const addChild = (parentId) => {
        const newRoots = JSON.parse(JSON.stringify(structure));
        const parent = findNode(newRoots, parentId);
        if (parent) {
            parent.isCollapsed = false; 
            parent.children.push({ id: 'u-' + Math.random().toString(36).substr(2, 9), name: '新規役職', title: '', type: 'sub', linkType: '', linkId: '', children: [] });
            updateStructure(newRoots);
        }
    };

    const addRootTree = () => {
        const newRoots = JSON.parse(JSON.stringify(structure));
        newRoots.push({ id: 'root-' + Math.random().toString(36).substr(2, 9), name: '新規独立組織', title: '権力機関', type: 'root', children: [] });
        updateStructure(newRoots);
    };

    const deleteNode = (id) => {
        if (!window.confirm("削除しますか？配下の組織も消えます。")) return;
        let newRoots = JSON.parse(JSON.stringify(structure));
        if (newRoots.some(r => r.id === id)) {
            if (newRoots.length <= 1) { alert("最後の1つは削除できません"); return; }
            newRoots = newRoots.filter(r => r.id !== id);
        } else {
            const removeRecursive = (nodes) => {
                for (let node of nodes) {
                    if (node.children) {
                        node.children = node.children.filter(c => c.id !== id);
                        removeRecursive(node.children);
                    }
                }
            };
            removeRecursive(newRoots);
        }
        updateStructure(newRoots);
    };

    // --- 操作ロジック ---

    const handleStartDrag = (clientX, clientY, target) => {
        if (target.closest('.editor-sidebar') || target.closest('.toggle-btn') || target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'BUTTON') return;
        setIsDragging(true);
        setDragStart({ x: clientX - pan.x, y: clientY - pan.y });
    };

    const handleDragMove = (clientX, clientY) => {
        if (!isDragging) return;
        setPan({ x: clientX - dragStart.x, y: clientY - dragStart.y });
    };

    const onMouseDown = (e) => {
        handleStartDrag(e.clientX, e.clientY, e.target);
        if (!e.target.closest('.editor-sidebar') && !e.target.closest('.toggle-btn') && !['INPUT','SELECT','BUTTON'].includes(e.target.tagName)) {
            e.currentTarget.style.cursor = 'grabbing';
        }
    };
    const onMouseMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        handleDragMove(e.clientX, e.clientY);
    };
    const onMouseUp = (e) => {
        setIsDragging(false);
        e.currentTarget.style.cursor = 'grab';
    };
    const onWheel = (e) => {
        if (e.target.closest('.editor-sidebar')) return;
        const scaleAmount = -e.deltaY * 0.001;
        setZoom(prev => Math.min(Math.max(0.1, prev + scaleAmount), 3.0));
    };

    const getTouchDist = (touches) => {
        return Math.hypot(
            touches[0].clientX - touches[1].clientX,
            touches[0].clientY - touches[1].clientY
        );
    };

    const onTouchStart = (e) => {
        if (e.target.closest('.editor-sidebar') || e.target.closest('.toggle-btn') || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;
        if (e.touches.length === 2) {
            e.preventDefault(); setIsPinching(true); setIsDragging(false);
            const dist = getTouchDist(e.touches); setPinchStartDist(dist); setPinchStartZoom(zoom);
        } else if (e.touches.length === 1) {
            const touch = e.touches[0]; handleStartDrag(touch.clientX, touch.clientY, e.target);
        }
    };

    const onTouchMove = (e) => {
        if (isPinching && e.touches.length === 2) {
            e.preventDefault(); const dist = getTouchDist(e.touches);
            if (pinchStartDist > 0) { const scale = dist / pinchStartDist; setZoom(Math.min(Math.max(0.1, pinchStartZoom * scale), 3.0)); }
        } else if (isDragging && e.touches.length === 1) {
            const touch = e.touches[0]; handleDragMove(touch.clientX, touch.clientY);
        }
    };

    const onTouchEnd = () => { setIsDragging(false); setIsPinching(false); };

    // CSS定義
    const treeCss = `
        .tf-tree { display: flex; text-align: center; }
        .tf-tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; }
        .tf-tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; }
        .tf-tree li::before, .tf-tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #999; width: 50%; height: 20px; }
        .tf-tree li::after { right: auto; left: 50%; border-left: 1px solid #999; }
        .tf-tree li:only-child::after, .tf-tree li:only-child::before { display: none; }
        .tf-tree li:only-child { padding-top: 0; }
        .tf-tree li:first-child::before { border: 0 none; }
        .tf-tree li:last-child::after { border: 0 none; }
        .tf-tree li:last-child::before { border-right: 1px solid #999; border-radius: 0 5px 0 0; }
        .tf-tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tf-tree ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #999; width: 0; height: 20px; }
        .node-card { display: flex; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 200px; position: relative; z-index: 10; text-align: left; }
        .node-card:hover { border-color: #60a5fa; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2); z-index: 20; }
    `;

    const renderTree = (node) => {
        let linkedData = null;
        if (node.linkType === 'org' && node.linkId) {
            linkedData = organizations.find(o => o.id === node.linkId);
        } else if (node.linkType === 'char' && node.linkId) {
            linkedData = characters.find(c => c.id === node.linkId);
        }
        const imageSrc = linkedData ? (node.linkType === 'org' ? linkedData.logo : linkedData.portrait) : null;
        const DefaultIcon = node.linkType === 'org' ? Icons.Briefcase : (node.linkType === 'char' ? Icons.User : Icons.User);
        
        const hasChildren = node.children && node.children.length > 0;
        const isCollapsed = !!node.isCollapsed;

        return (
            <li key={node.id}>
                <div className="node-card group !p-0 overflow-visible">
                    <div className="w-16 h-16 bg-gray-100 flex-shrink-0 border-r border-gray-200 flex items-center justify-center overflow-hidden relative rounded-l">
                        {imageSrc ? <img src={imageSrc} className="w-full h-full object-cover" /> : <div className="text-gray-300">{node.linkType ? <DefaultIcon size={24}/> : <Icons.User size={24}/>}</div>}
                        {node.linkType && <div className={`absolute top-0 left-0 p-0.5 text-white text-[8px] ${node.linkType === 'org' ? 'bg-blue-500' : 'bg-green-500'}`}>{node.linkType === 'org' ? <Icons.Briefcase size={8}/> : <Icons.User size={8}/>}</div>}
                    </div>
                    <div className="flex-grow p-2 flex flex-col justify-center w-36 bg-white rounded-r">
                        <input type="text" value={node.name} onChange={e => updateNodeField(node.id, 'name', e.target.value)} className="w-full font-bold border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none text-sm bg-transparent mb-0.5 px-1" placeholder="役職名" />
                        <input type="text" value={node.title} onChange={e => updateNodeField(node.id, 'title', e.target.value)} className="w-full text-[10px] text-gray-500 outline-none bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 px-1" placeholder="権限・役割" />
                        {linkedData ? ( <div className="text-[9px] font-bold text-blue-800 truncate bg-blue-50 px-1 rounded mt-1 mx-1">{linkedData.name}</div> ) : ( <div className="text-[9px] text-gray-300 italic mt-1 mx-1">未設定</div> )}
                    </div>
                    
                    {hasChildren && (
                        <button 
                            onClick={(e) => { e.stopPropagation(); updateNodeField(node.id, 'isCollapsed', !isCollapsed); }}
                            className="absolute -bottom-3 left-1/2 transform -translate-x-1/2 w-6 h-6 bg-white border border-gray-400 hover:border-blue-500 text-gray-500 hover:text-blue-600 rounded-full flex items-center justify-center z-40 shadow-sm transition-colors"
                            title={isCollapsed ? "展開" : "折りたたむ"}
                        >
                            {isCollapsed ? <Icons.Plus size={12} strokeWidth={3} /> : <Icons.Minus size={12} strokeWidth={3} />}
                        </button>
                    )}

                    <div className="absolute top-full left-0 w-full bg-white border border-t-0 border-gray-300 rounded-b shadow-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none group-hover:pointer-events-auto z-30 flex flex-col gap-2">
                        <div className="flex gap-1">
                            <select value={node.linkType || ''} onChange={e => updateNodeField(node.id, 'linkType', e.target.value)} className="text-[9px] border rounded w-1/3 p-0.5 bg-gray-50"> <option value="">紐付なし</option><option value="org">組織</option><option value="char">人物</option> </select>
                            {node.linkType === 'org' && ( <select value={node.linkId || ''} onChange={e => updateNodeField(node.id, 'linkId', e.target.value)} className="text-[9px] border rounded w-2/3 p-0.5 bg-gray-50"> <option value="">--選択--</option>{organizations.map(o => <option key={o.id} value={o.id}>{o.name}</option>)} </select> )}
                            {node.linkType === 'char' && ( <select value={node.linkId || ''} onChange={e => updateNodeField(node.id, 'linkId', e.target.value)} className="text-[9px] border rounded w-2/3 p-0.5 bg-gray-50"> <option value="">--選択--</option>{characters.map(c => <option key={c.id} value={c.id}>{c.name}</option>)} </select> )}
                        </div>
                        <div className="flex gap-2 justify-between">
                            <button onClick={() => deleteNode(node.id)} className="bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded hover:bg-red-200 flex-1">削除</button>
                            <button onClick={() => addChild(node.id)} className="bg-blue-100 text-blue-600 text-[10px] px-2 py-1 rounded hover:bg-blue-200 flex-1 font-bold">＋下部</button>
                        </div>
                    </div>
                </div>
                {!isCollapsed && hasChildren && <ul>{node.children.map(child => renderTree(child))}</ul>}
            </li>
        );
    };

    return (
        <div className="h-full flex flex-col bg-[#f4f4f9] overflow-hidden relative touch-none">
            <style>{treeCss}</style>
            
            {/* ★ パネル開閉ボタン (興亡系統図と同様に配置) */}
            <button 
                onClick={() => setIsPanelOpen(!isPanelOpen)} 
                className="toggle-btn absolute top-4 left-4 z-[60] bg-white p-2 rounded-lg shadow-md border border-gray-200 text-gray-600 hover:bg-gray-50"
                title={isPanelOpen ? "パネルを閉じる" : "設定を開く"}
            >
                {isPanelOpen ? <Icons.X size={20}/> : <Icons.Settings size={20}/>}
            </button>

            {/* ★ 左上のコントロールパネル (折りたたみ対応) */}
            <div className={`editor-sidebar absolute top-16 left-4 md:top-4 md:left-4 z-50 bg-white/95 backdrop-blur p-4 rounded-lg shadow-xl border border-gray-200 w-64 max-h-[80vh] overflow-y-auto custom-scrollbar transition-all duration-300 origin-top-left ${isPanelOpen ? 'scale-100 opacity-100' : 'scale-0 opacity-0 pointer-events-none'}`}>
                
                {/* 閉じるボタンがあるため、ヘッダーのマージンを調整 (ボタンと重ならないように) */}
                <div className="flex items-center gap-2 mb-4 pb-2 border-b pl-10 md:pl-0">
                    <h2 className="font-bold text-sm text-gray-700 flex items-center gap-2"><Icons.Structure size={16}/> 権力構造図エディタ</h2>
                </div>

                <label className="block text-xs font-bold text-gray-500 mb-1">編集する国家</label>
                <select value={targetNationId} onChange={e => setTargetNationId(e.target.value)} className="w-full p-2 border rounded text-sm mb-4 font-bold">
                    {nations.map(n => <option key={n.id} value={n.id}>{n.name}</option>)}
                </select>
                <div className="flex items-center gap-2 bg-gray-100 p-2 rounded mb-2">
                    <button onClick={() => setZoom(z => Math.max(0.1, z - 0.1))} className="w-6 h-6 bg-white rounded border text-sm font-bold">-</button>
                    <span className="flex-grow text-center text-xs font-mono">{Math.round(zoom * 100)}%</span>
                    <button onClick={() => setZoom(z => Math.min(3.0, z + 0.1))} className="w-6 h-6 bg-white rounded border text-sm font-bold">+</button>
                </div>
                <button onClick={addRootTree} className="w-full mt-2 py-2 bg-blue-600 text-white rounded font-bold text-xs hover:bg-blue-700 shadow flex items-center justify-center gap-2">
                    <Icons.GitMerge size={14}/> 独立組織(トップ)を追加
                </button>
                <div className="text-[10px] text-gray-400 leading-tight mt-3">
                    <p>・ドラッグで移動、ホイール/ピンチで拡大</p>
                    <p>・[+/-]でツリー開閉</p>
                    <p>・カードホバーで編集メニュー</p>
                </div>
            </div>
            
            <div 
                ref={containerRef}
                className="flex-grow overflow-hidden cursor-grab active:cursor-grabbing relative"
                onMouseDown={onMouseDown}
                onMouseMove={onMouseMove}
                onMouseUp={onMouseUp}
                onMouseLeave={onMouseUp}
                onTouchStart={onTouchStart}
                onTouchMove={onTouchMove}
                onTouchEnd={onTouchEnd}
                onWheel={onWheel}
                style={{ backgroundImage: 'radial-gradient(#ccc 1px, transparent 1px)', backgroundSize: '20px 20px' }}
            >
                <div 
                    className="absolute top-0 left-0 origin-top-left transition-transform duration-75 ease-out flex gap-16 items-start"
                    style={{ 
                        transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`,
                        minWidth: '100%', minHeight: '100%', padding: '100px'
                    }}
                >
                    {structure.map(rootNode => (
                        <div key={rootNode.id} className="tf-tree">
                            <ul>{renderTree(rootNode)}</ul>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- StatsEditView コンポーネント (修正版v3: プレビュー切り替え機能付き) ---
const StatsEditView = ({ setView, nations, stats, setStats }) => {
    const [mode, setMode] = useState('nation');
    const [targetYear, setTargetYear] = useState(DEFAULT_YEAR);
    const [yearInputData, setYearInputData] = useState({}); 
    
    const [targetNationId, setTargetNationId] = useState(nations[0]?.id || '');
    const [nationInputData, setNationInputData] = useState([]); 
    
    // 自動補完用ステート
    const [fillStartYear, setFillStartYear] = useState('');
    const [fillEndYear, setFillEndYear] = useState('');
    const [fillStartPop, setFillStartPop] = useState('');
    const [fillEndPop, setFillEndPop] = useState('');
    const [fillStartGdp, setFillStartGdp] = useState('');
    const [fillEndGdp, setFillEndGdp] = useState('');
    const [curveType, setCurveType] = useState('linear');

    // 中間点（Midpoints）用ステート
    const [midPoints, setMidPoints] = useState([]);

    // ★追加: プレビュー表示項目切り替え用 ('population' or 'gdp')
    const [previewMetric, setPreviewMetric] = useState('population');

    // 初期データ読み込み
    useEffect(() => {
        if (mode === 'year') {
            const currentStats = stats.filter(s => s.year === parseInt(targetYear));
            const map = {};
            currentStats.forEach(s => { map[s.nationId] = { population: s.population, gdp: s.gdp }; });
            setYearInputData(map);
        } else {
            if (!targetNationId) return;
            const currentStats = stats.filter(s => s.nationId === targetNationId).sort((a, b) => a.year - b.year);
            const formatted = currentStats.map(s => ({ id: s.id, year: s.year, population: s.population, gdp: s.gdp }));
            setNationInputData(formatted);
            
            if (currentStats.length > 0) {
                const first = currentStats[0];
                const last = currentStats[currentStats.length - 1];
                setFillStartYear(first.year); setFillStartPop(first.population); setFillStartGdp(first.gdp);
                setFillEndYear(last.year); setFillEndPop(last.population); setFillEndGdp(last.gdp);
            }
        }
    }, [mode, targetYear, targetNationId, stats]);

    const lookupAndSetData = (yearStr, setPop, setGdp) => {
        const y = parseInt(yearStr);
        if (isNaN(y)) return;
        const existing = nationInputData.find(d => d.year === y);
        if (existing) {
            if (existing.population) setPop(existing.population);
            if (existing.gdp) setGdp(existing.gdp);
        }
    };

    const handleStartYearChange = (val) => { setFillStartYear(val); lookupAndSetData(val, setFillStartPop, setFillStartGdp); };
    const handleEndYearChange = (val) => { setFillEndYear(val); lookupAndSetData(val, setFillEndPop, setFillEndGdp); };
    
    const addMidPoint = () => { setMidPoints([...midPoints, { id: Date.now(), year: '', population: '', gdp: '' }]); };
    const removeMidPoint = (idx) => { setMidPoints(midPoints.filter((_, i) => i !== idx)); };
    const updateMidPoint = (idx, field, val) => {
        const newMids = [...midPoints];
        newMids[idx][field] = val;
        if (field === 'year') {
            lookupAndSetData(val, (p) => { newMids[idx].population = p; setMidPoints([...newMids]); }, (g) => { newMids[idx].gdp = g; setMidPoints([...newMids]); });
        }
        setMidPoints(newMids);
    };

    const handleYearInputChange = (nationId, field, value) => { setYearInputData(prev => ({ ...prev, [nationId]: { ...prev[nationId], [field]: value } })); };
    
    const saveYearData = () => {
        const otherStats = stats.filter(s => s.year !== parseInt(targetYear));
        const newStats = [...otherStats];
        Object.entries(yearInputData).forEach(([nationId, data]) => {
            if (data && (data.population || data.gdp)) {
                newStats.push({ id: `stats_${targetYear}_${nationId}`, year: parseInt(targetYear), nationId, population: parseFloat(data.population) || 0, gdp: parseFloat(data.gdp) || 0 });
            }
        });
        setStats(newStats);
        alert(`${targetYear}年のデータを保存しました。`);
    };

    const handleNationInputChange = (index, field, value) => {
        const newData = [...nationInputData];
        newData[index] = { ...newData[index], [field]: value };
        setNationInputData(newData);
    };

    const addNationYearRow = () => {
        const lastYear = nationInputData.length > 0 ? nationInputData[nationInputData.length - 1].year : DEFAULT_YEAR;
        setNationInputData([...nationInputData, { year: lastYear + 1, population: '', gdp: '' }]);
    };

    const removeNationYearRow = (index) => { setNationInputData(nationInputData.filter((_, i) => i !== index)); };

    const executeAutoFill = () => {
        const points = [
            { year: parseInt(fillStartYear), pop: parseFloat(fillStartPop), gdp: parseFloat(fillStartGdp) },
            ...midPoints.map(m => ({ year: parseInt(m.year), pop: parseFloat(m.population), gdp: parseFloat(m.gdp) })),
            { year: parseInt(fillEndYear), pop: parseFloat(fillEndPop), gdp: parseFloat(fillEndGdp) }
        ].filter(p => !isNaN(p.year)).sort((a, b) => a.year - b.year);

        if (points.length < 2) { alert("開始年と終了年を正しく設定してください"); return; }

        const easing = EASING_FUNCTIONS[curveType].func;
        const existingMap = {};
        nationInputData.forEach(d => existingMap[d.year] = d);

        for (let i = 0; i < points.length - 1; i++) {
            const p1 = points[i]; const p2 = points[i+1];
            if (p1.year >= p2.year) continue;

            const startY = p1.year; const endY = p2.year;
            const startPop = p1.pop || 0; const endPop = p2.pop || 0;
            const startGdp = p1.gdp || 0; const endGdp = p2.gdp || 0;

            for (let y = startY; y <= endY; y++) {
                const t = (y - startY) / (endY - startY);
                const factor = easing(t);
                const pop = Math.round(startPop + (endPop - startPop) * factor);
                const gdp = Math.round(startGdp + (endGdp - startGdp) * factor);
                existingMap[y] = { year: y, population: pop, gdp: gdp, id: existingMap[y]?.id };
            }
        }
        const result = Object.values(existingMap).sort((a, b) => a.year - b.year);
        setNationInputData(result);
    };

    const saveNationData = () => {
        const otherStats = stats.filter(s => s.nationId !== targetNationId);
        const newStats = [...otherStats];
        nationInputData.forEach(d => {
            if (d.year && (d.population || d.gdp)) {
                newStats.push({ id: `stats_${d.year}_${targetNationId}`, year: parseInt(d.year), nationId: targetNationId, population: parseFloat(d.population) || 0, gdp: parseFloat(d.gdp) || 0 });
            }
        });
        setStats(newStats);
        alert(`データを保存しました。`);
    };

    const chartData = nationInputData.filter(d => d.year && (d.population || d.gdp)).sort((a,b)=>a.year-b.year);

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">
            <SectionHeader icon={Icons.BarChart2} title="統計データ管理" desc="各国の人口・GDPデータを管理します。自動補完機能を使うと、始点と終点を入力するだけで間のデータを一括生成できます。" />
            
            <div className="bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col flex-grow min-h-[600px]">
                <div className="flex border-b border-gray-200 bg-gray-50 flex-shrink-0">
                    <button onClick={() => setMode('nation')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${mode === 'nation' ? 'bg-white border-t-4 border-green-500 text-green-800' : 'text-gray-500 hover:bg-gray-100'}`}>
                        <Icons.TrendingUp size={16}/> 時系列で記録 (国単位・推奨)
                    </button>
                    <button onClick={() => setMode('year')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${mode === 'year' ? 'bg-white border-t-4 border-blue-500 text-blue-800' : 'text-gray-500 hover:bg-gray-100'}`}>
                        <Icons.Calendar size={16}/> 定点観測 (年単位)
                    </button>
                </div>

                {mode === 'nation' && (
                    <div className="flex flex-col lg:flex-row h-full overflow-hidden">
                        <div className="w-full lg:w-1/3 bg-gray-50 border-b lg:border-b-0 lg:border-r border-gray-200 flex flex-col overflow-y-auto custom-scrollbar">
                            <div className="p-4 border-b border-gray-200 bg-white sticky top-0 z-10">
                                <label className="block text-xs font-bold text-gray-500 mb-1">編集対象の国家</label>
                                <select value={targetNationId} onChange={e => setTargetNationId(e.target.value)} className="w-full p-2 border rounded font-bold mb-2 bg-gray-50 focus:bg-white transition-colors">
                                    {nations.map(n => <option key={n.id} value={n.id}>{n.name}</option>)}
                                </select>
                                <button onClick={saveNationData} className="w-full bg-green-700 text-white py-2 rounded font-bold shadow hover:bg-green-600 flex items-center justify-center gap-2 transition-transform active:scale-95">
                                    <Icons.Save size={18}/> データを保存
                                </button>
                            </div>

                            <div className="p-4 space-y-4">
                                <div className="bg-white p-4 rounded-lg border border-green-200 shadow-sm relative">
                                    <h4 className="font-bold text-sm text-green-800 mb-3 flex items-center gap-2"><Icons.Zap size={16}/> 自動補完 (Auto Fill)</h4>
                                    
                                    <div className="mb-4 bg-green-50 p-2 rounded border border-green-100">
                                        <label className="text-[10px] font-bold text-green-800 mb-1 block">始点 (Start)</label>
                                        <div className="flex gap-2 mb-1">
                                            <input type="number" placeholder="年" value={fillStartYear} onChange={e=>handleStartYearChange(e.target.value)} className="w-1/3 p-1 border rounded text-center text-sm font-bold" />
                                            <input type="number" placeholder="人口" value={fillStartPop} onChange={e=>setFillStartPop(e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm" />
                                            <input type="number" placeholder="GDP" value={fillStartGdp} onChange={e=>setFillStartGdp(e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm" />
                                        </div>
                                    </div>

                                    {midPoints.map((mp, idx) => (
                                        <div key={mp.id} className="mb-2 pl-4 border-l-2 border-dashed border-gray-300 relative">
                                            <div className="absolute -left-[7px] top-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-gray-300"></div>
                                            <div className="flex gap-2 items-center">
                                                <input type="number" placeholder="中間年" value={mp.year} onChange={e=>updateMidPoint(idx, 'year', e.target.value)} className="w-1/3 p-1 border rounded text-center text-sm bg-gray-50" />
                                                <input type="number" placeholder="人口" value={mp.population} onChange={e=>updateMidPoint(idx, 'population', e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm bg-gray-50" />
                                                <input type="number" placeholder="GDP" value={mp.gdp} onChange={e=>updateMidPoint(idx, 'gdp', e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm bg-gray-50" />
                                                <button onClick={() => removeMidPoint(idx)} className="text-red-400 hover:text-red-600"><Icons.X size={14}/></button>
                                            </div>
                                        </div>
                                    ))}

                                    <div className="text-center mb-4">
                                        <button onClick={addMidPoint} className="text-xs text-blue-600 hover:text-blue-800 hover:underline flex items-center justify-center gap-1 mx-auto">
                                            <Icons.Plus size={12}/> 中間点(経由地)を追加
                                        </button>
                                    </div>

                                    <div className="mb-4 bg-blue-50 p-2 rounded border border-blue-100">
                                        <label className="text-[10px] font-bold text-blue-800 mb-1 block">終点 (End)</label>
                                        <div className="flex gap-2 mb-1">
                                            <input type="number" placeholder="年" value={fillEndYear} onChange={e=>handleEndYearChange(e.target.value)} className="w-1/3 p-1 border rounded text-center text-sm font-bold" />
                                            <input type="number" placeholder="人口" value={fillEndPop} onChange={e=>setFillEndPop(e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm" />
                                            <input type="number" placeholder="GDP" value={fillEndGdp} onChange={e=>setFillEndGdp(e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm" />
                                        </div>
                                    </div>

                                    <div className="mb-4">
                                        <label className="text-[10px] font-bold text-gray-500 mb-1 block">変化カーブ (区間ごとに適用)</label>
                                        <select value={curveType} onChange={e=>setCurveType(e.target.value)} className="w-full p-1.5 border rounded text-sm">
                                            {Object.entries(EASING_FUNCTIONS).map(([key, func]) => (
                                                <option key={key} value={key}>{func.name}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <button onClick={executeAutoFill} className="w-full py-2 bg-green-600 text-white rounded font-bold text-xs hover:bg-green-700 shadow-sm flex items-center justify-center gap-2">
                                        <Icons.RefreshCw size={14}/> 生成 / 上書き
                                    </button>
                                </div>

                                {chartData.length > 1 && (
                                    <div className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                        <div className="flex justify-between items-center mb-2">
                                            <h4 className="font-bold text-xs text-gray-500">入力データプレビュー</h4>
                                            {/* ★プレビュー切り替えボタン */}
                                            <div className="flex bg-gray-100 rounded p-0.5">
                                                <button onClick={() => setPreviewMetric('population')} className={`px-2 py-0.5 text-[10px] font-bold rounded transition-colors ${previewMetric === 'population' ? 'bg-white shadow text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}>人口</button>
                                                <button onClick={() => setPreviewMetric('gdp')} className={`px-2 py-0.5 text-[10px] font-bold rounded transition-colors ${previewMetric === 'gdp' ? 'bg-white shadow text-green-600' : 'text-gray-400 hover:text-gray-600'}`}>GDP</button>
                                            </div>
                                        </div>
                                        <div className="h-24 flex items-end gap-0.5 border-b border-gray-200 pb-1">
                                            {(() => {
                                                // 選択された指標に基づいて最大値を計算
                                                const getValue = (d) => parseFloat(d[previewMetric]) || 0;
                                                const maxValue = Math.max(...chartData.map(getValue));
                                                
                                                return chartData.map((d, i) => {
                                                    const val = getValue(d);
                                                    const h = maxValue ? (val / maxValue) * 100 : 0;
                                                    // 色の切り替え
                                                    const barColor = previewMetric === 'population' ? 'bg-blue-400 hover:bg-blue-600' : 'bg-green-400 hover:bg-green-600';
                                                    const unit = previewMetric === 'population' ? '人' : '円';

                                                    return (
                                                        <div key={i} className={`flex-1 ${barColor} transition-all rounded-t-sm relative group`} style={{height: `${h}%`}}>
                                                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 bg-black text-white text-[9px] px-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none mb-1 whitespace-nowrap z-10 shadow-lg">
                                                                {d.year}年: {formatJapaneseNumber(val, unit, true)}
                                                            </div>
                                                        </div>
                                                    );
                                                });
                                            })()}
                                        </div>
                                        <div className="flex justify-between text-[9px] text-gray-400 mt-1">
                                            <span>{chartData[0].year}</span>
                                            <span>{chartData[chartData.length-1].year}</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex-grow flex flex-col h-full overflow-hidden bg-white">
                            <div className="p-2 bg-gray-100 border-b border-gray-200 flex justify-between items-center text-xs font-bold text-gray-500">
                                <span className="pl-2">データリスト ({nationInputData.length}件)</span>
                                <div className="flex gap-2">
                                    <button onClick={() => setNationInputData([])} className="px-2 py-1 hover:bg-red-100 text-red-500 rounded">全クリア</button>
                                    <button onClick={() => {
                                        const sorted = [...nationInputData].sort((a,b)=>a.year-b.year);
                                        setNationInputData(sorted);
                                    }} className="px-2 py-1 hover:bg-gray-200 rounded">年ソート</button>
                                </div>
                            </div>
                            <div className="flex-grow overflow-y-auto custom-scrollbar p-0">
                                <table className="w-full text-sm text-left whitespace-nowrap">
                                    <thead className="text-xs text-gray-500 bg-gray-50 sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th className="px-2 py-2 text-center w-20">年</th>
                                            <th className="px-2 py-2 text-right">人口</th>
                                            <th className="px-2 py-2 text-right">GDP</th>
                                            <th className="px-1 py-2 w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {nationInputData.map((d, idx) => (
                                            <tr key={idx} className="group hover:bg-blue-50 transition-colors">
                                                <td className="p-1">
                                                    <input type="number" value={d.year} onChange={e => handleNationInputChange(idx, 'year', e.target.value)} className="w-full p-1.5 border border-transparent group-hover:bg-white group-hover:border-gray-300 rounded text-center font-bold bg-transparent" placeholder="年" />
                                                </td>
                                                <td className="p-1">
                                                    <input type="number" value={d.population} onChange={e => handleNationInputChange(idx, 'population', e.target.value)} className="w-full p-1.5 border border-transparent group-hover:bg-white group-hover:border-gray-300 rounded text-right font-mono bg-transparent text-blue-800" placeholder="-" />
                                                </td>
                                                <td className="p-1">
                                                    <input type="number" value={d.gdp} onChange={e => handleNationInputChange(idx, 'gdp', e.target.value)} className="w-full p-1.5 border border-transparent group-hover:bg-white group-hover:border-gray-300 rounded text-right font-mono bg-transparent text-green-800" placeholder="-" />
                                                </td>
                                                <td className="p-1 text-center">
                                                    <button onClick={() => removeNationYearRow(idx)} className="text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.X size={16}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="p-4 border-t border-dashed border-gray-200">
                                    <button onClick={addNationYearRow} className="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-400 font-bold hover:border-blue-400 hover:text-blue-500 flex justify-center items-center gap-2 transition-colors">
                                        <Icons.Plus size={16}/> 空行を追加
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {mode === 'year' && (
                    <div className="flex flex-col h-full">
                        <div className="p-4 border-b bg-gray-50 flex items-center gap-4">
                            <label className="font-bold text-gray-700">対象年:</label>
                            <input type="number" value={targetYear} onChange={e => setTargetYear(e.target.value)} className="w-24 p-2 border rounded font-bold text-center" />
                            <div className="flex-grow"></div>
                            <button onClick={saveYearData} className="bg-blue-900 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-800 flex items-center gap-2"><Icons.Save size={18}/> 保存する</button>
                        </div>
                        <div className="flex-grow overflow-y-auto custom-scrollbar p-4">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-100 text-gray-600 sticky top-0 shadow-sm">
                                    <tr>
                                        <th className="p-3 text-left">国家</th>
                                        <th className="p-3 text-right">人口 (人)</th>
                                        <th className="p-3 text-right">GDP (円)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {nations.map(n => {
                                        const info = getNationInfo(n, targetYear);
                                        const isDimmed = info.isCollapsed || info.isFuture;
                                        return (
                                            <tr key={n.id} className={isDimmed ? 'opacity-50 bg-gray-50' : 'hover:bg-blue-50'}>
                                                <td className="p-3 font-bold flex items-center gap-2">
                                                    {info.flag ? <img src={info.flag} className="w-6 h-4 object-cover border"/> : <div className="w-6 h-4 bg-gray-200"></div>}
                                                    {info.name}
                                                </td>
                                                <td className="p-2"><input type="number" value={yearInputData[n.id]?.population || ''} onChange={e => handleYearInputChange(n.id, 'population', e.target.value)} className="w-full p-2 border rounded text-right font-mono" placeholder="-" /></td>
                                                <td className="p-2"><input type="number" value={yearInputData[n.id]?.gdp || ''} onChange={e => handleYearInputChange(n.id, 'gdp', e.target.value)} className="w-full p-2 border rounded text-right font-mono" placeholder="-" /></td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// --- SimpleLineChart コンポーネント (グラフの点を間引き表示) ---
        const SimpleLineChart = ({ title, data, nations, getValue, formatValue, icon: Icon, dataType }) => {
            const [includeRefScale, setIncludeRefScale] = useState(false);
            const [isLegendExpanded, setIsLegendExpanded] = useState(false);
            const [visibleNationIds, setVisibleNationIds] = useState(nations.map(n => n.id));

            useEffect(() => {
                setVisibleNationIds(prev => { const currentIds = nations.map(n => n.id); return currentIds; });
            }, [nations.length]);

            const toggleNation = (id) => { setVisibleNationIds(prev => prev.includes(id) ? prev.filter(nid => nid !== id) : [...prev, id]); };
            const toggleAll = () => { setVisibleNationIds(visibleNationIds.length === nations.length ? [] : nations.map(n => n.id)); };

            const sortedData = [...data].sort((a, b) => a.year - b.year);
            const years = [...new Set(sortedData.map(d => d.year))];
            if (years.length === 0) return <div className="bg-white p-8 rounded-lg shadow text-center text-gray-400">データがありません</div>;
            
            let maxValue = 0; 
            const activeData = sortedData.filter(d => visibleNationIds.includes(d.nationId));
            activeData.forEach(d => { const val = getValue(d); if (val > maxValue) maxValue = val; });

            let refData = [];
            if (dataType && ['population', 'gdp', 'perCapita'].includes(dataType)) {
                    refData = US_STATS.map(d => ({ ...d, year: d.year - AD_OFFSET }));
                    if (includeRefScale) { 
                        const minYear = Math.min(...years); const maxYear = Math.max(...years);
                        const scaleRefData = refData.filter(d => d.year >= minYear - 100 && d.year <= maxYear + 100);
                        scaleRefData.forEach(d => { let val = 0; if (dataType === 'population') val = d.population; else if (dataType === 'gdp') val = d.gdp; else if (dataType === 'perCapita') val = Math.round(d.gdp / d.population); if (val > maxValue) maxValue = val; }); 
                    }
            }
            if (maxValue === 0) maxValue = 100; const yMax = maxValue * 1.2;
            
            const width = 600; const height = 300; const padding = { top: 30, right: 30, bottom: 50, left: 80 }; const graphWidth = width - padding.left - padding.right; const graphHeight = height - padding.top - padding.bottom;
            const getX = (year) => { const index = years.indexOf(year); if (years.length === 1) return padding.left + graphWidth / 2; return padding.left + (index / (years.length - 1)) * graphWidth; };
            const getXByYear = (year) => { const minYear = Math.min(...years); const maxYear = Math.max(...years); if (maxYear === minYear) return padding.left + graphWidth / 2; return padding.left + ((year - minYear) / (maxYear - minYear)) * graphWidth; };
            const getY = (value) => padding.top + graphHeight - ((value / yMax) * graphHeight);
            const yGridLines = [0, 1, 2, 3, 4].map(i => { const val = (yMax / 5) * i; const y = getY(val); return ( <g key={i}> <line x1={padding.left} y1={y} x2={width - padding.right} y2={y} stroke="#f0f0f0" strokeWidth="1" /> <text x={padding.left - 10} y={y + 5} textAnchor="end" fontSize="12" fill="#999">{formatValue(val, true)}</text> </g> ); });
            
            let refLine = null;
            if (refData.length > 0) { 
                const points = refData.map(d => { let val = 0; if (dataType === 'population') val = d.population; else if (dataType === 'gdp') val = d.gdp; else if (dataType === 'perCapita') val = Math.round(d.gdp / d.population); const y = getY(val); return `${getXByYear(d.year)},${y}`; }).join(' '); 
                const minYear = Math.min(...years); const maxYear = Math.max(...years);
                const visibleRefPoints = refData.filter(d => d.year >= minYear - 50 && d.year <= maxYear + 50);
                const labelPoint = visibleRefPoints.length > 0 ? visibleRefPoints[visibleRefPoints.length - 1] : null;
                refLine = ( <g className="opacity-50"> <polyline points={points} fill="none" stroke="#cbd5e1" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" strokeDasharray="4 4" /> {labelPoint && ( <text x={getXByYear(labelPoint.year)} y={getY(dataType === 'population' ? labelPoint.population : (dataType === 'gdp' ? labelPoint.gdp : labelPoint.gdp/labelPoint.population)) - 10} textAnchor="middle" fontSize="10" fill="#94a3b8" fontWeight="bold">USA</text> )} </g> ); 
            }
            
            const lines = nations.map(nation => { 
                if (!visibleNationIds.includes(nation.id)) return null;

                const nationStats = sortedData.filter(d => { if (d.nationId !== nation.id) return false; const info = getNationInfo(nation, d.year); return !info.isCollapsed && !info.isFuture; }).sort((a, b) => a.year - b.year); if (nationStats.length === 0) return null; 
                const points = nationStats.map(d => `${getX(d.year)},${getY(getValue(d))}`).join(' '); 
                
                return ( 
                    <g key={nation.id}> 
                        {/* 線本体 */}
                        <polyline points={points} fill="none" stroke={nation.color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="opacity-70 hover:opacity-100 transition-opacity" /> 
                        
                        {/* データ点 */}
                        {nationStats.map((d, i) => { 
                            const info = getNationInfo(nation, d.year);
                            
                            // ★修正: 点の間引きロジック
                            const prev = nationStats[i - 1];
                            const next = nationStats[i + 1];
                            // 前後と連続している（差が1年）場合は、中間点とみなして非表示にする
                            const isContinuousPrev = prev && (d.year - prev.year === 1);
                            const isContinuousNext = next && (next.year - d.year === 1);
                            const isIntermediate = isContinuousPrev && isContinuousNext;
                            
                            // 中間点なら非表示(opacity-0)、端点なら表示
                            const dotClass = isIntermediate 
                                ? "opacity-0 group-hover/point:opacity-100 scale-75" 
                                : "opacity-100";

                            return ( 
                                <g key={d.id} className="group/point"> 
                                    {/* ヒットエリア (透明な大きい円) - 中間点でもマウスが反応するように */}
                                    <circle cx={getX(d.year)} cy={getY(getValue(d))} r="6" fill="transparent" className="cursor-pointer" />
                                    
                                    {/* 表示用の円 */}
                                    <circle 
                                        cx={getX(d.year)} 
                                        cy={getY(getValue(d))} 
                                        r={isIntermediate ? 3 : 4} 
                                        fill="white" 
                                        stroke={info.color} 
                                        strokeWidth="2" 
                                        className={`pointer-events-none transition-all duration-200 ${dotClass}`} 
                                    /> 
                                    
                                    {/* ポップアップ (ホバー時) */}
                                    <g className="opacity-0 group-hover/point:opacity-100 transition-opacity pointer-events-none z-50"> 
                                        <rect x={Math.min(Math.max(getX(d.year) - 70, 0), width - 140)} y={getY(getValue(d)) - 65} width="140" height="55" rx="4" fill="rgba(0,0,0,0.9)" /> 
                                        <text x={Math.min(Math.max(getX(d.year), 70), width - 70)} y={getY(getValue(d)) - 45} textAnchor="middle" fill="white" fontSize="11"> {d.year}年 ({info.name}) </text> 
                                        <text x={Math.min(Math.max(getX(d.year), 70), width - 70)} y={getY(getValue(d)) - 25} textAnchor="middle" fill="white" fontSize="13" fontWeight="bold"> {formatValue(getValue(d), false)} </text> 
                                    </g> 
                                </g> 
                            ); 
                        })} 
                    </g> 
                ); 
            });

            return ( 
                <div className="bg-white p-4 rounded-lg shadow-lg border border-gray-200 mb-8"> 
                    <div className="flex flex-wrap items-center justify-between mb-4 border-b pb-2 gap-2"> 
                        <div className="flex items-center gap-2"> <div className="p-2 bg-gray-100 rounded-full text-gray-700"><Icon size={20} /></div> <h3 className="text-lg font-bold text-gray-800">{title}</h3> </div> 
                        <div className="flex items-center gap-4 text-xs"> <div className="flex items-center gap-2 text-gray-400"> <span className="w-4 h-0.5 bg-gray-300 border border-gray-300 border-dashed inline-block"></span> アメリカ (史実参考: 西暦-{AD_OFFSET}年) </div> <label className="flex items-center gap-1 cursor-pointer bg-gray-50 px-2 py-1 rounded border hover:bg-gray-100 transition-colors"> <input type="checkbox" checked={includeRefScale} onChange={(e) => setIncludeRefScale(e.target.checked)} className="rounded text-blue-600" /> <span>基準データに合わせて縮小</span> </label> </div> 
                    </div> 
                    <div className="w-full overflow-hidden"> 
                        <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto bg-gray-50 rounded border border-gray-100"> {yGridLines} {refLine} {years.map((year, i) => { const showLabel = years.length <= 10 || i % Math.ceil(years.length / 10) === 0 || i === years.length - 1; if (!showLabel) return null; return (<text key={year} x={getX(year)} y={height - 15} textAnchor="middle" fontSize="12" fill="#555" fontWeight="bold">{year}</text>); })} {lines} </svg> 
                    </div> 
                    <div className="mt-4">
                        <div className="flex justify-between items-center mb-2 px-1">
                             <div className="text-xs font-bold text-gray-500 flex items-center gap-2">
                                <span>表示対象: {visibleNationIds.length}/{nations.length}ヵ国</span>
                                <button onClick={toggleAll} className="text-blue-600 hover:underline bg-blue-50 px-2 py-0.5 rounded border border-blue-100 transition-colors">
                                    {visibleNationIds.length === nations.length ? 'すべて隠す' : 'すべて表示'}
                                </button>
                             </div>
                             <button onClick={() => setIsLegendExpanded(!isLegendExpanded)} className="text-xs text-gray-500 flex items-center gap-1 hover:bg-gray-100 px-2 py-1 rounded transition-colors">
                                {isLegendExpanded ? <><Icons.Minus size={12} /> 折りたたむ</> : <><Icons.Plus size={12} /> すべて見る</>}
                             </button>
                        </div>
                        <div className={`flex flex-wrap gap-2 justify-center transition-all overflow-hidden ${isLegendExpanded ? 'max-h-full' : 'max-h-16'}`}> 
                            {nations.map(n => {
                                const isActive = visibleNationIds.includes(n.id);
                                return (
                                    <button key={n.id} onClick={() => toggleNation(n.id)} className={`flex items-center gap-1.5 text-xs font-bold px-2 py-1 rounded border transition-all select-none ${isActive ? 'bg-gray-50 text-gray-700 border-gray-300 shadow-sm' : 'bg-transparent text-gray-300 border-transparent hover:bg-gray-50'}`}>
                                        <div className={`w-3 h-3 rounded-full transition-opacity ${isActive ? '' : 'opacity-20 grayscale'}`} style={{backgroundColor: n.color}}></div>
                                        <span className={isActive ? '' : 'line-through decoration-gray-300'}>{n.name}</span>
                                    </button>
                                );
                            })} 
                        </div>
                    </div>
                </div> 
            );
        };

// --- GraphView コンポーネント (ここが抜けていました) ---
const GraphView = ({ setView, stats, nations }) => ( 
    <div className="space-y-6 animate-fade-in pb-20"> 
        <SectionHeader icon={Icons.TrendingUp} title="国家統計データ分析" desc="登録された全統計データを、期間に合わせて等間隔で配置・可視化します。" /> 
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6"> 
            <div className="h-full"><SimpleLineChart title="総人口推移" data={stats} nations={nations} getValue={(d) => d.population} formatValue={(v, isShort) => formatJapaneseNumber(v, '人', isShort)} icon={Icons.Users} dataType="population" /></div> 
            <div className="h-full"><SimpleLineChart title="GDP (国内総生産) 推移" data={stats} nations={nations} getValue={(d) => d.gdp} formatValue={(v, isShort) => formatJapaneseNumber(v, '円', isShort)} icon={Icons.BarChart2} dataType="gdp" /></div> 
            <div className="h-full"><SimpleLineChart title="一人あたりGDP (豊かさ) 推移" data={stats} nations={nations} getValue={(d) => calculatePerCapita(d.gdp, d.population)} formatValue={(v, isShort) => formatJapaneseNumber(v, '円', isShort)} icon={Icons.DollarSign} dataType="perCapita" /></div> 
            <div className="bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg flex flex-col items-center justify-center text-gray-400 p-8 min-h-[300px]"><Icons.BarChart2 size={32} className="opacity-20 mb-2"/><span className="font-bold text-sm opacity-50">No Data</span></div> 
        </div> 
    </div> 
);

// --- NationOverviewView コンポーネント (復活・修正版) ---
const NationOverviewView = ({ setView, nations, setNations, targetNation }) => {
    const [selectedNation, setSelectedNation] = useState(null);

    useEffect(() => {
        if (targetNation) {
            const current = nations.find(n => n.id === targetNation.id);
            if (current) setSelectedNation(current);
        }
    }, [targetNation, nations]);

    const handleSave = (htmlContent) => {
        const updatedNation = { ...selectedNation, note: htmlContent };
        const newNations = nations.map(n => n.id === selectedNation.id ? updatedNation : n);
        setNations(newNations);
        setSelectedNation(updatedNation);
        alert('概要を保存しました');
    };

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">
            
            <SectionHeader icon={Icons.FileText} title="国家概要管理" desc="リッチテキストエディタを使用して、国家の詳細な設定（文化、地理、歴史詳細など）を記述します。" />

            <div className="flex gap-6 items-start flex-grow">
                {/* 左側リスト: Sticky配置 + 高さ指定 */}
                <div 
                    className="w-full md:w-80 flex-shrink-0 sticky top-4"
                    style={{ height: 'calc(100vh - 320px)', minHeight: '400px' }}
                >
                    <NationListPanel 
                        nations={nations} 
                        setNations={setNations} 
                        selectedNationId={selectedNation?.id} 
                        onSelect={setSelectedNation} 
                    />
                </div>

                {/* 右側: エディタエリア */}
                <div className="flex-grow w-full min-w-[300px]">
                    {selectedNation ? (
                        <QuillEditor 
                            key={selectedNation.id} 
                            initialContent={selectedNation.note} 
                            nationName={selectedNation.name}
                            nationFlag={selectedNation.flag}
                            onSave={handleSave} 
                        />
                    ) : (
                        <div className="w-full min-h-[600px] flex flex-col bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden justify-center items-center text-gray-400 bg-gray-50">
                            <Icons.FileText size={64} className="mb-4 opacity-20"/>
                            <p>左のリストから編集したい国家を選択してください</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};


// --- 国家興亡系譜図ビュー (スマホ対応・ピンチズーム実装版) ---
const GenealogyView = ({ setView, nations, stats, entries, setSelectedEntry }) => {
    // ビューポート状態
    const [zoom, setZoom] = useState(1.0);
    const [pan, setPan] = useState({ x: 0, y: 0 });
    const [isDragging, setIsDragging] = useState(false);
    const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
    
    // ★追加: ピンチズーム用状態
    const [isPinching, setIsPinching] = useState(false);
    const [pinchStartDist, setPinchStartDist] = useState(0);
    const [pinchStartZoom, setPinchStartZoom] = useState(1.0);

    // スマホ用: 設定パネルの開閉状態
    const [isPanelOpen, setIsPanelOpen] = useState(true);

    // レイアウト設定
    const [yearHeight, setYearHeight] = useState(5);
    const [laneWidth, setLaneWidth] = useState(100);
    const [showMarkers, setShowMarkers] = useState(true);
    const [showConnections, setShowConnections] = useState(true);

    // --- データ計算ロジック (変更なし) ---
    const { nationBlocks, renderSegments, connections, minYear, maxYear, lanesCount, continentZones } = useMemo(() => {
        const blocks = []; 
        let gMin = 10000, gMax = -10000;
        nations.forEach(n => {
            const info = getNationInfo(n, 9999); 
            let start = info.nationStartYear || DEFAULT_YEAR;
            let end = info.nationEndYear || (new Date().getFullYear() + 50); 
            const nStats = stats.filter(s => s.nationId === n.id);
            if (nStats.length > 0) { const sMin = Math.min(...nStats.map(s => s.year)); if (sMin < start) start = sMin; }
            if (start < gMin) gMin = start; if (end > gMax) gMax = end;
            blocks.push({ ...n, start, end, lane: 0, location: n.location || 'unknown', rank: n.rank || 'minor_power' });
        });
        if (nations.length === 0) { gMin = DEFAULT_YEAR; gMax = DEFAULT_YEAR + 100; } else { gMin -= 10; gMax += 20; }

        const sortedLocKeys = Object.keys(LOCATIONS).sort((a, b) => LOCATIONS[a].order - LOCATIONS[b].order);
        let totalLanesOffset = 0;
        const continentZones = [];
        sortedLocKeys.forEach(locKey => {
            const locBlocks = blocks.filter(b => b.location === locKey);
            if (locBlocks.length === 0) return;
            locBlocks.sort((a, b) => {
                const rankA = NATION_RANKS[a.rank]?.order || 99;
                const rankB = NATION_RANKS[b.rank]?.order || 99;
                if (rankA !== rankB) return rankA - rankB;
                return a.start - b.start;
            });
            const lanes = [];
            locBlocks.forEach(block => {
                let assigned = false;
                for (let i = 0; i < lanes.length; i++) {
                    if (lanes[i] < block.start) { block.lane = totalLanesOffset + i; lanes[i] = block.end + 5; assigned = true; break; }
                }
                if (!assigned) { block.lane = totalLanesOffset + lanes.length; lanes.push(block.end + 5); }
            });
            continentZones.push({ key: locKey, label: LOCATIONS[locKey].label, color: LOCATIONS[locKey].color, startLane: totalLanesOffset, endLane: totalLanesOffset + lanes.length });
            totalLanesOffset += lanes.length + 1;
        });

        const segments = [];
        blocks.forEach(block => {
            const eras = (block.eras || []).sort((a, b) => a.startYear - b.startYear);
            const validEras = eras.filter(e => e.startYear >= block.start && e.startYear < block.end);
            let currentStart = block.start;
            let currentParams = block.params || {};
            let activeState = { name: block.name, flag: block.flag, color: block.color, params: currentParams };
            let activeType = 'foundation';

            validEras.forEach(era => {
                const nextParams = { ...currentParams, ...(era.params || {}) };
                const nextState = { name: era.name || block.name, flag: era.flag || block.flag, color: era.color || block.color, params: nextParams };
                if (era.startYear === currentStart) {
                    activeState = nextState; currentParams = nextParams; activeType = era.type;
                } else {
                    const prevGovColor = activeState.params?.ideology_gov?.color;
                    const nextGovColor = nextState.params?.ideology_gov?.color;
                    const isDifferent = nextState.name !== activeState.name || nextState.flag !== activeState.flag || nextState.color !== activeState.color || prevGovColor !== nextGovColor;
                    if (isDifferent) {
                        segments.push({ id: `${block.id}_${currentStart}`, nationId: block.id, lane: block.lane, start: currentStart, end: era.startYear, ...activeState, type: activeType, rank: block.rank });
                        currentStart = era.startYear; activeState = nextState; currentParams = nextParams; activeType = era.type;
                    } else {
                        activeType = era.type; currentParams = nextParams; activeState.params = nextParams;
                    }
                }
            });
            segments.push({ id: `${block.id}_last`, nationId: block.id, lane: block.lane, start: currentStart, end: block.end, ...activeState, type: activeType, rank: block.rank });
        });

        const conns = [];
        nations.forEach(n => {
            (n.eras || []).forEach(era => {
                if (!era.event) return;
                const targets = era.event.targetIds || (era.event.targetId ? [era.event.targetId] : []);
                targets.forEach(targetId => {
                    const targetBlock = blocks.find(b => b.id === targetId);
                    const selfBlock = blocks.find(b => b.id === n.id);
                    if (!targetBlock || !selfBlock) return;
                    const year = era.startYear; const type = era.event.type;
                    if (['independence', 'splinter'].includes(type)) conns.push({ from: targetBlock, to: selfBlock, year, type });
                    else if (['lose_independence', 'lose_splinter'].includes(type)) conns.push({ from: selfBlock, to: targetBlock, year, type: type.replace('lose_', '') });
                    else if (['annexed_by', 'merger', 'partitioned_by', 'dissolution'].includes(type)) conns.push({ from: selfBlock, to: targetBlock, year, type });
                    else if (['annexation', 'unification', 'partition'].includes(type)) { let mappedType = type; if (type === 'annexation') mappedType = 'annexed_by'; if (type === 'unification') mappedType = 'merger'; if (type === 'partition') mappedType = 'partitioned_by'; conns.push({ from: targetBlock, to: selfBlock, year, type: mappedType }); }
                    else if (['foundation_puppet', 'be_puppet', 'puppet'].includes(type)) conns.push({ from: targetBlock, to: selfBlock, year, type });
                });
            });
        });
        const uniqueConns = []; const connSet = new Set();
        conns.forEach(c => { const key = `${c.from.id}-${c.to.id}-${c.type}-${c.year}`; if (!connSet.has(key)) { connSet.add(key); uniqueConns.push(c); } });
        return { nationBlocks: blocks, renderSegments: segments, connections: uniqueConns, minYear: gMin, maxYear: gMax, lanesCount: totalLanesOffset, continentZones };
    }, [nations, stats]);

    const legendaryEvents = useMemo(() => {
        if (!entries) return [];
        return entries.filter(e => (e.importance || 2) >= 5).sort((a, b) => a.year - b.year);
    }, [entries]);

    // --- マウス操作ハンドラ ---
    const handleStartDrag = (clientX, clientY, target) => {
        if (target.closest('.control-panel') || target.tagName === 'BUTTON' || target.tagName === 'INPUT') return;
        setIsDragging(true);
        setDragStart({ x: clientX - pan.x, y: clientY - pan.y });
    };

    const handleDragMove = (clientX, clientY) => {
        if (!isDragging) return;
        setPan({ x: clientX - dragStart.x, y: clientY - dragStart.y });
    };

    // --- マウスイベント (PC) ---
    const onMouseDown = (e) => {
        handleStartDrag(e.clientX, e.clientY, e.target);
        e.currentTarget.style.cursor = 'grabbing';
    };
    const onMouseMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        handleDragMove(e.clientX, e.clientY);
    };
    const onMouseUp = (e) => {
        setIsDragging(false);
        e.currentTarget.style.cursor = 'grab';
    };
    const handleWheel = (e) => {
        const scaleAmount = -e.deltaY * 0.001;
        setZoom(prev => Math.min(Math.max(0.1, prev + scaleAmount), 3.0));
    };

    // --- ★タッチイベント (スマホ: ピンチズーム対応) ---
    const getTouchDist = (touches) => {
        return Math.hypot(
            touches[0].clientX - touches[1].clientX,
            touches[0].clientY - touches[1].clientY
        );
    };

    const onTouchStart = (e) => {
        if (e.target.closest('.control-panel') || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;

        if (e.touches.length === 2) {
            // 2本指: ピンチズーム開始
            e.preventDefault();
            setIsPinching(true);
            setIsDragging(false); // ドラッグはキャンセル
            const dist = getTouchDist(e.touches);
            setPinchStartDist(dist);
            setPinchStartZoom(zoom);
        } else if (e.touches.length === 1) {
            // 1本指: ドラッグ開始
            const touch = e.touches[0];
            handleStartDrag(touch.clientX, touch.clientY, e.target);
        }
    };

    const onTouchMove = (e) => {
        if (isPinching && e.touches.length === 2) {
            // 2本指: ピンチズーム中
            e.preventDefault();
            const dist = getTouchDist(e.touches);
            if (pinchStartDist > 0) {
                const scale = dist / pinchStartDist;
                // 既存のzoom値に対して比率を掛ける
                const newZoom = Math.min(Math.max(0.1, pinchStartZoom * scale), 3.0);
                setZoom(newZoom);
            }
        } else if (isDragging && e.touches.length === 1) {
            // 1本指: ドラッグ中
            // スクロールを阻害しないよう preventDefault は条件付きにするか外す
            // ここでは横スクロール操作感を優先し、斜め移動も許容するためpreventDefaultはしない（またはCSSで touch-action: none を指定）
            const touch = e.touches[0];
            handleDragMove(touch.clientX, touch.clientY);
        }
    };

    const onTouchEnd = () => {
        setIsDragging(false);
        setIsPinching(false);
    };

    // 描画ヘルパー
    const getY = (year) => (year - minYear) * yearHeight;
    const getX = (lane) => lane * laneWidth + 100;
    const TOTAL_HEIGHT = (maxYear - minYear) * yearHeight + 100;
    const TOTAL_WIDTH = Math.max(1000, lanesCount * laneWidth + 200);

    return (
        <div 
            className="h-full w-full bg-[#f0f2f5] overflow-hidden relative cursor-grab touch-none" // touch-none必須
            onMouseDown={onMouseDown}
            onMouseMove={onMouseMove}
            onMouseUp={onMouseUp}
            onMouseLeave={onMouseUp}
            onTouchStart={onTouchStart}
            onTouchMove={onTouchMove}
            onTouchEnd={onTouchEnd}
            onWheel={handleWheel}
        >
            {/* コントロールパネル開閉ボタン (スマホで便利) */}
            <button 
                onClick={() => setIsPanelOpen(!isPanelOpen)} 
                className="absolute top-4 left-4 z-[60] bg-white p-2 rounded-lg shadow-md border border-gray-200 text-gray-600 md:hidden"
            >
                {isPanelOpen ? <Icons.X size={20}/> : <Icons.Settings size={20}/>}
            </button>

            {/* コントロールパネル */}
            <div className={`control-panel absolute top-16 left-4 md:top-4 md:left-4 z-50 bg-white/95 backdrop-blur p-4 rounded-lg shadow-xl border border-gray-200 w-72 space-y-4 transition-all duration-300 origin-top-left ${isPanelOpen ? 'scale-100 opacity-100' : 'scale-0 opacity-0 md:scale-100 md:opacity-100 pointer-events-none md:pointer-events-auto'}`}>
                <div className="flex justify-between items-center border-b pb-2">
                    <h2 className="font-bold text-gray-800 flex items-center gap-2"><Icons.GitMerge size={18}/> 興亡系譜図</h2>
                </div>
                <div className="flex items-center justify-between bg-blue-50 p-2 rounded border border-blue-100">
                    <span className="text-xs font-bold text-blue-800">VIEW ZOOM</span>
                    <div className="flex items-center gap-2">
                        <button onClick={() => setZoom(z => Math.max(0.1, z - 0.1))} className="w-6 h-6 bg-white rounded shadow text-blue-600 font-bold hover:bg-blue-100">-</button>
                        <span className="text-xs font-mono w-10 text-center">{Math.round(zoom * 100)}%</span>
                        <button onClick={() => setZoom(z => Math.min(3.0, z + 0.1))} className="w-6 h-6 bg-white rounded shadow text-blue-600 font-bold hover:bg-blue-100">+</button>
                    </div>
                </div>

                <div className="space-y-3">
                    <div>
                        <div className="flex justify-between text-xs text-gray-600 mb-1"><span>縦間隔 (年)</span><span className="font-mono">{yearHeight}px</span></div>
                        <input type="range" min="1" max="20" step="0.5" value={yearHeight} onChange={e=>setYearHeight(parseFloat(e.target.value))} className="w-full h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                    </div>
                    <div>
                        <div className="flex justify-between text-xs text-gray-600 mb-1"><span>横幅 (国)</span><span className="font-mono">{laneWidth}px</span></div>
                        <input type="range" min="50" max="300" step="10" value={laneWidth} onChange={e=>setLaneWidth(parseInt(e.target.value))} className="w-full h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                    </div>
                </div>

                <div className="flex gap-2">
                    <button onClick={() => setShowMarkers(!showMarkers)} className={`flex-1 py-1 text-xs rounded border transition-colors ${showMarkers ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>イベント</button>
                    <button onClick={() => setShowConnections(!showConnections)} className={`flex-1 py-1 text-xs rounded border transition-colors ${showConnections ? 'bg-green-100 border-green-300 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>関係線</button>
                </div>
                
                <div className="text-[10px] text-gray-400 pt-2 border-t">
                    スワイプで移動、ピンチで拡大縮小。<br/>
                    上から下へ時間が流れます。
                </div>
            </div>

            {/* キャンバスエリア */}
            <div 
                className="origin-top-left transition-transform duration-75 ease-out relative bg-white"
                style={{ 
                    transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`, 
                    width: `${TOTAL_WIDTH}px`, 
                    height: `${TOTAL_HEIGHT}px`,
                    minWidth: '100%', minHeight: '100%'
                }}
            >
                {/* 背景グリッド */}
                {Array.from({ length: Math.max(0, Math.ceil((maxYear - minYear) / 10) + 1) }).map((_, i) => {
                    const year = minYear + (i * 10); const y = getY(year);
                    if (yearHeight < 2 && i % 5 !== 0) return null; if (yearHeight < 4 && i % 2 !== 0) return null;
                    return ( <div key={year} className="absolute w-full border-t border-gray-100 text-[10px] text-gray-300 pl-2 pointer-events-none flex items-center" style={{ top: y }}><span className="bg-white/80 pr-1">{year}</span></div> );
                })}

                {/* 大陸ゾーンヘッダー */}
                {continentZones.map((zone, i) => {
                    const startX = getX(zone.startLane) - (laneWidth / 2) + 5;
                    const endX = getX(zone.endLane) + (laneWidth / 2) - 5; 
                    const width = endX - startX;
                    return (
                        <React.Fragment key={zone.key}>
                            <div className="absolute top-0 text-center text-xs font-bold text-white py-1 shadow-sm opacity-90" style={{ left: startX, width: width, backgroundColor: zone.color, borderRadius: '0 0 4px 4px' }}>{zone.label}</div>
                            <div className="absolute top-0 bottom-0 pointer-events-none bg-gray-50/30" style={{ left: startX, width: width, borderLeft: '1px dashed #e5e7eb', borderRight: '1px dashed #e5e7eb' }} />
                        </React.Fragment>
                    );
                })}
                
                {/* 伝説級イベントマーカー */}
                {showMarkers && legendaryEvents.map(e => {
                    const top = getY(e.year);
                    if (top < 0 || top > TOTAL_HEIGHT) return null;
                    const isMyth = (e.importance || 2) === 6;
                    return (
                        <div key={e.id} className="absolute left-4 z-30 group" style={{ top: top - 12 }}>
                            <div className={`w-6 h-6 ${isMyth ? 'bg-rose-600' : 'bg-yellow-500'} rounded-full border-2 border-white shadow-md flex items-center justify-center text-white text-xs font-bold ring-2 ${isMyth ? 'ring-rose-300' : 'ring-yellow-200'} group-hover:scale-110 transition-transform cursor-pointer relative z-40`} onClick={(ev) => { ev.stopPropagation(); setSelectedEntry(e); setView('detail'); }} title="詳細を表示">{isMyth ? '✦' : '★'}</div>
                            <div className="absolute left-8 top-0 bg-white/90 backdrop-blur border border-yellow-400 px-2 py-1 rounded shadow-sm text-xs font-bold text-gray-800 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none max-w-[200px] truncate z-50">{e.year}年: {e.title}</div>
                            <div className="absolute left-3 top-3 border-t border-yellow-300 border-dashed opacity-0 group-hover:opacity-50 pointer-events-none z-30" style={{ width: `${TOTAL_WIDTH}px` }}></div>
                        </div>
                    );
                })}

                {/* 国家ブロック */}
                {renderSegments.map(seg => {
                    const top = getY(seg.start);
                    const height = Math.max(yearHeight * 2, getY(seg.end) - top);
                    const left = getX(seg.lane);
                    const isCollapsed = seg.end < 3000 && (seg.type === 'collapse' || seg.type === 'annexed_by' || seg.type === 'merger'); 
                    const isTiny = height < 30 || laneWidth < 60;
                    const govColor = seg.params?.ideology_gov?.color;
                    const bgColor = isCollapsed ? '#e5e7eb' : (govColor || '#ffffff'); 
                    
                    return (
                        <div key={seg.id} 
                            className="absolute rounded shadow-sm hover:z-20 hover:shadow-lg transition-all flex flex-col items-center justify-start overflow-hidden"
                            style={{
                                top: `${top}px`, left: `${left}px`, width: `${laneWidth - 10}px`, height: `${height}px`, 
                                backgroundColor: bgColor, borderColor: '#000000', borderWidth: isTiny ? '1px' : '2px', borderStyle: 'solid', 
                                color: isCollapsed ? '#6b7280' : '#000000', opacity: isCollapsed ? 0.7 : 1
                            }}
                            title={`${seg.name} (${seg.start} - ${seg.end < 3000 ? seg.end : '...'})`}
                        >
                            <div className="w-full flex flex-col items-center justify-start pt-1 pb-1 bg-inherit">
                                {!isTiny && seg.flag && <img src={seg.flag} className="w-6 h-4 object-cover mb-0.5 shadow-sm border border-black/20" />}
                                <span className="text-center leading-tight px-1 truncate w-full" style={{fontSize: isTiny ? '8px' : '10px', fontWeight: 'bold'}}>{seg.name}</span>
                                {!isTiny && <span className="text-[9px] font-mono mt-0.5 opacity-80">{seg.start}</span>}
                            </div>
                        </div>
                    );
                })}

                {/* 接続線 */}
                {showConnections && (
                    <svg className="absolute inset-0 pointer-events-none z-10" width="100%" height="100%">
                        <defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af" /></marker></defs>
                        {connections.map((conn, i) => {
                            const x1 = getX(conn.from.lane) + (laneWidth / 2) - 5; const y1 = getY(conn.year);
                            const x2 = getX(conn.to.lane) + (laneWidth / 2) - 5; const y2 = getY(conn.year);
                            const curveY = Math.min(30, yearHeight * 10);
                            const path = `M ${x1} ${y1} C ${x1} ${y1 + curveY}, ${x2} ${y2 - curveY}, ${x2} ${y2}`;
                            let strokeColor = "#9ca3af"; let lineText = ""; let isIndependence = false;

                            if (['independence', 'splinter'].includes(conn.type)) { strokeColor = "#4ade80"; lineText = conn.type === 'splinter' ? "分裂" : "独立"; isIndependence = true; }
                            else if (['annexation', 'merger', 'partitioned_by', 'dissolution', 'annexed_by'].includes(conn.type)) { 
                                strokeColor = "#f87171"; 
                                if (['annexation', 'annexed_by'].includes(conn.type)) lineText = "併合";
                                else if (['merger', 'unification'].includes(conn.type)) lineText = "統合";
                                else if (['partition', 'partitioned_by'].includes(conn.type)) lineText = "分割";
                                else if (conn.type === 'dissolution') lineText = "解体";
                                else lineText = "併合";
                                isIndependence = false;
                            }
                            else if (['foundation_puppet', 'be_puppet', 'puppet'].includes(conn.type)) {
                                strokeColor = "#a855f7"; lineText = "傀儡"; isIndependence = true;
                            }

                            const midX = (x1 + x2) / 2; const midY = (y1 + y2) / 2 + (isIndependence ? 10 : -10);
                            return (
                                <g key={i}>
                                    <path d={path} fill="none" stroke={strokeColor} strokeWidth={Math.max(1, yearHeight / 2)} markerEnd="url(#arrowhead)" opacity="0.8" />
                                    {yearHeight > 2 && (
                                        <g transform={`translate(${midX}, ${midY})`}>
                                            <rect x="-14" y="-7" width="28" height="14" rx="2" fill="white" stroke={strokeColor} strokeWidth="1" opacity="0.9" />
                                            <text x="0" y="4" textAnchor="middle" fontSize="10" fill={strokeColor} fontWeight="bold">{lineText}</text>
                                        </g>
                                    )}
                                </g> 
                            );
                        })}
                    </svg>
                )}
            </div>
        </div>
    );
};

const StatsDisplay = ({ year, stats, expandedStatsYears, setExpandedStatsYears, nations }) => {
    const yearStats = stats.filter(s => s.year === year); if (yearStats.length === 0) return null; const isExpanded = expandedStatsYears.includes(year);
    return ( <div className="relative my-4 z-10 w-full max-w-3xl mx-auto md:pl-16"> <div className="flex justify-start"> <button onClick={() => setExpandedStatsYears(prev => prev.includes(year) ? prev.filter(y => y !== year) : [...prev, year])} className={`flex items-center gap-2 px-3 py-2 rounded-full text-sm font-bold shadow-sm border transition-all ${isExpanded ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'}`}> <Icons.BarChart2 size={16} /> {year}年の統計データ <span className="text-xs font-normal ml-1">({yearStats.length}カ国)</span> <Icons.ChevronRight size={16} className={isExpanded ? 'rotate-90' : ''} /> </button> </div> {isExpanded && ( <div className="mt-2 bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden animate-fade-in"> <div className="overflow-x-auto"> <table className="w-full text-sm text-left whitespace-nowrap"> <thead className="bg-gray-50 text-xs uppercase text-gray-500"><tr><th className="px-4 py-2">国家</th><th className="px-4 py-2 text-right">人口</th><th className="px-4 py-2 text-right">GDP (円)</th><th className="px-4 py-2 text-right">一人あたりGDP (円)</th></tr></thead> <tbody> {yearStats.map(stat => { const n = nations.find(n => n.id === stat.nationId) || {name:'?',color:'#ccc'}; const info = getNationInfo(n, year); if (info.isCollapsed) return null; return ( <tr key={stat.id} className="border-b last:border-0 hover:bg-gray-50"> <td className="px-4 py-2 font-bold flex gap-2 items-center">{info.flag && <img src={info.flag} className="w-6 h-4 object-cover border border-gray-200" />}<div className="w-2.5 h-2.5 rounded-full" style={{backgroundColor: info.color}}></div>{info.name}</td> <td className="px-4 py-2 text-right font-mono text-gray-600">{formatJapaneseNumber(stat.population, '人')}</td> <td className="px-4 py-2 text-right font-mono text-gray-600">{formatJapaneseNumber(stat.gdp, '円')}</td> <td className="px-4 py-2 text-right font-mono font-bold text-gray-800">{formatJapaneseNumber(calculatePerCapita(stat.gdp, stat.population), '円')}</td> </tr> ) })} </tbody> </table> </div> </div> )} </div> );
};

const EditForm = ({ entry, onSave, onCancel, nations }) => {
    const [formData, setFormData] = useState(entry); const [tagInput, setTagInput] = useState(entry.tags ? entry.tags.join(', ') : ''); const currentYear = parseInt(formData.year) || DEFAULT_YEAR;
    const sortedNations = useMemo(() => { return [...nations].sort((a, b) => { const locA = LOCATIONS[a.location || 'unknown']?.order || 99; const locB = LOCATIONS[b.location || 'unknown']?.order || 99; if (locA !== locB) return locA - locB; const rankA = NATION_RANKS[a.rank || 'minor_power']?.order || 99; const rankB = NATION_RANKS[b.rank || 'minor_power']?.order || 99; return rankA - rankB; }); }, [nations]);
    const addNationTag = (nationName) => { const currentTags = tagInput.split(',').map(t => t.trim()).filter(t => t !== ''); if (!currentTags.includes(nationName)) { const newTags = [...currentTags, nationName].join(', '); setTagInput(newTags); } };
    return ( <div className="bg-white p-6 rounded-lg shadow-lg max-w-2xl mx-auto border-2 border-gray-800"> <h2 className="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2"><Icons.Edit2 size={24} /> 記録を編集</h2> <div className="space-y-6"> <div className="bg-gray-50 p-4 rounded border border-gray-200"> <div className="flex items-center gap-2 mb-2 text-sm font-bold text-gray-700"><Icons.Calendar size={16} /><span>時期設定</span></div> <div className="grid grid-cols-3 gap-4"> <div><label className="block text-xs text-gray-500 mb-1">英覇暦 (年)</label><input type="number" value={formData.year} onChange={e => setFormData({...formData, year: e.target.value})} className="w-full p-2 border rounded" placeholder="必須" /></div> <div><label className="block text-xs text-gray-500 mb-1">月 (任意)</label><select value={formData.month || ''} onChange={e => setFormData({...formData, month: e.target.value})} className="w-full p-2 border rounded"><option value="">-- 不明 --</option>{Object.entries(CUSTOM_MONTHS).map(([num, name]) => <option key={num} value={num}>{name} ({num}月)</option>)}</select></div> <div><label className="block text-xs text-gray-500 mb-1">日 (任意)</label><input type="number" min="1" max="31" value={formData.day || ''} onChange={e => setFormData({...formData, day: e.target.value})} className="w-full p-2 border rounded" placeholder="--" /></div> </div> </div> <div> <label className="block text-sm font-bold text-gray-700 mb-1">重要度</label> <select value={formData.importance || 2} onChange={e => setFormData({...formData, importance: parseInt(e.target.value)})} className="w-full p-2 border-2 border-gray-300 rounded font-bold"> {Object.entries(importanceLevels).map(([level, info]) => <option key={level} value={level}>Lv.{level} {info.label}</option>)} </select> </div> <div className="space-y-2"> <div><label className="block text-xs text-gray-500">ふりがな</label><input type="text" value={formData.reading || ''} onChange={e => setFormData({...formData, reading: e.target.value})} className="w-full p-1 border-b border-gray-300 outline-none text-sm" /></div> <div><label className="block text-sm font-bold text-gray-700 mb-1">タイトル</label><input type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-2 border-2 border-gray-300 rounded text-lg font-bold" /></div> </div> <div> <label className="block text-sm font-bold text-gray-700 mb-1">タグ</label> <input type="text" value={tagInput} onChange={e => setTagInput(e.target.value)} className="w-full p-2 border border-gray-300 rounded" placeholder="政治, 戦争" /> <div className="mt-2"> <span className="text-xs text-gray-500 mr-2">国家タグを追加:</span> <div className="flex flex-wrap gap-1 mt-1 max-h-32 overflow-y-auto p-1 border rounded bg-gray-50"> <button onClick={() => addNationTag('世界')} className="text-xs bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 text-indigo-700 px-2 py-1 rounded flex items-center gap-1"><Icons.Globe size={12} /> 世界</button> {sortedNations.map(n => { const info = getNationInfo(n, currentYear); if (info.isCollapsed) return null; const rankColor = NATION_RANKS[n.rank || 'minor_power']?.color || '#ccc'; return ( <button key={n.id} onClick={() => addNationTag(info.name)} className="text-xs bg-white hover:bg-gray-100 border px-2 py-1 rounded flex items-center gap-1" style={{borderColor: rankColor}}> {info.flag && <img src={info.flag} className="w-4 h-3 object-cover border border-gray-200" />} <span style={{color: rankColor, fontWeight: 'bold'}}>{info.name}</span> </button> ); })} </div> </div> </div> <div><label className="block text-sm font-bold text-gray-700 mb-1">詳細記述</label><textarea value={formData.content} onChange={e => setFormData({...formData, content: e.target.value})} className="w-full p-2 border-2 border-gray-300 rounded min-h-[200px]" /></div> <div className="flex justify-end gap-4 pt-4 border-t"> <button onClick={onCancel} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded font-bold">破棄</button> <button onClick={() => {const tagsArray = tagInput.split(',').map(t => t.trim()).filter(t => t !== ''); onSave({ ...formData, tags: tagsArray });}} disabled={!formData.title} className="px-6 py-2 bg-gray-900 text-white rounded hover:bg-gray-800 flex items-center gap-2 font-bold shadow-lg"><Icons.Save size={18} /> 記録する</button> </div> </div> </div> );
};

const DetailView = ({ entry, onEdit, onClose, onDelete, nations }) => ( <div className="bg-white min-h-screen md:min-h-0 pb-20"> <div className="sticky top-0 bg-white/90 backdrop-blur-sm border-b border-gray-200 p-4 flex justify-between items-center z-10"><div className="flex gap-2"><button onClick={() => onEdit(entry)} className="p-2 text-blue-600 rounded" title="編集"><Icons.Edit2 size={20} /></button><button onClick={() => onDelete(entry.id)} className="p-2 text-red-600 rounded" title="削除"><Icons.Trash2 size={20} /></button></div></div> <div className="max-w-3xl mx-auto p-6 md:p-10"> <div className="flex flex-wrap items-center gap-4 mb-6"><div className="inline-block bg-gray-900 text-white px-4 py-1 rounded-sm font-mono text-xl font-bold shadow-md">{formatDate(entry.year, entry.month, entry.day)}</div><div className={`px-3 py-1 text-sm rounded-full border ${importanceLevels[entry.importance || 2].badge} border-opacity-20`}>{importanceLevels[entry.importance || 2].label}</div></div> <div className="mb-8 pb-4 border-b-4 border-gray-100">{entry.reading && <p className="text-sm text-gray-500 font-medium mb-1">{entry.reading}</p>}<h1 className="text-4xl md:text-5xl font-black text-gray-900 leading-tight">{entry.title}</h1></div> <div className="prose prose-lg text-gray-800 whitespace-pre-wrap leading-loose font-serif">{entry.content || <span className="text-gray-400 italic">記述なし</span>}</div> {entry.tags && entry.tags.length > 0 && (<div className="mt-10 pt-6 border-t border-gray-100"><div className="flex flex-wrap gap-2">{entry.tags.map(tag => <NationTag key={tag} text={tag} nations={nations} year={entry.year} />)}</div></div>)} </div> </div> );

// --- StatsInputModal コンポーネント (修正版: 高さ制限・内部スクロール対応) ---
const StatsInputModal = ({ showStatsInput, setShowStatsInput, nations, stats, setStats }) => {
    const [year, setYear] = useState(DEFAULT_YEAR);
    const [inputData, setInputData] = useState({});

    // 初期データのロード
    useEffect(() => {
        const existingStats = stats.filter(s => s.year === parseInt(year));
        const map = {};
        existingStats.forEach(s => {
            map[s.nationId] = { population: s.population, gdp: s.gdp };
        });
        setInputData(map);
    }, [year, stats]);

    if (!showStatsInput) return null;

    const handleInputChange = (nationId, field, value) => {
        setInputData(prev => ({
            ...prev,
            [nationId]: { ...prev[nationId], [field]: value }
        }));
    };

    const saveStats = () => {
        // 既存の同年のデータを削除して上書き保存する（重複防止）
        const newStats = [...stats.filter(s => s.year !== parseInt(year))];
        Object.entries(inputData).forEach(([nationId, data]) => {
            if (data && (data.population || data.gdp)) {
                newStats.push({
                    id: `stats_${year}_${nationId}`,
                    year: parseInt(year),
                    nationId,
                    population: parseFloat(data.population) || 0,
                    gdp: parseFloat(data.gdp) || 0
                });
            }
        });
        setStats(newStats);
        setShowStatsInput(false);
    };

    return (
        // z-indexを大きくして、メイン画面のヘッダー(z-50)より上に来るようにする
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 sm:p-6">
            {/* max-h-[90vh] で画面からはみ出さないように制限し、flex-colで縦並びにする */}
            <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl flex flex-col max-h-[90vh] animate-fade-in overflow-hidden">
                
                {/* --- ヘッダー (固定) --- */}
                <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0 bg-white">
                    <h2 className="text-xl font-bold flex items-center gap-2 text-gray-800">
                        <Icons.BarChart2 size={24} className="text-blue-600"/> 統計データ記録
                    </h2>
                    <button onClick={() => setShowStatsInput(false)} className="text-gray-400 hover:text-gray-600 p-1 rounded transition-colors">
                        <Icons.X size={24} />
                    </button>
                </div>

                {/* --- 年設定エリア (固定) --- */}
                <div className="p-4 bg-gray-50 border-b border-gray-200 flex-shrink-0">
                    <div className="flex items-center gap-4">
                        <label className="font-bold text-gray-700">対象年:</label>
                        <div className="relative">
                            <input 
                                type="number" 
                                value={year} 
                                onChange={e => setYear(e.target.value)} 
                                className="pl-3 pr-10 py-2 border border-gray-300 rounded-lg w-32 font-bold text-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" 
                            />
                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">年</span>
                        </div>
                    </div>
                </div>

                {/* --- リストエリア (ここだけスクロールする) --- */}
                <div className="overflow-y-auto flex-grow custom-scrollbar bg-white">
                    <table className="w-full text-sm text-left whitespace-nowrap">
                        {/* テーブルヘッダーをstickyにして追従させる */}
                        <thead className="text-xs uppercase bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th className="px-4 py-3 font-bold border-b border-gray-200">国家 (現在の名称)</th>
                                <th className="px-4 py-3 font-bold border-b border-gray-200 w-40">人口 (人)</th>
                                <th className="px-4 py-3 font-bold border-b border-gray-200 w-48">GDP (円)</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {nations.map(n => {
                                const info = getNationInfo(n, year);
                                // 滅亡した国もデータ入力できるよう表示は残すが、薄くするなどの処理はお好みで
                                const isDimmed = info.isCollapsed || info.isFuture;
                                
                                return (
                                    <tr key={n.id} className={`hover:bg-blue-50/50 transition-colors ${isDimmed ? 'opacity-60 bg-gray-50' : ''}`}>
                                        <td className="px-4 py-3 font-bold flex gap-3 items-center">
                                            {info.flag ? (
                                                <img src={info.flag} className="w-8 h-5 object-cover border border-gray-200 shadow-sm" />
                                            ) : (
                                                <div className="w-8 h-5 bg-gray-200 border border-gray-300"></div>
                                            )}
                                            <div className="flex flex-col">
                                                <span className="text-gray-800">{info.name}</span>
                                                {isDimmed && <span className="text-[10px] text-gray-400 font-normal">{info.isFuture ? '(未成立)' : '(滅亡・変遷済)'}</span>}
                                            </div>
                                        </td>
                                        <td className="px-4 py-3">
                                            <input 
                                                type="number" 
                                                placeholder="0"
                                                value={inputData[n.id]?.population || ''} 
                                                onChange={e => handleInputChange(n.id, 'population', e.target.value)} 
                                                className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-right font-mono" 
                                            />
                                        </td>
                                        <td className="px-4 py-3">
                                            <input 
                                                type="number" 
                                                placeholder="0"
                                                value={inputData[n.id]?.gdp || ''} 
                                                onChange={e => handleInputChange(n.id, 'gdp', e.target.value)} 
                                                className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-right font-mono" 
                                            />
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>

                {/* --- フッター (固定) --- */}
                <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-end flex-shrink-0">
                    <button onClick={saveStats} className="bg-blue-900 text-white px-8 py-2.5 rounded-lg font-bold shadow-md hover:bg-blue-800 transition-transform active:scale-95 flex items-center gap-2">
                        <Icons.Save size={18} /> 保存して閉じる
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- LevelInfoModal コンポーネント (修正版) ---
const LevelInfoModal = ({ isOpen, onClose }) => {
    if (!isOpen) return null;
    
    // ランク定義 (アイコンコンポーネントをマッピング)
    const ranks = [
        { range: '~7', label: '一般市民', ruby: '', color: 'text-gray-500', bg: 'bg-gray-100', icon: Icons.User, desc: '非戦闘員。武器を持ったことがない人々。' },
        { range: '8~14', label: '駆け出し', ruby: '', color: 'text-stone-600', bg: 'bg-stone-100', icon: Icons.Dagger, desc: '基礎的な武装を整え、実戦の空気に触れ始めた段階。訓練中の従卒、あるいは街のゴロツキなど。一般人相手なら圧倒できるが、正規兵の放つ殺気にはまだ足がすくむレベル。この世界の人間の平均。' },
        { range: '15~24', label: '正規兵', ruby: '', color: 'text-blue-700', bg: 'bg-blue-100', icon: Icons.Shield, desc: '一人前の戦力。基礎訓練を終え、組織的な戦闘ができる状態。' },
        { range: '25~39', label: '精鋭', ruby: 'エリート', color: 'text-cyan-700', bg: 'bg-cyan-100', icon: Icons.Crosshair, desc: '正規兵の中から選抜された、特殊工作や要人警護を担う実力者。正確無比な連携攻撃で対象を確実に排除する。一般兵にとっては雲の上の存在であり、現場の小隊長クラス。' },
        { range: '40~49', label: '歴戦の古強者', ruby: 'ベテラン', color: 'text-teal-700', bg: 'bg-teal-100', icon: Icons.Award, desc: '数々の修羅場をくぐり抜けてきた生存者。一般兵では歯が立たない。' },
        { range: '50~59', label: '武芸の達人', ruby: 'マスター', color: 'text-emerald-700', bg: 'bg-emerald-100', icon: Icons.Eye, desc: '生涯をかけて一つの技術を極限まで研ぎ澄ませた求道者。大規模な破壊魔法などは使えない場合もあるが、対人戦闘の間合いや技術においては「古強者」すら赤子のようにあしらう。' },
        { range: '60~69', label: '一騎当千の猛者', ruby: 'エース', color: 'text-orange-700', bg: 'bg-orange-100', icon: Icons.Swords, desc: '戦場の支配者。単独で戦況をひっくり返せる実力者。兵士1000人に匹敵すると言われる、個の武力の到達点。' },
        { range: '70~79', label: '救国の英雄', ruby: 'ヒーロー', color: 'text-red-700', bg: 'bg-red-100', icon: Icons.Zap, desc: 'その名を知らぬ者はいない、吟遊詩人の物語の主役たち。単独での戦闘能力に加え、戦場に立つだけで味方の全能力を底上げし、敗色濃厚な戦況すら覆す「希望」そのもの。' },
        { range: '80~89', label: '国を背負う最高戦力', ruby: 'スペリオル', color: 'text-purple-700', bg: 'bg-purple-100', icon: Icons.Castle, desc: '「あの人が動くなら戦争になる」と他国が警戒するレベル。大列強の将軍、宮廷魔導師筆頭など、国家の存亡に関わる力。' },
        { range: '90~99', label: '超越者', ruby: 'トランセンデント', color: 'text-fuchsia-700', bg: 'bg-fuchsia-100', icon: Icons.Sun, desc: '人の身でありながら、生物としての限界を完全に逸脱してしまった特異点。もはや国や組織の制御を受け付けず、その気になれば単独で地図を書き換えることすら可能な、歩く大災害。' },
        { range: '100~', label: '祝福を受けた者', ruby: 'ソヴリン', color: 'text-yellow-700', bg: 'bg-yellow-100', icon: Icons.Crown, desc: '時代や国境を超えて語り継がれる存在。子供たちが憧れ、神話に名前が刻まれるレベル。悪としても善としても。' },
    ];

    return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[150] p-4 animate-fade-in" onClick={onClose}>
            <div className="bg-white rounded-lg shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-indigo-900 text-white p-4 flex justify-between items-center shrink-0">
                    <h3 className="font-bold text-lg flex items-center gap-2"><Icons.Activity size={20} className="text-yellow-400"/> 魂位深度 (レベル) について</h3>
                    <button onClick={onClose}><Icons.X size={20}/></button>
                </div>
                <div className="p-6 text-sm text-gray-700 leading-relaxed overflow-y-auto custom-scrollbar">
                    <p className="mb-4">
                        <span className="font-bold text-indigo-900">レベル (Lv)</span> とは、すべての生命体の<span className="font-bold">「魂の格」</span>を同一の尺度で計る絶対指標です。
                        レベルが高ければ高いほど、魔法などの超常的な力が強化され、世界への干渉力が増大します。
                    </p>
                    
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 className="font-bold text-xs text-gray-500 border-b pb-1 mb-3">階梯目安</h4>
                        <div className="grid grid-cols-[50px_32px_1fr] gap-x-3 gap-y-6 items-start">
                            {ranks.map((rank, idx) => (
                                <React.Fragment key={idx}>
                                    <span className={`font-mono font-bold text-right mt-1.5 ${rank.color.replace('700','500')}`}>{rank.range}</span>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center shadow-sm border border-white ring-1 ring-opacity-20 ring-black mt-0.5 ${rank.bg} ${rank.color}`}>
                                        <rank.icon size={16} />
                                    </div>
                                    <div>
                                        <span className={`font-bold text-base ${rank.color}`}>
                                            {rank.ruby ? <ruby>{rank.label}<rt>{rank.ruby}</rt></ruby> : rank.label}
                                        </span>
                                        <p className="text-xs text-gray-500 mt-1 leading-relaxed">{rank.desc}</p>
                                    </div>
                                </React.Fragment>
                            ))}
                        </div>
                    </div>
                    <p className="text-xs text-gray-400 text-right mt-2">※Lv差が20開くと、下位の攻撃は上位に殆ど通用しなくなると言われている。</p>
                </div>
            </div>
        </div>
    );
};

// --- KeySelectionModal コンポーネント (新規: 重要人物/組織の選択・並び替え) ---
const KeySelectionModal = ({ isOpen, onClose, title, candidates, selectedIds, onSave }) => {
    const [currentSelectedIds, setCurrentSelectedIds] = useState([]);

    useEffect(() => {
        if (isOpen) setCurrentSelectedIds(selectedIds || []);
    }, [isOpen, selectedIds]);

    if (!isOpen) return null;

    const handleToggle = (id) => {
        if (currentSelectedIds.includes(id)) {
            setCurrentSelectedIds(prev => prev.filter(pid => pid !== id));
        } else {
            setCurrentSelectedIds(prev => [...prev, id]);
        }
    };

    const moveUp = (index) => {
        if (index === 0) return;
        const newList = [...currentSelectedIds];
        [newList[index - 1], newList[index]] = [newList[index], newList[index - 1]];
        setCurrentSelectedIds(newList);
    };

    const moveDown = (index) => {
        if (index === currentSelectedIds.length - 1) return;
        const newList = [...currentSelectedIds];
        [newList[index + 1], newList[index]] = [newList[index], newList[index + 1]];
        setCurrentSelectedIds(newList);
    };

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[80vh] animate-fade-in overflow-hidden">
                <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 className="font-bold text-gray-800">{title}の設定</h3>
                    <button onClick={onClose}><Icons.X size={20} className="text-gray-400 hover:text-gray-600"/></button>
                </div>
                <div className="flex-grow overflow-hidden flex p-4 gap-4">
                    {/* 左：候補リスト */}
                    <div className="w-1/2 flex flex-col">
                        <span className="text-xs font-bold text-gray-500 mb-2">関連リスト (選択して追加)</span>
                        <div className="flex-grow border rounded bg-gray-50 overflow-y-auto p-2 space-y-1">
                            {candidates.map(c => {
                                const isSelected = currentSelectedIds.includes(c.id);
                                return (
                                    <div key={c.id} onClick={() => !isSelected && handleToggle(c.id)} 
                                         className={`p-2 rounded text-sm flex items-center gap-2 cursor-pointer border ${isSelected ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-default' : 'bg-white hover:bg-blue-50 border-gray-200 shadow-sm'}`}>
                                        {isSelected ? <div className="w-4 h-4 border-2 border-gray-300 rounded bg-gray-300 flex items-center justify-center"><Icons.X size={10} className="text-white"/></div> : <div className="w-4 h-4 border-2 border-gray-400 rounded"></div>}
                                        <span className="truncate">{c.name}</span>
                                    </div>
                                );
                            })}
                            {candidates.length === 0 && <div className="text-xs text-gray-400 text-center py-4">候補がありません</div>}
                        </div>
                    </div>
                    {/* アイコン */}
                    <div className="flex flex-col justify-center items-center text-gray-400">
                        <Icons.ChevronRight size={24}/>
                    </div>
                    {/* 右：選択済み（並び替え） */}
                    <div className="w-1/2 flex flex-col">
                        <span className="text-xs font-bold text-blue-600 mb-2">重要項目 (順序変更可)</span>
                        <div className="flex-grow border-2 border-blue-100 rounded bg-white overflow-y-auto p-2 space-y-1">
                            {currentSelectedIds.map((id, idx) => {
                                const item = candidates.find(c => c.id === id) || { name: '不明なデータ', id };
                                return (
                                    <div key={id} className="p-2 rounded text-sm flex items-center justify-between bg-blue-50 border border-blue-200 shadow-sm group">
                                        <span className="truncate font-bold text-blue-900">{idx + 1}. {item.name}</span>
                                        <div className="flex items-center gap-1 opacity-60 group-hover:opacity-100">
                                            <button onClick={() => moveUp(idx)} disabled={idx === 0} className="p-1 hover:bg-blue-200 rounded disabled:opacity-30"><Icons.ChevronDown size={12} className="rotate-180"/></button>
                                            <button onClick={() => moveDown(idx)} disabled={idx === currentSelectedIds.length - 1} className="p-1 hover:bg-blue-200 rounded disabled:opacity-30"><Icons.ChevronDown size={12}/></button>
                                            <button onClick={() => handleToggle(id)} className="p-1 hover:bg-red-200 text-red-500 rounded ml-1"><Icons.X size={12}/></button>
                                        </div>
                                    </div>
                                );
                            })}
                            {currentSelectedIds.length === 0 && <div className="text-xs text-gray-400 text-center py-4">選択されていません</div>}
                        </div>
                    </div>
                </div>
                <div className="p-4 border-t bg-gray-50 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded text-sm font-bold">キャンセル</button>
                    <button onClick={() => onSave(currentSelectedIds)} className="px-6 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 text-sm font-bold flex items-center gap-2"><Icons.Save size={16}/> 保存</button>
                </div>
            </div>
        </div>
    );
};

// --- ItemDetailModal コンポーネント (修正版: ヘッダーにLv表示追加) ---
const ItemDetailModal = ({ item, type, onClose, parseRuby }) => {
    if (!item) return null;

    const isChar = type === 'char';
    const imageSrc = isChar ? item.portrait : item.logo;
    const DefaultIcon = isChar ? Icons.User : Icons.Briefcase;
    const raceInfo = isChar ? RACES.find(r => r.label === item.race) : null;
    const labelColor = raceInfo?.color || '#9ca3af';
    
    const period = isChar 
        ? `${item.birthYear || '?'} - ${item.deathYear || '?'}`
        : `${item.activeStart || '?'} - ${item.activeEnd || '...'}`;

    return (
        <div className="fixed inset-0 z-[120] bg-black/70 backdrop-blur-sm overflow-y-auto" onClick={onClose}>
            <div className="min-h-screen flex items-center justify-center p-4 sm:p-6">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl h-auto relative p-8 animate-fade-in" onClick={e => e.stopPropagation()}>
                    
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10">
                        <Icons.X size={20} />
                    </button>

                    <div className="flex flex-col">
                        <div className="flex flex-col sm:flex-row items-center sm:items-end gap-6 mb-8 border-b border-gray-100 pb-6">
                            <div className="w-32 h-32 rounded-2xl bg-gray-50 p-1 shadow-lg border border-gray-200 shrink-0 overflow-hidden">
                                {imageSrc ? (
                                    <img src={imageSrc} className="w-full h-full object-cover rounded-xl" />
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center text-gray-300">
                                        <DefaultIcon size={48} />
                                    </div>
                                )}
                            </div>
                            <div className="flex-grow text-center sm:text-left">
                                <div className="flex flex-wrap justify-center sm:justify-start items-center gap-2 mb-2">
                                    <span className="px-2.5 py-0.5 rounded text-[11px] font-bold text-white shadow-sm tracking-wide" style={{backgroundColor: labelColor}}>
                                        {isChar ? item.race : (ORG_TYPES.find(t=>t.key===item.type)?.label || '組織')}
                                    </span>
                                    {isChar && raceInfo?.ruby && (
                                        <span className="text-[10px] text-gray-500 font-bold bg-gray-100 px-2 py-0.5 rounded border border-gray-200">
                                            {raceInfo.ruby}
                                        </span>
                                    )}
                                    {/* ★追加: Lv表示 */}
                                    {isChar && item.level && (
                                        <span className="text-[11px] font-mono font-bold text-white bg-indigo-500 px-2 py-0.5 rounded shadow-sm">
                                            Lv.{item.level}
                                        </span>
                                    )}
                                    <span className="text-xs font-mono font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200">
                                        <span className="opacity-50 mr-1">TIME:</span>{period}
                                    </span>
                                </div>
                                <h2 className="text-3xl sm:text-4xl font-black leading-tight tracking-tight text-gray-900">
                                    {item.name}
                                </h2>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-2 space-y-4">
                                <h4 className="text-xs font-bold text-gray-400 uppercase flex items-center gap-2 pb-1 border-b border-gray-100">
                                    <Icons.FileText size={14} className="text-yellow-500"/> 概要・詳細
                                </h4>
                                <div className="text-base leading-loose text-gray-700 ql-editor font-serif" style={{padding:0}}>
                                    {item.note ? (
                                        <div dangerouslySetInnerHTML={{ __html: parseRuby(item.note) }} />
                                    ) : (
                                        <p className="text-gray-400 text-sm italic p-4 border border-dashed rounded bg-gray-50 text-center">詳細な記述はありません。</p>
                                    )}
                                </div>
                            </div>

                            <div className="lg:col-span-1">
                                <div className="bg-gray-50 rounded-xl p-5 border border-gray-100 h-full">
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-4 flex items-center gap-2">
                                        {isChar ? <><Icons.Briefcase size={14} className="text-blue-500"/> 所属・関連組織</> : <><Icons.User size={14} className="text-blue-500"/> 主要人物・構成員</>}
                                    </h4>
                                    <div className="space-y-2">
                                        {(isChar ? item.affiliations : item.keyPeople)?.length > 0 ? (
                                            (isChar ? item.affiliations : item.keyPeople).map((aff, idx) => {
                                                const name = typeof aff === 'string' ? aff : aff.name;
                                                const role = typeof aff === 'object' && aff.role ? aff.role : '';
                                                return (
                                                    <div key={idx} className="flex items-center justify-between p-2 bg-white border border-gray-200 rounded-lg shadow-sm">
                                                        <span className="font-bold text-sm text-gray-800 truncate pr-2">{name}</span>
                                                        {role && <span className="text-[10px] font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200 shrink-0">{role}</span>}
                                                    </div>
                                                );
                                            })
                                        ) : (
                                            <p className="text-xs text-gray-400 text-center py-2">登録なし</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- NationProfileView コンポーネント (修正版: 構造図ズレ修正・タブ追加) ---
const NationProfileView = ({ setView, nation: initialNation, nations, entries, stats, characters, organizations, onEditEntry, onEditNation, onEditStats, onEditOverview, updateNation }) => {
    const [activeTab, setActiveTab] = useState('overview');
    const [isKeyCharModalOpen, setIsKeyCharModalOpen] = useState(false);
    const [isKeyOrgModalOpen, setIsKeyOrgModalOpen] = useState(false);
    const [viewingItem, setViewingItem] = useState(null);

    const nation = useMemo(() => nations.find(n => n.id === initialNation.id) || initialNation, [nations, initialNation]);

    useEffect(() => {
        if (document.getElementById('quill-custom-styles')) return;
        const style = document.createElement('style');
        style.id = 'quill-custom-styles';
        style.innerHTML = `
            .ql-font-gothic { font-family: 'Yu Gothic', 'YuGothic', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; }
            .ql-font-mincho { font-family: 'Yu Mincho', 'YuMincho', 'Hiragino Mincho ProN', 'HGS Mincho E', 'MS PMincho', serif; }
            .ql-font-serif { font-family: 'Times New Roman', 'YuMincho', serif; }
            .ql-font-sans-serif { font-family: Arial, Helvetica, sans-serif; }
            .ql-font-monospace { font-family: 'Courier New', Courier, monospace; }
        `;
        document.head.appendChild(style);
    }, []);

    if (!nation) return null;

    const { relatedEntries, relatedChars, relatedOrgs, sortedEras } = useMemo(() => {
        const targetNames = new Set([nation.name]);
        const targetEraIds = new Set();
        if (nation.eras) {
            nation.eras.forEach((era, idx) => {
                if (era.name) targetNames.add(era.name);
                targetEraIds.add(`${nation.id}_era_${idx}`);
            });
        }
        const rEntries = entries.filter(e => e.tags && e.tags.some(tag => targetNames.has(tag))).sort((a, b) => a.year - b.year);
        const rChars = characters.filter(c => c.affiliations && c.affiliations.some(aff => targetNames.has(typeof aff === 'string' ? aff : aff.name)));
        const rOrgs = organizations.filter(o => o.affiliationId === nation.id || targetEraIds.has(o.affiliationId));

        return { 
            relatedEntries: rEntries, 
            relatedChars: rChars, 
            relatedOrgs: rOrgs,
            sortedEras: (nation.eras || []).sort((a, b) => a.startYear - b.startYear)
        };
    }, [entries, characters, organizations, nation]);

    const relatedStats = useMemo(() => stats.filter(s => s.nationId === nation.id).sort((a, b) => a.year - b.year), [stats, nation]);

    // 権力構造データの取得
    const powerStructureData = useMemo(() => {
        const raw = nation.powerStructure;
        if (!raw) return [];
        return Array.isArray(raw) ? raw : [raw];
    }, [nation]);

    const handleSaveKeyChars = (ids) => { updateNation({ ...nation, keyCharacterIds: ids }); setIsKeyCharModalOpen(false); };
    const handleSaveKeyOrgs = (ids) => { updateNation({ ...nation, keyOrganizationIds: ids }); setIsKeyOrgModalOpen(false); };

    const textOutlineStyle = { textShadow: '2px 2px 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff, 2px 0 0 #fff, -2px 0 0 #fff, 0 2px 0 #fff, 0 -2px 0 #fff' };
    const parseRuby = (html) => html ? html.replace(/\[(.*?)\|(.*?)\]/g, '<ruby>$1<rt>$2</rt></ruby>') : '';

    // ★修正: ツリー表示用CSS (Flexboxによるセンタリングを強化)
    const treeCss = `
        .tf-tree { display: flex; text-align: center; }
        .tf-tree ul { 
            padding-top: 20px; 
            position: relative; 
            display: flex; 
            justify-content: center;
            padding-inline-start: 0; 
            margin: 0;
        }
        .tf-tree li { 
            list-style-type: none; 
            position: relative; 
            padding: 20px 5px 0 5px; 
            display: flex;           /* Flexbox化 */
            flex-direction: column;  /* 縦並び */
            align-items: center;     /* 中央揃え (これでズレが直ります) */
        }
        .tf-tree li::before, .tf-tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #ccc; width: 50%; height: 20px; }
        .tf-tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tf-tree li:only-child::after, .tf-tree li:only-child::before { display: none; }
        .tf-tree li:only-child { padding-top: 0; }
        .tf-tree li:first-child::before { border: 0 none; }
        .tf-tree li:last-child::after { border: 0 none; }
        .tf-tree li:last-child::before { border-right: 1px solid #ccc; border-radius: 0 5px 0 0; }
        .tf-tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tf-tree ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #ccc; width: 0; height: 20px; }
    `;

    // ツリーノードのレンダリング（閲覧用）
    const renderReadOnlyTree = (node) => {
        let linkedData = null;
        let imageSrc = null;
        let DefaultIcon = Icons.User;
        
        if (node.linkType === 'org' && node.linkId) {
            linkedData = organizations.find(o => o.id === node.linkId);
            imageSrc = linkedData?.logo;
            DefaultIcon = Icons.Briefcase;
        } else if (node.linkType === 'char' && node.linkId) {
            linkedData = characters.find(c => c.id === node.linkId);
            imageSrc = linkedData?.portrait;
            DefaultIcon = Icons.User;
        }

        return (
            <li key={node.id}>
                 <div className="flex flex-col items-center bg-white border border-gray-300 rounded shadow-sm min-w-[140px] max-w-[180px] overflow-hidden hover:shadow-md transition-shadow z-10 relative">
                    {/* Header/Image */}
                    <div className="w-full h-12 bg-gray-50 flex items-center justify-center border-b border-gray-200 relative overflow-hidden">
                         {imageSrc ? <img src={imageSrc} className="w-full h-full object-cover" /> : <DefaultIcon className="text-gray-300" />}
                         {node.linkType && <div className={`absolute top-0 left-0 p-0.5 text-white text-[8px] ${node.linkType === 'org' ? 'bg-blue-500' : 'bg-green-500'}`}>{node.linkType === 'org' ? <Icons.Briefcase size={8}/> : <Icons.User size={8}/>}</div>}
                    </div>
                    {/* Content */}
                    <div className="p-2 text-center w-full">
                        <div className="font-bold text-sm text-gray-800 leading-tight mb-0.5">{node.name}</div>
                        {node.title && <div className="text-[10px] text-gray-500 mb-1">{node.title}</div>}
                        {linkedData ? (
                            <div 
                                className="text-[10px] bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded truncate mx-auto border border-blue-100 cursor-pointer hover:bg-blue-100 transition-colors"
                                onClick={(e) => { e.stopPropagation(); setViewingItem({item: linkedData, type: node.linkType}); }}
                            >
                                {linkedData.name}
                            </div>
                        ) : (
                            <div className="text-[9px] text-gray-300">-</div>
                        )}
                    </div>
                 </div>
                 {node.children && node.children.length > 0 && <ul>{node.children.map(child => renderReadOnlyTree(child))}</ul>}
            </li>
        );
    };

    const SidebarKeyList = ({ title, icon: Icon, items, allItems, onEdit, type, onItemClick }) => (
        <div className="bg-white p-6 rounded-lg shadow border border-gray-200 relative group/sidebar">
            <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-gray-500 text-xs uppercase flex items-center gap-2"><Icon size={16}/> {title}</h3>
                <button onClick={onEdit} className="text-xs bg-gray-100 text-gray-600 border border-gray-200 px-2 py-1 rounded hover:bg-gray-200 flex items-center gap-1 transition-colors">
                    <Icons.Edit2 size={12} /> 編集
                </button>
            </div>
            <div className="space-y-3">
                {items && items.length > 0 ? items.map(id => {
                    const item = allItems.find(i => i.id === id);
                    if (!item) return null;
                    let role = '';
                    if (type === 'char') {
                        const aff = item.affiliations?.find(a => (typeof a === 'string' ? a : a.name) === nation.name) || item.affiliations?.[0];
                        role = (typeof aff === 'object' && aff.role) ? aff.role : '';
                    }
                    const rank = type === 'char' ? getLevelRank(item.level) : null;
                    return (
                        <div key={id} onClick={() => onItemClick(item, type)} className="flex items-center gap-3 p-2 rounded border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-md cursor-pointer transition-all">
                            <div className="w-10 h-10 rounded-full bg-gray-200 border border-gray-300 overflow-hidden flex-shrink-0">
                                {(type === 'char' ? item.portrait : item.logo) ? <img src={type === 'char' ? item.portrait : item.logo} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-400"><Icon size={16}/></div>}
                            </div>
                            <div className="overflow-hidden">
                                <div className="font-bold text-sm text-gray-800 truncate">{item.name}</div>
                                {role && <div className="text-xs text-blue-600 font-bold">{role}</div>}
                                <div className="flex flex-wrap items-center gap-1 mt-0.5">
                                    {!role && type === 'org' && item.type && <span className="text-xs text-gray-400">{ORG_TYPES.find(t=>t.key===item.type)?.label}</span>}
                                    {type === 'char' && item.level && rank ? (
                                        <span className={`inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[10px] font-bold border ${rank.bg} ${rank.color} ${rank.border}`}>
                                            <rank.icon size={10} /> <span className="font-mono">Lv.{item.level}</span>
                                        </span>
                                    ) : ( type === 'char' && item.level && <span className="font-mono font-bold text-indigo-400 text-xs">Lv.{item.level}</span> )}
                                </div>
                            </div>
                        </div>
                    );
                }) : (
                    <div className="text-center py-4 border-2 border-dashed border-gray-100 rounded">
                        <p className="text-xs text-gray-400 mb-2">設定なし</p>
                        <button onClick={onEdit} className="text-xs text-blue-500 hover:underline">選択</button>
                    </div>
                )}
            </div>
        </div>
    );

    return (
        <div className="space-y-6 animate-fade-in pb-20">
            <KeySelectionModal isOpen={isKeyCharModalOpen} onClose={() => setIsKeyCharModalOpen(false)} title="重要人物" candidates={relatedChars} selectedIds={nation.keyCharacterIds} onSave={handleSaveKeyChars} />
            <KeySelectionModal isOpen={isKeyOrgModalOpen} onClose={() => setIsKeyOrgModalOpen(false)} title="主要組織" candidates={relatedOrgs} selectedIds={nation.keyOrganizationIds} onSave={handleSaveKeyOrgs} />
            <ItemDetailModal item={viewingItem?.item} type={viewingItem?.type} onClose={() => setViewingItem(null)} parseRuby={parseRuby} />

            {/* "一覧へ戻る" ボタンのみ配置 (年表へ戻る は削除済み) */}
            <div className="flex items-center gap-4">
                <button onClick={() => setView('nation_list')} className="flex items-center gap-2 px-4 py-2 bg-white text-gray-700 font-bold rounded-lg shadow hover:bg-gray-50 transition-colors border border-gray-200">
                    <Icons.ArrowLeft size={20} /> 一覧へ戻る
                </button>
            </div>

            <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden relative">
                <div className="h-32 w-full relative overflow-hidden" style={{ backgroundColor: nation.color || '#1f2937' }}>
                    {nation.flag && <img src={nation.flag} className="w-full h-full object-cover opacity-30 blur-xl scale-110" />}
                    <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                </div>
                <div className="px-8 pb-0 relative flex flex-col md:flex-row items-end gap-6 -mt-16">
                    <div className="w-40 h-28 bg-white p-1 shadow-xl border-4 border-white flex-shrink-0 rounded-sm relative z-10">
                        {nation.flag ? <img src={nation.flag} className="w-full h-full object-cover border border-gray-200" /> : <div className="w-full h-full bg-gray-100 flex items-center justify-center text-gray-400 text-xs font-bold">No Image</div>}
                    </div>
                    <div className="flex-grow mb-4 relative z-10">
                        <div className="flex items-center justify-between">
                            <div>
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="bg-yellow-100 border border-yellow-300 text-yellow-800 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">{LOCATIONS[nation.location || 'unknown']?.label}</span>
                                    <span className="bg-gray-100 border border-gray-300 text-gray-600 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">{NATION_RANKS[nation.rank || 'minor_power']?.label}</span>
                                </div>
                                <h1 className="text-4xl font-black tracking-tight text-gray-900 leading-none mb-2" style={textOutlineStyle}>{nation.name}</h1>
                                <div className="flex gap-3 text-xs font-mono text-gray-500">
                                    <span className="bg-white/80 px-1.5 py-0.5 rounded border border-gray-200 backdrop-blur-sm">ID: {nation.id}</span>
                                </div>
                            </div>
                            <button onClick={onEditNation} className="mb-2 mr-2 bg-white/90 hover:bg-white text-gray-700 border border-gray-300 shadow-sm px-3 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                                <Icons.Settings size={16} /> <span className="hidden sm:inline">国家設定を編集</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div className="flex px-8 pt-4 border-t border-gray-100 bg-gray-50/50 gap-1 overflow-x-auto">
                    {[
                        {id: 'overview', icon: Icons.FileText, label: '概要・変遷'},
                        {id: 'characters', icon: Icons.User, label: '関連人物', badge: relatedChars.length},
                        {id: 'organizations', icon: Icons.Briefcase, label: '関連組織', badge: relatedOrgs.length},
                        {id: 'structure', icon: Icons.Structure, label: '統治機構'}, // ★追加
                        {id: 'stats', icon: Icons.Activity, label: '統計データ'},
                        {id: 'timeline', icon: Icons.List, label: '関連年表', badge: relatedEntries.length},
                    ].map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-6 py-3 text-sm font-bold border-b-4 transition-colors whitespace-nowrap flex items-center gap-2 ${activeTab === tab.id ? 'border-yellow-500 text-gray-900 bg-yellow-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'}`}>
                            <tab.icon size={18} /> {tab.label}
                            {tab.badge > 0 && <span className="bg-gray-200 text-gray-600 text-[10px] px-1.5 rounded-full">{tab.badge}</span>}
                        </button>
                    ))}
                </div>
            </div>

            <div className="animate-fade-in">
                {activeTab === 'overview' && (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white p-8 rounded-lg shadow border border-gray-200 min-h-[300px] relative">
                                <div className="flex justify-between items-center border-b pb-3 mb-4">
                                    <h3 className="font-bold text-gray-800 text-lg flex items-center gap-2"><Icons.BookOpen size={20} className="text-yellow-600"/> 国家概要</h3>
                                    <button onClick={onEditOverview} className="bg-yellow-100 text-yellow-800 border border-yellow-300 px-3 py-1.5 rounded font-bold text-xs flex items-center gap-1 hover:bg-yellow-200 transition-colors shadow-sm"><Icons.Edit2 size={14} /> 概要を編集</button>
                                </div>
                                {nation.note ? <div className="text-base leading-loose text-gray-800 font-serif ql-editor" style={{ padding: 0, overflow: 'visible' }} dangerouslySetInnerHTML={{ __html: parseRuby(nation.note) }} /> : <div className="text-center py-10"><p className="text-gray-400 italic font-serif mb-4">記述がありません。</p><button onClick={onEditOverview} className="text-blue-600 hover:underline text-sm">編集して追加する</button></div>}
                            </div>
                        </div>
                        <div className="lg:col-span-1 space-y-6">
                            <SidebarKeyList title="重要人物" icon={Icons.User} items={nation.keyCharacterIds} allItems={characters} onEdit={() => setIsKeyCharModalOpen(true)} type="char" onItemClick={(item, type) => setViewingItem({item, type})} />
                            <SidebarKeyList title="主要組織" icon={Icons.Briefcase} items={nation.keyOrganizationIds} allItems={organizations} onEdit={() => setIsKeyOrgModalOpen(true)} type="org" onItemClick={(item, type) => setViewingItem({item, type})} />
                            <div className="bg-white p-6 rounded-lg shadow border border-gray-200">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-gray-500 text-xs uppercase flex items-center gap-2"><Icons.History size={16}/> 歴史的変遷</h3>
                                    <button onClick={onEditNation} className="text-xs bg-gray-100 text-gray-600 border border-gray-200 px-2 py-1 rounded hover:bg-gray-200 flex items-center gap-1"><Icons.Settings size={12} /> 変遷を編集</button>
                                </div>
                                <div className="relative border-l-2 border-gray-200 ml-3 space-y-8 py-2">
                                    {sortedEras.map((era, idx) => {
                                        const isCollapse = era.type === 'collapse';
                                        let eventBadge = null;
                                        const eventType = era.event?.type;
                                        if (eventType && eventType !== 'none') {
                                            const eventDef = ERA_EVENT_TYPES[eventType];
                                            if (eventDef) {
                                                const targetIds = era.event.targetIds || (era.event.targetId ? [era.event.targetId] : []);
                                                const targetNames = targetIds.map(tid => {
                                                    const n = nations.find(nav => nav.id === tid);
                                                    return n ? n.name : '';
                                                }).filter(n => n).join('・');
                                                let labelText = eventDef.label;
                                                let badgeClass = "bg-gray-100 text-gray-600 border-gray-200";
                                                if (['annexed_by', 'merger'].includes(eventType)) { labelText = targetNames ? `${targetNames}に併合` : "他国に併合"; badgeClass = "bg-red-50 text-red-600 border-red-100"; } 
                                                else if (eventType === 'partitioned_by') { labelText = targetNames ? `${targetNames}により分割` : "分割統治される"; badgeClass = "bg-red-50 text-red-600 border-red-100"; } 
                                                else if (['independence', 'splinter'].includes(eventType)) { labelText = targetNames ? `${targetNames}より${eventDef.label}` : eventDef.label; badgeClass = "bg-indigo-50 text-indigo-700 border-indigo-100"; } 
                                                else if (eventType === 'foundation') { labelText = "建国・成立"; badgeClass = "bg-green-50 text-green-700 border-green-100"; } 
                                                else if (eventType === 'foundation_puppet') { labelText = targetNames ? `${targetNames}の傀儡として成立` : "傀儡国として成立"; badgeClass = "bg-purple-50 text-purple-700 border-purple-100"; } 
                                                else if (eventType === 'regime_change') { labelText = "政体変更"; badgeClass = "bg-blue-50 text-blue-700 border-blue-100"; } 
                                                else if (eventType === 'be_puppet') { labelText = targetNames ? `${targetNames}の傀儡になる` : "傀儡化される"; badgeClass = "bg-purple-50 text-purple-700 border-purple-100"; }
                                                eventBadge = ( <span className={`inline-flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded border ${badgeClass} mt-1 w-fit`}> {eventDef.icon} {labelText} </span> );
                                            }
                                        }
                                        return (
                                            <div key={idx} className="relative pl-6">
                                                <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 border-white shadow-sm ${isCollapse ? 'bg-gray-400' : 'bg-blue-500'}`}></div>
                                                <div className="flex flex-col">
                                                    <span className="text-xs font-mono font-bold text-gray-500 mb-1 block">{era.startYear}年</span>
                                                    <span className={`font-bold text-base ${isCollapse ? 'text-gray-500 line-through' : 'text-gray-800'}`}>{era.name}</span>
                                                    {eventBadge}
                                                    {era.params && Object.keys(era.params).length > 0 && (
                                                        <div className="mt-3 space-y-2">
                                                            {NATION_PARAMS.map(p => {
                                                                const val = era.params[p.key];
                                                                if (!val || !val.name) return null;
                                                                return (
                                                                    <div key={p.key} className="text-xs flex flex-col bg-gray-50 p-2 rounded border border-gray-100">
                                                                        <span className="text-[9px] font-bold text-gray-400 mb-0.5">{p.label}</span>
                                                                        <div className="flex items-center gap-2">
                                                                            <div className="w-2 h-2 rounded-full flex-shrink-0" style={{backgroundColor: val.color || p.defaultColor}}></div>
                                                                            <span className="font-bold text-gray-800">{val.name}</span>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {activeTab === 'characters' && (
                    <div className="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h3 className="font-bold text-lg text-gray-800 mb-6 flex items-center gap-2"><Icons.User size={20} className="text-blue-600"/> 関連人物一覧 ({relatedChars.length})</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {relatedChars.sort((a, b) => {
                                const aKey = nation.keyCharacterIds?.includes(a.id) ? 1 : 0;
                                const bKey = nation.keyCharacterIds?.includes(b.id) ? 1 : 0;
                                return bKey - aKey;
                            }).map(char => {
                                const isKey = nation.keyCharacterIds?.includes(char.id);
                                const aff = char.affiliations?.find(a => (typeof a === 'string' ? a : a.name) === nation.name) || char.affiliations?.[0];
                                const role = (typeof aff === 'object' && aff.role) ? aff.role : '';
                                const rank = getLevelRank(char.level);
                                return (
                                    <div key={char.id} onClick={() => setViewingItem({item: char, type: 'char'})} className={`p-4 rounded-lg border flex items-start gap-4 cursor-pointer transition-all ${isKey ? 'bg-blue-50 border-blue-200 hover:shadow-md' : 'bg-white border-gray-100 hover:bg-gray-50 hover:shadow-sm'}`}>
                                        <div className="w-16 h-16 rounded-full bg-gray-200 border-2 border-white shadow overflow-hidden flex-shrink-0">
                                            {char.portrait ? <img src={char.portrait} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-400"><Icons.User size={24}/></div>}
                                        </div>
                                        <div className="flex-grow overflow-hidden">
                                            <div className="flex items-center gap-2">
                                                <h4 className="font-bold text-lg text-gray-900 truncate">{char.name}</h4>
                                                {isKey && <span className="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200 font-bold flex-shrink-0">重要</span>}
                                            </div>
                                            <div className="text-sm text-gray-600 font-bold mb-1">{role || '所属'}</div>
                                            <div className="text-xs text-gray-500 flex items-center gap-2 mb-2">
                                                <span className="px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">{char.race}</span>
                                                {char.level && rank ? (
                                                    <span className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-bold border ${rank.bg} ${rank.color} ${rank.border}`}>
                                                        <rank.icon size={10} /> <span className="font-mono">Lv.{char.level}</span>
                                                    </span>
                                                ) : ( char.level && <span className="font-mono font-bold text-indigo-400">Lv.{char.level}</span> )}
                                                <span>{char.birthYear || '?'} - {char.deathYear || '?'}</span>
                                            </div>
                                            {char.note && <div className="text-xs text-gray-500 line-clamp-2 border-t border-gray-100 pt-2 mt-1">{char.note.replace(/<[^>]+>/g, '')}</div>}
                                        </div>
                                    </div>
                                );
                            })}
                            {relatedChars.length === 0 && <p className="text-gray-400 italic col-span-2">関連する人物は登録されていません。</p>}
                        </div>
                    </div>
                )}

                {activeTab === 'organizations' && (
                    <div className="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h3 className="font-bold text-lg text-gray-800 mb-6 flex items-center gap-2"><Icons.Briefcase size={20} className="text-blue-600"/> 関連組織一覧 ({relatedOrgs.length})</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {relatedOrgs.sort((a, b) => {
                                const aKey = nation.keyOrganizationIds?.includes(a.id) ? 1 : 0;
                                const bKey = nation.keyOrganizationIds?.includes(b.id) ? 1 : 0;
                                return bKey - aKey;
                            }).map(org => {
                                const isKey = nation.keyOrganizationIds?.includes(org.id);
                                const typeInfo = ORG_TYPES.find(t => t.key === org.type);
                                return (
                                    <div key={org.id} onClick={() => setViewingItem({item: org, type: 'org'})} className={`p-4 rounded-lg border flex items-start gap-4 cursor-pointer transition-all ${isKey ? 'bg-blue-50 border-blue-200 hover:shadow-md' : 'bg-white border-gray-100 hover:bg-gray-50 hover:shadow-sm'}`}>
                                        <div className="w-16 h-16 rounded bg-white border border-gray-200 flex items-center justify-center overflow-hidden flex-shrink-0 p-1">
                                            {org.logo ? <img src={org.logo} className="w-full h-full object-contain"/> : <span className="text-2xl">{typeInfo?.icon}</span>}
                                        </div>
                                        <div className="flex-grow overflow-hidden">
                                            <div className="flex items-center gap-2">
                                                <h4 className="font-bold text-lg text-gray-900 truncate">{org.name}</h4>
                                                {isKey && <span className="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200 font-bold flex-shrink-0">主要</span>}
                                            </div>
                                            <div className="text-xs text-gray-500 mb-2">{typeInfo?.label}</div>
                                            <p className="text-xs text-gray-600 line-clamp-2">{org.note || '概要なし'}</p>
                                        </div>
                                    </div>
                                );
                            })}
                            {relatedOrgs.length === 0 && <p className="text-gray-400 italic col-span-2">関連する組織は登録されていません。</p>}
                        </div>
                    </div>
                )}

                {/* ★追加: 統治機構タブ */}
                {activeTab === 'structure' && (
                    <div className="bg-white rounded-lg shadow border border-gray-200 p-8 min-h-[400px]">
                        <style>{treeCss}</style>
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2">
                                <Icons.Structure size={24} className="text-purple-600"/> 統治機構・権力構造図
                            </h3>
                            <button onClick={() => { setView('power_structure'); }} className="bg-purple-100 text-purple-800 border border-purple-300 px-4 py-2 rounded font-bold text-sm flex items-center gap-2 hover:bg-purple-200 transition-colors shadow-sm">
                                <Icons.Edit2 size={16} /> 構造を編集
                            </button>
                        </div>
                        <div className="w-full overflow-x-auto pb-8 custom-scrollbar bg-[#f9fafb] rounded border border-gray-100 p-8">
                            {powerStructureData.length > 0 ? (
                                <div className="flex gap-16 justify-center min-w-max">
                                    {powerStructureData.map((rootNode, index) => (
                                        <div key={index} className="tf-tree">
                                            <ul>{renderReadOnlyTree(rootNode)}</ul>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-20 text-gray-400">
                                    <Icons.Structure size={48} className="mx-auto mb-4 opacity-20"/>
                                    <p>権力構造図が未作成です。</p>
                                    <p className="text-sm">「構造を編集」ボタンから作成できます。</p>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {activeTab === 'stats' && (
                    <div className="space-y-6">
                        <div className="flex justify-end"><button onClick={onEditStats} className="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-800 flex items-center gap-2 transition-colors"><Icons.BarChart2 size={18} /> 統計データを記録・修正</button></div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white p-6 rounded-lg shadow border border-gray-200"><SimpleLineChart title="総人口推移" data={relatedStats} nations={[nation]} getValue={(d) => d.population} formatValue={(v, isShort) => formatJapaneseNumber(v, '人', isShort)} icon={Icons.Users} dataType="population" /></div>
                            <div className="bg-white p-6 rounded-lg shadow border border-gray-200"><SimpleLineChart title="GDP推移" data={relatedStats} nations={[nation]} getValue={(d) => d.gdp} formatValue={(v, isShort) => formatJapaneseNumber(v, '円', isShort)} icon={Icons.BarChart2} dataType="gdp" /></div>
                        </div>
                    </div>
                )}

                {activeTab === 'timeline' && (
                    <div className="bg-white p-8 rounded-lg shadow border border-gray-200 min-h-[400px]">
                        <div className="flex items-center justify-between mb-6 border-b pb-4"><h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><Icons.List size={24} className="text-green-600"/> 関連年表</h3><span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">{relatedEntries.length} 件の記録</span></div>
                        <div className="space-y-0">
                            {relatedEntries.map((entry, idx) => (
                                <div key={entry.id} className="flex gap-6 p-4 hover:bg-gray-50 transition-all group border-b border-gray-100 last:border-0 relative">
                                    <div className="flex-shrink-0 w-28 pt-1 text-right"><div className="font-mono font-bold text-lg text-gray-700">{entry.year}年</div><div className="text-xs text-gray-400">{entry.month ? entry.month + '月' : ''}{entry.day ? entry.day + '日' : ''}</div></div>
                                    <div className="flex-grow relative pl-6 border-l-2 border-gray-200 group-hover:border-green-300 transition-colors"><div className={`absolute -left-[7px] top-2 w-3 h-3 rounded-full border-2 border-white shadow-sm ${importanceLevels[entry.importance||2].bg.replace('bg-', 'bg-').replace('-50', '-400')}`}></div><h4 className="font-bold text-lg text-gray-900 mb-1">{entry.title}</h4><p className="text-sm text-gray-600 leading-relaxed">{entry.content}</p></div>
                                    <div className="absolute right-4 top-4 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => onEditEntry(entry)} className="p-2 bg-white text-gray-400 hover:text-blue-600 border border-gray-200 rounded-lg shadow-sm"><Icons.Edit2 size={16} /></button></div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// --- UserManagementView コンポーネント (修正版: 全ユーザー管理・ソート機能付き) ---
const UserManagementView = ({ setView, allUsers, onChangeRole }) => {
    // 並び替えロジック: 役割順 (Admin > Writer > Guest > Pending > Rejected) -> 登録日順
    const sortedUsers = useMemo(() => {
        const rolePriority = { 'admin': 1, 'writer': 2, 'guest': 3, 'pending': 4, 'rejected': 5 };
        return [...allUsers].sort((a, b) => {
            // 1. 役割で並び替え
            const priorityA = rolePriority[a.role] || 99;
            const priorityB = rolePriority[b.role] || 99;
            if (priorityA !== priorityB) return priorityA - priorityB;
            
            // 2. 登録日順 (appliedAt)
            const dateA = a.appliedAt ? new Date(a.appliedAt).getTime() : 0;
            const dateB = b.appliedAt ? new Date(b.appliedAt).getTime() : 0;
            return dateA - dateB;
        });
    }, [allUsers]);

    const getRoleLabel = (role) => {
        switch(role) {
            case 'admin': return { text: '管理者', bg: 'bg-gray-800 text-yellow-400 border-gray-700' };
            case 'writer': return { text: '執筆者', bg: 'bg-blue-600 text-white border-blue-700' };
            case 'guest': return { text: 'ゲスト', bg: 'bg-green-100 text-green-800 border-green-200' };
            case 'pending': return { text: '申請中', bg: 'bg-yellow-100 text-yellow-800 border-yellow-200 animate-pulse' };
            default: return { text: '停止中', bg: 'bg-gray-100 text-gray-400 border-gray-200' };
        }
    };

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">
            <SectionHeader icon={Icons.Users} title="アカウント管理" desc="登録済みアカウントの一覧です。役割の変更や権限の管理を行えます。" />
            
            <div className="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <span className="font-bold text-gray-700">登録ユーザー一覧 ({allUsers.length})</span>
                    <span className="text-xs text-gray-400">表示順: 管理者 &gt; 執筆者 &gt; ゲスト (登録順)</span>
                </div>
                
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-gray-100 text-gray-500 font-bold border-b border-gray-200">
                            <tr>
                                <th className="p-4 w-64">ユーザー</th>
                                <th className="p-4 w-32">現在の権限</th>
                                <th className="p-4">権限の変更・操作</th>
                                <th className="p-4 text-right w-40">登録日</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {sortedUsers.map(user => {
                                const roleStyle = getRoleLabel(user.role);
                                return (
                                    <tr key={user.id} className="hover:bg-gray-50 transition-colors group">
                                        <td className="p-4">
                                            <div className="flex items-center gap-3">
                                                {user.photoURL ? (
                                                    <img src={user.photoURL} className="w-10 h-10 rounded-full border border-gray-200 shadow-sm" />
                                                ) : (
                                                    <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-400"><Icons.User size={20}/></div>
                                                )}
                                                <div>
                                                    <div className="font-bold text-gray-800">{user.displayName || '名称未設定'}</div>
                                                    <div className="text-xs text-gray-500 font-mono">{user.email}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="p-4">
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold border ${roleStyle.bg} inline-block text-center min-w-[80px]`}>
                                                {roleStyle.text}
                                            </span>
                                        </td>
                                        <td className="p-4">
                                            <div className="flex flex-wrap gap-2 opacity-100 sm:opacity-40 group-hover:opacity-100 transition-opacity">
                                                <button onClick={() => onChangeRole(user.id, 'admin')} disabled={user.role === 'admin'} className={`px-2 py-1 text-xs rounded border ${user.role === 'admin' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-600 hover:bg-gray-800 hover:text-yellow-400 border-gray-300'}`}>管理者</button>
                                                <button onClick={() => onChangeRole(user.id, 'writer')} disabled={user.role === 'writer'} className={`px-2 py-1 text-xs rounded border ${user.role === 'writer' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-600 hover:bg-blue-600 hover:text-white border-gray-300'}`}>執筆者</button>
                                                <button onClick={() => onChangeRole(user.id, 'guest')} disabled={user.role === 'guest'} className={`px-2 py-1 text-xs rounded border ${user.role === 'guest' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-600 hover:bg-green-600 hover:text-white border-gray-300'}`}>ゲスト</button>
                                                <button onClick={() => onChangeRole(user.id, 'reject')} className="px-2 py-1 text-xs rounded border bg-white text-red-400 hover:bg-red-50 hover:text-red-600 border-red-100 ml-auto">停止</button>
                                            </div>
                                        </td>
                                        <td className="p-4 text-right text-xs text-gray-400 font-mono">
                                            {user.appliedAt ? new Date(user.appliedAt).toLocaleDateString() : '-'}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

// --- MainMenu コンポーネント (修正版: ログイン制限対応) ---
const MainMenu = ({ setView, handleCreateNew, handleExport, fileInputRef, convertFileInputRef, currentUser, isAuthorized, handleLogin, handleLogout }) => {
    
    // 権限がない場合の無効化スタイルクラス
    const disabledClass = !isAuthorized ? "opacity-40 grayscale pointer-events-none select-none" : "";

    const MenuBtn = ({ onClick, icon: Icon, label, subLabel, color }) => (
        <button onClick={onClick} className="group relative flex flex-col items-center justify-center p-4 bg-white border-2 border-gray-200 rounded-xl shadow-sm hover:shadow-lg hover:border-yellow-400 hover:-translate-y-1 transition-all duration-200 h-32 w-full">
            <div className={`p-3 rounded-full mb-2 transition-colors ${color || 'bg-gray-100 text-gray-500 group-hover:bg-yellow-100 group-hover:text-yellow-700'}`}>
                <Icon size={28} />
            </div>
            <span className="font-bold text-gray-700 group-hover:text-gray-900">{label}</span>
            {subLabel && <span className="text-[10px] text-gray-400 mt-1">{subLabel}</span>}
        </button>
    );

    const ActionBtn = ({ onClick, icon: Icon, label, className = "" }) => (
        <button onClick={onClick} className={`flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors shadow-sm ${className}`}>
            <Icon size={16}/> {label}
        </button>
    );

    return (
        <div className="min-h-screen bg-[#f0f2f5] flex flex-col items-center justify-center p-6 animate-fade-in">
            {/* タイトルロゴ */}
            <div className="text-center mb-10 scale-110">
                <div className="inline-flex items-center justify-center p-4 bg-[#1a1a1a] rounded-2xl shadow-2xl mb-4 ring-4 ring-yellow-500/20">
                    <Icons.BookOpen size={48} className="text-yellow-500" />
                </div>
                <h1 className="text-4xl font-black text-gray-800 tracking-[0.2em] mb-2" style={{textShadow: '2px 2px 0px white'}}>英覇歴代記</h1>
                <p className="text-xs font-mono text-gray-400 tracking-[0.5em] uppercase">Timeline Wiki System</p>
            </div>

            <div className="w-full max-w-5xl space-y-8">
                
                {/* 上部アクションボタン群 (ログイン・保存・読込) */}
                <div className="flex flex-wrap justify-center gap-4 items-center">
                    {/* ログイン/ログアウトボタン */}
                    {!currentUser ? (
                        <ActionBtn onClick={handleLogin} icon={Icons.Users} label="管理者ログイン" className="bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100" />
                    ) : (
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400 mr-2">
                                {isAuthorized ? "管理者としてログイン中" : "ゲスト閲覧モード"}
                            </span>
                            <ActionBtn onClick={handleLogout} icon={Icons.X} label="ログアウト" className="bg-gray-100 text-gray-600 hover:bg-gray-200" />
                        </div>
                    )}

                    <div className="h-8 w-px bg-gray-300 mx-2 hidden sm:block"></div>

                    {/* 保存は誰でも可能 */}
                    <ActionBtn onClick={handleExport} icon={Icons.Upload} label="データ保存 (Export)" />
                    
                    {/* 読込・統合は管理者のみ (divでラップして無効化クラスを適用) */}
                    <div className={`flex gap-4 ${disabledClass}`}>
                        <ActionBtn onClick={() => fileInputRef.current.click()} icon={Icons.Download} label="データ読込 (Import)" />
                        <ActionBtn onClick={() => convertFileInputRef.current.click()} icon={Icons.RefreshCw} label="データ統合 (Convert)" />
                    </div>
                    
                    <ActionBtn onClick={() => setView('help')} icon={Icons.HelpCircle} label="使い方 (Help)" />
                </div>

                {/* MANAGE セクション (管理者のみ操作可能) */}
                <div className={`bg-gray-50/50 p-6 rounded-2xl border border-dashed border-gray-300 relative transition-all ${disabledClass}`}>
                    {!isAuthorized && (
                        <div className="absolute inset-0 z-10 flex items-center justify-center">
                            <div className="bg-white/80 backdrop-blur-sm px-6 py-3 rounded-full border border-gray-200 shadow-sm font-bold text-gray-500 flex items-center gap-2">
                                <Icons.Lock size={16}/> 編集機能はロックされています
                            </div>
                        </div>
                    )}
                    <div className="flex items-center gap-3 mb-4">
                        <span className="bg-yellow-500 text-white text-xs font-bold px-3 py-1 rounded-full tracking-widest">MANAGE</span>
                        <span className="text-sm text-gray-500 font-bold">情報の編集・記録</span>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <button onClick={handleCreateNew} className="group relative flex flex-col items-center justify-center p-4 bg-yellow-500 border-2 border-yellow-600 rounded-xl shadow-md hover:shadow-xl hover:bg-yellow-400 hover:-translate-y-1 transition-all duration-200 h-32 w-full text-white">
                            <div className="p-3 rounded-full mb-2 bg-yellow-700/20">
                                <Icons.Edit2 size={28} />
                            </div>
                            <span className="font-black tracking-wider">歴史を刻む</span>
                            <span className="text-[10px] opacity-80 mt-1">年表に追加</span>
                        </button>
                        <MenuBtn onClick={() => setView('settings')} icon={Icons.Globe} label="国家編成" subLabel="基本設定・変遷" />
                        <MenuBtn onClick={() => setView('characters')} icon={Icons.User} label="人物管理" subLabel="重要人物" />
                        <MenuBtn onClick={() => setView('organizations')} icon={Icons.Briefcase} label="組織管理" subLabel="ギルド・結社" />
                        <MenuBtn onClick={() => setView('statsEdit')} icon={Icons.BarChart2} label="統計編集" subLabel="人口・GDP" />
                        <MenuBtn onClick={() => setView('power_structure')} icon={Icons.Structure} label="権力構造" subLabel="組織図" />
                    </div>
                </div>

                {/* VIEW セクション (全員可能) */}
                <div className="bg-gray-50/50 p-6 rounded-2xl border border-dashed border-gray-300">
                    <div className="flex items-center gap-3 mb-4">
                        <span className="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full tracking-widest">VIEW</span>
                        <span className="text-sm text-gray-500 font-bold">情報の閲覧・分析</span>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <button onClick={() => setView('timeline')} className="group relative flex flex-col items-center justify-center p-4 bg-blue-600 border-2 border-blue-700 rounded-xl shadow-md hover:shadow-xl hover:bg-blue-500 hover:-translate-y-1 transition-all duration-200 h-32 w-full text-white">
                            <div className="p-3 rounded-full mb-2 bg-blue-800/30">
                                <Icons.History size={28} />
                            </div>
                            <span className="font-black tracking-wider">年表閲覧</span>
                            <span className="text-[10px] opacity-80 mt-1">全歴史を確認</span>
                        </button>
                        
                        <MenuBtn onClick={() => setView('nation_list')} icon={Icons.LayoutGrid} label="国家一覧" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                        <MenuBtn onClick={() => setView('genealogy')} icon={Icons.GitMerge} label="興亡系譜図" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                        <MenuBtn onClick={() => setView('graph')} icon={Icons.Activity} label="統計グラフ" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                        <MenuBtn onClick={() => setView('table')} icon={Icons.List} label="体制一覧表" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                    </div>
                </div>
            </div>
            
            <div className="mt-12 text-center text-gray-400 text-xs font-mono">
                <p>© EIHA CHRONICLE TIMELINE SYSTEM</p>
            </div>
        </div>
    );
};


// --- TimelineWiki メインコンポーネント (修正完了版) ---
        function TimelineWiki() {
            const [entries, setEntries] = useState([]);
            const [nations, setNations] = useState([]);
            const [stats, setStats] = useState([]);
            const [characters, setCharacters] = useState([]); 
            const [organizations, setOrganizations] = useState([]); 
            
            const [view, setView] = useState('menu'); 
            
            const [selectedEntry, setSelectedEntry] = useState(null);
            const [selectedProfileNation, setSelectedProfileNation] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [showFilters, setShowFilters] = useState(false);
            const [showStatsInput, setShowStatsInput] = useState(false);
            const [expandedStatsYears, setExpandedStatsYears] = useState([]);
            const [filterTags, setFilterTags] = useState([]);
            const [filterImportance, setFilterImportance] = useState([]);
            const [targetNation, setTargetNation] = useState(null);
            const [uiScale, setUiScale] = useState(100);

            // ★修正: ここで currentUser を定義
            const [currentUser, setCurrentUser] = useState(null);

            // ★権限管理用ステート
            const [userRole, setUserRole] = useState('guest'); 
            const [allUsers, setAllUsers] = useState([]);

            // ★権限判定ロジック
            const canEdit = userRole === 'admin' || userRole === 'writer' || (currentUser && currentUser.email === ADMIN_EMAIL);
            const isAdmin = userRole === 'admin' || (currentUser && currentUser.email === ADMIN_EMAIL);
            
            // ★重要: エラー回避のため isAuthorized を canEdit のエイリアスとして定義
            const isAuthorized = canEdit;

            const fileInputRef = useRef(null);
            const convertFileInputRef = useRef(null);

            // 権限がない場合の無効化クラス
            const disabledClass = !canEdit ? "opacity-30 grayscale pointer-events-none select-none" : "";

            // ログイン監視
            useEffect(() => {
                const unsubscribeAuth = auth.onAuthStateChanged(async (user) => {
                    setCurrentUser(user);
                    if (user) {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            setUserRole(userDoc.data().role);
                        } else {
                            setUserRole('guest');
                        }
                    } else {
                        setUserRole('guest');
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            // ★変更: 管理者用 - 全ユーザーリストのリアルタイム監視
            useEffect(() => {
                if (!isAdmin) return;
                // .where('role', '==', 'pending') を削除して全件取得に変更
                const unsubscribeUsers = db.collection('users')
                    .onSnapshot(snap => {
                        const users = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setAllUsers(users);
                    });
                return () => unsubscribeUsers();
            }, [isAdmin]);

            // アカウント申請
            const handleApplyAccount = async () => {
                if (!currentUser) return;
                try {
                    await db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        displayName: currentUser.displayName,
                        photoURL: currentUser.photoURL,
                        role: 'pending',
                        appliedAt: new Date().toISOString()
                    });
                    setUserRole('pending');
                    alert("申請しました。管理者の承認をお待ちください。");
                } catch (e) {
                    console.error(e);
                    alert("申請に失敗しました。");
                }
            };

            // 権限承認 (管理者のみ)
            const handleApproveUser = async (uid, newRole) => {
                if (!isAdmin) return;
                try {
                    if (newRole === 'reject') {
                        await db.collection('users').doc(uid).update({ role: 'rejected' });
                        alert("申請を却下しました。");
                    } else {
                        await db.collection('users').doc(uid).update({ role: newRole });
                        alert(`権限を ${newRole} に変更しました。`);
                    }
                } catch (e) {
                    console.error(e);
                    alert("処理に失敗しました。");
                }
            };

            // ログイン・ログアウト
            const handleLogin = async () => {
                try { await auth.signInWithPopup(googleProvider); } 
                catch (e) { alert("ログイン失敗: " + e.message); }
            };
            const handleLogout = async () => {
                try { await auth.signOut(); setView('menu'); } 
                catch (e) { console.error(e); }
            };

            // データ同期
            useEffect(() => {
                const unsubscribe = db.collection("wiki_data").doc("main_db")
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            if (data.entries) setEntries(data.entries);
                            if (data.nations) setNations(data.nations);
                            if (data.stats) setStats(data.stats);
                            if (data.characters) setCharacters(data.characters);
                            if (data.organizations) setOrganizations(data.organizations);
                            if (data.uiScale) setUiScale(data.uiScale);
                        }
                    }, (error) => {
                        console.error("同期エラー:", error);
                    });
                return () => unsubscribe();
            }, []);

            // クラウド保存
            const saveToCloud = async (newData = {}) => {
                if (!canEdit) return;
                const dataToSave = {
                    entries: newData.entries || entries,
                    nations: newData.nations || nations,
                    stats: newData.stats || stats,
                    characters: newData.characters || characters,
                    organizations: newData.organizations || organizations,
                    uiScale: newData.uiScale || uiScale,
                    lastUpdated: new Date().toISOString()
                };
                if (!dataToSave.entries || dataToSave.entries.length === 0) return;
                try {
                    await db.collection("wiki_data").doc("main_db").set(dataToSave, { merge: true });
                } catch (e) {
                    console.error("保存失敗:", e);
                }
            };

            // 自動保存 (修正: 依存配列を isAuthorized から canEdit に変更)
            useEffect(() => {
                if (!canEdit) return;
                const timer = setTimeout(() => {
                    if (entries.length > 0 || nations.length > 0) {
                        saveToCloud();
                    }
                }, 2000);
                return () => clearTimeout(timer);
            }, [entries, nations, stats, characters, organizations, uiScale, canEdit]);

            // エクスポート
            const handleExport = () => { 
                const fullData = { entries, nations, stats, characters, organizations }; 
                const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: 'application/json' }); 
                const url = URL.createObjectURL(blob); 
                const link = document.createElement('a'); 
                link.href = url; link.download = `英覇歴代記_全データ_${new Date().toISOString().slice(0,10)}.json`; 
                document.body.appendChild(link); link.click(); document.body.removeChild(link); 
            };

            // インポート
            const handleImportFile = (event) => { 
                if (!canEdit) return;
                const file = event.target.files[0]; if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    try { 
                        const data = JSON.parse(e.target.result); 
                        if (window.confirm('警告: 現在のデータをすべて削除し、ファイルの内容に置き換えますか？')) { 
                            const newEntries = Array.isArray(data) ? data : (data.entries || []);
                            const newNations = !Array.isArray(data) && data.nations ? data.nations : [];
                            const newStats = !Array.isArray(data) && data.stats ? data.stats : [];
                            const newChars = !Array.isArray(data) && data.characters ? data.characters : [];
                            const newOrgs = !Array.isArray(data) && data.organizations ? data.organizations : [];
                            setEntries(newEntries); setNations(newNations); setStats(newStats); setCharacters(newChars); setOrganizations(newOrgs);
                            saveToCloud({ entries: newEntries, nations: newNations, stats: newStats, characters: newChars, organizations: newOrgs });
                            alert(`インポート完了しました。`); 
                        } 
                    } catch (error) { console.error(error); alert('読み込みに失敗しました。'); } 
                    finally { if (fileInputRef.current) fileInputRef.current.value = ''; } 
                }; 
                reader.readAsText(file); 
            };

            // コンバート
            const handleConvertFile = (event) => { 
                if (!canEdit) return;
                const file = event.target.files[0]; if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    try { 
                        const data = JSON.parse(e.target.result); 
                        if (!window.confirm('既存のデータを保持しつつ、新しい項目のみを追加しますか？')) return; 
                        const loadedEntries = Array.isArray(data) ? data : (data.entries || []); 
                        const loadedNations = !Array.isArray(data) && data.nations ? data.nations : []; 
                        const loadedStats = !Array.isArray(data) && data.stats ? data.stats : []; 
                        const loadedChars = !Array.isArray(data) && data.characters ? data.characters : []; 
                        const loadedOrgs = !Array.isArray(data) && data.organizations ? data.organizations : []; 
                        const mergedEntries = [...entries, ...loadedEntries.filter(e => !entries.some(ex => ex.id === e.id))];
                        const mergedNations = [...nations, ...loadedNations.filter(n => !nations.some(ex => ex.id === n.id))];
                        const mergedStats = [...stats, ...loadedStats.filter(s => !stats.some(ex => ex.id === s.id))];
                        const mergedChars = [...characters, ...loadedChars.filter(c => !characters.some(ex => ex.id === c.id))];
                        const mergedOrgs = [...organizations, ...loadedOrgs.filter(o => !organizations.some(ex => ex.id === o.id))];
                        setEntries(mergedEntries); setNations(mergedNations); setStats(mergedStats); setCharacters(mergedChars); setOrganizations(mergedOrgs); 
                        saveToCloud({ entries: mergedEntries, nations: mergedNations, stats: mergedStats, characters: mergedChars, organizations: mergedOrgs });
                        alert('コンバート完了しました。'); 
                    } catch (error) { console.error(error); alert('読み込み失敗'); } 
                    finally { if (convertFileInputRef.current) convertFileInputRef.current.value = ''; } 
                }; 
                reader.readAsText(file); 
            };
            
            const handleCreateNew = () => { 
                if (!canEdit) return;
                const newEntry = { id: Date.now().toString(), title: '', reading: '', year: DEFAULT_YEAR, month: '', day: '', content: '', tags: [], importance: 2 }; 
                setSelectedEntry(newEntry); setIsEditing(true); setView('edit'); 
            };

            const openSettings = (nation = null) => { setTargetNation(nation); setView('settings'); };
            
            const timelineItems = useMemo(() => { 
                const items = []; 
                let filteredEntries = entries; 
                if (searchTerm) { 
                    const lowerTerm = searchTerm.toLowerCase(); 
                    filteredEntries = filteredEntries.filter(e => e.title.toLowerCase().includes(lowerTerm) || (e.reading && e.reading.toLowerCase().includes(lowerTerm)) || e.content.toLowerCase().includes(lowerTerm) || e.year.toString().includes(lowerTerm)); 
                } 
                if (filterTags.length > 0) filteredEntries = filteredEntries.filter(e => e.tags && filterTags.every(tag => e.tags.includes(tag))); 
                if (filterImportance.length > 0) filteredEntries = filteredEntries.filter(e => filterImportance.includes(e.importance || 2)); 
                
                filteredEntries.forEach(entry => { items.push({ type: 'entry', year: entry.year, month: entry.month || 0, day: entry.day || 0, data: entry }); }); 
                const statsYears = [...new Set(stats.map(s => s.year))]; 
                statsYears.forEach(year => { 
                    if (searchTerm && !year.toString().includes(searchTerm)) return; 
                    items.push({ type: 'stats_marker', year: year, month: -1, day: -1, id: `stats_marker_${year}` }); 
                }); 
                return items.sort((a, b) => { if (a.year !== b.year) return a.year - b.year; if (a.month !== b.month) return a.month - b.month; return a.day - b.day; }); 
            }, [entries, stats, searchTerm, filterTags, filterImportance]);

            const allTags = useMemo(() => { const tags = new Set(); entries.forEach(e => e.tags?.forEach(t => tags.add(t))); return Array.from(tags).sort(); }, [entries]);
            let entryCounter = 0;
            const zoomIn = () => setUiScale(prev => Math.min(200, prev + 10));
            const zoomOut = () => setUiScale(prev => Math.max(30, prev - 10));
            const zoomReset = () => setUiScale(100);

            return (
                <>
                    <input type="file" ref={fileInputRef} onChange={handleImportFile} className="hidden" accept=".json" disabled={!canEdit} />
                    <input type="file" ref={convertFileInputRef} onChange={handleConvertFile} className="hidden" accept=".json" disabled={!canEdit} />
                    <StatsInputModal showStatsInput={showStatsInput} setShowStatsInput={setShowStatsInput} nations={nations} stats={stats} setStats={setStats} />

                    {view === 'menu' ? (
                        <MainMenu 
                            setView={setView} 
                            handleCreateNew={handleCreateNew} 
                            handleExport={handleExport} 
                            fileInputRef={fileInputRef} 
                            convertFileInputRef={convertFileInputRef}
                            currentUser={currentUser}
                            isAuthorized={isAuthorized} // ★修正: isAuthorized(実体はcanEdit)を渡す
                            handleLogin={handleLogin}
                            handleLogout={handleLogout}
                        />
                    ) : (
                        <div className="min-h-screen bg-[#f0f2f5] font-sans text-gray-800 flex flex-col h-screen overflow-hidden">
                            <header className="bg-[#1a1a1a] text-white p-2 shadow-lg shrink-0 z-50 border-b-4 border-yellow-600">
                                <div className="max-w-7xl mx-auto flex justify-between items-center overflow-x-auto custom-scrollbar pb-1">
                                    <div className="flex items-center gap-4 mr-6 shrink-0">
                                        <button onClick={() => setView('menu')} className="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded text-sm font-bold flex items-center gap-2 transition-colors">
                                            <Icons.ArrowLeft size={18} /> MENU
                                        </button>
                                        <div className="h-6 w-px bg-gray-700"></div>
                                        <div className="flex items-center gap-2 cursor-pointer group" onClick={() => {setView('timeline'); setSelectedEntry(null);}}>
                                            <div className="bg-yellow-600 p-1 rounded text-black shrink-0"><Icons.BookOpen size={20} /></div>
                                            <div><h1 className="text-lg font-bold tracking-widest group-hover:text-yellow-500 transition-colors leading-none">英覇歴代記</h1></div>
                                        </div>
                                    </div>
                                    <div className="flex items-end gap-3 shrink-0">
                                        <div className="flex flex-col items-center gap-1"><span className="text-[9px] text-gray-500 font-bold uppercase tracking-widest">ZOOM</span><div className="flex items-center bg-gray-700 rounded-lg border border-gray-600"><button onClick={zoomOut} className="p-1.5 hover:bg-gray-600 rounded-l text-gray-300"><Icons.Minus size={16}/></button><button onClick={zoomReset} className="text-xs font-mono font-bold w-10 text-center text-yellow-500 hover:text-white">{uiScale}%</button><button onClick={zoomIn} className="p-1.5 hover:bg-gray-600 rounded-r text-gray-300"><Icons.Plus size={16}/></button></div></div>
                                        
                                        <div className={`flex flex-col items-center gap-1 ${disabledClass}`}>
                                            <span className="text-[9px] text-yellow-600/80 font-bold uppercase tracking-widest">MANAGE</span>
                                            <div className="flex items-center bg-gray-800 rounded-lg border border-gray-700 overflow-hidden shadow-sm">
                                                <button onClick={() => openSettings(null)} className={`p-2 transition-colors border-r border-gray-700 ${view === 'settings' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="国家変遷"><Icons.Globe size={20} /></button>
                                                <button onClick={() => setView('nation_overview')} className={`p-2 transition-colors border-r border-gray-700 ${view === 'nation_overview' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="概要"><Icons.FileText size={20} /></button>
                                                <button onClick={() => setView('characters')} className={`p-2 transition-colors border-r border-gray-700 ${view === 'characters' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="人物"><Icons.User size={20} /></button>
                                                <button onClick={() => setView('organizations')} className={`p-2 transition-colors border-r border-gray-700 ${view === 'organizations' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="組織"><Icons.Briefcase size={20} /></button>
                                                <button onClick={() => setView('statsEdit')} className={`p-2 transition-colors border-r border-gray-700 ${view === 'statsEdit' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="統計編集"><Icons.BarChart2 size={20} /></button>
                                                <button onClick={() => setView('power_structure')} className={`p-2 transition-colors ${view === 'power_structure' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="権力構造図"><Icons.Structure size={20} /></button>
                                            </div>
                                        </div>

                                        <div className="flex flex-col items-center gap-1"><span className="text-[9px] text-blue-400/60 font-bold uppercase tracking-widest">VIEW</span><div className="flex items-center bg-gray-800 rounded-lg border border-gray-700 overflow-hidden shadow-sm"><button onClick={() => setView('nation_list')} className={`p-2 transition-colors border-r border-gray-700 ${view === 'nation_list' || view === 'nation_profile' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="国家一覧"><Icons.LayoutGrid size={20} /></button><button onClick={() => setView('graph')} className={`p-2 transition-colors border-r border-gray-700 ${view === 'graph' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="グラフ分析"><Icons.Activity size={20} /></button><button onClick={() => setView('genealogy')} className={`p-2 transition-colors border-r border-gray-700 ${view === 'genealogy' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="系譜図"><Icons.GitMerge size={20} /></button><button onClick={() => setView('table')} className={`p-2 transition-colors ${view === 'table' ? 'bg-yellow-600 text-black' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'}`} title="体制一覧"><Icons.List size={20} /></button></div></div>
                                        
                                        <div className="flex flex-col items-center gap-1">
                                            <span className="text-[9px] text-gray-500 font-bold uppercase tracking-widest">DATA</span>
                                            <div className="flex items-center gap-1 border-r border-gray-700 pr-2 mr-1">
                                                <button onClick={handleExport} className="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors" title="エクスポート"><Icons.Upload size={20} /></button>
                                                <div className={`flex gap-1 ${disabledClass}`}>
                                                    <button onClick={() => fileInputRef.current.click()} className="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors" title="インポート"><Icons.Download size={20} /></button>
                                                    <button onClick={() => convertFileInputRef.current.click()} className="p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded transition-colors" title="コンバート"><Icons.RefreshCw size={20} /></button>
                                                </div>
                                                <button onClick={() => setView('help')} className={`p-2 rounded transition-colors ${view === 'help' ? 'bg-yellow-600 text-black' : 'text-gray-400 hover:text-white hover:bg-gray-800'}`} title="ヘルプ"><Icons.HelpCircle size={20} /></button>
                                            </div>
                                        </div>
                                        {/* USER Controls */}
                                        <div className="flex flex-col items-center gap-1 ml-1">
                                            <span className="text-[9px] text-gray-500 font-bold uppercase tracking-widest">USER</span>
                                            {currentUser ? (
                                                <div className="flex items-center gap-2">
                                                    // ヘッダー内のボタン部分
                                                {isAdmin && (
                                                 <button onClick={() => setView('user_management')} className="relative p-2 bg-gray-700 text-yellow-400 rounded hover:bg-gray-600" title="アカウント管理">
                                                 <Icons.Users size={16} />
                                                {/* allUsersの中から pending の人がいるか探す */}
                                                {allUsers.some(u => u.role === 'pending') && <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping"></span>}
                                                 </button>
                                                  )}
                                                    {userRole === 'guest' && (
                                                        <button onClick={handleApplyAccount} className="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700">申請する</button>
                                                    )}
                                                    {userRole === 'pending' && (
                                                        <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200">承認待ち</span>
                                                    )}
                                                    <button onClick={handleLogout} className={`flex items-center gap-1 px-2 py-2 rounded text-xs font-bold transition-colors ${canEdit ? 'bg-green-700 text-white hover:bg-green-600' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`} title={`Logged in as ${currentUser.email}`}>
                                                        {currentUser.photoURL ? <img src={currentUser.photoURL} className="w-5 h-5 rounded-full" /> : <Icons.User size={16}/>}
                                                        <span className="hidden md:inline">{userRole === 'admin' ? 'Admin' : userRole === 'writer' ? 'Writer' : 'Guest'}</span>
                                                    </button>
                                                </div>
                                            ) : (
                                                <button onClick={handleLogin} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded font-bold text-xs flex items-center gap-1"><Icons.Users size={14}/> Login</button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </header>

                            <div className="flex-grow overflow-auto bg-[#f0f2f5] relative w-full h-full">
                                <main className={(view === 'power_structure' || view === 'genealogy') ? "w-full h-full p-0 overflow-hidden" : "max-w-5xl mx-auto p-4 origin-top-left"} style={(view === 'power_structure' || view === 'genealogy') ? {} : { zoom: uiScale / 100 }}>
                                    {view === 'settings' ? <SettingsView setView={setView} nations={nations} setNations={setNations} targetNation={targetNation} setTargetNation={setTargetNation} /> : view === 'nation_overview' ? <NationOverviewView setView={setView} nations={nations} setNations={setNations} targetNation={targetNation} /> : view === 'characters' ? <CharacterManager setView={setView} nations={nations} characters={characters} setCharacters={setCharacters} organizations={organizations} setOrganizations={setOrganizations} /> : view === 'organizations' ? <OrganizationManager setView={setView} nations={nations} organizations={organizations} setOrganizations={setOrganizations} characters={characters} setCharacters={setCharacters} /> : view === 'statsEdit' ? <StatsEditView setView={setView} nations={nations} stats={stats} setStats={setStats} /> : view === 'power_structure' ? <PowerStructureView setView={setView} nations={nations} setNations={setNations} organizations={organizations} characters={characters} /> : view === 'user_management' && isAdmin ? <UserManagementView setView={setView} applicants={applicants} onApprove={handleApproveUser} /> :view === 'user_management' && isAdmin ? <UserManagementView setView={setView} applicants={applicants} onApprove={handleApproveUser} />: view === 'graph' ? <GraphView setView={setView} stats={stats} nations={nations} /> : view === 'genealogy' ? <GenealogyView setView={setView} nations={nations} stats={stats} entries={entries} setSelectedEntry={setSelectedEntry} uiScale={uiScale} /> : view === 'table' ? <NationTableView setView={setView} nations={nations} stats={stats} onEditNation={openSettings} onAddNation={() => openSettings(null)}/> : view === 'nation_list' ? <NationListView setView={setView} nations={nations} onSelectNation={(n) => { setSelectedProfileNation(n); setView('nation_profile'); }} /> : view === 'nation_profile' && selectedProfileNation ? <NationProfileView setView={setView} nation={selectedProfileNation} nations={nations} entries={entries} stats={stats} characters={characters} organizations={organizations} updateNation={(updated) => { setNations(prev => prev.map(n => n.id === updated.id ? updated : n)); setSelectedProfileNation(updated); }} onEditEntry={(entry) => { setSelectedEntry(entry); setIsEditing(true); setView('edit'); }} onEditNation={() => openSettings(selectedProfileNation)} onEditStats={() => setShowStatsInput(true)} onEditOverview={() => { setTargetNation(selectedProfileNation); setView('nation_overview'); }} /> : view === 'help' ? <HelpView setView={setView} /> : view === 'timeline' ? (
                                        <div className="animate-fade-in">
                                            <div className="mb-8 sticky top-0 z-20 pt-4">
                                                <div className="relative max-w-2xl mx-auto flex gap-2">
                                                    <div className="relative flex-grow"><Icons.Search className="absolute left-4 top-3.5 text-gray-400" size={20} /><input type="text" placeholder="検索..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-12 pr-6 py-3 rounded-lg shadow-lg border-none focus:ring-2 focus:ring-yellow-500 transition-all bg-white/95 backdrop-blur" /></div>
                                                    <button onClick={() => setShowFilters(!showFilters)} className={`p-3 rounded-lg shadow-lg transition-colors flex items-center gap-2 font-bold shrink-0 ${(showFilters || filterTags.length > 0 || filterImportance.length > 0) ? 'bg-yellow-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}`}><Icons.Filter size={20} /><span className="hidden md:inline">条件</span></button>
                                                </div>
                                                {showFilters && ( <div className="max-w-2xl mx-auto mt-4 bg-white p-6 rounded-lg shadow-xl border border-gray-200"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-gray-700">絞り込み条件</h3><button onClick={() => {setFilterTags([]); setFilterImportance([]);}} className="text-xs text-blue-600 hover:underline">条件をクリア</button></div><div className="mb-6"><label className="block text-xs font-bold text-gray-500 mb-2">重要度クラス</label><div className="flex flex-wrap gap-2">{Object.entries(importanceLevels).map(([level, info]) => <button key={level} onClick={() => setFilterImportance(prev => prev.includes(parseInt(level)) ? prev.filter(l => l !== parseInt(level)) : [...prev, parseInt(level)])} className={`px-3 py-1.5 rounded text-sm border transition-all ${filterImportance.includes(parseInt(level)) ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200'}`}>{info.label}</button>)}</div></div><div><label className="block text-xs font-bold text-gray-500 mb-2">タグ</label><div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-1">{allTags.length > 0 ? allTags.map(tag => <button key={tag} onClick={() => setFilterTags(prev => prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag])} className={`px-3 py-1 rounded-full text-xs border flex items-center gap-1 transition-all ${filterTags.includes(tag) ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-gray-50 text-gray-600 border-gray-200'}`}><Icons.Tag size={10} />{tag}</button>) : <span className="text-sm text-gray-400">タグなし</span>}</div></div></div> )}
                                            </div>
                                            <div className="relative min-h-[600px] pb-20">
                                                <div className="absolute left-8 md:left-1/2 top-0 bottom-0 w-1.5 bg-gradient-to-b from-gray-800 via-gray-600 to-transparent transform -translate-x-1/2 rounded-full opacity-80"></div>
                                                <div className="space-y-12">
                                                    {timelineItems.map((item, index) => {
                                                        if (item.type === 'stats_marker') {
                                                            const hasEntryInSameYear = timelineItems.some(i => i.type === 'entry' && i.year === item.year);
                                                            return (
                                                                <div key={item.id} className="relative z-10">{!hasEntryInSameYear && (<><div className="absolute left-1/2 transform -translate-x-1/2 top-4 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></div><div className="absolute left-1/2 transform -translate-x-1/2 top-8 bg-gray-100 text-gray-500 text-xs font-bold px-2 py-1 rounded shadow-sm border border-gray-200">{item.year}年</div></>)}<StatsDisplay year={item.year} stats={stats} expandedStatsYears={expandedStatsYears} setExpandedStatsYears={setExpandedStatsYears} nations={nations} /></div>
                                                            );
                                                        }
                                                        const entry = item.data; const level = entry.importance || 2; const style = importanceLevels[level]; const isRight = entryCounter % 2 !== 0; entryCounter++;
                                                        let dotStyle = 'w-4 h-4 bg-gray-800 ring-4 ring-gray-200'; if (level === 6) { dotStyle = 'w-8 h-8 bg-rose-600 ring-4 ring-rose-200 shadow-xl'; } else if (level === 5) { dotStyle = 'w-6 h-6 bg-yellow-500 ring-4 ring-yellow-200'; } else if (level === 4) { dotStyle = 'w-5 h-5 bg-purple-600 ring-4 ring-purple-200'; }
                                                        return (
                                                            <div key={item.data.id} className={`relative flex flex-col md:flex-row items-center ${isRight ? 'md:flex-row-reverse' : ''}`}>
                                                                <div className="absolute left-8 md:left-1/2 transform -translate-x-1/2 z-10 flex flex-col items-center group/date"><div className={`${dotStyle} rounded-full shadow-lg mb-2 transition-all`}></div><div className={`bg-[#1a1a1a] text-xs font-bold px-2 py-1 rounded shadow-sm whitespace-nowrap border flex flex-col items-center ${level === 6 ? 'border-rose-500 text-rose-400' : 'border-gray-700 text-yellow-500'}`}><span>{entry.year}年</span>{entry.month && <span className="text-[10px] text-gray-300 font-normal mt-0.5">{CUSTOM_MONTHS[entry.month]}({entry.month}月){entry.day ? ` ${entry.day}日` : ''}</span>}</div></div>
                                                                <div className={`hidden md:block absolute w-[calc(50%-2rem)] border-t-2 ${level >= 4 ? 'border-yellow-500' : 'border-gray-300'} border-dashed ${isRight ? 'left-8' : 'right-8'}`}></div><div className="hidden md:block w-1/2"></div>
                                                                <div className={`w-full md:w-1/2 pl-16 md:pl-0 p-2 transition-all duration-300 ease-out hover:z-10 ${style.scale} ${isRight ? 'md:pr-12 md:pl-8' : 'md:pl-12 md:pr-8'}`}><div onClick={() => { setSelectedEntry(entry); setView('detail'); }} className={`relative cursor-pointer overflow-hidden rounded-lg shadow-md ${style.bg} border-l-4 ${style.color} hover:shadow-xl hover:-translate-y-1 transition-all p-5`}><div className="mb-2">{entry.reading && <p className="text-xs text-gray-500 mb-0.5 leading-none">{entry.reading}</p>}<h3 className={`font-bold text-gray-900 leading-tight ${level >= 4 ? 'text-2xl' : 'text-lg'}`}>{entry.title}</h3></div><p className="text-gray-600 text-sm line-clamp-3 mb-3">{entry.content || '...'}</p><div className="flex flex-wrap gap-1">{entry.tags?.map(tag => <NationTag key={tag} text={tag} nations={nations} year={entry.year} />)}</div></div></div>
                                                            </div>
                                                        );
                                                    })}
                                                    {timelineItems.length === 0 && <div className="text-center py-32"><p className="text-gray-500 font-serif text-lg">記録なし</p></div>}
                                                </div>
                                            </div>
                                        </div>
                                    ) : view === 'edit' && selectedEntry ? (
                                        <EditForm entry={selectedEntry} onSave={(entry) => { const clean = { ...entry, year: parseInt(entry.year)||0, month: entry.month?parseInt(entry.month):null, day: entry.day?parseInt(entry.day):null }; const newEntries = entries.some(e => e.id === clean.id) ? entries.map(e => e.id === clean.id ? clean : e) : [...entries, clean]; setEntries(newEntries); saveToCloud({ entries: newEntries }); setIsEditing(false); setSelectedEntry(clean); setView('detail'); }} onCancel={() => { setIsEditing(false); if(!selectedEntry.title) setView('timeline'); else setView('detail'); }} nations={nations} />
                                    ) : view === 'detail' && selectedEntry ? (
                                        <DetailView entry={selectedEntry} onEdit={() => { setIsEditing(true); setView('edit'); }} onClose={() => { setView('timeline'); setSelectedEntry(null); }} onDelete={(id) => { if(window.confirm('削除しますか？')) { const newEntries = entries.filter(e => e.id !== id); setEntries(newEntries); saveToCloud({ entries: newEntries }); setView('timeline'); setSelectedEntry(null); } }} nations={nations} />
                                    ) : null}
                                </main>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TimelineWiki />);
    </script>
</body>
</html>
