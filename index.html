<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±è¦‡æ­´ä»£è¨˜ Timeline Wiki</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<style>
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
body { font-family: 'Helvetica Neue', Arial, sans-serif; }
.custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #888; }
</style>
</head>
<body class="bg-[#f0f2f5] text-gray-800">
<div id="root"></div>
<script type="text/babel">

const { useState, useEffect, useMemo, useRef } = React

// â˜… Firebaseè¨­å®š (ã“ã“ã‚’ã”è‡ªèº«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„)
const firebaseConfig = {
  apiKey: "AIzaSyCjj_GvIPi-voXia6ilCQ4ZFNvG8sD3Qmc",
  authDomain: "hellmenea-wiki.firebaseapp.com",
  projectId: "hellmenea-wiki",
  storageBucket: "hellmenea-wiki.firebasestorage.app",
  messagingSenderId: "787258620406",
  appId: "1:787258620406:web:380d00c99618400727efd7"
};


// FirebaseåˆæœŸåŒ–
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const googleProvider = new firebase.auth.GoogleAuthProvider();
const ADMIN_EMAIL = "anohitodayoanohito@gmail.com"; 

const DEFAULT_YEAR = 1825;
const AD_OFFSET = 110;

const LOCATIONS = {
    'allugeberno': { label: 'ã‚¢ãƒªãƒ¥ãƒ¼ã‚¸ãƒ™ãƒ«ãƒå¤§é™¸', color: '#92400e', order: 1 },
    'grankleberno': { label: 'ã‚°ãƒ©ãƒ³ã‚¯ãƒ«ãƒ™ãƒ«ãƒå¤§é™¸', color: '#92400e', order: 2 },
    'fiageberno': { label: 'ãƒ•ã‚£ã‚¢ãƒ¼ã‚¸ãƒ™ãƒ«ãƒå¤§é™¸', color: '#92400e', order: 3 },
    'seabed': { label: 'æµ·åº•', color: '#1e3a8a', order: 4 },
    'unknown': { label: 'ãã®ä»–ãƒ»ä¸æ˜', color: '#4b5563', order: 99 }
};

const NATION_RANKS = {
    'world_government': { label: 'ä¸–ç•Œæ”¿åºœ', order: 1, color: '#000000' },
    'super_power': { label: 'å¤§åˆ—å¼·', order: 2, color: '#7f1d1d' },
    'great_power': { label: 'åˆ—å¼·', order: 3, color: '#c2410c' },
    'major_power': { label: 'å¤§å›½', order: 4, color: '#15803d' },
    'regional_power': { label: 'åœ°åŸŸå¤§å›½', order: 5, color: '#0f766e' },
    'minor_power': { label: 'ä¸­å°å›½', order: 6, color: '#374151' },
    'city_state': { label: 'éƒ½å¸‚å›½å®¶', order: 7, color: '#4b5563' }
};

const ERA_EVENT_TYPES = {
    'none': { label: 'ãªã—', icon: '', relationship: null },
    'regime_change': { label: 'æ”¿ä½“ã®å¤‰æ›´', icon: 'ğŸ›ï¸', relationship: null, counter: null },
    'foundation': { label: 'å»ºå›½ãƒ»æˆç«‹', icon: 'âœ¨', relationship: null, counter: null },
    'independence': { label: 'ã‚ˆã‚Šç‹¬ç«‹', icon: 'ğŸš©', relationship: null, counter: 'lose_independence' },
    'splinter': { label: 'ã‚ˆã‚Šåˆ†è£‚ã—ã¦æˆç«‹', icon: 'âš¡', relationship: null, counter: 'lose_splinter' },
    'unification': { label: 'ã‚’çµ±åˆã—ã¦æˆç«‹', icon: 'ğŸ¤', relationship: 'child', counter: 'merger' },
    'foundation_puppet': { label: 'å‚€å„¡å›½ã¨ã—ã¦æˆç«‹', icon: 'â™Ÿï¸', relationship: 'parent', counter: 'puppet_found' },
    'puppet_found': { label: 'ã‚’å‚€å„¡ã¨ã—ã¦å»ºå›½', icon: 'â™Ÿï¸', relationship: 'child', counter: 'foundation_puppet' },
    'annexation': { label: 'ã‚’ä½µåˆ', icon: 'â•', relationship: 'child', counter: 'annexed_by' },
    'partition': { label: 'ã‚’åˆ†å‰²çµ±æ²»', icon: 'ğŸ°', relationship: 'child', counter: 'partitioned_by' },
    'puppet': { label: 'ã‚’å‚€å„¡åŒ–', icon: 'ğŸ§¸', relationship: 'child', counter: 'be_puppet' },
    'be_puppet': { label: 'ã®å‚€å„¡ã«ãªã‚‹', icon: 'â›“ï¸', relationship: 'parent', counter: 'puppet' },
    'annexed_by': { label: 'ã«ä½µåˆã•ã‚Œã‚‹', icon: 'ğŸ³ï¸', relationship: 'parent', counter: 'annexation' },
    'partitioned_by': { label: 'ã«ã‚ˆã‚Šåˆ†å‰²ã•ã‚Œã‚‹', icon: 'ğŸ§©', relationship: 'parent', counter: 'partition' },
    'merger': { label: 'ã«å¸ååˆä½µã•ã‚Œã‚‹', icon: 'ğŸ”—', relationship: 'parent', counter: 'unification' },
    'dissolution': { label: 'åˆ†è£‚ãƒ»è§£ä½“ã—ã¦æ¶ˆæ»…', icon: 'ğŸ’¥', relationship: null, counter: 'splinter' },
    'collapse': { label: 'å´©å£Šãƒ»æ»…äº¡', icon: 'ğŸ’€', relationship: null, counter: null },
    'lose_independence': { label: 'ãŒç‹¬ç«‹', icon: 'ğŸ‘‹', relationship: 'null', counter: 'independence' },
    'lose_splinter': { label: 'ãŒåˆ†è£‚', icon: 'ğŸ’”', relationship: 'null', counter: 'splinter' },
};

// --- æ—¢å­˜ã®å®šæ•°å®šç¾©ã®ä¸‹ã‚ãŸã‚Šã«è¿½åŠ  ---

// ç¨®æ—å®šç¾© (ãƒ«ãƒ“å¯¾å¿œ)
const RACES = [
    { label: 'é«˜äººæ—', ruby: 'ãƒˆãƒ¼ãƒ«ãƒãƒ³', color: '#fdba74' }, // Gray
    { label: 'æ£®äººæ—', ruby: 'ã‚¨ãƒ«ãƒ•', color: '#86efac' }, // Green
    { label: 'é‰±äººæ—', ruby: 'ãƒ‰ãƒ¯ãƒ¼ãƒ•', color: '#808080' }, // Red
    { label: 'åŠäººæ—', ruby: 'ãƒãƒ¼ãƒ•ãƒ•ãƒƒãƒˆ', color: '#fde047' }, // Yellow
    { label: 'ç£äººæ—', ruby: 'ã‚¢ãƒ‹ã‚¹', color: '#fca5a5' }, // Orange
    { label: 'æµ·äººæ—', ruby: 'ãƒãƒªãƒ‹ã‚¢ãƒ³', color: '#93c5fd' }, // Blue
    { label: 'é­”äººæ—', ruby: 'ãƒãƒ«ã‚¹ãƒ¢ã‚·ã‚¢', color: '#c084fc' }, // Purple
    { label: 'å¤©äººæ—', ruby: 'ã‚¢ã‚·ã‚§ãƒª', color: '#fdf5e6' }, 
    { label: 'ãã®ä»–ãƒ»ä¸æ˜', ruby: '', color: '#9ca3af' }
];

// çµ„ç¹”ã‚¿ã‚¤ãƒ—å®šç¾© (è¨­å®šé …ç›®æ¡ˆ)
const ORG_TYPES = [
    { key: 'guild', label: 'ã‚®ãƒ«ãƒ‰ãƒ»çµ„åˆ', icon: 'ğŸ›¡ï¸' },
    { key: 'military', label: 'é¨å£«å›£ãƒ»è»äº‹çµ„ç¹”', icon: 'âš”ï¸' },
    { key: 'corporation', label: 'å•†ä¼šãƒ»ä¼æ¥­', icon: 'ğŸ’°' },
    { key: 'religious', label: 'å®—æ•™å›£ä½“ãƒ»æ•™å›£', icon: 'ğŸ™' },
    { key: 'academic', label: 'å­¦è¡“ãƒ»é­”æ³•æ©Ÿé–¢', icon: 'ğŸ“š' },
    { key: 'criminal', label: 'çŠ¯ç½ªçµ„ç¹”ãƒ»çµç¤¾', icon: 'ğŸ’€' },
    { key: 'government', label: 'æ”¿åºœæ©Ÿé–¢', icon: 'ğŸ›ï¸' },
    { key: 'family', label: 'åå®¶', icon: 'ğŸ ' },
    { key: 'other', label: 'ãã®ä»–', icon: 'ğŸš©' }
];


        


const importanceLevels = {
    1: { label: 'å°äº‹', scale: 'scale-95', badge: 'bg-gray-200 text-gray-700', bg: 'bg-gray-50', color: 'border-gray-200' },
    2: { label: 'ä¸€èˆ¬', scale: 'scale-100', badge: 'bg-gray-300 text-gray-800', bg: 'bg-white', color: 'border-gray-300' },
    3: { label: 'é‡è¦', scale: 'scale-105', badge: 'bg-blue-100 text-blue-800', bg: 'bg-blue-50', color: 'border-blue-400' },
    4: { label: 'æ¿€å‹•', scale: 'scale-110', badge: 'bg-purple-100 text-purple-800', bg: 'bg-purple-50', color: 'border-purple-500' },
    5: { label: 'ä¼èª¬', scale: 'scale-110 md:scale-115', badge: 'bg-yellow-100 text-yellow-800', bg: 'bg-yellow-50', color: 'border-yellow-500 border-4' },
    6: { label: 'ç¥è©±', scale: 'scale-110 md:scale-115', badge: 'bg-rose-100 text-rose-800', bg: 'bg-rose-50', color: 'border-rose-500 border-4' },
};

const CUSTOM_MONTHS = {1:'å‰µè–æœˆ',2:'ç¥ˆå¾‹æœˆ',3:'å•“å…‰æœˆ',4:'å¤©è© æœˆ',5:'ç¥è¯æœˆ',6:'æ´—ç¤¼æœˆ',7:'ç†¾å¤©æœˆ',8:'ç‚ä¾›æœˆ',9:'è–ç©¹æœˆ',10:'å†¥ç¥€æœˆ',11:'å†å¾‹æœˆ',12:'é»™ä¿¡æœˆ'};
// ã‚¢ãƒ¡ãƒªã‚«ã®GDPã‚’3å€ã«è£œæ­£æ¸ˆã¿ (å®Ÿè³ªä¾¡å€¤æ›ç®—ç”¨)
const US_STATS = [
    {year:1680, population:3929000, gdp:60000000000},
    {year:1900, population:76212000, gdp:12000000000000},
    {year:2000, population:281421000, gdp:3150000000000000}
];

const formatDate = (y, m, d) => `è‹±è¦‡æš¦ ${y}å¹´` + (m ? ` ${CUSTOM_MONTHS[m]}(${m}æœˆ)` : '') + (d ? ` ${d}æ—¥` : '');
const formatJapaneseNumber = (n, s='', short=false) => { 
    if(!n && n!==0) return '-'; 
    if(n===0) return '0'+s; 
    
    const abs = Math.abs(n);
    let unit = '';
    let num = n;

    if (abs >= 1e16) { unit = 'äº¬'; num = n / 1e16; }
    else if (abs >= 1e12) { unit = 'å…†'; num = n / 1e12; }
    else if (abs >= 1e8) { unit = 'å„„'; num = n / 1e8; }
    else if (abs >= 1e4) { unit = 'ä¸‡'; num = n / 1e4; }

    if (unit) {
        // å˜ä½ãŒã‚ã‚‹å ´åˆã¯æœ€å¤§å°æ•°ç‚¹2æ¡ï¼ˆã‚°ãƒ©ãƒ•ãªã©ã§short=trueã®å ´åˆã¯1æ¡ï¼‰ã¾ã§è¡¨ç¤º
        const formatted = num.toLocaleString(undefined, { maximumFractionDigits: short ? 1 : 2 });
        return formatted + unit + s;
    }
    
    // ä¸‡æœªæº€ã¯ãã®ã¾ã¾3æ¡åŒºåˆ‡ã‚Š
    return n.toLocaleString() + s; 
};const calculatePerCapita = (g, p) => (!p ? 0 : Math.round(g/p));

const fileToBase64 = (file) => new Promise((res, rej) => {
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = e => {
        const img = new Image(); img.onload = () => {
            const c = document.createElement('canvas'); let w=img.width, h=img.height;
            if(w>h){ if(w>150){h*=150/w; w=150;} } else { if(h>150){w*=150/h; h=150;} }
            c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/webp',0.8));
        }; img.src = e.target.result;
    }; reader.onerror = rej;
});

// äººç‰©ç”»ç”¨ï¼šå°‘ã—é«˜ç”»è³ª (é•·è¾º400px)
const fileToBase64HighRes = (file) => new Promise((res, rej) => {
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = e => {
        const img = new Image(); img.onload = () => {
            const c = document.createElement('canvas'); let w=img.width, h=img.height;
            // ã‚µã‚¤ã‚ºåˆ¶é™ã‚’ç·©å’Œ (150 -> 400)
            if(w>h){ if(w>400){h*=400/w; w=400;} } else { if(h>400){w*=400/h; h=400;} }
            c.width=w; c.height=h; 
            // ç”»è³ªã‚‚å°‘ã—ä¸Šã’ã‚‹ (0.8 -> 0.9)
            c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/webp',0.9));
        }; img.src = e.target.result;
    }; reader.onerror = rej;
});

const compressBase64Image = (base64) => new Promise(res => {
    const img = new Image(); img.onload = () => {
        const c = document.createElement('canvas'); let w=img.width, h=img.height;
        if(w>h){ if(w>150){h*=150/w; w=150;} } else { if(h>150){w*=150/h; h=150;} }
        c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/webp',0.8));
    }; img.onerror=()=>res(base64); img.src=base64;
});

const getNationInfo = (nation, year) => {
    let info = { name: nation.name, color: nation.color, flag: nation.flag, params: nation.params || {}, isCollapsed: false, isFuture: false, eraEvent: null, eraStartYear: null, eraEndYear: null, nationStartYear: null, nationEndYear: null };
    const sortedEras = (nation.eras || []).sort((a, b) => a.startYear - b.startYear);
    const birthEra = sortedEras.find(e => e.event && ['foundation', 'independence', 'splinter', 'unification', 'foundation_puppet'].includes(e.event.type));
    if (birthEra) info.nationStartYear = birthEra.startYear; else if (sortedEras.length > 0) info.nationStartYear = sortedEras[0].startYear;
    const collapseEra = sortedEras.find(e => e.type === 'collapse' || (e.event && ['annexed_by', 'partitioned_by', 'merger', 'dissolution'].includes(e.event.type)));
    if (collapseEra) info.nationEndYear = collapseEra.startYear;
    if (info.nationStartYear !== null && year < info.nationStartYear) return { ...info, isFuture: true };
    let idx = -1; for (let i = sortedEras.length - 1; i >= 0; i--) { if (sortedEras[i].startYear <= year) { idx = i; break; } }
    if (idx !== -1) {
        const cur = sortedEras[idx]; const next = sortedEras[idx + 1];
        info.eraStartYear = cur.startYear;
        if (next) info.eraEndYear = next.startYear; else if (info.nationEndYear) info.eraEndYear = info.nationEndYear;
        if (cur.type === 'collapse') return { ...info, isCollapsed: true, name: cur.name || `${info.name}(æ»…äº¡)`, color: '#9ca3af', flag: null, eraEvent: cur.event };
        return { ...info, name: cur.name, color: cur.color, flag: cur.flag || nation.flag, params: cur.params || {}, isCollapsed: false, eraEvent: cur.event };
    }
    return info;
};

const NATION_PARAMS = [
    { key: 'ideology_gov', label: 'çµ±æ²»ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼', defaultColor: '#60a5fa' },
    { key: 'ideology_pol', label: 'æ”¿æ²»ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼', defaultColor: '#fbbf24' },
    { key: 'ideology_eco', label: 'çµŒæ¸ˆã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼', defaultColor: '#4ade80' },
    { key: 'ideology_dip', label: 'å¤–äº¤ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼', defaultColor: '#a78bfa' },
    { key: 'suffrage', label: 'é¸æŒ™æ¨©', defaultColor: '#f87171' },
    { key: 'religion', label: 'å®—æ•™', defaultColor: '#fb923c' },
];

const EASING_FUNCTIONS = {
            linear: { name: 'ç›´ç·š (ä¸€å®š)', func: t => t },
            quadIn: { name: 'åŠ é€Ÿ (2ä¹—)', func: t => t * t },
            quadOut: { name: 'æ¸›é€Ÿ (2ä¹—)', func: t => t * (2 - t) },
            cubicIn: { name: 'æ€¥åŠ é€Ÿ (3ä¹—)', func: t => t * t * t },
            cubicOut: { name: 'æ€¥æ¸›é€Ÿ (3ä¹—)', func: t => (--t) * t * t + 1 },
            quartIn: { name: 'è¶…åŠ é€Ÿ (4ä¹—)', func: t => t * t * t * t },
            quartOut: { name: 'è¶…æ¸›é€Ÿ (4ä¹—)', func: t => 1 - (--t) * t * t * t },
            expoIn: { name: 'çˆ†ç™ºçš„ (æŒ‡æ•°)', func: t => Math.pow(2, 10 * (t - 1)) },
            expoOut: { name: 'åæŸ (æŒ‡æ•°)', func: t => -Math.pow(2, -10 * t) + 1 },
            sigmoid: { name: 'Så­— (æ»‘ã‚‰ã‹)', func: t => t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t },
        };

const IconWrapper = ({ children, size = 24, className = "", ...props }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
        {children}
    </svg>
);

 const Icons = {
    // æ—¢å­˜ã®ã‚¢ã‚¤ã‚³ãƒ³
    Dagger: p=><IconWrapper {...p}><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><line x1="13" y1="19" x2="19" y2="13"/></IconWrapper>,
    Shield: p=><IconWrapper {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconWrapper>,
    Crosshair: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></IconWrapper>,
    Award: p=><IconWrapper {...p}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconWrapper>,
    Eye: p=><IconWrapper {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
    Swords: p=><IconWrapper {...p}><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><path d="M17.5 14.5L6 3H3v3l11.5 11.5"/></IconWrapper>,
    Zap: p=><IconWrapper {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>,
    Castle: p=><IconWrapper {...p}><path d="M22 20v-7.82a2 2 0 0 0-1.11-1.79l-1.12-.56a.25.25 0 0 1-.13-.23V5a2 2 0 0 0-2-2h-3a2 2 0 0 0-2 2v2h-2V5a2 2 0 0 0-2-2H5.76a2 2 0 0 0-2 2v4.58a.25.25 0 0 1-.12.22l-1.13.57A2 2 0 0 0 1.4 12.18V20h20.2z"/></IconWrapper>,
    Sun: p=><IconWrapper {...p}><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></IconWrapper>,
    Crown: p=><IconWrapper {...p}><path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></IconWrapper>,
    Plus: p=><IconWrapper {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
    BookOpen: p=><IconWrapper {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>,
    Trash2: p=><IconWrapper {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconWrapper>,
    Edit2: p=><IconWrapper {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>,
    Save: p=><IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
    ChevronRight: p=><IconWrapper {...p}><polyline points="9 18 15 12 9 6"/></IconWrapper>,
    ChevronDown: p=><IconWrapper {...p}><polyline points="6 9 12 15 18 9"/></IconWrapper>,
    Search: p=><IconWrapper {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></IconWrapper>,
    Calendar: p=><IconWrapper {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconWrapper>,
    Download: p=><IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>,
    Upload: p=><IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>,
    Filter: p=><IconWrapper {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconWrapper>,
    Tag: p=><IconWrapper {...p}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></IconWrapper>,
    Settings: p=><IconWrapper {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconWrapper>,
    BarChart2: p=><IconWrapper {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconWrapper>,
    TrendingUp: p=><IconWrapper {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>,
    Users: p=><IconWrapper {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconWrapper>,
    DollarSign: p=><IconWrapper {...p}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>,
    X: p=><IconWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>,
    Activity: p=><IconWrapper {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconWrapper>,
    ArrowLeft: p=><IconWrapper {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconWrapper>,
    History: p=><IconWrapper {...p}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/></IconWrapper>,
    List: p=><IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconWrapper>,
    Flag: p=><IconWrapper {...p}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></IconWrapper>,
    Image: p=><IconWrapper {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconWrapper>,
    Globe: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconWrapper>,
    Skull: p=><IconWrapper {...p}><circle cx="9" cy="12" r="1" /><circle cx="15" cy="12" r="1" /><path d="M8 20v2h8v-2" /><path d="M12.5 17l-.5-4" /><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20" /></IconWrapper>,
    RefreshCw: p=><IconWrapper {...p}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconWrapper>,
    HelpCircle: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>,
    Link: p=><IconWrapper {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconWrapper>,
    CornerDownRight: p=><IconWrapper {...p}><polyline points="15 10 20 15 15 20"/><path d="M4 4v7a4 4 0 0 0 4 4h12"/></IconWrapper>,
    GitMerge: p=><IconWrapper {...p}><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></IconWrapper>,
    Minus: p=><IconWrapper {...p}><line x1="5" y1="12" x2="19" y2="12"/></IconWrapper>,
    LayoutGrid: p=><IconWrapper {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></IconWrapper>,
    FileText: p=><IconWrapper {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconWrapper>,
    MapPin: p=><IconWrapper {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
    User: p=><IconWrapper {...p}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>,
    Briefcase: p=><IconWrapper {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconWrapper>,
    Structure: p=><IconWrapper {...p}><rect x="9" y="3" width="6" height="6" rx="1"/><rect x="2" y="15" width="6" height="6" rx="1"/><rect x="16" y="15" width="6" height="6" rx="1"/><path d="M12 9v3"/><path d="M5 12h14"/><path d="M5 12v3"/><path d="M19 12v3"/></IconWrapper>,
    Lock: p=><IconWrapper {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>,
    Info: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></IconWrapper>,
    MousePointer: p=><IconWrapper {...p}><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></IconWrapper>,
    Clock: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>,
    Edit3: p=><IconWrapper {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconWrapper>,
    Monitor: p=><IconWrapper {...p}><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></IconWrapper>,
    ZoomIn: p=><IconWrapper {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></IconWrapper>,
    Database: p=><IconWrapper {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconWrapper>,
    Star: p=><IconWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>,
    Circle: p=><IconWrapper {...p}><circle cx="12" cy="12" r="10"/></IconWrapper>,
    Inbox: p=><IconWrapper {...p}><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></IconWrapper>,
    Terminal: p=><IconWrapper {...p}><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></IconWrapper>,
    MessageCircle: p=><IconWrapper {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconWrapper>,
    Send: p=><IconWrapper {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconWrapper>,
};

// ãƒ¬ãƒ™ãƒ«ãƒ©ãƒ³ã‚¯å®šç¾© (åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ç”¨)
const LEVEL_RANKS = [
    { max: 7, label: 'ä¸€èˆ¬å¸‚æ°‘', color: 'text-gray-500', bg: 'bg-gray-100', border: 'border-gray-200', icon: Icons.User },
    { max: 14, label: 'é§†ã‘å‡ºã—', color: 'text-stone-600', bg: 'bg-stone-100', border: 'border-stone-200', icon: Icons.Dagger },
    { max: 24, label: 'æ­£è¦å…µ', color: 'text-blue-700', bg: 'bg-blue-100', border: 'border-blue-200', icon: Icons.Shield },
    { max: 39, label: 'ç²¾é‹­', color: 'text-cyan-700', bg: 'bg-cyan-100', border: 'border-cyan-200', icon: Icons.Crosshair },
    { max: 49, label: 'å¤å¼·è€…', color: 'text-teal-700', bg: 'bg-teal-100', border: 'border-teal-200', icon: Icons.Award },
    { max: 59, label: 'é”äºº', color: 'text-emerald-700', bg: 'bg-emerald-100', border: 'border-emerald-200', icon: Icons.Eye },
    { max: 69, label: 'çŒ›è€…', color: 'text-orange-700', bg: 'bg-orange-100', border: 'border-orange-200', icon: Icons.Swords },
    { max: 79, label: 'è‹±é›„', color: 'text-red-700', bg: 'bg-red-100', border: 'border-red-200', icon: Icons.Zap },
    { max: 89, label: 'æœ€é«˜æˆ¦åŠ›', color: 'text-purple-700', bg: 'bg-purple-100', border: 'border-purple-200', icon: Icons.Castle },
    { max: 99, label: 'è¶…è¶Šè€…', color: 'text-fuchsia-700', bg: 'bg-fuchsia-100', border: 'border-fuchsia-200', icon: Icons.Sun },
    { max: 9999, label: 'ç¥è©±', color: 'text-yellow-700', bg: 'bg-yellow-100', border: 'border-yellow-200', icon: Icons.Crown },
];

const getLevelRank = (level) => {
    if (!level) return null;
    return LEVEL_RANKS.find(r => level <= r.max) || LEVEL_RANKS[LEVEL_RANKS.length - 1];
};


const SectionHeader = ({ icon: Icon, title, desc }) => (
    <div className="bg-gray-800 text-white p-6 rounded-lg shadow-md mb-6">
        <h2 className="text-2xl font-bold flex items-center gap-2"><Icon size={28} className="text-yellow-500" />{title}</h2>{desc && <p className="text-gray-400 mt-2 text-sm">{desc}</p>}
    </div>
);

const NationTag = ({ text, nations, year }) => {
    if (text === 'ä¸–ç•Œ') return (<span className="text-[10px] bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded border border-indigo-100 inline-flex items-center gap-1 relative pr-2"><Icons.Globe size={10} /> ä¸–ç•Œ</span>);
    const matchedNation = nations.find(n => { const info = getNationInfo(n, year); return info.name === text && !info.isCollapsed; });
    let flagSrc = null; if (matchedNation) { const info = getNationInfo(matchedNation, year); flagSrc = info.flag; }
    return (<span className="text-[10px] bg-black/5 text-gray-600 px-1.5 py-0.5 rounded border border-black/5 inline-flex items-center gap-1 relative pr-2">{text}{flagSrc && (<span className="inline-block w-4 h-3 rounded-sm overflow-hidden border border-black/10 ml-1 shadow-sm"><img src={flagSrc} alt="" className="w-full h-full object-cover" /></span>)}</span>);
};

// --- HelpView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (å®Œå…¨è©³ç´°ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç‰ˆ) ---
const HelpView = ({ setView }) => {
    const [activeTab, setActiveTab] = useState('menu_guide');

    // ã‚¿ãƒ–å®šç¾©
    const TABS = [
        { id: 'menu_guide', label: 'æ©Ÿèƒ½ãƒ»æ“ä½œã‚¬ã‚¤ãƒ‰', icon: Icons.HelpCircle },
        { id: 'tips', label: 'ä¸–ç•Œæ§‹ç¯‰ã®ãƒ’ãƒ³ãƒˆ', icon: Icons.Zap },
        { id: 'database', label: 'ãƒ‡ãƒ¼ã‚¿å®šç¾©ãƒ»åŸºæº–', icon: Icons.BookOpen },
    ];

    // ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
    const SectionTitle = ({ icon: Icon, title, color = "text-gray-800", bgColor = "bg-gray-100", desc }) => (
        <div className={`p-4 rounded-xl border border-gray-200 mb-6 ${bgColor}`}>
            <div className="flex items-center gap-3 mb-2">
                <div className={`p-2 rounded-lg bg-white shadow-sm ${color}`}>
                    <Icon size={24} />
                </div>
                <h3 className={`text-xl font-bold ${color}`}>{title}</h3>
            </div>
            {desc && <p className="text-sm text-gray-600 ml-1">{desc}</p>}
        </div>
    );

    // è©³ç´°ç‰ˆãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚«ãƒ¼ãƒ‰
    const FeatureCard = ({ icon: Icon, title, subTitle, desc, features, tip, colorClass, badge }) => (
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-all duration-300 overflow-hidden group">
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */}
            <div className="p-5 flex gap-4 items-start border-b border-gray-100 bg-gray-50/30">
                <div className={`shrink-0 w-16 h-16 rounded-2xl flex items-center justify-center text-white shadow-lg ${colorClass} group-hover:scale-105 transition-transform duration-300`}>
                    <Icon size={32} />
                </div>
                <div className="flex-grow">
                    <div className="flex justify-between items-start">
                        <div>
                            <h4 className="font-bold text-xl text-gray-800 leading-tight">{title}</h4>
                            <div className="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">{subTitle}</div>
                        </div>
                        {badge && <span className="text-[10px] font-bold px-2 py-1 rounded bg-white text-gray-500 border border-gray-200 shadow-sm">{badge}</span>}
                    </div>
                    <p className="text-sm text-gray-600 mt-3 leading-relaxed font-medium">
                        {desc}
                    </p>
                </div>
            </div>

            {/* è©³ç´°ãƒªã‚¹ãƒˆéƒ¨åˆ† */}
            <div className="p-5 bg-white">
                <div className="mb-4">
                    <h5 className="text-xs font-bold text-gray-400 mb-2 flex items-center gap-1">
                        <Icons.List size={12}/> ä¸»ãªæ©Ÿèƒ½
                    </h5>
                    <ul className="space-y-1.5">
                        {features.map((f, i) => (
                            <li key={i} className="text-sm text-gray-700 flex items-start gap-2">
                                <span className="text-blue-400 mt-1.5 w-1 h-1 rounded-full bg-blue-400 shrink-0"></span>
                                <span className="leading-snug">{f}</span>
                            </li>
                        ))}
                    </ul>
                </div>

                {/* Tipséƒ¨åˆ† */}
                {tip && (
                    <div className="mt-4 pt-3 border-t border-dashed border-gray-200">
                        <div className="flex gap-2 items-start text-xs text-gray-500 bg-yellow-50/50 p-3 rounded-lg border border-yellow-100">
                            <Icons.Zap size={14} className="text-yellow-500 shrink-0 mt-0.5" />
                            <span><strong className="text-yellow-700">æ´»ç”¨ãƒ’ãƒ³ãƒˆ:</strong> {tip}</span>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );

    const renderContent = () => {
        switch (activeTab) {
            case 'menu_guide':
                return (
                    <div className="space-y-12 animate-fade-in">
                        <div className="bg-gradient-to-r from-gray-800 to-gray-700 p-8 rounded-2xl shadow-lg text-white mb-8">
                            <h2 className="text-2xl font-bold mb-3 flex items-center gap-3">
                                <Icons.BookOpen className="text-yellow-400" />
                                è‹±è¦‡æ­´ä»£è¨˜ æ©Ÿèƒ½å®Œå…¨ã‚¬ã‚¤ãƒ‰
                            </h2>
                            <p className="text-gray-300 leading-relaxed text-sm opacity-90">
                                å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®å½¹å‰²ã¨ã€è©³ç´°ãªä»•æ§˜ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚<br/>
                                ç·¨é›†æ©Ÿèƒ½ï¼ˆMANAGEï¼‰ã¯æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒä½¿ç”¨ã§ãã¾ã™ãŒã€é–²è¦§æ©Ÿèƒ½ï¼ˆVIEWï¼‰ã¯ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–‹æ”¾ã•ã‚Œã¦ã„ã¾ã™ã€‚
                            </p>
                        </div>

                        {/* MANAGE ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                        <div>
                            <SectionTitle 
                                icon={Icons.Edit2} 
                                title="MANAGEï¼šæƒ…å ±ã®ç·¨é›†ãƒ»è¨˜éŒ²" 
                                color="text-yellow-700" 
                                bgColor="bg-yellow-50"
                                desc="æ­´å²ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆãƒ»æ›´æ–°ã™ã‚‹ãŸã‚ã®ç®¡ç†è€…å‘ã‘ãƒ„ãƒ¼ãƒ«ç¾¤ã§ã™ã€‚"
                            />
                            
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <FeatureCard 
                                    icon={Icons.Edit2} 
                                    title="æ­´å²ã‚’åˆ»ã‚€" 
                                    subTitle="Create History"
                                    colorClass="bg-gradient-to-br from-yellow-400 to-yellow-600"
                                    desc="å¹´è¡¨ã«æ–°ã—ã„ã€Œå‡ºæ¥äº‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã€ã‚’è¿½åŠ ã—ã¾ã™ã€‚æ­´å²ã®æœ€å°å˜ä½ã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹å ´æ‰€ã§ã™ã€‚"
                                    features={[
                                        "å¹´æœˆæ—¥ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã®ç™»éŒ²ï¼ˆæœˆæ—¥ã¯ä¸æ˜ã§ã‚‚å¯ï¼‰",
                                        "é‡è¦åº¦ï¼ˆLv1ï½6ï¼‰ã®è¨­å®šï¼šLvãŒé«˜ã„ã»ã©å¹´è¡¨ã§å¤§ããè¡¨ç¤ºã•ã‚Œã¾ã™",
                                        "ã‚¿ã‚°ä»˜ã‘ï¼šæ¤œç´¢ç”¨ã«ã€Œæˆ¦äº‰ã€ã€Œæ–‡åŒ–ã€ãªã©ã®åˆ†é¡ã‚¿ã‚°ã‚’ä»˜ä¸",
                                        "è©³ç´°è¨˜è¿°ï¼šHTMLã‚¿ã‚°ã‚’ç”¨ã„ãŸè‡ªç”±ãªè¨˜è¿°ãŒå¯èƒ½"
                                    ]}
                                    tip="ã€Œé‡è¦åº¦: ç¥è©±(Lv6)ã€ã«è¨­å®šã™ã‚‹ã¨ã€èˆˆäº¡ç³»è­œå›³ä¸Šã«ç‰¹åˆ¥ãªãƒãƒ¼ã‚«ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã€æ™‚ä»£ã®è»¢æ›ç‚¹ã¨ã—ã¦å¼·èª¿ã•ã‚Œã¾ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.Globe} 
                                    title="å›½å®¶ç·¨æˆ" 
                                    subTitle="Nation Settings"
                                    colorClass="bg-gray-700"
                                    desc="å›½å®¶ã®åŸºæœ¬æƒ…å ±ã‚’ç®¡ç†ã—ã¾ã™ã€‚å˜ãªã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã ã‘ã§ãªãã€æ­´å²çš„ãªã€Œå¤‰é·ã€ã‚‚ã“ã“ã§åˆ¶å¾¡ã—ã¾ã™ã€‚"
                                    features={[
                                        "åŸºæœ¬æƒ…å ±ï¼šå›½æ——ã€ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã€æ‰€åœ¨å¤§é™¸ã€å›½åŠ›ãƒ©ãƒ³ã‚¯ã®è¨­å®š",
                                        "Eraï¼ˆå¤‰é·ï¼‰ã‚·ã‚¹ãƒ†ãƒ ï¼šé©å‘½ã‚„åˆä½µã«ã‚ˆã‚‹ã€Œå›½åãƒ»å›½æ——ã®å¤‰åŒ–ã€ã‚’æ™‚ç³»åˆ—ã§ç®¡ç†",
                                        "æ»…äº¡è¨˜éŒ²ï¼šä»–å›½ã¸ã®ä½µåˆã€åˆ†è£‚ãªã©ã®ç†ç”±ã¨å…±ã«æ»…äº¡å¹´ã‚’è¨˜éŒ²",
                                        "æ¦‚è¦ã‚¨ãƒ‡ã‚£ã‚¿ï¼šæ–‡åŒ–ã‚„åœ°ç†ãªã©ã®é•·æ–‡è¨­å®šã‚’è¨˜è¿°"
                                    ]}
                                    tip="å›½åãŒå¤‰ã‚ã‚‹å ´åˆï¼ˆç‹å›½â†’å…±å’Œå›½ãªã©ï¼‰ã¯ã€æ–°è¦ä½œæˆã›ãšã«ã€Œå¤‰é·ãƒªã‚¹ãƒˆã€ã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãªã©ãŒé€”åˆ‡ã‚Œãšã«ç¶™æ‰¿ã•ã‚Œã¾ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.User} 
                                    title="äººç‰©ç®¡ç†" 
                                    subTitle="Character Database"
                                    colorClass="bg-gray-700"
                                    desc="æ­´å²ã‚’å‹•ã‹ã™é‡è¦äººç‰©ã‚’ç™»éŒ²ã—ã¾ã™ã€‚å„å›½ã®ã€Œé–¢é€£äººç‰©ã€æ¬„ã«ã‚‚è‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚"
                                    features={[
                                        "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼šè‚–åƒç”»ã€ç¨®æ—ã€ç”Ÿæ²¡å¹´ã®ç™»éŒ²",
                                        "é­‚ä½æ·±åº¦(Lv)ï¼šå¼·ã•ã®æŒ‡æ¨™ã¨ãªã‚‹ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®šï¼ˆLv.1ï½100+ï¼‰",
                                        "æ‰€å±è¨­å®šï¼šè¤‡æ•°ã®çµ„ç¹”ã‚„å›½å®¶ã¸ã®æ‰€å±æ­´ã¨ã€å½“æ™‚ã®å½¹è·ã‚’è¨˜éŒ²",
                                    ]}
                                    tip="æ‰€å±ã«ã€Œå›½å®¶åã€ã‚’å…¥ã‚Œã‚‹ã¨ã€ãã®å›½ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ã«è‡ªå‹•çš„ã«ãƒªãƒ³ã‚¯ã•ã‚Œã¾ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.Briefcase} 
                                    title="çµ„ç¹”ç®¡ç†" 
                                    subTitle="Organization Database"
                                    colorClass="bg-gray-700"
                                    desc="å›½å®¶ã¨ã„ã†æ çµ„ã¿ã«åã¾ã‚‰ãªã„é›†å›£ï¼ˆã‚®ãƒ«ãƒ‰ã€çµç¤¾ã€ä¼æ¥­ã€å®—æ•™å›£ä½“ãªã©ï¼‰ã‚’ç®¡ç†ã—ã¾ã™ã€‚"
                                    features={[
                                        "çµ„ç¹”ã‚¿ã‚¤ãƒ—ï¼šè»äº‹ã€å­¦è¡“ã€çŠ¯ç½ªçµ„ç¹”ãªã©ã®ã‚«ãƒ†ã‚´ãƒªè¨­å®š",
                                        "æ´»å‹•æœŸé–“ï¼šè¨­ç«‹å¹´ã¨è§£æ•£å¹´ã®è¨˜éŒ²",
                                        "æ‹ ç‚¹è¨­å®šï¼šã©ã“ã®å›½ã‚’æ‹ ç‚¹ã«ã—ã¦ã„ã‚‹ã‹ã‚’ç´ä»˜ã‘",
                                        "æ§‹æˆå“¡ç®¡ç†ï¼šä¸»è¦äººç‰©ã‚’ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦ç™»éŒ²"
                                    ]}
                                    tip="ã€Œå¤§é™¸å…¨åœŸã«æ”¯éƒ¨ã‚’æŒã¤ã‚®ãƒ«ãƒ‰ã€ãªã©ã¯ã€ç‰¹å®šã®å›½ã«ç´ä»˜ã‘ãšã€Œæ‰€å±ãªã—ã€ã¨ã—ã¦ä½œæˆã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.BarChart2} 
                                    title="çµ±è¨ˆç·¨é›†" 
                                    subTitle="Statistics Editor"
                                    colorClass="bg-gray-700"
                                    desc="å„å›½ã®ã€Œäººå£ã€ã¨ã€ŒGDPï¼ˆçµŒæ¸ˆåŠ›ï¼‰ã€ã®æ•°å€¤ã‚’å¹´å˜ä½ã§å…¥åŠ›ã—ã¾ã™ã€‚"
                                    features={[
                                        "æ™‚ç³»åˆ—å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼šä¸€å›½ã‚’é¸ã³ã€æ™‚ç³»åˆ—ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›",
                                        "å®šç‚¹è¦³æ¸¬ãƒ¢ãƒ¼ãƒ‰ï¼šç‰¹å®šã®å¹´ã‚’é¸ã³ã€å…¨å›½å®¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¨ªæ–­å…¥åŠ›",
                                        "â˜…ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«æ©Ÿèƒ½ï¼šé–‹å§‹å¹´ã¨çµ‚äº†å¹´ã®å€¤ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§ã€é–“ã®æ•°å€¤ã‚’è‡ªå‹•è¨ˆç®—ï¼ˆç›´ç·šã€Så­—ã‚«ãƒ¼ãƒ–ãªã©ï¼‰ã—ã¦åŸ‹ã‚ã‚‹å¼·åŠ›ãªæ©Ÿèƒ½"
                                    ]}
                                    tip="ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã®ã€ŒSå­—ã‚«ãƒ¼ãƒ–(Sigmoid)ã€ã‚’ä½¿ã†ã¨ã€æ€¥æˆé•·ã—ãŸå¾Œã«å®‰å®šæœŸã«å…¥ã‚‹ãƒªã‚¢ãƒ«ãªç™ºå±•ãƒ¢ãƒ‡ãƒ«ã‚’ç°¡å˜ã«ä½œã‚Œã¾ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.Structure} 
                                    title="æ¨©åŠ›æ§‹é€ " 
                                    subTitle="Power Structure"
                                    colorClass="bg-gray-700"
                                    desc="å›½å®¶ã‚„çµ„ç¹”ã®å†…éƒ¨çµ±æ²»æ©Ÿæ§‹ï¼ˆçµ„ç¹”å›³ï¼‰ã‚’ã€ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§è¦–è¦šçš„ã«æ§‹ç¯‰ã—ã¾ã™ã€‚"
                                    features={[
                                        "ãƒ„ãƒªãƒ¼ç·¨é›†ï¼šéƒ¨ç½²ã‚„å½¹è·ã‚’è‡ªç”±ã«ã¶ã‚‰ä¸‹ã’ã¦éšå±¤æ§‹é€ ã‚’ä½œæˆ",
                                        "äººç‰©ç´ä»˜ã‘ï¼šç™»éŒ²æ¸ˆã¿ã®äººç‰©ãƒ‡ãƒ¼ã‚¿ã‚’å½¹è·ã«å‰²ã‚Šå½“ã¦",
                                        "æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½ï¼šå¤§è¦æ¨¡ãªçµ„ç¹”å›³ã‚‚è¦‹ã‚„ã™ãç®¡ç†",
                                        "è¤‡æ•°ãƒ„ãƒªãƒ¼ï¼šä¸‰æ¨©åˆ†ç«‹ãªã©ã€è¤‡æ•°ã®é ‚ç‚¹ã‚’æŒã¤æ§‹é€ ã‚‚ä½œæˆå¯èƒ½"
                                    ]}
                                    tip="ã€Œçš‡å¸ã€ã®ä¸‹ã«ã€Œå®°ç›¸ã€ã‚’ç½®ãã€ãã®ä¸‹ã«ã€Œå„çœåºã€ã‚’ã¶ã‚‰ä¸‹ã’ã‚‹ã®ãŒåŸºæœ¬å½¢ã§ã™ã€‚"
                                />
                            </div>
                        </div>

                        {/* VIEW ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                        <div>
                            <SectionTitle 
                                icon={Icons.Eye} 
                                title="VIEWï¼šæƒ…å ±ã®é–²è¦§ãƒ»åˆ†æ" 
                                color="text-blue-700" 
                                bgColor="bg-blue-50"
                                desc="ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’æ§˜ã€…ãªåˆ‡ã‚Šå£ã§å¯è¦–åŒ–ãƒ»æ¤œç´¢ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ç¾¤ã§ã™ã€‚"
                            />

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <FeatureCard 
                                    icon={Icons.History} 
                                    title="å¹´è¡¨é–²è¦§" 
                                    subTitle="Timeline View"
                                    colorClass="bg-blue-600"
                                    badge="ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½"
                                    desc="å…¨ã¦ã®æ­´å²ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚ç³»åˆ—é †ã«ä¸¦ã¹ã¦é–²è¦§ã™ã‚‹ã€ã“ã®ã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã§ã™ã€‚"
                                    features={[
                                        "ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼šé‡è¦åº¦ã‚„ã‚¿ã‚°ã«ã‚ˆã‚‹è¡¨ç¤ºã®çµã‚Šè¾¼ã¿",
                                        "æ¤œç´¢æ©Ÿèƒ½ï¼šå‡ºæ¥äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚„å†…å®¹ã‚’å…¨æ–‡æ¤œç´¢",
                                        "çµ±è¨ˆé€£æºï¼šå¹´è¡¨ã®åˆé–“ã«ã€ãã®å¹´ã®å„å›½ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º",
                                        "è©³ç´°è¡¨ç¤ºï¼šã‚¯ãƒªãƒƒã‚¯ã§ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°ãƒšãƒ¼ã‚¸ã¸é·ç§»"
                                    ]}
                                    tip="ç”»é¢å³ä¸Šã®ã€Œæ¡ä»¶ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ç‰¹å®šã®å›½ã®å‡ºæ¥äº‹ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ãã¾ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.LayoutGrid} 
                                    title="å›½å®¶ä¸€è¦§" 
                                    subTitle="Nation List"
                                    colorClass="bg-blue-500"
                                    desc="ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®å›½å®¶ã‚’ã€å¤§é™¸åˆ¥ãƒ»å›½åŠ›é †ã«ã‚«ãƒ¼ãƒ‰å½¢å¼ã§ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ã€‚"
                                    features={[
                                        "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼šç¾åœ¨ã®å­˜ç¶šçŠ¶æ³ï¼ˆå­˜ç¶š/æ»…äº¡/æœªæˆç«‹ï¼‰ã‚’è¡¨ç¤º",
                                        "å›½åŠ›ãƒ©ãƒ³ã‚¯ãƒãƒƒã‚¸ï¼šå¤§åˆ—å¼·ï½éƒ½å¸‚å›½å®¶ã¾ã§ã®ãƒ©ãƒ³ã‚¯ã‚’å¯è¦–åŒ–",
                                        "è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼šã‚¯ãƒªãƒƒã‚¯ã§ãã®å›½ã®å…¨æƒ…å ±ï¼ˆæ¦‚è¦ã€äººç‰©ã€å¹´è¡¨ã€çµ„ç¹”å›³ï¼‰ã‚’é›†ç´„ã—ãŸãƒšãƒ¼ã‚¸ã¸ç§»å‹•"
                                    ]}
                                    tip="ã‚¹ãƒãƒ›ã§ã¯2åˆ—ã€PCã§ã¯4åˆ—ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å›½æ——ç”»åƒã‚’è¨­å®šã™ã‚‹ã¨è¦‹æ „ãˆãŒæ ¼æ®µã«è‰¯ããªã‚Šã¾ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.GitMerge} 
                                    title="èˆˆäº¡ç³»è­œå›³" 
                                    subTitle="Rise & Fall Genealogy"
                                    colorClass="bg-blue-500"
                                    desc="å›½å®¶ã®èª•ç”Ÿã€åˆä½µã€åˆ†è£‚ã€æ»…äº¡ã®æµã‚Œã‚’ã€ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆå½¢å¼ï¼ˆãƒ¬ãƒ¼ãƒ³å›³ï¼‰ã§å¯è¦–åŒ–ã—ã¾ã™ã€‚"
                                    features={[
                                        "æ­´å²ã®å¯è¦–åŒ–ï¼šã©ã®å›½ãŒã©ã®å›½ã‹ã‚‰æ´¾ç”Ÿã—ãŸã‹ãŒä¸€ç›®ç­ç„¶",
                                        "ã‚¤ãƒ™ãƒ³ãƒˆç·šï¼šç‹¬ç«‹ã€ä½µåˆã€å‚€å„¡åŒ–ãªã©ã®é–¢ä¿‚æ€§ã‚’çŸ¢å°ã§è¡¨ç¤º",
                                        "ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ï¼šã‚¹ãƒãƒ›ã®ãƒ”ãƒ³ãƒæ“ä½œã§æ‹¡å¤§ç¸®å°ãŒå¯èƒ½",
                                        "é‡è¦ã‚¤ãƒ™ãƒ³ãƒˆï¼šä¼èª¬ç´šã®å‡ºæ¥äº‹ã¯â˜…ãƒãƒ¼ã‚¯ã§è¡¨ç¤º"
                                    ]}
                                    tip="ä¸Šä¸‹æ–¹å‘ãŒæ™‚é–“è»¸ã§ã™ã€‚ä¸€ç•ªä¸‹ãŒç¾ä»£ã«ãªã‚Šã¾ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.Activity} 
                                    title="çµ±è¨ˆã‚°ãƒ©ãƒ•" 
                                    subTitle="Stats Analysis"
                                    colorClass="bg-blue-500"
                                    desc="å…¥åŠ›ã•ã‚ŒãŸäººå£ãƒ»GDPãƒ‡ãƒ¼ã‚¿ã‚’æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã§æ¯”è¼ƒè¡¨ç¤ºã—ã¾ã™ã€‚"
                                    features={[
                                        "3ã¤ã®æŒ‡æ¨™ï¼šç·äººå£ã€GDP(çµŒæ¸ˆè¦æ¨¡)ã€ä¸€äººã‚ãŸã‚ŠGDP(è±Šã‹ã•)ã‚’è¡¨ç¤º",
                                        "æ¯”è¼ƒæ©Ÿèƒ½ï¼šè¤‡æ•°ã®å›½å®¶ã®æˆé•·æ›²ç·šã‚’é‡ã­ã¦æ¯”è¼ƒ",
                                        "åŸºæº–ç·šï¼šç¾å®Ÿã®ã‚¢ãƒ¡ãƒªã‚«åˆè¡†å›½ã®æˆé•·ãƒ‡ãƒ¼ã‚¿ï¼ˆå²å®Ÿå‚è€ƒï¼‰ã¨æ¯”è¼ƒå¯èƒ½"
                                    ]}
                                    tip="å‡¡ä¾‹ã®å›½åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å›½ã®ã‚°ãƒ©ãƒ•ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.List} 
                                    title="ä½“åˆ¶ä¸€è¦§è¡¨" 
                                    subTitle="Regime Table"
                                    colorClass="bg-blue-500"
                                    desc="æŒ‡å®šã—ãŸå¹´ã«ãŠã‘ã‚‹ã€å…¨ä¸–ç•Œã®å›½å®¶æƒ…å‹¢ã‚’è¡¨å½¢å¼ã§ä¸€è¦§åŒ–ã—ã¾ã™ã€‚"
                                    features={[
                                        "æ™‚ç‚¹ç§»å‹•ï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è¥¿æš¦ã‚’å‹•ã‹ã—ã€ãã®ç¬é–“ã®ä¸–ç•Œæƒ…å‹¢ã‚’è¡¨ç¤º",
                                        "ä½“åˆ¶æ¯”è¼ƒï¼šå…ƒé¦–ã€æ”¿æ²»ãƒ»çµŒæ¸ˆã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼ã€å®—æ•™ãªã©ã‚’æ¨ªä¸¦ã³ã§æ¯”è¼ƒ",
                                        "äººå£ãƒ»GDPè¡¨ç¤ºï¼šãã®å¹´ã®æ¨å®šå€¤ã‚’è¡¨ç¤º"
                                    ]}
                                    tip="ã€Œ1900å¹´æ™‚ç‚¹ã®å…¨ä¸–ç•Œã®å›½å®¶å…ƒé¦–ä¸€è¦§ãŒè¦‹ãŸã„ã€ã¨ã„ã£ãŸç”¨é€”ã«æœ€é©ã§ã™ã€‚"
                                />
                                <FeatureCard 
                                    icon={Icons.BookOpen} 
                                    title="ç”¨èªé›†" 
                                    subTitle="Glossary / Encyclopedia"
                                    colorClass="bg-blue-500"
                                    desc="å›½å®¶ã€äººç‰©ã€å‡ºæ¥äº‹ã€ä¸€èˆ¬ç”¨èªã‚’çµ±åˆã—ãŸã€æ¤œç´¢å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆç™¾ç§‘äº‹å…¸ï¼‰ã§ã™ã€‚"
                                    features={[
                                        "æ¨ªæ–­æ¤œç´¢ï¼šã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãŒå¯èƒ½",
                                        "è‡ªå‹•ã‚¿ã‚°ï¼šç¨®æ—ã‚„çµ„ç¹”ã‚¿ã‚¤ãƒ—ãªã©ã§è‡ªå‹•çš„ã«åˆ†é¡",
                                        "â˜…è‡ªå‹•ãƒªãƒ³ã‚¯ï¼šè§£èª¬æ–‡ã®ä¸­ã«ä»–ã®ç”¨èªãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•çš„ã«ãƒªãƒ³ã‚¯ãŒè²¼ã‚‰ã‚Œã¾ã™",
                                        "æ›–æ˜§ã•å›é¿ï¼šåŒã˜åå‰ã®é …ç›®ãŒã‚ã‚‹å ´åˆã€é¸æŠè‚¢ã‚’è¡¨ç¤º"
                                    ]}
                                    tip="Wikiã®ã‚ˆã†ã«ä½¿ãˆã¾ã™ã€‚è¨˜äº‹ã‚’èª­ã‚“ã§ã„ã¦æ°—ã«ãªã£ãŸå˜èªã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚Œã°ã€ãã®ãƒšãƒ¼ã‚¸ã¸é£›ã³ã¾ã™ã€‚"
                                />
                            </div>
                        </div>
                    </div>
                );

            case 'tips':
                return (
                    <div className="space-y-8 animate-fade-in">
                        <SectionTitle icon={Icons.Zap} title="ä¸–ç•Œæ§‹ç¯‰ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯" color="text-yellow-600" />
                        
                        <div className="grid grid-cols-1 gap-6">
                             <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <h4 className="font-bold text-lg text-gray-800 mb-3 flex items-center gap-2 pb-2 border-b">
                                    <Icons.GitMerge className="text-blue-500"/> å†…æˆ¦ãƒ»åˆ†è£‚ã‚’ç³»è­œå›³ã§è¡¨ç¾ã™ã‚‹
                                </h4>
                                <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                                    èˆˆäº¡ç³»è­œå›³ã«ãŠã„ã¦ã€Œå›½ãŒçœŸã£äºŒã¤ã«å‰²ã‚Œã‚‹ã€ã‚ˆã†ãªè¡¨ç¾ã‚’ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’è¡Œã„ã¾ã™ã€‚
                                </p>
                                <ol className="list-decimal pl-5 space-y-2 text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">
                                    <li><strong>åä¹±å‹¢åŠ›ã®å›½å®¶åŒ–:</strong> ã€Œå¸å›½åä¹±è»ã€ã‚„ã€Œå—æœã€ãªã©ã®æ–°ã—ã„å›½å®¶ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚</li>
                                    <li><strong>ç‹¬ç«‹ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ:</strong> ãã®å‹¢åŠ›ã®æˆç«‹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆEraï¼‰ã‚’ä½œæˆã—ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’<span className="font-bold text-red-500">ã€Œç‹¬ç«‹ã€</span>ã¾ãŸã¯<span className="font-bold text-red-500">ã€Œå†…æˆ¦ã€</span>ã«è¨­å®šã—ã¾ã™ã€‚</li>
                                    <li><strong>è¦ªæŒ‡å®š (Parent):</strong> è©³ç´°è¨­å®šã®å¯¾è±¡å›½ã§ã€Œå…ƒã®å›½ï¼ˆå¸å›½ï¼‰ã€ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã‚Œã§å¸å›½ã®ãƒ©ã‚¤ãƒ³ã‹ã‚‰æåˆ†ã‹ã‚Œã™ã‚‹ç·šãŒæç”»ã•ã‚Œã¾ã™ã€‚</li>
                                    <li><strong>å†çµ±åˆ:</strong> æˆ¦äº‰ãŒçµ‚ã‚ã£ãŸã‚‰ã€è² ã‘ãŸæ–¹ã®å›½ã«<span className="font-bold text-blue-500">ã€Œä½µåˆã€</span>ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã€å¯¾è±¡ã‚’å‹ã£ãŸå›½ã«ã—ã¾ã™ã€‚ã“ã‚Œã§ç·šãŒå†ã³åˆæµã—ã¾ã™ã€‚</li>
                                </ol>
                            </div>

                            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                <h4 className="font-bold text-lg text-gray-800 mb-3 flex items-center gap-2 pb-2 border-b">
                                    <Icons.RefreshCw className="text-green-500"/> é©å‘½ã«ã‚ˆã‚‹å›½åãƒ»å›½æ——ã®å¤‰æ›´
                                </h4>
                                <p className="text-sm text-gray-600 mb-4 leading-relaxed">
                                    ã€Œãƒ•ãƒ©ãƒ³ã‚¹ç‹å›½ã€ãŒã€Œãƒ•ãƒ©ãƒ³ã‚¹å…±å’Œå›½ã€ã«ãªã£ãŸã‚ˆã†ã«ã€åŒä¸€å›½å®¶ã®ã¾ã¾ä½“åˆ¶ãŒå¤‰ã‚ã‚‹å ´åˆã¯ã€
                                    æ–°ã—ã„å›½ã‚’ä½œã‚‹ã®ã§ã¯ãªã<strong>ã€ŒEraï¼ˆå¤‰é·ï¼‰ã€</strong>æ©Ÿèƒ½ã‚’ä½¿ã„ã¾ã™ã€‚
                                </p>
                                <ul className="list-disc pl-5 space-y-2 text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">
                                    <li>ã€Œå›½å®¶ç·¨æˆã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å¯¾è±¡å›½ã‚’é¸ã³ã€å³å´ã®ã€Œå¤‰é·ãƒªã‚¹ãƒˆã€ã«è¿½åŠ ã—ã¾ã™ã€‚</li>
                                    <li>æ–°ã—ã„å›½åã€å›½æ——ã€ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚</li>
                                    <li>ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’ã€Œæ”¿ä½“ã®å¤‰æ›´ã€ãªã©ã«è¨­å®šã—ã¾ã™ã€‚</li>
                                    <li><span className="text-blue-600 font-bold">ãƒ¡ãƒªãƒƒãƒˆ:</span> çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„äººç‰©ã®æ‰€å±å±¥æ­´ãŒé€”åˆ‡ã‚Œãšã€é€£ç¶šã—ãŸä¸€ã¤ã®å›½ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                );
            
            case 'database':
                return (
                     <div className="space-y-6 animate-fade-in">
                        <SectionTitle icon={Icons.BookOpen} title="ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®šç¾©ãƒ»åŸºæº–" />
                        
                        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                             <h4 className="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
                                <Icons.Activity className="text-purple-500"/> é­‚ä½æ·±åº¦ (ãƒ¬ãƒ™ãƒ«) ã®ç›®å®‰
                             </h4>
                             <p className="text-sm text-gray-600 mb-4">
                                æœ¬ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¼·ã•ï¼ˆLvï¼‰ã®åŸºæº–è¡¨ã§ã™ã€‚ã‚·ãƒŠãƒªã‚ªã®ãƒ‘ãƒ¯ãƒ¼ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ã®å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
                             </p>
                             <div className="overflow-x-auto rounded-lg border border-gray-200">
                                <table className="w-full text-xs md:text-sm text-left border-collapse">
                                    <thead className="bg-gray-100 border-b text-gray-600">
                                        <tr><th className="p-3 w-20 text-center">Lv</th><th className="p-3 w-32">éšç´š</th><th className="p-3">æˆ¦é—˜èƒ½åŠ›ãƒ»å½±éŸ¿åŠ›ã®ç›®å®‰</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100 bg-white">
                                        {[
                                            { lv: '~7', label: 'ä¸€èˆ¬å¸‚æ°‘', desc: 'éæˆ¦é—˜å“¡ã€‚æ­¦å™¨ã‚’æŒã£ãŸã“ã¨ãŒãªã„äººã€…ã€‚' },
                                            { lv: '8-14', label: 'é§†ã‘å‡ºã—', desc: 'æ­¦è£…å¸‚æ°‘ã€å¾´é›†å…µãƒ¬ãƒ™ãƒ«ã€‚å®Ÿæˆ¦çµŒé¨“ã¯æµ…ã„ã€‚' },
                                            { lv: '15-24', label: 'æ­£è¦å…µ', desc: 'è¨“ç·´ã‚’å—ã‘ãŸè·æ¥­è»äººã€‚çµ„ç¹”çš„ãªæˆ¦é—˜ãŒå¯èƒ½ã€‚' },
                                            { lv: '25-39', label: 'ç²¾é‹­', desc: 'è¿‘è¡›å…µã€ç‰¹æ®Šéƒ¨éšŠå“¡ã€‚ä¸€èˆ¬å…µãªã‚‰1åˆ†éšŠã‚’ç›¸æ‰‹ã«ã§ãã‚‹ã€‚' },
                                            { lv: '40-49', label: 'å¤å¼·è€…', desc: 'åã®çŸ¥ã‚ŒãŸæˆ¦å£«ã€‚å°è¦æ¨¡ãªéƒ¨éšŠã®éšŠé•·ã‚¯ãƒ©ã‚¹ã€‚' },
                                            { lv: '50-59', label: 'é”äºº', desc: 'æ­¦èŠ¸ã®æ¥µã¿ã€‚å˜ç‹¬ã§æˆ¦æ³ã‚’å¤‰ãˆã†ã‚‹å®ŸåŠ›è€…ã€‚' },
                                            { lv: '60-69', label: 'çŒ›è€…', desc: 'ä¸€é¨å½“åƒã€‚è»ã®å°†è»ã‚¯ãƒ©ã‚¹ã€‚' },
                                            { lv: '70-79', label: 'è‹±é›„', desc: 'æ­´å²ã«åã‚’æ®‹ã™æ•‘å›½ã®è‹±é›„ã€‚å€‹ã®æ­¦åŠ›ãŒæˆ¦è¡“å…µå™¨ä¸¦ã¿ã€‚' },
                                            { lv: '80-89', label: 'æœ€é«˜æˆ¦åŠ›', desc: 'å¤§å›½ã®æœ€çµ‚å…µå™¨æ‰±ã„ã€‚å­˜åœ¨è‡ªä½“ãŒæˆ¦äº‰ã®æŠ‘æ­¢åŠ›ã¨ãªã‚‹ã€‚' },
                                            { lv: '90~', label: 'è¶…è¶Šè€…', desc: 'äººçŸ¥ã‚’è¶…ãˆãŸç½å®³æŒ‡å®šå­˜åœ¨ã€‚å˜ç‹¬ã§å›½ã‚’æ»…ã¼ã›ã‚‹ã€‚' },
                                        ].map((row, i) => (
                                            <tr key={i} className={i >= 7 ? "bg-yellow-50/50" : "hover:bg-gray-50"}>
                                                <td className="p-3 text-center font-mono font-bold text-gray-500 border-r border-gray-100">{row.lv}</td>
                                                <td className="p-3 font-bold text-gray-800 border-r border-gray-100">{row.label}</td>
                                                <td className="p-3 text-gray-600 leading-relaxed">{row.desc}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                     </div>
                );

            default: return null;
        }
    };

    return (
        <div className="flex flex-col md:flex-row h-full bg-[#f0f2f5] font-sans text-gray-800">
            {/* Sidebar Navigation */}
            <div className="w-full md:w-64 bg-white border-r border-gray-200 flex-shrink-0 md:h-full md:overflow-y-auto z-10">
                <div className="p-5 border-b border-gray-100 bg-gray-50 sticky top-0">
                    <h2 className="font-bold text-gray-800 flex items-center gap-2 text-lg">
                        <Icons.HelpCircle className="text-yellow-500" /> 
                        Manual & Help
                    </h2>
                    <p className="text-[10px] text-gray-400 mt-1 ml-7 tracking-wider uppercase">Official Guide</p>
                </div>
                <nav className="p-2 space-y-1">
                    {TABS.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold transition-all duration-200 group ${
                                activeTab === tab.id 
                                ? 'bg-blue-50 text-blue-700 shadow-sm border-l-4 border-blue-500' 
                                : 'text-gray-500 hover:bg-gray-100 hover:text-gray-800 hover:pl-5'
                            }`}
                        >
                            <tab.icon size={18} className={`transition-colors ${activeTab === tab.id ? "text-blue-600" : "text-gray-400 group-hover:text-gray-600"}`} />
                            {tab.label}
                        </button>
                    ))}
                </nav>
            </div>

            {/* Main Content Area */}
            <div className="flex-grow p-4 md:p-8 overflow-y-auto custom-scrollbar bg-[#f8f9fa]">
                <div className="max-w-5xl mx-auto pb-24">
                    {renderContent()}
                    
                    <div className="mt-16 pt-8 border-t border-gray-200 flex flex-col items-center text-gray-400 text-xs gap-2">
                        <span className="font-serif italic text-lg opacity-50">Helmenaea Chronicle Timeline Wiki</span>
                        <span>World Building & History Management Tool</span>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- NationListView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ã‚¹ãƒãƒ›2åˆ—è¡¨ç¤ºãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ç‰ˆ) ---
const NationListView = ({ setView, nations, onSelectNation }) => {
    // åœ°åŸŸã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const groupedNations = useMemo(() => {
        const grouped = {};
        Object.keys(LOCATIONS).forEach(key => grouped[key] = []);
        nations.forEach(n => {
            const loc = n.location || 'unknown';
            if (!grouped[loc]) grouped[loc] = [];
            grouped[loc].push(n);
        });
        return grouped;
    }, [nations]);

    return (
        <div className="space-y-8 animate-fade-in pb-20">
            {/* å¹´è¡¨ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¯å‰Šé™¤æ¸ˆã¿ã®ãŸã‚ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã¿ */}
            <SectionHeader icon={Icons.LayoutGrid} title="å›½å®¶ä¸€è¦§" desc="ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨å›½å®¶ã®ãƒªã‚¹ãƒˆã§ã™ã€‚è©³ç´°ã‚’ç¢ºèªã—ãŸã„å›½å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚" />
            
            {Object.entries(LOCATIONS).sort((a, b) => a[1].order - b[1].order).map(([locKey, locInfo]) => {
                const locNations = groupedNations[locKey];
                if (!locNations || locNations.length === 0) return null;

                // å›½åŠ›é †ã«ã‚½ãƒ¼ãƒˆ
                locNations.sort((a, b) => {
                    const rankA = NATION_RANKS[a.rank || 'minor_power']?.order || 99;
                    const rankB = NATION_RANKS[b.rank || 'minor_power']?.order || 99;
                    return rankA - rankB;
                });

                return (
                    <div key={locKey} className="mb-8">
                        <h3 className="text-lg font-bold text-gray-700 mb-4 border-l-4 pl-3 flex items-center gap-2" style={{borderColor: locInfo.color}}>
                            <span className="opacity-70"><Icons.MapPin size={18}/></span> {locInfo.label}
                        </h3>
                        {/* â˜…ä¿®æ­£: grid-cols-2 (ã‚¹ãƒãƒ›) -> md:grid-cols-3 -> lg:grid-cols-4 */}
                        {/* gapã‚‚ã‚¹ãƒãƒ›ã§ã¯ç‹­ã(gap-3)ã€PCã§ã¯åºƒã(gap-6)èª¿æ•´ */}
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6">
                            {locNations.map(nation => {
                                // æœŸé–“æƒ…å ±ã®å–å¾—
                                const info = getNationInfo(nation, 2000);
                                const startYear = info.nationStartYear || '????';
                                const endYear = info.nationEndYear;
                                
                                return (
                                    <div key={nation.id} onClick={() => onSelectNation(nation)} 
                                         className="bg-white cursor-pointer group hover:-translate-y-1 transition-transform duration-200 shadow-md hover:shadow-xl overflow-hidden border-2 md:border-4 border-black relative rounded-sm">
                                        {/* å›½æ——éƒ¨åˆ† (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å›ºå®š) */}
                                        <div className="w-full aspect-[3/2] bg-gray-100 border-b-2 md:border-b-4 border-black relative">
                                            {nation.flag ? (
                                                <img src={nation.flag} className="w-full h-full object-cover" alt={nation.name} />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-gray-300 bg-gray-50 font-bold text-xs">No Flag</div>
                                            )}
                                            {/* å›½åŠ›ãƒ©ãƒ³ã‚¯ãƒãƒƒã‚¸ */}
                                            <div className="absolute top-1 right-1 md:top-2 md:right-2">
                                                <span className="px-1.5 py-0.5 md:px-2 md:py-1 text-[8px] md:text-[10px] font-bold border md:border-2 border-black bg-white text-black shadow-sm">
                                                    {NATION_RANKS[nation.rank || 'minor_power']?.label}
                                                </span>
                                            </div>
                                        </div>
                                        {/* å›½åãƒ»æœŸé–“éƒ¨åˆ† (ã‚¹ãƒãƒ›ç”¨ã«paddingã¨æ–‡å­—ã‚µã‚¤ã‚ºã‚’èª¿æ•´) */}
                                        <div className="p-2 md:p-4 text-center bg-white group-hover:bg-yellow-50 transition-colors">
                                            <h4 className="font-black text-xs md:text-lg leading-tight text-gray-900 mb-1 md:mb-2 line-clamp-2 min-h-[1.5em] md:min-h-[auto]">{nation.name}</h4>
                                            <div className="inline-flex items-center gap-1 bg-gray-100 px-2 py-0.5 md:px-3 md:py-1 rounded-full text-[8px] md:text-xs font-mono font-bold text-gray-600 border border-gray-200">
                                                <span className="opacity-50"><Icons.History size={10} className="w-2.5 h-2.5 md:w-3 md:h-3" /></span>
                                                <span>{startYear}</span>
                                                <span className="text-gray-400">ï½</span>
                                                <span className={endYear ? "" : "text-gray-400"}>{endYear || ''}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            })}
        </div>
    );
};

// --- NationTableView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: æ¨©é™ãƒã‚§ãƒƒã‚¯è¿½åŠ ) ---
const NationTableView = ({ isAuthorized, setView, nations, stats, onEditNation, onAddNation }) => { 
    const [year, setYear] = useState(DEFAULT_YEAR);
    const [expandedParents, setExpandedParents] = useState({}); 
    const toggleExpand = (nationId) => { setExpandedParents(prev => ({ ...prev, [nationId]: !prev[nationId] })); };
    const getStat = (nationId, targetYear) => { const exactMatch = stats.find(s => s.nationId === nationId && s.year === targetYear); if (exactMatch) return { ...exactMatch, isEstimated: false }; const nationStats = stats.filter(s => s.nationId === nationId).sort((a, b) => a.year - b.year); if (nationStats.length < 2) return null; let prev = null, next = null; for (const s of nationStats) { if (s.year < targetYear) prev = s; else if (s.year > targetYear) { next = s; break; } } if (prev && next) { const timeRatio = (targetYear - prev.year) / (next.year - prev.year); return { nationId, year: targetYear, population: Math.round(prev.population + (next.population - prev.population) * timeRatio), gdp: Math.round(prev.gdp + (next.gdp - prev.gdp) * timeRatio), isEstimated: true }; } return null; };
    const resolveRelationships = () => { const parents = {}; const children = {}; nations.forEach(n => { const info = getNationInfo(n, year); if (info.eraEvent) { const type = ERA_EVENT_TYPES[info.eraEvent.type]; const targets = info.eraEvent.targetIds || (info.eraEvent.targetId ? [info.eraEvent.targetId] : []); if (type) { targets.forEach(targetId => { if (type.relationship === 'child') { if (!parents[targetId]) parents[targetId] = []; parents[targetId].push({ parentId: n.id, type: info.eraEvent.type }); } else if (type.relationship === 'parent') { if (!parents[n.id]) parents[n.id] = []; parents[n.id].push({ parentId: targetId, type: info.eraEvent.type }); } }); } } }); Object.keys(parents).forEach(childId => { parents[childId].forEach(rel => { if (!children[rel.parentId]) children[rel.parentId] = []; if (!children[rel.parentId].includes(childId)) children[rel.parentId].push(childId); }); }); return { parents, children }; };
    const { parents, children } = resolveRelationships();
    
    const renderRow = (nation, depth = 0, parentId = null) => {
        let info = getNationInfo(nation, year); 
        const stat = getStat(nation.id, year);

        if (parentId && !expandedParents[parentId]) return null;
        if (depth === 0 && parents[nation.id] && parents[nation.id].length > 0) return null;
        if (depth === 0 && info.isCollapsed) return null;
        if (info.isFuture) return null;

        const statStyle = stat?.isEstimated ? "text-gray-500 italic" : "text-gray-800";
        let relationLabel = null; let eventYearLabel = null; let targetEvent = null;

        if (depth > 0) {
            const sortedEras = (nation.eras || []).sort((a, b) => a.startYear - b.startYear);
            const targetEraIndex = sortedEras.findIndex(e => e.startYear <= year && e.event && (e.event.targetId === parentId || (e.event.targetIds && e.event.targetIds.includes(parentId))) && ['annexed_by', 'partitioned_by', 'merger', 'dissolution', 'be_puppet'].includes(e.event.type));
            if (targetEraIndex !== -1) {
                const targetEra = sortedEras[targetEraIndex]; targetEvent = targetEra.event;
                eventYearLabel = <span className="text-[10px] font-mono bg-gray-200 text-gray-700 px-1 rounded ml-1">{targetEra.startYear}å¹´:</span>;
                const prevEra = targetEraIndex > 0 ? sortedEras[targetEraIndex - 1] : null;
                info = { ...info, name: prevEra ? prevEra.name : (targetEra.type === 'collapse' ? nation.name : targetEra.name), color: prevEra ? prevEra.color : (targetEra.color || nation.color), flag: prevEra ? (prevEra.flag || nation.flag) : (targetEra.flag || nation.flag), params: prevEra ? (prevEra.params || {}) : (nation.params || {}), eraStartYear: prevEra ? prevEra.startYear : (info.nationStartYear || 'ä¸æ˜'), eraEndYear: targetEra.startYear, isCollapsed: false };
            } else { relationLabel = <span className="ml-2 text-[10px] text-gray-400 border border-gray-200 px-1 rounded">(å¾“å±)</span>; }
        } else { if (info.eraEvent && ['independence', 'splinter'].includes(info.eraEvent.type)) { targetEvent = info.eraEvent; } }

        if (targetEvent) { const t = ERA_EVENT_TYPES[targetEvent.type]; if (t) { const targetIds = targetEvent.targetIds || (targetEvent.targetId ? [targetEvent.targetId] : []); let targetNames = ''; if (targetIds.length > 0) { targetNames = targetIds.map(tid => { const tn = nations.find(n => n.id === tid); return tn ? tn.name : '?'; }).join('ãƒ»'); } let labelText = t.label; let styleClass = "bg-gray-100 text-gray-600 border-gray-200"; if (['annexed_by', 'merger'].includes(targetEvent.type)) { labelText = `${targetNames}ã«ä½µåˆ`; styleClass = "bg-red-50 text-red-600 border-red-100"; } else if (targetEvent.type === 'partitioned_by') { labelText = `${targetNames}ã«ã‚ˆã‚Šåˆ†å‰²`; styleClass = "bg-red-50 text-red-600 border-red-100"; } else if (targetEvent.type === 'dissolution') { labelText = `${targetNames}ã¸è§£ä½“ãƒ»åˆ†è£‚`; styleClass = "bg-red-50 text-red-600 border-red-100"; } else if (['independence', 'splinter'].includes(targetEvent.type)) { labelText = `${targetNames}${t.label}`; styleClass = "bg-indigo-50 text-indigo-700 border-indigo-100"; } else if (targetEvent.type === 'be_puppet') { labelText = `${targetNames}ã®å‚€å„¡`; } relationLabel = <span className={`ml-2 text-[10px] px-1 rounded border flex items-center gap-1 ${styleClass}`}>{t.icon} {labelText}</span>; } }

        const myChildren = children[nation.id] || []; const hasChildren = myChildren.length > 0; const isExpanded = expandedParents[nation.id]; const isChild = depth > 0; const rowClass = isChild ? "bg-gray-50/80" : "hover:bg-gray-50"; const opacityClass = (info.isCollapsed && depth === 0) ? "opacity-60 grayscale" : ""; const key = `${nation.id}-${parentId || 'root'}`;
        let rankBadge = null; if (depth === 0 && info.params && !info.isCollapsed) { const rankInfo = NATION_RANKS[nation.rank || 'minor_power']; if (rankInfo) { rankBadge = <span className="text-[9px] px-1 rounded border ml-1 whitespace-nowrap" style={{borderColor: rankInfo.color, color: rankInfo.color, backgroundColor: 'white'}}>{rankInfo.label}</span>; } }
        
        return ( <React.Fragment key={key}> <tr className={`${rowClass} transition-colors ${opacityClass}`}> <td className="px-4 py-3 font-bold sticky left-0 bg-white/95 z-10 shadow-sm border-r border-gray-100 align-top"> <div className="flex items-center" style={{ paddingLeft: `${depth * 20}px` }}> {hasChildren ? ( <button onClick={() => toggleExpand(nation.id)} className="mr-2 p-0.5 rounded hover:bg-gray-200 text-gray-500"> {isExpanded ? <Icons.ChevronDown size={14} /> : <Icons.ChevronRight size={14} />} </button> ) : ( <span className="w-4 mr-2"></span> )} {isChild && !hasChildren && <Icons.CornerDownRight size={14} className="text-gray-300 mr-1" />} {info.flag ? ( <img src={info.flag} alt="Flag" className="w-8 h-5 object-cover border border-gray-200 shadow-sm mr-2 flex-shrink-0" /> ) : ( <div className="w-8 h-5 shadow-sm border border-gray-200 flex-shrink-0 flex items-center justify-center text-[8px] text-gray-400 bg-gray-100 mr-2">No</div> )} <div className="flex flex-col justify-center"> <div className="flex items-center gap-1 flex-wrap"> {eventYearLabel} <span className={`text-sm ${info.isCollapsed && depth === 0 ? 'line-through text-gray-400' : ''}`}>{info.name}</span> {rankBadge} {relationLabel} </div> </div> </div> </td> <td className="px-2 py-3 text-center border-l border-gray-100 bg-gray-50/30">{isAuthorized && <button onClick={() => onEditNation(nation)} className="text-blue-600 hover:bg-blue-100 p-2 rounded transition-colors"><Icons.Edit2 size={16} /></button>}</td> <td className="px-2 py-3 text-center border-l border-gray-100 bg-gray-50/30"><div className="flex flex-col items-center justify-center leading-tight"><span className="text-xs font-bold text-gray-700">{info.eraStartYear ? info.eraStartYear : 'ä¸æ˜'}<span className="text-gray-400 mx-0.5">ï½</span>{info.eraEndYear ? info.eraEndYear : ''}</span><span className="text-[10px] text-gray-400 mt-0.5">(å›½: {info.nationStartYear ? info.nationStartYear : 'ä¸æ˜'}<span className="mx-0.5">ï½</span>{info.nationEndYear ? info.nationEndYear : ''})</span></div></td> <td className={`px-4 py-3 text-right font-mono border-l border-gray-100 bg-blue-50/30 ${statStyle} text-xs`}>{stat ? formatJapaneseNumber(stat.population, 'äºº', true) : '-'}</td> <td className={`px-4 py-3 text-right font-mono border-l border-gray-100 bg-green-50/30 ${statStyle} text-xs`}>{stat ? formatJapaneseNumber(stat.gdp, 'å††', true) : '-'}</td> <td className={`px-4 py-3 text-right font-mono border-l border-gray-100 bg-yellow-50/30 ${statStyle} text-xs`}>{stat ? formatJapaneseNumber(calculatePerCapita(stat.gdp, stat.population), 'å††', true) : '-'}</td> {NATION_PARAMS.map(p => { const param = info.params?.[p.key] || {}; const bgColor = param.color || '#f3f4f6'; const isLight = parseInt(bgColor.replace('#', ''), 16) > 0xffffff / 2; const textColor = param.color ? (isLight ? '#000' : '#fff') : '#9ca3af'; return ( <td key={p.key} className="px-2 py-2 border-l border-gray-100 align-top"> <div className="h-full w-full rounded p-1 text-center flex flex-col items-center justify-center gap-0.5 min-h-[40px]" style={{backgroundColor: bgColor, color: textColor, border: param.name ? 'none' : '1px dashed #e5e7eb'}}> {param.name ? ( <> <div className="font-bold leading-tight text-[11px]">{param.name}</div> {param.desc && <div className={`text-[8px] leading-tight opacity-80 font-normal mt-0.5`}>{param.desc}</div>} </> ) : <span className="text-[10px]">-</span>} </div> </td> ); })} </tr> {myChildren.map(childId => { const childNation = nations.find(n => n.id === childId); if (childNation) return renderRow(childNation, depth + 1, nation.id); return null; })} </React.Fragment> );
    };

    const rootNations = nations.filter(n => !parents[n.id]);
    
    return ( <div className="space-y-6 animate-fade-in pb-20"> <div className="flex flex-wrap items-center justify-between gap-4"> <div className="flex items-center gap-3 bg-white px-4 py-2 rounded-lg shadow border border-gray-200"> <span className="font-bold text-sm text-gray-600 whitespace-nowrap">è¡¨ç¤ºå¹´:</span> <div className="flex items-center gap-2"><input type="range" min="-3000" max="3000" value={year} onChange={e => setYear(parseInt(e.target.value) || 0)} className="w-32 md:w-48 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-900" /><input type="number" value={year} onChange={e => setYear(parseInt(e.target.value) || 0)} className="w-20 p-1 border rounded font-mono text-lg font-bold text-center text-blue-900" /></div> </div> </div> <SectionHeader icon={Icons.List} title={`å›½å®¶ä½“åˆ¶ä¸€è¦§ (${year}å¹´æ™‚ç‚¹)`} desc="å„å›½ã®çµ±æ²»ä½“åˆ¶ã€ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼ã€å®—æ•™ãªã©ã®è©³ç´°ã‚’æ¯”è¼ƒãƒ»ç¢ºèªã§ãã¾ã™ã€‚å¤§é™¸åˆ¥ã«å›½åŠ›ãƒ©ãƒ³ã‚¯é †ï¼ˆå¤§åˆ—å¼· > éƒ½å¸‚å›½å®¶ï¼‰ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚" /> <div className="bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden"> <div className="overflow-x-auto custom-scrollbar"> <table className="w-full text-sm text-left whitespace-nowrap border-collapse"> <thead className="bg-gray-100 text-gray-700 font-bold uppercase border-b-2 border-gray-300"> <tr> <th className="px-4 py-3 sticky left-0 bg-gray-100 z-10 shadow-sm min-w-[240px] border-r border-gray-200">å›½åãƒ»å›½æ——</th> <th className="px-2 py-3 text-center border-l border-gray-200 w-[60px] bg-gray-50">æ“ä½œ</th> <th className="px-4 py-3 text-center border-l border-gray-200 min-w-[140px] bg-gray-50">æœŸé–“</th> <th className="px-4 py-3 text-center border-l border-gray-200 min-w-[100px] bg-blue-50">äººå£</th> <th className="px-4 py-3 text-center border-l border-gray-200 min-w-[120px] bg-green-50">GDP</th> <th className="px-4 py-3 text-center border-l border-gray-200 min-w-[100px] bg-yellow-50">ä¸€äººã‚ãŸã‚Š</th> {NATION_PARAMS.map(p => ( <th key={p.key} className="px-4 py-3 text-center border-l border-gray-200 min-w-[140px]">{p.label}</th> ))} </tr> </thead> <tbody className="divide-y divide-gray-200"> {Object.entries(LOCATIONS).sort((a, b) => a[1].order - b[1].order).map(([locKey, locInfo]) => { const nationsInLoc = rootNations.filter(n => (n.location || 'unknown') === locKey); if (nationsInLoc.length === 0) return null; nationsInLoc.sort((a, b) => { const rankA = NATION_RANKS[a.rank || 'minor_power']?.order || 99; const rankB = NATION_RANKS[b.rank || 'minor_power']?.order || 99; return rankA - rankB; }); return ( <React.Fragment key={locKey}> <tr className="bg-orange-900/10 border-b border-orange-900/20"> <td colSpan={6 + NATION_PARAMS.length} className="px-4 py-2 font-bold text-white text-sm tracking-wider" style={{ backgroundColor: locInfo.color }}> {locInfo.label} </td> </tr> {nationsInLoc.map(nation => renderRow(nation))} </React.Fragment> ); }) } </tbody> </table> </div> </div> <div className="flex justify-end"> {isAuthorized && <button onClick={onAddNation} className="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow hover:bg-blue-800"><Icons.Plus size={18} /> æ–°è¦å›½å®¶ã‚’è¿½åŠ </button>} </div> </div> );
};
// --- NationListPanel ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: å¹…æŒ‡å®šã‚’è¦ªã«å§”ã­ã‚‹) ---
const NationListPanel = ({ nations, setNations, selectedNationId, onSelect }) => {
    const [newNationName, setNewNationName] = useState('');
    const [newNationColor, setNewNationColor] = useState('#000000');
    const [newNationFlag, setNewNationFlag] = useState(null);
    const newFlagInputRef = useRef(null);

    const handleFlagUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try { const base64 = await fileToBase64(file); setNewNationFlag(base64); } 
        catch (err) { console.error(err); alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    };

    const addNation = () => {
        if (!newNationName) return;
        const newNation = { id: Date.now().toString(), name: newNationName, color: newNationColor, flag: newNationFlag, eras: [], startYear: null, note: '', location: 'unknown', rank: 'minor_power' };
        setNations([...nations, newNation]);
        setNewNationName(''); setNewNationFlag(null);
        if(newFlagInputRef.current) newFlagInputRef.current.value = '';
        onSelect(newNation);
    };

    const optimizeAllImages = async () => {
        if (!window.confirm('ç™»éŒ²æ¸ˆã¿ã®å…¨ã¦ã®å›½æ——ç”»åƒã‚’è»½é‡åŒ–(ãƒªã‚µã‚¤ã‚ºãƒ»åœ§ç¸®)ã—ã¾ã™ã€‚\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
        let count = 0;
        const newNations = await Promise.all(nations.map(async (n) => {
            let updated = { ...n }; let changed = false;
            if (updated.flag && updated.flag.startsWith('data:image')) {
                const compressed = await compressBase64Image(updated.flag);
                if (updated.flag !== compressed) { updated.flag = compressed; changed = true; count++; }
            }
            if (updated.eras && updated.eras.length > 0) {
                const newEras = await Promise.all(updated.eras.map(async (era) => {
                    if (era.flag && era.flag.startsWith('data:image')) {
                        const c = await compressBase64Image(era.flag);
                        if (era.flag !== c) { count++; return { ...era, flag: c }; }
                    }
                    return era;
                }));
                if (JSON.stringify(newEras) !== JSON.stringify(updated.eras)) { updated.eras = newEras; changed = true; }
            }
            return updated;
        }));
        setNations(newNations);
        alert(`å®Œäº†ã—ã¾ã—ãŸã€‚\n${count} æšã®ç”»åƒã‚’è»½é‡åŒ–ã—ã¾ã—ãŸã€‚`);
    };

    return (
        <div className="w-full h-full flex flex-col bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
            <div className="p-4 bg-gray-800 text-white flex justify-between items-center flex-shrink-0">
                <h2 className="text-lg font-bold flex items-center gap-2"><Icons.Globe size={20} className="text-yellow-500"/> å›½å®¶ãƒªã‚¹ãƒˆ</h2>
            </div>
            <div className="p-4 border-b border-gray-100 bg-gray-50 flex-shrink-0">
                <h3 className="font-bold text-xs text-gray-500 mb-2">æ–°è¦å›½å®¶è¿½åŠ </h3>
                <div className="flex gap-2 items-center mb-2">
                    <div className="flex-shrink-0">
                        <label className="cursor-pointer block w-10 h-7 bg-white border border-gray-300 flex items-center justify-center text-[8px] text-gray-400 hover:bg-gray-100 overflow-hidden">
                            {newNationFlag ? <img src={newNationFlag} className="w-full h-full object-cover" /> : 'ç”»åƒ'}
                            <input type="file" className="hidden" accept="image/*" ref={newFlagInputRef} onChange={handleFlagUpload} />
                        </label>
                    </div>
                    <input type="color" value={newNationColor} onChange={e => setNewNationColor(e.target.value)} className="h-7 w-7 rounded cursor-pointer border border-gray-300" />
                    <input type="text" value={newNationName} onChange={e => setNewNationName(e.target.value)} placeholder="å›½å" className="flex-grow p-1 border rounded text-sm" />
                </div>
                <button onClick={addNation} className="w-full bg-blue-900 text-white py-1.5 rounded text-sm font-bold hover:bg-blue-800 flex justify-center items-center gap-1"><Icons.Plus size={14} /> è¿½åŠ </button>
            </div>
            <div className="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-1 min-h-[200px]">
                {nations.map(n => (
                    <div key={n.id} onClick={() => onSelect(n)} className={`flex items-center justify-between p-3 rounded cursor-pointer border transition-all ${selectedNationId === n.id ? 'bg-blue-50 border-blue-300 ring-1 ring-blue-200' : 'bg-white border-transparent hover:bg-gray-50 hover:border-gray-200'}`}>
                        <div className="flex items-center gap-3">
                            {n.flag ? <img src={n.flag} className="w-8 h-5 object-cover border border-gray-200" /> : <div className="w-8 h-5 bg-gray-100 border border-gray-200"></div>}
                            <div className="w-3 h-3 rounded-full" style={{backgroundColor: n.color}}></div>
                            <span className="font-bold text-sm">{n.name}</span>
                        </div>
                        <Icons.ChevronRight size={16} className="text-gray-400" />
                    </div>
                ))}
            </div>
            <div className="p-2 border-t bg-gray-50 flex-shrink-0">
                <button onClick={optimizeAllImages} className="w-full py-2 text-xs text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-100 flex items-center justify-center gap-2"><Icons.Image size={14} /> å…¨ç”»åƒã®è»½é‡åŒ– (ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹)</button>
            </div>
        </div>
    );
};

// --- SettingsView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: å³å´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å»ƒæ­¢ãƒ»ç‰©ç†æ‹¡å¼µã€å·¦å´Stickyãƒ»é«˜ã•çµ±ä¸€) ---
const SettingsView = ({ setView, nations, setNations, targetNation, setTargetNation }) => {
    const [editingNation, setEditingNation] = useState(null); 
    
    // Eraç·¨é›†ç”¨ã®Stateç¾¤
    const [eraStartYear, setEraStartYear] = useState(''); const [eraName, setEraName] = useState(''); const [eraColor, setEraColor] = useState('#000000'); const [eraFlag, setEraFlag] = useState(null); const [eraParams, setEraParams] = useState({}); const [eraMode, setEraMode] = useState('normal'); const [editingEraIndex, setEditingEraIndex] = useState(null); const [eraEventType, setEraEventType] = useState('none'); const [eraRelatedNationId, setEraRelatedNationId] = useState(''); const [eraRelatedNationIds, setEraRelatedNationIds] = useState([]); 
    
    const editFlagInputRef = useRef(null); const eraFlagInputRef = useRef(null);

    useEffect(() => { if (targetNation) { setEditingNation(targetNation); } else { setEditingNation(null); } }, [targetNation]);
    
    const handleClose = () => { if (setTargetNation) setTargetNation(null); setView('timeline'); };
    const handleFlagUpload = async (e, setter) => { const file = e.target.files[0]; if (!file) return; try { const base64 = await fileToBase64(file); setter(base64); } catch (err) { console.error("Image upload failed", err); alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); } };
    
    const deleteNation = (id) => { if (window.confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { setNations(nations.filter(n => n.id !== id)); if (editingNation && editingNation.id === id) setEditingNation(null); } };
    const updateNationBase = (id, key, value) => { const updated = { ...editingNation, [key]: value }; setEditingNation(updated); setNations(nations.map(n => n.id === id ? updated : n)); };
    
    const updateEraParam = (key, field, value) => { setEraParams(prev => ({ ...prev, [key]: { ...prev[key], [field]: value } })); };
    const toggleRelatedNationId = (id) => { setEraRelatedNationIds(prev => prev.includes(id) ? prev.filter(pid => pid !== id) : [...prev, id]); };
    const saveEra = () => { if (!eraStartYear) return; let targetId = eraRelatedNationId; let targetIds = []; const multiTargetEvents = ['partitioned_by', 'dissolution', 'unification', 'annexation', 'partition']; if (multiTargetEvents.includes(eraEventType)) { targetIds = eraRelatedNationIds; targetId = null; } else if (eraRelatedNationId) { targetIds = [eraRelatedNationId]; } let type = 'default'; if (eraMode === 'collapse') type = 'collapse'; const newEraData = { startYear: parseInt(eraStartYear), name: eraName || (eraMode === 'collapse' ? 'æ»…äº¡' : editingNation.name), color: eraColor, flag: eraFlag, params: eraParams, type: type, event: { type: eraEventType, targetId: targetId, targetIds: targetIds } }; let updatedEras; if (editingEraIndex !== null) { updatedEras = [...editingNation.eras]; updatedEras[editingEraIndex] = newEraData; } else { updatedEras = [ ...(editingNation.eras || []), newEraData]; } const updatedNation = { ...editingNation, eras: updatedEras }; let updatedNations = nations.map(n => n.id === editingNation.id ? updatedNation : n); setEditingNation(updatedNation); setNations(updatedNations); resetEraForm(); };
    const resetEraForm = () => { setEraStartYear(''); setEraName(''); setEraParams({}); setEraFlag(null); setEraColor('#000000'); setEraMode('normal'); setEraEventType('none'); setEraRelatedNationId(''); setEraRelatedNationIds([]); if(eraFlagInputRef.current) eraFlagInputRef.current.value = ''; setEditingEraIndex(null); };
    const startEditEra = (index) => { const era = editingNation.eras[index]; setEraStartYear(era.startYear); setEraName(era.name); setEraColor(era.color); setEraFlag(era.flag); setEraParams(era.params || {}); if (era.type === 'collapse') setEraMode('collapse'); else if (['foundation', 'independence', 'splinter', 'unification', 'foundation_puppet'].includes(era.event?.type)) setEraMode('birth'); else setEraMode('normal'); if (era.event) { setEraEventType(era.event.type || 'none'); setEraRelatedNationId(era.event.targetId || ''); setEraRelatedNationIds(era.event.targetIds || []); } else { setEraEventType('none'); setEraRelatedNationId(''); setEraRelatedNationIds([]); } setEditingEraIndex(index); };
    const deleteEra = (index) => { const updatedEras = editingNation.eras.filter((_, i) => i !== index); const updatedNation = { ...editingNation, eras: updatedEras }; setEditingNation(updatedNation); setNations(nations.map(n => n.id === editingNation.id ? updatedNation : n)); if (editingEraIndex === index) resetEraForm(); };

    const jumpToOverview = () => {
        setTargetNation(editingNation);
        setView('nation_overview');
    };

    return ( 
        // â˜…ä¿®æ­£ç‚¹: é«˜ã•å›ºå®šã‚’å»ƒæ­¢ã—ã€min-hã«å¤‰æ›´ã€‚overflowæŒ‡å®šã‚‚å‰Šé™¤ã—ã¦ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«å§”ã­ã‚‹ã€‚
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20"> 
            <SectionHeader icon={Icons.Globe} title="å›½å®¶å¤‰é·ç®¡ç†" desc="å›½å®¶ã®æ–°è¦ç™»éŒ²ã€æ­´å²çš„å¤‰é·ï¼ˆEraï¼‰ã®ç®¡ç†ã€å›½æ——ã‚„ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚" /> 
            
            {/* â˜…ä¿®æ­£ç‚¹: items-stretch ã§ã¯ãªã items-start ã«å¤‰æ›´ã—ã€å·¦ã‚«ãƒ©ãƒ ã®Stickyã‚’æœ‰åŠ¹åŒ– */}
            <div className="flex gap-6 items-start flex-grow"> 
                {/* å·¦å´ãƒªã‚¹ãƒˆ: Stickyé…ç½® + é«˜ã•æŒ‡å®š (NationOverviewViewã¨çµ±ä¸€) */}
                <div 
                    className="w-full md:w-80 flex-shrink-0 sticky top-4"
                    style={{ height: 'calc(100vh - 320px)', minHeight: '400px' }}
                >
                    <NationListPanel nations={nations} setNations={setNations} selectedNationId={editingNation?.id} onSelect={(n) => { setEditingNation(n); resetEraForm(); }} />
                </div>

                {/* å³å´ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: é«˜ã•åˆ¶é™ãƒ»å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«(overflow-y-auto)ã‚’å‰Šé™¤ã—ã€ç‰©ç†çš„ã«ä¼¸ã³ã‚‹ã‚ˆã†ã«ã™ã‚‹ */}
                <div className="flex-grow w-full min-w-[300px]"> 
                    {editingNation ? ( 
                        <div className="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden animate-fade-in"> 
                            {/* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã¯Stickyã«ã—ã¦ã€ç¸¦ã«é•·ããªã£ã¦ã‚‚æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */}
                            <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 sticky top-0 z-30 shadow-sm">
                                <h3 className="font-bold text-lg flex items-center gap-2">
                                    <span className="w-4 h-4 rounded-full inline-block" style={{backgroundColor: editingNation.color}}></span>"{editingNation.name}" ã®è¨­å®š
                                </h3>
                                <button onClick={() => deleteNation(editingNation.id)} className="text-red-500 text-xs flex items-center gap-1 hover:underline bg-red-50 px-2 py-1 rounded border border-red-100">
                                    <Icons.Trash2 size={12} /> å‰Šé™¤
                                </button>
                            </div> 
                            <div className="p-6 space-y-8"> 
                                <section> 
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b pb-1">åŸºæœ¬æƒ…å ± (åˆæœŸçŠ¶æ…‹)</h4> 
                                    <div className="flex gap-6 items-start"> 
                                        <div className="flex-shrink-0 text-center"> 
                                            <label className="block cursor-pointer group relative"> 
                                                {editingNation.flag ? <img src={editingNation.flag} className="w-24 h-16 object-cover border border-gray-300 shadow-sm" /> : <div className="w-24 h-16 bg-gray-100 border border-gray-300 flex items-center justify-center text-gray-400 text-xs">No Image</div>} 
                                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">å¤‰æ›´</div> 
                                                <input type="file" className="hidden" accept="image/*" ref={editFlagInputRef} onChange={(e) => handleFlagUpload(e, (val) => updateNationBase(editingNation.id, 'flag', val))} /> 
                                            </label> 
                                        </div> 
                                        <div className="flex-grow grid grid-cols-2 gap-4"> 
                                            <div><label className="block text-xs font-bold text-gray-600 mb-1">å›½å</label><input type="text" value={editingNation.name} onChange={e => updateNationBase(editingNation.id, 'name', e.target.value)} className="w-full p-2 border rounded shadow-sm font-bold" /></div> 
                                            <div> <label className="block text-xs font-bold text-gray-600 mb-1">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</label> <div className="flex items-center gap-2"> <input type="color" value={editingNation.color} onChange={e => updateNationBase(editingNation.id, 'color', e.target.value)} className="h-9 w-12 rounded cursor-pointer border border-gray-300 shadow-sm" /> <span className="text-xs text-gray-500 font-mono">{editingNation.color}</span> </div> </div> 
                                            <div> <label className="block text-xs font-bold text-gray-600 mb-1">æ‰€åœ¨ãƒ»åœ°åŸŸ</label> <select value={editingNation.location || 'unknown'} onChange={e => updateNationBase(editingNation.id, 'location', e.target.value)} className="w-full p-2 border rounded shadow-sm text-sm bg-white"> {Object.entries(LOCATIONS).sort((a,b) => a[1].order - b[1].order).map(([key, info]) => ( <option key={key} value={key}>{info.label}</option> ))} </select> </div> 
                                            <div> <label className="block text-xs font-bold text-gray-600 mb-1">å›½åŠ›ãƒ©ãƒ³ã‚¯</label> <select value={editingNation.rank || 'minor_power'} onChange={e => updateNationBase(editingNation.id, 'rank', e.target.value)} className="w-full p-2 border rounded shadow-sm text-sm bg-white font-bold" style={{color: NATION_RANKS[editingNation.rank || 'minor_power']?.color}}> {Object.entries(NATION_RANKS).sort((a,b) => a[1].order - b[1].order).map(([key, info]) => ( <option key={key} value={key} style={{color: info.color}}>{info.label}</option> ))} </select> </div> 
                                        </div> 
                                    </div> 
                                </section> 
                                
                                <section> 
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b pb-1">å›½å®¶æ¦‚è¦</h4> 
                                    <div className="bg-gray-50 p-4 rounded border border-gray-200 text-center">
                                        <p className="text-sm text-gray-500 mb-3 font-bold">
                                            å›½å®¶ã®æ–‡åŒ–ã€æ­´å²ã€åœ°ç†ãªã©ã®è©³ç´°ãªè¨­å®šã¯<br/>
                                            ã€Œå›½å®¶æ¦‚è¦ç®¡ç†ã€ã§ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§è¨˜è¿°ã§ãã¾ã™ã€‚
                                        </p>
                                        <button 
                                            onClick={jumpToOverview}
                                            className="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold py-2 px-4 rounded shadow flex items-center gap-2 mx-auto transition-colors"
                                        >
                                            <Icons.FileText size={18} /> æ¦‚è¦ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã
                                        </button>
                                    </div>
                                </section> 
                                
                                <section> 
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b pb-1">æ­´å²çš„å¤‰é· (Era)</h4> 
                                    <div className="flex flex-col lg:flex-row gap-6"> 
                                        <div className={`flex-grow p-4 rounded-lg border transition-colors ${eraMode === 'collapse' ? 'bg-red-50 border-red-300' : eraMode === 'birth' ? 'bg-green-50 border-green-300' : (editingEraIndex !== null ? 'bg-yellow-50 border-yellow-300' : 'bg-blue-50 border-blue-200')}`}> 
                                            <div className="flex justify-between items-center mb-4"> 
                                                <div className="flex bg-white rounded-lg shadow-sm border border-gray-200 p-1"> 
                                                    <button onClick={() => setEraMode('normal')} className={`px-3 py-1 text-xs font-bold rounded ${eraMode === 'normal' ? 'bg-blue-100 text-blue-800' : 'text-gray-500 hover:bg-gray-50'}`}>é€šå¸¸(å¤‰æ›´)</button> 
                                                    <button onClick={() => setEraMode('birth')} className={`px-3 py-1 text-xs font-bold rounded ${eraMode === 'birth' ? 'bg-green-100 text-green-800' : 'text-gray-500 hover:bg-gray-50'}`}>âœ¨ èª•ç”Ÿ</button> 
                                                    <button onClick={() => setEraMode('collapse')} className={`px-3 py-1 text-xs font-bold rounded ${eraMode === 'collapse' ? 'bg-red-100 text-red-800' : 'text-gray-500 hover:bg-gray-50'}`}>ğŸ’€ æ»…äº¡</button> 
                                                </div> 
                                                {editingEraIndex !== null && <button onClick={resetEraForm} className="text-xs text-gray-500 hover:underline">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>} 
                                            </div> 
                                            <div className="mb-4"><label className="block text-xs font-bold text-gray-600 mb-1">é–‹å§‹å¹´ (ç™ºç”Ÿå¹´)</label><input type="number" value={eraStartYear} onChange={e => setEraStartYear(e.target.value)} className="w-full p-2 border rounded text-lg font-bold" placeholder="ä¾‹: 1900" required /></div> 
                                            {eraMode === 'collapse' ? ( 
                                                <div className="animate-fade-in space-y-4"> 
                                                    <div className="p-3 bg-white rounded border border-red-100"> 
                                                        <label className="block text-xs font-bold text-red-600 mb-1">æ»…äº¡ã®ç†ç”±</label> 
                                                        <select value={eraEventType} onChange={e => setEraEventType(e.target.value)} className="w-full p-2 border rounded text-sm bg-white"> 
                                                            <option value="none">è‡ªç„¶æ¶ˆæ»… / ä¸æ˜</option> <option value="annexed_by">ä»–å›½ã«ä½µåˆã•ã‚Œã‚‹</option> <option value="merger">ä»–å›½ã¨åˆä½µã—ã¦æ¶ˆæ»…</option> <option value="dissolution">åˆ†è£‚ãƒ»è§£ä½“ã—ã¦æ¶ˆæ»… (è¤‡æ•°å›½ã¸)</option> <option value="partitioned_by">è¤‡æ•°å›½ã«ã‚ˆã‚Šåˆ†å‰²çµ±æ²»ã•ã‚Œã‚‹</option> 
                                                        </select> 
                                                    </div> 
                                                    {(eraEventType === 'partitioned_by' || eraEventType === 'dissolution') ? ( 
                                                        <div> 
                                                            <label className="block text-xs font-bold text-gray-600 mb-1">{eraEventType === 'dissolution' ? 'åˆ†è£‚å¾Œã«ç”Ÿã¾ã‚ŒãŸå›½ (è¤‡æ•°å¯)' : 'åˆ†å‰²ã—ãŸå›½ (è¤‡æ•°å¯)'}</label> 
                                                            <div className="border rounded bg-white p-2 max-h-32 overflow-y-auto custom-scrollbar"> {nations.filter(n => n.id !== editingNation.id).map(n => ( <label key={n.id} className="flex items-center gap-2 p-1 hover:bg-gray-50 cursor-pointer"><input type="checkbox" checked={eraRelatedNationIds.includes(n.id)} onChange={() => toggleRelatedNationId(n.id)} className="rounded text-red-600" />{n.flag && <img src={n.flag} className="w-4 h-3 object-cover border border-gray-200" />}<span className="text-xs">{n.name}</span></label> ))} </div> 
                                                        </div> 
                                                    ) : eraEventType !== 'none' && ( 
                                                        <div> 
                                                            <label className="block text-xs font-bold text-gray-600 mb-1">å¯¾è±¡å›½</label> 
                                                            <select value={eraRelatedNationId} onChange={e => setEraRelatedNationId(e.target.value)} className="w-full p-2 border rounded text-sm bg-white"> 
                                                                <option value="">-- å›½ã‚’é¸æŠ --</option> {nations.filter(n => n.id !== editingNation.id).map(n => <option key={n.id} value={n.id}>{n.name}</option>)} 
                                                            </select> 
                                                        </div> 
                                                    )} 
                                                    <p className="text-[10px] text-red-400">â€»æ»…äº¡ã‚’è¨­å®šã™ã‚‹ã¨ã€ä»¥é™ã®å¹´è¡¨ã«ã¯è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚</p> 
                                                </div> 
                                            ) : ( 
                                                <div className="animate-fade-in space-y-4"> 
                                                    <div className="flex gap-3"> 
                                                        <label className="cursor-pointer flex-shrink-0 w-16 h-10 bg-white border border-gray-300 flex items-center justify-center hover:bg-gray-50 relative group"> {eraFlag ? <img src={eraFlag} className="w-full h-full object-cover" /> : <span className="text-[10px] text-gray-400">Flag</span>} <input type="file" className="hidden" accept="image/*" ref={eraFlagInputRef} onChange={(e) => handleFlagUpload(e, setEraFlag)} /> </label> 
                                                        <div className="flex-grow grid grid-cols-1 gap-2"> <input type="text" value={eraName} onChange={e => setEraName(e.target.value)} className="w-full p-2 border rounded text-sm font-bold" placeholder={eraMode === 'birth' ? "å»ºå›½æ™‚ã®å›½å" : "å¤‰æ›´å¾Œã®å›½å"} /> <div className="flex items-center gap-2"> <input type="color" value={eraColor} onChange={e => setEraColor(e.target.value)} className="h-8 w-12 rounded cursor-pointer border border-gray-300" /> <span className="text-xs text-gray-500">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</span> </div> </div> 
                                                    </div> 
                                                    <div className="p-3 bg-white rounded border border-blue-100"> 
                                                        <label className="block text-[10px] font-bold text-blue-600 mb-1 flex items-center gap-1"><Icons.Link size={10}/> {eraMode === 'birth' ? 'æˆç«‹ã®çµŒç·¯' : 'é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ (ä»»æ„)'}</label> 
                                                        <div className="flex flex-col gap-2"> 
                                                            <div className="flex gap-2"> 
                                                                <select value={eraEventType} onChange={e => setEraEventType(e.target.value)} className="w-1/2 p-1.5 border rounded text-xs"> 
                                                                    <option value="none">-- ãªã— --</option> {eraMode === 'birth' ? ( <> <option value="foundation">å»ºå›½ãƒ»æˆç«‹ (å˜ç‹¬)</option> <option value="independence">ã‚ˆã‚Šç‹¬ç«‹</option> <option value="splinter">ã‚ˆã‚Šåˆ†è£‚ã—ã¦æˆç«‹</option> <option value="unification">ã‚’çµ±åˆã—ã¦æˆç«‹</option> <option value="foundation_puppet">ã®å‚€å„¡å›½ã¨ã—ã¦æˆç«‹</option> </> ) : ( <> <option value="regime_change">æ”¿ä½“ã®å¤‰æ›´</option> <option value="annexation">ã‚’ä½µåˆ</option> <option value="partition">ã‚’åˆ†å‰²çµ±æ²»</option> <option value="puppet">ã‚’å‚€å„¡åŒ–</option> <option value="be_puppet">ã®å‚€å„¡ã«ãªã‚‹</option></> )} 
                                                                </select> 
                                                                {!['unification', 'annexation', 'partition'].includes(eraEventType) && ( <select value={eraRelatedNationId} onChange={e => setEraRelatedNationId(e.target.value)} disabled={['none', 'foundation', 'regime_change'].includes(eraEventType)} className="w-1/2 p-1.5 border rounded text-xs disabled:opacity-50"> <option value="">-- å¯¾è±¡å›½ --</option> {nations.filter(n => n.id !== editingNation.id).map(n => <option key={n.id} value={n.id}>{n.name}</option>)} </select> )} 
                                                            </div> 
                                                            {['unification', 'annexation', 'partition'].includes(eraEventType) && ( <div className="mt-2"> <label className="block text-xs font-bold text-gray-600 mb-1"> {eraEventType === 'unification' ? 'çµ±åˆã™ã‚‹å›½ (è¤‡æ•°å¯)' : eraEventType === 'annexation' ? 'ä½µåˆã™ã‚‹å›½ (è¤‡æ•°å¯)' : 'åˆ†å‰²ã™ã‚‹å›½ (è¤‡æ•°å¯)'} </label> <div className="border rounded bg-white p-2 max-h-32 overflow-y-auto custom-scrollbar"> {nations.filter(n => n.id !== editingNation.id).map(n => ( <label key={n.id} className="flex items-center gap-2 p-1 hover:bg-gray-50 cursor-pointer"><input type="checkbox" checked={eraRelatedNationIds.includes(n.id)} onChange={() => toggleRelatedNationId(n.id)} className="rounded text-blue-600" />{n.flag && <img src={n.flag} className="w-4 h-3 object-cover border border-gray-200" />}<span className="text-xs">{n.name}</span></label> ))} </div> </div> )} 
                                                        </div> 
                                                    </div> 
                                                    <div className="space-y-2"> 
                                                        <p className="text-[10px] font-bold text-gray-500">ä½“åˆ¶è©³ç´°</p> 
                                                        <div className="grid grid-cols-2 gap-2"> {NATION_PARAMS.map(param => ( <div key={param.key} className="bg-white p-1.5 rounded border border-gray-200 text-xs"> <div className="flex justify-between items-center mb-1"><span className="font-bold text-[10px] text-gray-600">{param.label}</span><input type="color" value={eraParams[param.key]?.color || param.defaultColor} onChange={e => updateEraParam(param.key, 'color', e.target.value)} className="w-3 h-3 rounded cursor-pointer border-none" /></div> <input type="text" placeholder="åç§° (ä¾‹: ç«‹æ†²å›ä¸»åˆ¶)" value={eraParams[param.key]?.name || ''} onChange={e => updateEraParam(param.key, 'name', e.target.value)} className="w-full p-1 border rounded mb-1 text-[10px] font-bold" /> <input type="text" placeholder="ä¸€è¨€ãƒ¡ãƒ¢ (ä¾‹: ç‹ã¯æ³•ã®ä¸‹ã«...)" value={eraParams[param.key]?.desc || ''} onChange={e => updateEraParam(param.key, 'desc', e.target.value)} className="w-full p-1 border-b border-gray-100 text-[9px] text-gray-500 outline-none bg-transparent" /> </div> ))} </div> 
                                                    </div> 
                                                </div> 
                                            )} 
                                            <div className="text-right mt-4"> <button onClick={saveEra} className={`w-full text-white px-4 py-2 rounded font-bold shadow transition-colors flex justify-center items-center gap-2 text-sm ${eraMode === 'collapse' ? 'bg-red-700 hover:bg-red-800' : eraMode === 'birth' ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-900 hover:bg-blue-800'}`}> {editingEraIndex !== null ? <Icons.Save size={14} /> : <Icons.Plus size={14} />} {editingEraIndex !== null ? 'æ›´æ–°ã™ã‚‹' : (eraMode === 'collapse' ? 'æ»…äº¡ã‚’è¨˜éŒ²' : eraMode === 'birth' ? 'èª•ç”Ÿã‚’è¨˜éŒ²' : 'å¤‰é·ã‚’è¿½åŠ ')} </button> </div> 
                                        </div> 
                                        <div className="w-full lg:w-1/3 space-y-4"> <h5 className="font-bold text-xs text-gray-500">å¤‰é·ãƒªã‚¹ãƒˆ</h5> <div className="space-y-2"> {editingNation.eras && editingNation.eras.length > 0 ? ( editingNation.eras.sort((a,b) => b.startYear - a.startYear).map((era, index) => { const eventType = era.event?.type || 'none'; const eventDef = ERA_EVENT_TYPES[eventType]; const targetIds = era.event?.targetIds || (era.event?.targetId ? [era.event.targetId] : []); const targetNames = targetIds.map(tid => { const n = nations.find(nav => nav.id === tid); return n ? n.name : ''; }).filter(n => n).join('ãƒ»'); let badgeLabel = "æ”¹ç§°ãƒ»å¤‰æ›´"; let badgeClass = "bg-gray-100 text-gray-600 border-gray-200"; if (era.type === 'collapse') { const baseLabel = (eventDef && eventType !== 'none') ? eventDef.label : "æ»…äº¡"; badgeLabel = targetNames ? `${targetNames}${baseLabel}` : baseLabel; badgeClass = "bg-red-100 text-red-600 border-red-200"; } else if (['foundation', 'independence', 'splinter', 'unification', 'foundation_puppet'].includes(eventType)) { const baseLabel = eventDef ? eventDef.label : "èª•ç”Ÿ"; badgeLabel = targetNames ? `${targetNames}${baseLabel}` : baseLabel; badgeClass = "bg-green-100 text-green-800 border-green-200"; } else if (['puppet', 'be_puppet', 'annexation', 'partition', 'regime_change'].includes(eventType)) { const baseLabel = eventDef ? eventDef.label : "å¤‰é·"; badgeLabel = targetNames ? `${targetNames}${baseLabel}` : baseLabel; badgeClass = "bg-indigo-50 text-indigo-700 border-indigo-100"; } return ( <div key={index} className="bg-white border rounded p-2 flex justify-between items-center text-sm"> <div className="flex items-center gap-2"> <span className="font-mono font-bold text-gray-600 w-10 text-right text-xs">{era.startYear}å¹´</span> {(era.flag || editingNation.flag) ? ( <img src={era.flag || editingNation.flag} className="w-8 h-5 object-cover border border-gray-200 shadow-sm flex-shrink-0" alt="flag" /> ) : ( <div className="w-8 h-5 bg-gray-100 border border-gray-200 flex-shrink-0"></div> )} <div className="flex flex-col"> <span className={`leading-tight text-xs font-bold ${era.type === 'collapse' ? 'text-gray-400 line-through' : ''}`}>{era.name}</span> <div className="mt-0.5"> <span className={`text-[9px] px-1.5 py-0.5 rounded border ${badgeClass} inline-flex items-center gap-0.5`}> {eventDef && eventDef.icon} {badgeLabel} </span> </div> </div> </div> <div className="flex gap-1"><button onClick={() => startEditEra(index)} className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icons.Edit2 size={14} /></button><button onClick={() => deleteEra(index)} className="p-1 text-red-600 hover:bg-red-50 rounded"><Icons.Trash2 size={14} /></button></div> </div> ); }) ) : ( <p className="text-gray-400 text-xs text-center py-4">è¨˜éŒ²ãªã—</p> )} </div> </div> </div> </section> 
                            </div> 
                        </div> 
                    ) : ( 
                        <div className="bg-white p-12 rounded-lg shadow-lg border border-gray-200 text-center text-gray-400 flex flex-col justify-center items-center min-h-[500px]"> 
                            <Icons.Globe size={48} className="mx-auto mb-4 text-gray-300"/> 
                            <p>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰å›½å®¶ã‚’é¸æŠã™ã‚‹ã‹ã€<br/>æ–°è¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p> 
                        </div> 
                    )} 
                </div> 
            </div> 
        </div> 
    );
};

// --- CharacterManager ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: ãƒ¬ãƒ™ãƒ«è¨­å®šãƒ»èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œ) ---
const CharacterManager = ({ setView, nations, characters, setCharacters, organizations, setOrganizations }) => {
    const [editingChar, setEditingChar] = useState(null);
    const [name, setName] = useState('');
    const [portrait, setPortrait] = useState(null);
    const [race, setRace] = useState(RACES[0].label);
    const [level, setLevel] = useState(''); // â˜…è¿½åŠ : ãƒ¬ãƒ™ãƒ«
    const [birthYear, setBirthYear] = useState('');
    const [deathYear, setDeathYear] = useState('');
    
    const [affiliations, setAffiliations] = useState([]); 
    const [affilInput, setAffilInput] = useState('');
    const [affilRole, setAffilRole] = useState('');

    const [note, setNote] = useState('');
    const [showLevelInfo, setShowLevelInfo] = useState(false); // â˜…è¿½åŠ : ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨
    const fileInputRef = useRef(null);

    const affiliationOptions = useMemo(() => {
        const list = [];
        organizations.forEach(o => list.push({ type: 'org', name: o.name }));
        nations.forEach(n => {
            list.push({ type: 'nation', name: n.name });
            (n.eras || []).forEach(e => {
                if (e.name && e.name !== n.name) list.push({ type: 'era', name: e.name });
            });
        });
        return list;
    }, [organizations, nations]);

    const resetForm = () => {
        setEditingChar(null);
        setName('');
        setPortrait(null);
        setRace(RACES[0].label);
        setLevel(''); // â˜…ãƒªã‚»ãƒƒãƒˆ
        setBirthYear('');
        setDeathYear('');
        setAffiliations([]);
        setAffilInput('');
        setAffilRole('');
        setNote('');
        if(fileInputRef.current) fileInputRef.current.value = '';
    };

    const handleImageUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try { const base64 = await fileToBase64HighRes(file); setPortrait(base64); } 
        catch (err) { console.error(err); alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    };

    const addAffiliation = () => {
        const text = affilInput.trim();
        if (text) {
            const newItem = { name: text, role: affilRole.trim() };
            const exists = affiliations.some(a => (typeof a === 'string' ? a : a.name) === text);
            if (exists) {
                setAffiliations(affiliations.map(a => (typeof a === 'string' ? a : a.name) === text ? newItem : a));
            } else {
                setAffiliations([...affiliations, newItem]);
            }
            setAffilInput('');
            setAffilRole('');
        }
    };

    const removeAffiliation = (idx) => {
        setAffiliations(affiliations.filter((_, i) => i !== idx));
    };

    const handleSave = () => {
        if (!name) return;
        const newChar = {
            id: editingChar ? editingChar.id : Date.now().toString(),
            name, portrait, race, 
            level: level ? parseInt(level) : null, // â˜…ä¿å­˜
            birthYear, deathYear, affiliations, note
        };

        if (editingChar) {
            setCharacters(characters.map(c => c.id === editingChar.id ? newChar : c));
        } else {
            setCharacters([...characters, newChar]);
        }

        if (organizations && setOrganizations) {
            const updatedOrgs = organizations.map(org => {
                const matchingAffil = newChar.affiliations.find(a => (typeof a === 'string' ? a : a.name) === org.name);
                let newKeyPeople = Array.isArray(org.keyPeople) ? [...org.keyPeople] : [];
                const namesToRemove = [newChar.name];
                if (editingChar && editingChar.name !== newChar.name) namesToRemove.push(editingChar.name);
                newKeyPeople = newKeyPeople.filter(p => !namesToRemove.includes(typeof p === 'string' ? p : p.name));
                if (matchingAffil) {
                    newKeyPeople.push({
                        name: newChar.name,
                        role: typeof matchingAffil === 'string' ? '' : matchingAffil.role
                    });
                }
                return { ...org, keyPeople: newKeyPeople };
            });
            setOrganizations(updatedOrgs);
        }
        resetForm();
    };

    const handleEdit = (char) => {
        setEditingChar(char);
        setName(char.name);
        setPortrait(char.portrait);
        setRace(char.race);
        setLevel(char.level || ''); // â˜…ã‚»ãƒƒãƒˆ
        setBirthYear(char.birthYear);
        setDeathYear(char.deathYear);
        if (char.affiliations) {
            const normalized = char.affiliations.map(item => {
                if (typeof item === 'string') return { name: item, role: '' };
                return item;
            });
            setAffiliations(normalized);
        } else {
            setAffiliations([]);
        }
        setNote(char.note);
    };

    const handleDelete = (id) => {
        if (window.confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            if (editingChar && organizations && setOrganizations) {
                const updatedOrgs = organizations.map(org => {
                    let newKeyPeople = Array.isArray(org.keyPeople) ? [...org.keyPeople] : [];
                    newKeyPeople = newKeyPeople.filter(p => (typeof p === 'string' ? p : p.name) !== editingChar.name);
                    return { ...org, keyPeople: newKeyPeople };
                });
                setOrganizations(updatedOrgs);
            }
            setCharacters(characters.filter(c => c.id !== id));
            if (editingChar && editingChar.id === id) resetForm();
        }
    };

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">
            <LevelInfoModal isOpen={showLevelInfo} onClose={() => setShowLevelInfo(false)} />
           
            <SectionHeader icon={Icons.User} title="äººç‰©ç®¡ç†" desc="æ­´å²ä¸Šã®é‡è¦äººç‰©ã‚’ç™»éŒ²ã—ã¾ã™ã€‚è‚–åƒç”»ã‚„é–¢é€£çµ„ç¹”ã‚’è¨­å®šã§ãã¾ã™ã€‚" />

            <div className="flex gap-6 items-start flex-grow">
                {/* å·¦å´ãƒªã‚¹ãƒˆ */}
                <div className="w-80 flex-shrink-0 h-[calc(100vh-320px)] min-h-[400px] bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col sticky top-4">
                    <div className="p-3 bg-gray-50 border-b font-bold text-gray-600 text-sm flex justify-between items-center">
                        ç™»éŒ²äººç‰©ä¸€è¦§ <span className="bg-gray-200 px-2 rounded-full text-xs">{characters.length}</span>
                    </div>
                    <div className="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-2">
                        {characters.map(char => {
                            const raceInfo = RACES.find(r => r.label === char.race);
                            return (
                                <div key={char.id} onClick={() => handleEdit(char)} className={`p-2 rounded border cursor-pointer transition-colors flex gap-3 ${editingChar?.id === char.id ? 'bg-blue-50 border-blue-300' : 'bg-white hover:bg-gray-50'}`}>
                                    <div className="w-10 h-10 bg-gray-200 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                                        {char.portrait ? <img src={char.portrait} className="w-full h-full object-cover" /> : <Icons.User className="w-full h-full p-2 text-gray-400" />}
                                    </div>
                                    <div className="flex-grow overflow-hidden">
                                        <div className="font-bold text-sm truncate">{char.name}</div>
                                        <div className="text-xs flex items-center gap-2 mt-0.5">
                                            <span className="px-1.5 py-0.5 rounded text-[10px] text-white whitespace-nowrap" style={{backgroundColor: raceInfo?.color || '#9ca3af'}}>{char.race}</span>
                                            {char.level && <span className="text-[10px] font-mono font-bold text-gray-500">Lv.{char.level}</span>}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        <button onClick={resetForm} className="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-400 hover:border-blue-400 hover:text-blue-500 font-bold text-sm flex items-center justify-center gap-2">
                            <Icons.Plus size={16}/> æ–°è¦ä½œæˆ
                        </button>
                    </div>
                </div>

                {/* å³å´ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */}
                <div className="flex-grow bg-white rounded-lg shadow-lg border border-gray-200 p-6">
                    <h3 className="font-bold text-lg mb-6 border-b pb-2">{editingChar ? 'äººç‰©ã‚’ç·¨é›†' : 'æ–°è¦äººç‰©ç™»éŒ²'}</h3>
                    <div className="flex flex-col gap-6">
                        
                        {/* ç”»åƒã‚¨ãƒªã‚¢ */}
                        <div className="w-full flex flex-col items-center gap-2">
                            <div className="relative group cursor-pointer w-40 h-40 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 overflow-hidden flex items-center justify-center shadow-inner">
                                {portrait ? <img src={portrait} className="w-full h-full object-contain" /> : <div className="text-center p-2 text-gray-400"><Icons.User size={40} className="mx-auto mb-1"/><span className="text-[10px] font-bold">è‚–åƒç”»ã‚’è¨­å®š</span></div>}
                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" ref={fileInputRef} onChange={handleImageUpload} />
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none text-xs">ç”»åƒã‚’å¤‰æ›´</div>
                            </div>
                            {portrait && <button onClick={() => setPortrait(null)} className="text-xs text-red-500 hover:underline">ç”»åƒã‚’å‰Šé™¤</button>}
                        </div>

                        {/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */}
                        <div className="space-y-5">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="col-span-2">
                                    <label className="block text-xs font-bold text-gray-600 mb-1">åå‰</label>
                                    <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border rounded font-bold text-lg" placeholder="ä¾‹: è‹±è¦‡ ç‹å¤ªéƒ" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-1">ç¨®æ—</label>
                                    <select value={race} onChange={e => setRace(e.target.value)} className="w-full p-2 border rounded bg-white">
                                        {RACES.map(r => <option key={r.label} value={r.label}>{r.label} ({r.ruby})</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-1 flex items-center gap-1">
                                        ãƒ¬ãƒ™ãƒ« (Lv) 
                                        <button onClick={() => setShowLevelInfo(true)} className="bg-gray-200 text-gray-500 rounded-full w-4 h-4 flex items-center justify-center hover:bg-blue-500 hover:text-white transition-colors" title="ãƒ¬ãƒ™ãƒ«ã¨ã¯ï¼Ÿ"><Icons.HelpCircle size={10}/></button>
                                    </label>
                                    <div className="flex items-center gap-2">
                                        <input type="number" min="1" max="120" value={level} onChange={e => setLevel(e.target.value)} className="w-20 p-2 border rounded font-mono text-center" placeholder="Lv" />
                                        <input type="range" min="1" max="120" value={level || 1} onChange={e => setLevel(e.target.value)} className="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="w-1/2">
                                        <label className="block text-xs font-bold text-gray-600 mb-1">ç”Ÿå¹´</label>
                                        <input type="number" value={birthYear} onChange={e => setBirthYear(e.target.value)} className="w-full p-2 border rounded" placeholder="1800" />
                                    </div>
                                    <div className="w-1/2">
                                        <label className="block text-xs font-bold text-gray-600 mb-1">æ²¡å¹´</label>
                                        <input type="number" value={deathYear} onChange={e => setDeathYear(e.target.value)} className="w-full p-2 border rounded" placeholder="1880" />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-gray-50 p-3 rounded border border-gray-200">
                                <label className="block text-xs font-bold text-gray-600 mb-2 flex items-center gap-1"><Icons.Briefcase size={12}/> é–¢é€£çµ„ç¹”ãƒ»æ‰€å±ã¨å½¹è·</label>
                                <div className="flex flex-col sm:flex-row gap-2 mb-2">
                                    <select className="p-1.5 border rounded text-sm bg-white sm:w-40 flex-shrink-0" onChange={(e) => { if(e.target.value) setAffilInput(e.target.value); e.target.value=''; }}>
                                        <option value="">çµ„ç¹”ãƒ»å›½å®¶ã‚’é¸æŠ...</option>
                                        {affiliationOptions.map((opt, idx) => <option key={idx} value={opt.name}>{opt.name}</option>)}
                                    </select>
                                    <input type="text" value={affilInput} onChange={e => setAffilInput(e.target.value)} className="flex-grow p-1.5 border rounded text-sm" placeholder="çµ„ç¹”å (å…¥åŠ›å¯)" />
                                    <input type="text" value={affilRole} onChange={e => setAffilRole(e.target.value)} onKeyDown={e => { if(e.key === 'Enter'){ e.preventDefault(); addAffiliation(); } }} className="sm:w-32 p-1.5 border rounded text-sm" placeholder="å½¹è· (ä¾‹: å›£é•·)" />
                                    <button onClick={addAffiliation} className="bg-gray-200 px-3 py-1.5 rounded hover:bg-gray-300 text-gray-600 font-bold text-sm flex-shrink-0">+</button>
                                </div>
                                <div className="flex flex-wrap gap-1.5 min-h-[30px]">
                                    {affiliations.map((item, idx) => {
                                        const orgName = typeof item === 'string' ? item : item.name;
                                        const orgRole = typeof item === 'string' ? '' : item.role;
                                        return (
                                            <span key={idx} className="inline-flex items-center gap-1 px-2 py-1 bg-white border border-gray-300 rounded-full text-xs text-gray-700 shadow-sm">
                                                <span className="font-bold">{orgName}</span>
                                                {orgRole && <span className="text-gray-500 border-l pl-1 ml-1 border-gray-300">{orgRole}</span>}
                                                <button onClick={() => removeAffiliation(idx)} className="text-gray-400 hover:text-red-500 ml-1"><Icons.X size={12}/></button>
                                            </span>
                                        );
                                    })}
                                    {affiliations.length === 0 && <span className="text-xs text-gray-400 italic p-1">æ‰€å±ãªã—</span>}
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-gray-600 mb-1">å‚™è€ƒãƒ»ãƒ¡ãƒ¢</label>
                                <textarea value={note} onChange={e => setNote(e.target.value)} className="w-full p-2 border rounded h-24 text-sm" placeholder="äººç‰©ã®èƒŒæ™¯ã‚„å½¹å‰²ãªã©..." />
                            </div>

                            <div className="flex justify-end gap-3 pt-2">
                                {editingChar && <button onClick={() => handleDelete(editingChar.id)} className="text-red-500 text-sm hover:bg-red-50 px-3 py-2 rounded mr-auto">å‰Šé™¤</button>}
                                <button onClick={resetForm} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <button onClick={handleSave} className="bg-blue-900 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-800 flex items-center gap-2"><Icons.Save size={18}/> ä¿å­˜</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- OrganizationManager ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: ãƒ­ã‚´ã‚’ä¸Šéƒ¨ã«é…ç½®) ---
const OrganizationManager = ({ setView, nations, organizations, setOrganizations, characters, setCharacters }) => {
    const [editingOrg, setEditingOrg] = useState(null);
    const [name, setName] = useState('');
    const [logo, setLogo] = useState(null);
    const [type, setType] = useState(ORG_TYPES[0].key);
    
    const [keyPeople, setKeyPeople] = useState([]);
    const [personInput, setPersonInput] = useState('');
    const [personRole, setPersonRole] = useState('');

    const [affiliationId, setAffiliationId] = useState('');
    const [activeStart, setActiveStart] = useState('');
    const [activeEnd, setActiveEnd] = useState('');
    const [note, setNote] = useState('');
    const fileInputRef = useRef(null);

    const charOptions = useMemo(() => {
        return characters.map(c => ({ id: c.id, name: c.name }));
    }, [characters]);

    const nationOptions = useMemo(() => {
        const options = [];
        nations.forEach(n => {
            options.push({ value: n.id, label: n.name, isEra: false });
            (n.eras || []).forEach((era, idx) => {
                if (era.name && era.name !== n.name) {
                    options.push({ value: `${n.id}_era_${idx}`, label: `${era.name} (${era.startYear}å¹´ï½)`, isEra: true });
                }
            });
        });
        return options;
    }, [nations]);

    const resetForm = () => {
        setEditingOrg(null);
        setName('');
        setLogo(null);
        setType(ORG_TYPES[0].key);
        setKeyPeople([]);
        setPersonInput('');
        setPersonRole('');
        setAffiliationId('');
        setActiveStart('');
        setActiveEnd('');
        setNote('');
        if(fileInputRef.current) fileInputRef.current.value = '';
    };

    const handleImageUpload = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try { const base64 = await fileToBase64(file); setLogo(base64); } 
        catch (err) { console.error(err); alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    };

    const addPerson = () => {
        const text = personInput.trim();
        if (text) {
            const newItem = { name: text, role: personRole.trim() };
            const exists = keyPeople.some(p => (typeof p === 'string' ? p : p.name) === text);
            if (exists) {
                setKeyPeople(keyPeople.map(p => (typeof p === 'string' ? p : p.name) === text ? newItem : p));
            } else {
                setKeyPeople([...keyPeople, newItem]);
            }
            setPersonInput('');
            setPersonRole('');
        }
    };

    const removePerson = (idx) => {
        setKeyPeople(keyPeople.filter((_, i) => i !== idx));
    };

    const handleSave = () => {
        if (!name) return;
        const newOrg = {
            id: editingOrg ? editingOrg.id : Date.now().toString(),
            name, logo, type, 
            keyPeople,
            affiliationId, activeStart, activeEnd, note
        };

        if (editingOrg) {
            setOrganizations(organizations.map(o => o.id === editingOrg.id ? newOrg : o));
        } else {
            setOrganizations([...organizations, newOrg]);
        }

        if (characters && setCharacters) {
            const updatedChars = characters.map(char => {
                const matchingPerson = newOrg.keyPeople.find(p => (typeof p === 'string' ? p : p.name) === char.name);
                let newAffiliations = Array.isArray(char.affiliations) ? [...char.affiliations] : [];
                const namesToRemove = [newOrg.name];
                if (editingOrg && editingOrg.name !== newOrg.name) namesToRemove.push(editingOrg.name);
                newAffiliations = newAffiliations.filter(a => !namesToRemove.includes(typeof a === 'string' ? a : a.name));
                if (matchingPerson) {
                    newAffiliations.push({
                        name: newOrg.name,
                        role: typeof matchingPerson === 'string' ? '' : matchingPerson.role
                    });
                }
                return { ...char, affiliations: newAffiliations };
            });
            setCharacters(updatedChars);
        }
        resetForm();
    };

    const handleEdit = (org) => {
        setEditingOrg(org);
        setName(org.name);
        setLogo(org.logo);
        setType(org.type);
        if (org.keyPeople) {
            const normalized = org.keyPeople.map(item => {
                if (typeof item === 'string') return { name: item, role: '' };
                return item;
            });
            setKeyPeople(normalized);
        } else if (org.leader) {
            setKeyPeople([{ name: org.leader, role: 'ä»£è¡¨' }]);
        } else {
            setKeyPeople([]);
        }
        setAffiliationId(org.affiliationId);
        setActiveStart(org.activeStart);
        setActiveEnd(org.activeEnd);
        setNote(org.note);
    };

    const handleDelete = (id) => {
        if (window.confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            if (editingOrg && characters && setCharacters) {
                const updatedChars = characters.map(char => {
                    let newAffiliations = Array.isArray(char.affiliations) ? [...char.affiliations] : [];
                    newAffiliations = newAffiliations.filter(a => (typeof a === 'string' ? a : a.name) !== editingOrg.name);
                    return { ...char, affiliations: newAffiliations };
                });
                setCharacters(updatedChars);
            }
            setOrganizations(organizations.filter(o => o.id !== id));
            if (editingOrg && editingOrg.id === id) resetForm();
        }
    };

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">

            <SectionHeader icon={Icons.Briefcase} title="çµ„ç¹”ç®¡ç†" desc="å›½å®¶å†…ã®ã‚®ãƒ«ãƒ‰ã€é¨å£«å›£ã€ä¼æ¥­ã€å®—æ•™å›£ä½“ãªã©ã‚’ç™»éŒ²ã—ã¾ã™ã€‚" />

            <div className="flex gap-6 items-start flex-grow">
                {/* å·¦å´ãƒªã‚¹ãƒˆ */}
                <div className="w-80 flex-shrink-0 h-[calc(100vh-320px)] min-h-[400px] bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col sticky top-4">
                    <div className="p-3 bg-gray-50 border-b font-bold text-gray-600 text-sm flex justify-between items-center">
                        ç™»éŒ²çµ„ç¹”ä¸€è¦§ <span className="bg-gray-200 px-2 rounded-full text-xs">{organizations.length}</span>
                    </div>
                    <div className="flex-grow overflow-y-auto custom-scrollbar p-2 space-y-2">
                        {organizations.map(org => {
                            const typeInfo = ORG_TYPES.find(t => t.key === org.type);
                            return (
                                <div key={org.id} onClick={() => handleEdit(org)} className={`p-2 rounded border cursor-pointer transition-colors flex gap-3 items-center ${editingOrg?.id === org.id ? 'bg-blue-50 border-blue-300' : 'bg-white hover:bg-gray-50'}`}>
                                    <div className="w-8 h-8 bg-gray-100 rounded flex-shrink-0 border border-gray-200 flex items-center justify-center overflow-hidden">
                                        {org.logo ? <img src={org.logo} className="w-full h-full object-cover"/> : <span>{typeInfo?.icon}</span>}
                                    </div>
                                    <div className="flex-grow overflow-hidden">
                                        <div className="font-bold text-sm truncate">{org.name}</div>
                                        <div className="text-xs text-gray-500">{typeInfo?.label}</div>
                                    </div>
                                </div>
                            );
                        })}
                        <button onClick={resetForm} className="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-400 hover:border-blue-400 hover:text-blue-500 font-bold text-sm flex items-center justify-center gap-2">
                            <Icons.Plus size={16}/> æ–°è¦ä½œæˆ
                        </button>
                    </div>
                </div>

                {/* å³å´ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  (ä¿®æ­£: ä¸Šä¸‹é…ç½®) */}
                <div className="flex-grow bg-white rounded-lg shadow-lg border border-gray-200 p-6">
                    <h3 className="font-bold text-lg mb-6 border-b pb-2">{editingOrg ? 'çµ„ç¹”ã‚’ç·¨é›†' : 'æ–°è¦çµ„ç¹”ç™»éŒ²'}</h3>
                    
                    {/* â˜…ä¿®æ­£: flex-colã®ã¿ã«ã—ã€ãƒ­ã‚´ã‚’æœ€åˆã«é…ç½® */}
                    <div className="flex flex-col gap-6">
                        
                        {/* ãƒ­ã‚´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ (ä¸­å¤®é…ç½®) */}
                        <div className="w-full flex flex-col items-center gap-2">
                            <div className="relative group cursor-pointer w-32 h-32 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 overflow-hidden flex items-center justify-center shadow-inner">
                                {logo ? (
                                    <img src={logo} className="w-full h-full object-contain" />
                                ) : (
                                    <div className="text-center p-2 text-gray-400">
                                        <Icons.Briefcase size={32} className="mx-auto mb-1"/>
                                        <span className="text-[10px] font-bold">ãƒ­ã‚´è¨­å®š</span>
                                    </div>
                                )}
                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" ref={fileInputRef} onChange={handleImageUpload} />
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none text-xs">å¤‰æ›´</div>
                            </div>
                            {logo && <button onClick={() => setLogo(null)} className="text-xs text-red-500 hover:underline">ç”»åƒã‚’å‰Šé™¤</button>}
                        </div>

                        {/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒªã‚¢ */}
                        <div className="space-y-5">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="col-span-2">
                                    <label className="block text-xs font-bold text-gray-600 mb-1">çµ„ç¹”å</label>
                                    <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border rounded font-bold" placeholder="ä¾‹: ç‹ç«‹é­”å°ç ”ç©¶æ‰€" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-1">ç¨®åˆ¥</label>
                                    <select value={type} onChange={e => setType(e.target.value)} className="w-full p-2 border rounded bg-white">
                                        {ORG_TYPES.map(t => (
                                            <option key={t.key} value={t.key}>{t.icon} {t.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-600 mb-1">æ‹ ç‚¹ãƒ»æ‰€å±å›½å®¶</label>
                                    <select value={affiliationId} onChange={e => setAffiliationId(e.target.value)} className="w-full p-2 border rounded bg-white text-sm">
                                        <option value="">-- ç‰¹ã«ãªã— --</option>
                                        {nationOptions.map(opt => (
                                            <option key={opt.value} value={opt.value}>
                                                {opt.isEra ? 'â”” ' : ''}{opt.label}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div className="bg-gray-50 p-3 rounded border border-gray-200">
                                <label className="block text-xs font-bold text-gray-600 mb-2 flex items-center gap-1">
                                    <Icons.User size={12}/> ä¸»è¦äººç‰©ãƒ»æ§‹æˆå“¡
                                </label>
                                <div className="flex flex-col sm:flex-row gap-2 mb-2">
                                    <select 
                                        className="p-1.5 border rounded text-sm bg-white sm:w-40 flex-shrink-0"
                                        onChange={(e) => { if(e.target.value) setPersonInput(e.target.value); e.target.value=''; }}
                                    >
                                        <option value="">ç™»éŒ²äººç‰©ã‹ã‚‰é¸æŠ...</option>
                                        {charOptions.map(c => (
                                            <option key={c.id} value={c.name}>{c.name}</option>
                                        ))}
                                    </select>
                                    <input 
                                        type="text" 
                                        value={personInput} 
                                        onChange={e => setPersonInput(e.target.value)} 
                                        className="flex-grow p-1.5 border rounded text-sm" 
                                        placeholder="äººç‰©å (å…¥åŠ›å¯)" 
                                    />
                                    <input 
                                        type="text" 
                                        value={personRole} 
                                        onChange={e => setPersonRole(e.target.value)} 
                                        onKeyDown={e => { if(e.key === 'Enter'){ e.preventDefault(); addPerson(); } }}
                                        className="sm:w-32 p-1.5 border rounded text-sm" 
                                        placeholder="å½¹è· (ä¾‹: ä»£è¡¨)" 
                                    />
                                    <button onClick={addPerson} className="bg-gray-200 px-3 py-1.5 rounded hover:bg-gray-300 text-gray-600 font-bold text-sm flex-shrink-0">+</button>
                                </div>
                                <div className="flex flex-wrap gap-1.5 min-h-[30px]">
                                    {keyPeople.map((item, idx) => {
                                        const pName = typeof item === 'string' ? item : item.name;
                                        const pRole = typeof item === 'string' ? '' : item.role;
                                        return (
                                            <span key={idx} className="inline-flex items-center gap-1 px-2 py-1 bg-white border border-gray-300 rounded-full text-xs text-gray-700 shadow-sm">
                                                <span className="font-bold">{pName}</span>
                                                {pRole && <span className="text-gray-500 border-l pl-1 ml-1 border-gray-300">{pRole}</span>}
                                                <button onClick={() => removePerson(idx)} className="text-gray-400 hover:text-red-500 ml-1"><Icons.X size={12}/></button>
                                            </span>
                                        );
                                    })}
                                    {keyPeople.length === 0 && <span className="text-xs text-gray-400 italic p-1">äººç‰©ãªã—</span>}
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <div className="w-1/2">
                                    <label className="block text-xs font-bold text-gray-600 mb-1">è¨­ç«‹å¹´</label>
                                    <input type="number" value={activeStart} onChange={e => setActiveStart(e.target.value)} className="w-full p-2 border rounded" placeholder="1800" />
                                </div>
                                <div className="w-1/2">
                                    <label className="block text-xs font-bold text-gray-600 mb-1">è§£æ•£å¹´</label>
                                    <input type="number" value={activeEnd} onChange={e => setActiveEnd(e.target.value)} className="w-full p-2 border rounded" placeholder="" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-600 mb-1">æ¦‚è¦ãƒ»ç›®çš„</label>
                                <textarea value={note} onChange={e => setNote(e.target.value)} className="w-full p-2 border rounded h-24 text-sm" placeholder="çµ„ç¹”ã®ç›®çš„ã‚„æ´»å‹•å†…å®¹..." />
                            </div>

                            <div className="flex justify-end gap-3 pt-2 border-t">
                                {editingOrg && (
                                    <button onClick={() => handleDelete(editingOrg.id)} className="text-red-500 text-sm hover:bg-red-50 px-3 py-2 rounded mr-auto">å‰Šé™¤</button>
                                )}
                                <button onClick={resetForm} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                <button onClick={handleSave} className="bg-blue-900 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-800 flex items-center gap-2">
                                    <Icons.Save size={18}/> ä¿å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- ä¿®æ­£ç‰ˆ QuillEditor (ãƒã‚°ä¿®æ­£æ¸ˆã¿: ä½™è¨ˆãªè¡Œã‚’å‰Šé™¤) ---
const QuillEditor = ({ initialContent, onSave, nationName, nationFlag }) => {
    const editorRef = useRef(null);
    const quillInstanceRef = useRef(null);
    // Ã— ã“ã“ã«ã‚ã£ãŸé–“é•ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ

    // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ³ãƒˆãƒ»ãƒ«ãƒ“ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ä¿®æ­£ç”¨ã®CSSã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
    const injectCustomStyles = () => {
        if (document.getElementById('quill-custom-styles')) return;
        const style = document.createElement('style');
        style.id = 'quill-custom-styles';
        style.innerHTML = `
            /* --- ã‚¨ãƒ‡ã‚£ã‚¿åŸºæœ¬è¨­å®š --- */
            .ql-container { height: auto !important; min-height: 500px; font-family: "Helvetica Neue", Arial, sans-serif; font-size: 16px; border: none !important; }
            .ql-editor { height: auto; min-height: 500px; overflow-y: visible; padding-bottom: 50px; }
            
            /* --- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã¨ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒã‚°ä¿®æ­£ --- */
            .ql-toolbar { position: sticky; top: 0; z-index: 30; background: #f9fafb; border-bottom: 1px solid #e5e7eb !important; }
            .ql-snow .ql-stroke { stroke: #444; }
            .ql-snow .ql-fill { fill: #444; }
            .ql-picker-label { outline: none !important; }
            
            /* --- ãƒ•ã‚©ãƒ³ãƒˆå®šç¾© --- */
            .ql-font-gothic { font-family: "Yu Gothic", sans-serif; }
            .ql-font-mincho { font-family: "Yu Mincho", serif; }
        `;
        document.head.appendChild(style);
    };

    // åˆæœŸåŒ–ã¨è¨­å®š
    useEffect(() => {
        if (!editorRef.current) return;
        
        // æ—¢ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹å ´åˆã¯å†ç”Ÿæˆã‚’é˜²ã
        if (quillInstanceRef.current) return;

        editorRef.current.innerHTML = ''; 
        injectCustomStyles();
        
        if (window.Quill) {
            // ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
            const Font = window.Quill.import('formats/font');
            Font.whitelist = ['gothic', 'mincho', 'serif', 'sans-serif', 'monospace'];
            window.Quill.register(Font, true);

            const quill = new window.Quill(editorRef.current, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'font': Font.whitelist }, { 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'blockquote', 'code-block'],
                        ['clean']
                    ]
                },
                placeholder: 'ã“ã“ã«å›½å®¶ã®æ­´å²ã‚„è©³ç´°ã‚’è¨˜è¿°ã—ã¾ã™...'
            });

            // åˆæœŸå€¤ã‚»ãƒƒãƒˆï¼ˆåˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚ï¼‰
            if (initialContent) {
                quill.clipboard.dangerouslyPasteHTML(initialContent);
            }

            quillInstanceRef.current = quill;
        }
    }, []);

    // é…å»¶ãƒ‡ãƒ¼ã‚¿åæ˜ å‡¦ç†
    useEffect(() => {
        const quill = quillInstanceRef.current;
        if (quill && initialContent) {
            const currentText = quill.getText().trim();
            // ã‚¨ãƒ‡ã‚£ã‚¿ãŒç©ºã£ã½ã®å ´åˆã®ã¿ãƒ‡ãƒ¼ã‚¿ã‚’æµã—è¾¼ã‚€ï¼ˆä¸Šæ›¸ãé˜²æ­¢ï¼‰
            if (currentText.length === 0 && initialContent.length > 0) {
                 quill.clipboard.dangerouslyPasteHTML(initialContent);
            }
        }
    }, [initialContent]);

    const insertRuby = () => {
        const quill = quillInstanceRef.current;
        if (!quill) return;
        const range = quill.getSelection();
        if (range && range.length > 0) {
            const text = quill.getText(range.index, range.length);
            const reading = prompt(`ã€Œ${text}ã€ã®ãƒ«ãƒ“ã‚’å…¥åŠ›:`);
            if (reading) {
                quill.deleteText(range.index, range.length);
                quill.insertText(range.index, `[${text}|${reading}]`);
            }
        } else {
            alert('æ–‡å­—ã‚’é¸æŠã—ã¦ã‹ã‚‰æŠ¼ã—ã¦ãã ã•ã„');
        }
    };

    const handleSaveClick = () => {
        if (quillInstanceRef.current) {
            onSave(quillInstanceRef.current.root.innerHTML);
        }
    };

    return (
        <div className="w-full bg-white rounded-lg shadow-lg border border-gray-200">
             <div className="p-3 border-b bg-gray-50 flex justify-between items-center sticky top-0 z-40">
                <div className="flex items-center gap-2">
                    {nationFlag && <img src={nationFlag} className="w-8 h-5 object-cover border" />}
                    <span className="font-bold text-gray-700">{nationName}</span>
                </div>
                <div className="flex items-center gap-2">
                    <button onClick={insertRuby} className="bg-white border hover:bg-gray-50 text-gray-700 px-3 py-1 rounded text-xs font-bold">
                        ãƒ«ãƒ“
                    </button>
                    <button onClick={handleSaveClick} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded shadow text-sm font-bold flex items-center gap-2">
                        <Icons.Save size={16} /> ä¿å­˜
                    </button>
                </div>
            </div>
            <div className="bg-white">
                <div ref={editorRef} style={{minHeight: '500px'}}></div>
            </div>
        </div>
    );
};

// --- æ¨©åŠ›æ§‹é€ å›³ãƒ“ãƒ¥ãƒ¼ (ä¿®æ­£ç‰ˆ: ãƒ‘ãƒãƒ«é–‹é–‰æ©Ÿèƒ½ä»˜ã) ---
const PowerStructureView = ({ setView, nations, setNations, organizations, characters }) => {
    // é¸æŠä¸­ã®å›½ID
    const [targetNationId, setTargetNationId] = useState(nations.length > 0 ? nations[0].id : '');
    
    // --- ãƒ‘ãƒãƒ«é–‹é–‰ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ (è¿½åŠ ) ---
    const [isPanelOpen, setIsPanelOpen] = useState(true);

    // --- ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ“ä½œç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ ---
    const [zoom, setZoom] = useState(1.0);
    const [pan, setPan] = useState({ x: 0, y: 0 });
    const [isDragging, setIsDragging] = useState(false);
    const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

    // ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
    const [isPinching, setIsPinching] = useState(false);
    const [pinchStartDist, setPinchStartDist] = useState(0);
    const [pinchStartZoom, setPinchStartZoom] = useState(1.0);

    const containerRef = useRef(null);
    const targetNation = nations.find(n => n.id === targetNationId);

    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ­£è¦åŒ–
    const structure = useMemo(() => {
        let raw = targetNation?.powerStructure;
        if (!raw) {
            return [
                { id: 'legis', name: 'ç«‹æ³•åºœ', title: 'è­°ä¼š', type: 'root', children: [] },
                { id: 'exec', name: 'è¡Œæ”¿åºœ', title: 'å†…é–£/å¤§çµ±é ˜åºœ', type: 'root', children: [] },
                { id: 'judic', name: 'å¸æ³•åºœ', title: 'æœ€é«˜è£åˆ¤æ‰€', type: 'root', children: [] }
            ];
        }
        return Array.isArray(raw) ? raw : [raw];
    }, [targetNation]);

    const updateStructure = (newStructure) => {
        const newNations = nations.map(n => n.id === targetNationId ? { ...n, powerStructure: newStructure } : n);
        setNations(newNations);
    };

    // å†å¸°æ¢ç´¢ãƒ»æ›´æ–°ç”¨é–¢æ•°
    const findNode = (nodes, id) => {
        for (let node of nodes) {
            if (node.id === id) return node;
            if (node.children) {
                const found = findNode(node.children, id);
                if (found) return found;
            }
        }
        return null;
    };
    
    const updateNodeField = (id, field, value) => {
        const newRoots = JSON.parse(JSON.stringify(structure));
        const node = findNode(newRoots, id);
        if (node) { node[field] = value; updateStructure(newRoots); }
    };

    const addChild = (parentId) => {
        const newRoots = JSON.parse(JSON.stringify(structure));
        const parent = findNode(newRoots, parentId);
        if (parent) {
            parent.isCollapsed = false; 
            parent.children.push({ id: 'u-' + Math.random().toString(36).substr(2, 9), name: 'æ–°è¦å½¹è·', title: '', type: 'sub', linkType: '', linkId: '', children: [] });
            updateStructure(newRoots);
        }
    };

    const addRootTree = () => {
        const newRoots = JSON.parse(JSON.stringify(structure));
        newRoots.push({ id: 'root-' + Math.random().toString(36).substr(2, 9), name: 'æ–°è¦ç‹¬ç«‹çµ„ç¹”', title: 'æ¨©åŠ›æ©Ÿé–¢', type: 'root', children: [] });
        updateStructure(newRoots);
    };

    const deleteNode = (id) => {
        if (!window.confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé…ä¸‹ã®çµ„ç¹”ã‚‚æ¶ˆãˆã¾ã™ã€‚")) return;
        let newRoots = JSON.parse(JSON.stringify(structure));
        if (newRoots.some(r => r.id === id)) {
            if (newRoots.length <= 1) { alert("æœ€å¾Œã®1ã¤ã¯å‰Šé™¤ã§ãã¾ã›ã‚“"); return; }
            newRoots = newRoots.filter(r => r.id !== id);
        } else {
            const removeRecursive = (nodes) => {
                for (let node of nodes) {
                    if (node.children) {
                        node.children = node.children.filter(c => c.id !== id);
                        removeRecursive(node.children);
                    }
                }
            };
            removeRecursive(newRoots);
        }
        updateStructure(newRoots);
    };

    // --- æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ ---

    const handleStartDrag = (clientX, clientY, target) => {
        if (target.closest('.editor-sidebar') || target.closest('.toggle-btn') || target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'BUTTON') return;
        setIsDragging(true);
        setDragStart({ x: clientX - pan.x, y: clientY - pan.y });
    };

    const handleDragMove = (clientX, clientY) => {
        if (!isDragging) return;
        setPan({ x: clientX - dragStart.x, y: clientY - dragStart.y });
    };

    const onMouseDown = (e) => {
        handleStartDrag(e.clientX, e.clientY, e.target);
        if (!e.target.closest('.editor-sidebar') && !e.target.closest('.toggle-btn') && !['INPUT','SELECT','BUTTON'].includes(e.target.tagName)) {
            e.currentTarget.style.cursor = 'grabbing';
        }
    };
    const onMouseMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        handleDragMove(e.clientX, e.clientY);
    };
    const onMouseUp = (e) => {
        setIsDragging(false);
        e.currentTarget.style.cursor = 'grab';
    };
    const onWheel = (e) => {
        if (e.target.closest('.editor-sidebar')) return;
        const scaleAmount = -e.deltaY * 0.001;
        setZoom(prev => Math.min(Math.max(0.1, prev + scaleAmount), 3.0));
    };

    const getTouchDist = (touches) => {
        return Math.hypot(
            touches[0].clientX - touches[1].clientX,
            touches[0].clientY - touches[1].clientY
        );
    };

    const onTouchStart = (e) => {
        if (e.target.closest('.editor-sidebar') || e.target.closest('.toggle-btn') || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;
        if (e.touches.length === 2) {
            e.preventDefault(); setIsPinching(true); setIsDragging(false);
            const dist = getTouchDist(e.touches); setPinchStartDist(dist); setPinchStartZoom(zoom);
        } else if (e.touches.length === 1) {
            const touch = e.touches[0]; handleStartDrag(touch.clientX, touch.clientY, e.target);
        }
    };

    const onTouchMove = (e) => {
        if (isPinching && e.touches.length === 2) {
            e.preventDefault(); const dist = getTouchDist(e.touches);
            if (pinchStartDist > 0) { const scale = dist / pinchStartDist; setZoom(Math.min(Math.max(0.1, pinchStartZoom * scale), 3.0)); }
        } else if (isDragging && e.touches.length === 1) {
            const touch = e.touches[0]; handleDragMove(touch.clientX, touch.clientY);
        }
    };

    const onTouchEnd = () => { setIsDragging(false); setIsPinching(false); };

    // CSSå®šç¾©
    const treeCss = `
        .tf-tree { display: flex; text-align: center; }
        .tf-tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; }
        .tf-tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; }
        .tf-tree li::before, .tf-tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #999; width: 50%; height: 20px; }
        .tf-tree li::after { right: auto; left: 50%; border-left: 1px solid #999; }
        .tf-tree li:only-child::after, .tf-tree li:only-child::before { display: none; }
        .tf-tree li:only-child { padding-top: 0; }
        .tf-tree li:first-child::before { border: 0 none; }
        .tf-tree li:last-child::after { border: 0 none; }
        .tf-tree li:last-child::before { border-right: 1px solid #999; border-radius: 0 5px 0 0; }
        .tf-tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tf-tree ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #999; width: 0; height: 20px; }
        .node-card { display: flex; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 200px; position: relative; z-index: 10; text-align: left; }
        .node-card:hover { border-color: #60a5fa; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2); z-index: 20; }
    `;

    const renderTree = (node) => {
        let linkedData = null;
        if (node.linkType === 'org' && node.linkId) {
            linkedData = organizations.find(o => o.id === node.linkId);
        } else if (node.linkType === 'char' && node.linkId) {
            linkedData = characters.find(c => c.id === node.linkId);
        }
        const imageSrc = linkedData ? (node.linkType === 'org' ? linkedData.logo : linkedData.portrait) : null;
        const DefaultIcon = node.linkType === 'org' ? Icons.Briefcase : (node.linkType === 'char' ? Icons.User : Icons.User);
        
        const hasChildren = node.children && node.children.length > 0;
        const isCollapsed = !!node.isCollapsed;

        return (
            <li key={node.id}>
                <div className="node-card group !p-0 overflow-visible">
                    <div className="w-16 h-16 bg-gray-100 flex-shrink-0 border-r border-gray-200 flex items-center justify-center overflow-hidden relative rounded-l">
                        {imageSrc ? <img src={imageSrc} className="w-full h-full object-cover" /> : <div className="text-gray-300">{node.linkType ? <DefaultIcon size={24}/> : <Icons.User size={24}/>}</div>}
                        {node.linkType && <div className={`absolute top-0 left-0 p-0.5 text-white text-[8px] ${node.linkType === 'org' ? 'bg-blue-500' : 'bg-green-500'}`}>{node.linkType === 'org' ? <Icons.Briefcase size={8}/> : <Icons.User size={8}/>}</div>}
                    </div>
                    <div className="flex-grow p-2 flex flex-col justify-center w-36 bg-white rounded-r">
                        <input type="text" value={node.name} onChange={e => updateNodeField(node.id, 'name', e.target.value)} className="w-full font-bold border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none text-sm bg-transparent mb-0.5 px-1" placeholder="å½¹è·å" />
                        <input type="text" value={node.title} onChange={e => updateNodeField(node.id, 'title', e.target.value)} className="w-full text-[10px] text-gray-500 outline-none bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 px-1" placeholder="æ¨©é™ãƒ»å½¹å‰²" />
                        {linkedData ? ( <div className="text-[9px] font-bold text-blue-800 truncate bg-blue-50 px-1 rounded mt-1 mx-1">{linkedData.name}</div> ) : ( <div className="text-[9px] text-gray-300 italic mt-1 mx-1">æœªè¨­å®š</div> )}
                    </div>
                    
                    {hasChildren && (
                        <button 
                            onClick={(e) => { e.stopPropagation(); updateNodeField(node.id, 'isCollapsed', !isCollapsed); }}
                            className="absolute -bottom-3 left-1/2 transform -translate-x-1/2 w-6 h-6 bg-white border border-gray-400 hover:border-blue-500 text-gray-500 hover:text-blue-600 rounded-full flex items-center justify-center z-40 shadow-sm transition-colors"
                            title={isCollapsed ? "å±•é–‹" : "æŠ˜ã‚ŠãŸãŸã‚€"}
                        >
                            {isCollapsed ? <Icons.Plus size={12} strokeWidth={3} /> : <Icons.Minus size={12} strokeWidth={3} />}
                        </button>
                    )}

                    <div className="absolute top-full left-0 w-full bg-white border border-t-0 border-gray-300 rounded-b shadow-lg p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none group-hover:pointer-events-auto z-30 flex flex-col gap-2">
                        <div className="flex gap-1">
                            <select value={node.linkType || ''} onChange={e => updateNodeField(node.id, 'linkType', e.target.value)} className="text-[9px] border rounded w-1/3 p-0.5 bg-gray-50"> <option value="">ç´ä»˜ãªã—</option><option value="org">çµ„ç¹”</option><option value="char">äººç‰©</option> </select>
                            {node.linkType === 'org' && ( <select value={node.linkId || ''} onChange={e => updateNodeField(node.id, 'linkId', e.target.value)} className="text-[9px] border rounded w-2/3 p-0.5 bg-gray-50"> <option value="">--é¸æŠ--</option>{organizations.map(o => <option key={o.id} value={o.id}>{o.name}</option>)} </select> )}
                            {node.linkType === 'char' && ( <select value={node.linkId || ''} onChange={e => updateNodeField(node.id, 'linkId', e.target.value)} className="text-[9px] border rounded w-2/3 p-0.5 bg-gray-50"> <option value="">--é¸æŠ--</option>{characters.map(c => <option key={c.id} value={c.id}>{c.name}</option>)} </select> )}
                        </div>
                        <div className="flex gap-2 justify-between">
                            <button onClick={() => deleteNode(node.id)} className="bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded hover:bg-red-200 flex-1">å‰Šé™¤</button>
                            <button onClick={() => addChild(node.id)} className="bg-blue-100 text-blue-600 text-[10px] px-2 py-1 rounded hover:bg-blue-200 flex-1 font-bold">ï¼‹ä¸‹éƒ¨</button>
                        </div>
                    </div>
                </div>
                {!isCollapsed && hasChildren && <ul>{node.children.map(child => renderTree(child))}</ul>}
            </li>
        );
    };

    return (
        <div className="h-full flex flex-col bg-[#f4f4f9] overflow-hidden relative touch-none">
            <style>{treeCss}</style>
            
            {/* â˜… ãƒ‘ãƒãƒ«é–‹é–‰ãƒœã‚¿ãƒ³ (èˆˆäº¡ç³»çµ±å›³ã¨åŒæ§˜ã«é…ç½®) */}
            <button 
                onClick={() => setIsPanelOpen(!isPanelOpen)} 
                className="toggle-btn absolute top-4 left-4 z-[60] bg-white p-2 rounded-lg shadow-md border border-gray-200 text-gray-600 hover:bg-gray-50"
                title={isPanelOpen ? "ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹" : "è¨­å®šã‚’é–‹ã"}
            >
                {isPanelOpen ? <Icons.X size={20}/> : <Icons.Settings size={20}/>}
            </button>

            {/* â˜… å·¦ä¸Šã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« (æŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œ) */}
            <div className={`editor-sidebar absolute top-16 left-4 md:top-4 md:left-4 z-50 bg-white/95 backdrop-blur p-4 rounded-lg shadow-xl border border-gray-200 w-64 max-h-[80vh] overflow-y-auto custom-scrollbar transition-all duration-300 origin-top-left ${isPanelOpen ? 'scale-100 opacity-100' : 'scale-0 opacity-0 pointer-events-none'}`}>
                
                {/* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ãŸã‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ (ãƒœã‚¿ãƒ³ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã«) */}
                <div className="flex items-center gap-2 mb-4 pb-2 border-b pl-10 md:pl-0">
                    <h2 className="font-bold text-sm text-gray-700 flex items-center gap-2"><Icons.Structure size={16}/> æ¨©åŠ›æ§‹é€ å›³ã‚¨ãƒ‡ã‚£ã‚¿</h2>
                </div>

                <label className="block text-xs font-bold text-gray-500 mb-1">ç·¨é›†ã™ã‚‹å›½å®¶</label>
                <select value={targetNationId} onChange={e => setTargetNationId(e.target.value)} className="w-full p-2 border rounded text-sm mb-4 font-bold">
                    {nations.map(n => <option key={n.id} value={n.id}>{n.name}</option>)}
                </select>
                <div className="flex items-center gap-2 bg-gray-100 p-2 rounded mb-2">
                    <button onClick={() => setZoom(z => Math.max(0.1, z - 0.1))} className="w-6 h-6 bg-white rounded border text-sm font-bold">-</button>
                    <span className="flex-grow text-center text-xs font-mono">{Math.round(zoom * 100)}%</span>
                    <button onClick={() => setZoom(z => Math.min(3.0, z + 0.1))} className="w-6 h-6 bg-white rounded border text-sm font-bold">+</button>
                </div>
                <button onClick={addRootTree} className="w-full mt-2 py-2 bg-blue-600 text-white rounded font-bold text-xs hover:bg-blue-700 shadow flex items-center justify-center gap-2">
                    <Icons.GitMerge size={14}/> ç‹¬ç«‹çµ„ç¹”(ãƒˆãƒƒãƒ—)ã‚’è¿½åŠ 
                </button>
                <div className="text-[10px] text-gray-400 leading-tight mt-3">
                    <p>ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€ãƒ›ã‚¤ãƒ¼ãƒ«/ãƒ”ãƒ³ãƒã§æ‹¡å¤§</p>
                    <p>ãƒ»[+/-]ã§ãƒ„ãƒªãƒ¼é–‹é–‰</p>
                    <p>ãƒ»ã‚«ãƒ¼ãƒ‰ãƒ›ãƒãƒ¼ã§ç·¨é›†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</p>
                </div>
            </div>
            
            <div 
                ref={containerRef}
                className="flex-grow overflow-hidden cursor-grab active:cursor-grabbing relative"
                onMouseDown={onMouseDown}
                onMouseMove={onMouseMove}
                onMouseUp={onMouseUp}
                onMouseLeave={onMouseUp}
                onTouchStart={onTouchStart}
                onTouchMove={onTouchMove}
                onTouchEnd={onTouchEnd}
                onWheel={onWheel}
                style={{ backgroundImage: 'radial-gradient(#ccc 1px, transparent 1px)', backgroundSize: '20px 20px' }}
            >
                <div 
                    className="absolute top-0 left-0 origin-top-left transition-transform duration-75 ease-out flex gap-16 items-start"
                    style={{ 
                        transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`,
                        minWidth: '100%', minHeight: '100%', padding: '100px'
                    }}
                >
                    {structure.map(rootNode => (
                        <div key={rootNode.id} className="tf-tree">
                            <ul>{renderTree(rootNode)}</ul>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- StatsEditView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆv3: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ä»˜ã) ---
const StatsEditView = ({ setView, nations, stats, setStats }) => {
    const [mode, setMode] = useState('nation');
    const [targetYear, setTargetYear] = useState(DEFAULT_YEAR);
    const [yearInputData, setYearInputData] = useState({}); 
    
    const [targetNationId, setTargetNationId] = useState(nations[0]?.id || '');
    const [nationInputData, setNationInputData] = useState([]); 
    
    // è‡ªå‹•è£œå®Œç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
    const [fillStartYear, setFillStartYear] = useState('');
    const [fillEndYear, setFillEndYear] = useState('');
    const [fillStartPop, setFillStartPop] = useState('');
    const [fillEndPop, setFillEndPop] = useState('');
    const [fillStartGdp, setFillStartGdp] = useState('');
    const [fillEndGdp, setFillEndGdp] = useState('');
    const [curveType, setCurveType] = useState('linear');

    // ä¸­é–“ç‚¹ï¼ˆMidpointsï¼‰ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
    const [midPoints, setMidPoints] = useState([]);

    // â˜…è¿½åŠ : ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºé …ç›®åˆ‡ã‚Šæ›¿ãˆç”¨ ('population' or 'gdp')
    const [previewMetric, setPreviewMetric] = useState('population');

    // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    useEffect(() => {
        if (mode === 'year') {
            const currentStats = stats.filter(s => s.year === parseInt(targetYear));
            const map = {};
            currentStats.forEach(s => { map[s.nationId] = { population: s.population, gdp: s.gdp }; });
            setYearInputData(map);
        } else {
            if (!targetNationId) return;
            const currentStats = stats.filter(s => s.nationId === targetNationId).sort((a, b) => a.year - b.year);
            const formatted = currentStats.map(s => ({ id: s.id, year: s.year, population: s.population, gdp: s.gdp }));
            setNationInputData(formatted);
            
            if (currentStats.length > 0) {
                const first = currentStats[0];
                const last = currentStats[currentStats.length - 1];
                setFillStartYear(first.year); setFillStartPop(first.population); setFillStartGdp(first.gdp);
                setFillEndYear(last.year); setFillEndPop(last.population); setFillEndGdp(last.gdp);
            }
        }
    }, [mode, targetYear, targetNationId, stats]);

    const lookupAndSetData = (yearStr, setPop, setGdp) => {
        const y = parseInt(yearStr);
        if (isNaN(y)) return;
        const existing = nationInputData.find(d => d.year === y);
        if (existing) {
            if (existing.population) setPop(existing.population);
            if (existing.gdp) setGdp(existing.gdp);
        }
    };

    const handleStartYearChange = (val) => { setFillStartYear(val); lookupAndSetData(val, setFillStartPop, setFillStartGdp); };
    const handleEndYearChange = (val) => { setFillEndYear(val); lookupAndSetData(val, setFillEndPop, setFillEndGdp); };
    
    const addMidPoint = () => { setMidPoints([...midPoints, { id: Date.now(), year: '', population: '', gdp: '' }]); };
    const removeMidPoint = (idx) => { setMidPoints(midPoints.filter((_, i) => i !== idx)); };
    const updateMidPoint = (idx, field, val) => {
        const newMids = [...midPoints];
        newMids[idx][field] = val;
        if (field === 'year') {
            lookupAndSetData(val, (p) => { newMids[idx].population = p; setMidPoints([...newMids]); }, (g) => { newMids[idx].gdp = g; setMidPoints([...newMids]); });
        }
        setMidPoints(newMids);
    };

    const handleYearInputChange = (nationId, field, value) => { setYearInputData(prev => ({ ...prev, [nationId]: { ...prev[nationId], [field]: value } })); };
    
    const saveYearData = () => {
        const otherStats = stats.filter(s => s.year !== parseInt(targetYear));
        const newStats = [...otherStats];
        Object.entries(yearInputData).forEach(([nationId, data]) => {
            if (data && (data.population || data.gdp)) {
                newStats.push({ id: `stats_${targetYear}_${nationId}`, year: parseInt(targetYear), nationId, population: parseFloat(data.population) || 0, gdp: parseFloat(data.gdp) || 0 });
            }
        });
        setStats(newStats);
        alert(`${targetYear}å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
    };

    const handleNationInputChange = (index, field, value) => {
        const newData = [...nationInputData];
        newData[index] = { ...newData[index], [field]: value };
        setNationInputData(newData);
    };

    const addNationYearRow = () => {
        const lastYear = nationInputData.length > 0 ? nationInputData[nationInputData.length - 1].year : DEFAULT_YEAR;
        setNationInputData([...nationInputData, { year: lastYear + 1, population: '', gdp: '' }]);
    };

    const removeNationYearRow = (index) => { setNationInputData(nationInputData.filter((_, i) => i !== index)); };

    const executeAutoFill = () => {
        const points = [
            { year: parseInt(fillStartYear), pop: parseFloat(fillStartPop), gdp: parseFloat(fillStartGdp) },
            ...midPoints.map(m => ({ year: parseInt(m.year), pop: parseFloat(m.population), gdp: parseFloat(m.gdp) })),
            { year: parseInt(fillEndYear), pop: parseFloat(fillEndPop), gdp: parseFloat(fillEndGdp) }
        ].filter(p => !isNaN(p.year)).sort((a, b) => a.year - b.year);

        if (points.length < 2) { alert("é–‹å§‹å¹´ã¨çµ‚äº†å¹´ã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„"); return; }

        const easing = EASING_FUNCTIONS[curveType].func;
        const existingMap = {};
        nationInputData.forEach(d => existingMap[d.year] = d);

        for (let i = 0; i < points.length - 1; i++) {
            const p1 = points[i]; const p2 = points[i+1];
            if (p1.year >= p2.year) continue;

            const startY = p1.year; const endY = p2.year;
            const startPop = p1.pop || 0; const endPop = p2.pop || 0;
            const startGdp = p1.gdp || 0; const endGdp = p2.gdp || 0;

            for (let y = startY; y <= endY; y++) {
                const t = (y - startY) / (endY - startY);
                const factor = easing(t);
                const pop = Math.round(startPop + (endPop - startPop) * factor);
                const gdp = Math.round(startGdp + (endGdp - startGdp) * factor);
                existingMap[y] = { year: y, population: pop, gdp: gdp, id: existingMap[y]?.id };
            }
        }
        const result = Object.values(existingMap).sort((a, b) => a.year - b.year);
        setNationInputData(result);
    };

    const saveNationData = () => {
        const otherStats = stats.filter(s => s.nationId !== targetNationId);
        const newStats = [...otherStats];
        nationInputData.forEach(d => {
            if (d.year && (d.population || d.gdp)) {
                newStats.push({ id: `stats_${d.year}_${targetNationId}`, year: parseInt(d.year), nationId: targetNationId, population: parseFloat(d.population) || 0, gdp: parseFloat(d.gdp) || 0 });
            }
        });
        setStats(newStats);
        alert(`ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
    };

    const chartData = nationInputData.filter(d => d.year && (d.population || d.gdp)).sort((a,b)=>a.year-b.year);

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">
            <SectionHeader icon={Icons.BarChart2} title="çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ç®¡ç†" desc="å„å›½ã®äººå£ãƒ»GDPãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™ã€‚è‡ªå‹•è£œå®Œæ©Ÿèƒ½ã‚’ä½¿ã†ã¨ã€å§‹ç‚¹ã¨çµ‚ç‚¹ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç”Ÿæˆã§ãã¾ã™ã€‚" />
            
            <div className="bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col flex-grow min-h-[600px]">
                <div className="flex border-b border-gray-200 bg-gray-50 flex-shrink-0">
                    <button onClick={() => setMode('nation')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${mode === 'nation' ? 'bg-white border-t-4 border-green-500 text-green-800' : 'text-gray-500 hover:bg-gray-100'}`}>
                        <Icons.TrendingUp size={16}/> æ™‚ç³»åˆ—ã§è¨˜éŒ² (å›½å˜ä½ãƒ»æ¨å¥¨)
                    </button>
                    <button onClick={() => setMode('year')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${mode === 'year' ? 'bg-white border-t-4 border-blue-500 text-blue-800' : 'text-gray-500 hover:bg-gray-100'}`}>
                        <Icons.Calendar size={16}/> å®šç‚¹è¦³æ¸¬ (å¹´å˜ä½)
                    </button>
                </div>

                {mode === 'nation' && (
                    <div className="flex flex-col lg:flex-row h-full overflow-hidden">
                        <div className="w-full lg:w-1/3 bg-gray-50 border-b lg:border-b-0 lg:border-r border-gray-200 flex flex-col overflow-y-auto custom-scrollbar">
                            <div className="p-4 border-b border-gray-200 bg-white sticky top-0 z-10">
                                <label className="block text-xs font-bold text-gray-500 mb-1">ç·¨é›†å¯¾è±¡ã®å›½å®¶</label>
                                <select value={targetNationId} onChange={e => setTargetNationId(e.target.value)} className="w-full p-2 border rounded font-bold mb-2 bg-gray-50 focus:bg-white transition-colors">
                                    {nations.map(n => <option key={n.id} value={n.id}>{n.name}</option>)}
                                </select>
                                <button onClick={saveNationData} className="w-full bg-green-700 text-white py-2 rounded font-bold shadow hover:bg-green-600 flex items-center justify-center gap-2 transition-transform active:scale-95">
                                    <Icons.Save size={18}/> ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                                </button>
                            </div>

                            <div className="p-4 space-y-4">
                                <div className="bg-white p-4 rounded-lg border border-green-200 shadow-sm relative">
                                    <h4 className="font-bold text-sm text-green-800 mb-3 flex items-center gap-2"><Icons.Zap size={16}/> è‡ªå‹•è£œå®Œ (Auto Fill)</h4>
                                    
                                    <div className="mb-4 bg-green-50 p-2 rounded border border-green-100">
                                        <label className="text-[10px] font-bold text-green-800 mb-1 block">å§‹ç‚¹ (Start)</label>
                                        <div className="flex gap-2 mb-1">
                                            <input type="number" placeholder="å¹´" value={fillStartYear} onChange={e=>handleStartYearChange(e.target.value)} className="w-1/3 p-1 border rounded text-center text-sm font-bold" />
                                            <input type="number" placeholder="äººå£" value={fillStartPop} onChange={e=>setFillStartPop(e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm" />
                                            <input type="number" placeholder="GDP" value={fillStartGdp} onChange={e=>setFillStartGdp(e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm" />
                                        </div>
                                    </div>

                                    {midPoints.map((mp, idx) => (
                                        <div key={mp.id} className="mb-2 pl-4 border-l-2 border-dashed border-gray-300 relative">
                                            <div className="absolute -left-[7px] top-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-gray-300"></div>
                                            <div className="flex gap-2 items-center">
                                                <input type="number" placeholder="ä¸­é–“å¹´" value={mp.year} onChange={e=>updateMidPoint(idx, 'year', e.target.value)} className="w-1/3 p-1 border rounded text-center text-sm bg-gray-50" />
                                                <input type="number" placeholder="äººå£" value={mp.population} onChange={e=>updateMidPoint(idx, 'population', e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm bg-gray-50" />
                                                <input type="number" placeholder="GDP" value={mp.gdp} onChange={e=>updateMidPoint(idx, 'gdp', e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm bg-gray-50" />
                                                <button onClick={() => removeMidPoint(idx)} className="text-red-400 hover:text-red-600"><Icons.X size={14}/></button>
                                            </div>
                                        </div>
                                    ))}

                                    <div className="text-center mb-4">
                                        <button onClick={addMidPoint} className="text-xs text-blue-600 hover:text-blue-800 hover:underline flex items-center justify-center gap-1 mx-auto">
                                            <Icons.Plus size={12}/> ä¸­é–“ç‚¹(çµŒç”±åœ°)ã‚’è¿½åŠ 
                                        </button>
                                    </div>

                                    <div className="mb-4 bg-blue-50 p-2 rounded border border-blue-100">
                                        <label className="text-[10px] font-bold text-blue-800 mb-1 block">çµ‚ç‚¹ (End)</label>
                                        <div className="flex gap-2 mb-1">
                                            <input type="number" placeholder="å¹´" value={fillEndYear} onChange={e=>handleEndYearChange(e.target.value)} className="w-1/3 p-1 border rounded text-center text-sm font-bold" />
                                            <input type="number" placeholder="äººå£" value={fillEndPop} onChange={e=>setFillEndPop(e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm" />
                                            <input type="number" placeholder="GDP" value={fillEndGdp} onChange={e=>setFillEndGdp(e.target.value)} className="w-1/3 p-1 border rounded text-right text-sm" />
                                        </div>
                                    </div>

                                    <div className="mb-4">
                                        <label className="text-[10px] font-bold text-gray-500 mb-1 block">å¤‰åŒ–ã‚«ãƒ¼ãƒ– (åŒºé–“ã”ã¨ã«é©ç”¨)</label>
                                        <select value={curveType} onChange={e=>setCurveType(e.target.value)} className="w-full p-1.5 border rounded text-sm">
                                            {Object.entries(EASING_FUNCTIONS).map(([key, func]) => (
                                                <option key={key} value={key}>{func.name}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <button onClick={executeAutoFill} className="w-full py-2 bg-green-600 text-white rounded font-bold text-xs hover:bg-green-700 shadow-sm flex items-center justify-center gap-2">
                                        <Icons.RefreshCw size={14}/> ç”Ÿæˆ / ä¸Šæ›¸ã
                                    </button>
                                </div>

                                {chartData.length > 1 && (
                                    <div className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                        <div className="flex justify-between items-center mb-2">
                                            <h4 className="font-bold text-xs text-gray-500">å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
                                            {/* â˜…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */}
                                            <div className="flex bg-gray-100 rounded p-0.5">
                                                <button onClick={() => setPreviewMetric('population')} className={`px-2 py-0.5 text-[10px] font-bold rounded transition-colors ${previewMetric === 'population' ? 'bg-white shadow text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}>äººå£</button>
                                                <button onClick={() => setPreviewMetric('gdp')} className={`px-2 py-0.5 text-[10px] font-bold rounded transition-colors ${previewMetric === 'gdp' ? 'bg-white shadow text-green-600' : 'text-gray-400 hover:text-gray-600'}`}>GDP</button>
                                            </div>
                                        </div>
                                        <div className="h-24 flex items-end gap-0.5 border-b border-gray-200 pb-1">
                                            {(() => {
                                                // é¸æŠã•ã‚ŒãŸæŒ‡æ¨™ã«åŸºã¥ã„ã¦æœ€å¤§å€¤ã‚’è¨ˆç®—
                                                const getValue = (d) => parseFloat(d[previewMetric]) || 0;
                                                const maxValue = Math.max(...chartData.map(getValue));
                                                
                                                return chartData.map((d, i) => {
                                                    const val = getValue(d);
                                                    const h = maxValue ? (val / maxValue) * 100 : 0;
                                                    // è‰²ã®åˆ‡ã‚Šæ›¿ãˆ
                                                    const barColor = previewMetric === 'population' ? 'bg-blue-400 hover:bg-blue-600' : 'bg-green-400 hover:bg-green-600';
                                                    const unit = previewMetric === 'population' ? 'äºº' : 'å††';

                                                    return (
                                                        <div key={i} className={`flex-1 ${barColor} transition-all rounded-t-sm relative group`} style={{height: `${h}%`}}>
                                                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 bg-black text-white text-[9px] px-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none mb-1 whitespace-nowrap z-10 shadow-lg">
                                                                {d.year}å¹´: {formatJapaneseNumber(val, unit, true)}
                                                            </div>
                                                        </div>
                                                    );
                                                });
                                            })()}
                                        </div>
                                        <div className="flex justify-between text-[9px] text-gray-400 mt-1">
                                            <span>{chartData[0].year}</span>
                                            <span>{chartData[chartData.length-1].year}</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="flex-grow flex flex-col h-full overflow-hidden bg-white">
                            <div className="p-2 bg-gray-100 border-b border-gray-200 flex justify-between items-center text-xs font-bold text-gray-500">
                                <span className="pl-2">ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ ({nationInputData.length}ä»¶)</span>
                                <div className="flex gap-2">
                                    <button onClick={() => setNationInputData([])} className="px-2 py-1 hover:bg-red-100 text-red-500 rounded">å…¨ã‚¯ãƒªã‚¢</button>
                                    <button onClick={() => {
                                        const sorted = [...nationInputData].sort((a,b)=>a.year-b.year);
                                        setNationInputData(sorted);
                                    }} className="px-2 py-1 hover:bg-gray-200 rounded">å¹´ã‚½ãƒ¼ãƒˆ</button>
                                </div>
                            </div>
                            <div className="flex-grow overflow-y-auto custom-scrollbar p-0">
                                <table className="w-full text-sm text-left whitespace-nowrap">
                                    <thead className="text-xs text-gray-500 bg-gray-50 sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th className="px-2 py-2 text-center w-20">å¹´</th>
                                            <th className="px-2 py-2 text-right">äººå£</th>
                                            <th className="px-2 py-2 text-right">GDP</th>
                                            <th className="px-1 py-2 w-8"></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {nationInputData.map((d, idx) => (
                                            <tr key={idx} className="group hover:bg-blue-50 transition-colors">
                                                <td className="p-1">
                                                    <input type="number" value={d.year} onChange={e => handleNationInputChange(idx, 'year', e.target.value)} className="w-full p-1.5 border border-transparent group-hover:bg-white group-hover:border-gray-300 rounded text-center font-bold bg-transparent" placeholder="å¹´" />
                                                </td>
                                                <td className="p-1">
                                                    <input type="number" value={d.population} onChange={e => handleNationInputChange(idx, 'population', e.target.value)} className="w-full p-1.5 border border-transparent group-hover:bg-white group-hover:border-gray-300 rounded text-right font-mono bg-transparent text-blue-800" placeholder="-" />
                                                </td>
                                                <td className="p-1">
                                                    <input type="number" value={d.gdp} onChange={e => handleNationInputChange(idx, 'gdp', e.target.value)} className="w-full p-1.5 border border-transparent group-hover:bg-white group-hover:border-gray-300 rounded text-right font-mono bg-transparent text-green-800" placeholder="-" />
                                                </td>
                                                <td className="p-1 text-center">
                                                    <button onClick={() => removeNationYearRow(idx)} className="text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.X size={16}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="p-4 border-t border-dashed border-gray-200">
                                    <button onClick={addNationYearRow} className="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-400 font-bold hover:border-blue-400 hover:text-blue-500 flex justify-center items-center gap-2 transition-colors">
                                        <Icons.Plus size={16}/> ç©ºè¡Œã‚’è¿½åŠ 
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {mode === 'year' && (
                    <div className="flex flex-col h-full">
                        <div className="p-4 border-b bg-gray-50 flex items-center gap-4">
                            <label className="font-bold text-gray-700">å¯¾è±¡å¹´:</label>
                            <input type="number" value={targetYear} onChange={e => setTargetYear(e.target.value)} className="w-24 p-2 border rounded font-bold text-center" />
                            <div className="flex-grow"></div>
                            <button onClick={saveYearData} className="bg-blue-900 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-800 flex items-center gap-2"><Icons.Save size={18}/> ä¿å­˜ã™ã‚‹</button>
                        </div>
                        <div className="flex-grow overflow-y-auto custom-scrollbar p-4">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-100 text-gray-600 sticky top-0 shadow-sm">
                                    <tr>
                                        <th className="p-3 text-left">å›½å®¶</th>
                                        <th className="p-3 text-right">äººå£ (äºº)</th>
                                        <th className="p-3 text-right">GDP (å††)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {nations.map(n => {
                                        const info = getNationInfo(n, targetYear);
                                        const isDimmed = info.isCollapsed || info.isFuture;
                                        return (
                                            <tr key={n.id} className={isDimmed ? 'opacity-50 bg-gray-50' : 'hover:bg-blue-50'}>
                                                <td className="p-3 font-bold flex items-center gap-2">
                                                    {info.flag ? <img src={info.flag} className="w-6 h-4 object-cover border"/> : <div className="w-6 h-4 bg-gray-200"></div>}
                                                    {info.name}
                                                </td>
                                                <td className="p-2"><input type="number" value={yearInputData[n.id]?.population || ''} onChange={e => handleYearInputChange(n.id, 'population', e.target.value)} className="w-full p-2 border rounded text-right font-mono" placeholder="-" /></td>
                                                <td className="p-2"><input type="number" value={yearInputData[n.id]?.gdp || ''} onChange={e => handleYearInputChange(n.id, 'gdp', e.target.value)} className="w-full p-2 border rounded text-right font-mono" placeholder="-" /></td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// --- SimpleLineChart ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ã‚°ãƒ©ãƒ•ã®ç‚¹ã‚’é–“å¼•ãè¡¨ç¤º) ---
        const SimpleLineChart = ({ title, data, nations, getValue, formatValue, icon: Icon, dataType }) => {
            const [includeRefScale, setIncludeRefScale] = useState(false);
            const [isLegendExpanded, setIsLegendExpanded] = useState(false);
            const [visibleNationIds, setVisibleNationIds] = useState(nations.map(n => n.id));

            useEffect(() => {
                setVisibleNationIds(prev => { const currentIds = nations.map(n => n.id); return currentIds; });
            }, [nations.length]);

            const toggleNation = (id) => { setVisibleNationIds(prev => prev.includes(id) ? prev.filter(nid => nid !== id) : [...prev, id]); };
            const toggleAll = () => { setVisibleNationIds(visibleNationIds.length === nations.length ? [] : nations.map(n => n.id)); };

            const sortedData = [...data].sort((a, b) => a.year - b.year);
            const years = [...new Set(sortedData.map(d => d.year))];
            if (years.length === 0) return <div className="bg-white p-8 rounded-lg shadow text-center text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>;
            
            let maxValue = 0; 
            const activeData = sortedData.filter(d => visibleNationIds.includes(d.nationId));
            activeData.forEach(d => { const val = getValue(d); if (val > maxValue) maxValue = val; });

            let refData = [];
            if (dataType && ['population', 'gdp', 'perCapita'].includes(dataType)) {
                    refData = US_STATS.map(d => ({ ...d, year: d.year - AD_OFFSET }));
                    if (includeRefScale) { 
                        const minYear = Math.min(...years); const maxYear = Math.max(...years);
                        const scaleRefData = refData.filter(d => d.year >= minYear - 100 && d.year <= maxYear + 100);
                        scaleRefData.forEach(d => { let val = 0; if (dataType === 'population') val = d.population; else if (dataType === 'gdp') val = d.gdp; else if (dataType === 'perCapita') val = Math.round(d.gdp / d.population); if (val > maxValue) maxValue = val; }); 
                    }
            }
            if (maxValue === 0) maxValue = 100; const yMax = maxValue * 1.2;
            
            const width = 600; const height = 300; const padding = { top: 30, right: 30, bottom: 50, left: 80 }; const graphWidth = width - padding.left - padding.right; const graphHeight = height - padding.top - padding.bottom;
            const getX = (year) => { const index = years.indexOf(year); if (years.length === 1) return padding.left + graphWidth / 2; return padding.left + (index / (years.length - 1)) * graphWidth; };
            const getXByYear = (year) => { const minYear = Math.min(...years); const maxYear = Math.max(...years); if (maxYear === minYear) return padding.left + graphWidth / 2; return padding.left + ((year - minYear) / (maxYear - minYear)) * graphWidth; };
            const getY = (value) => padding.top + graphHeight - ((value / yMax) * graphHeight);
            const yGridLines = [0, 1, 2, 3, 4].map(i => { const val = (yMax / 5) * i; const y = getY(val); return ( <g key={i}> <line x1={padding.left} y1={y} x2={width - padding.right} y2={y} stroke="#f0f0f0" strokeWidth="1" /> <text x={padding.left - 10} y={y + 5} textAnchor="end" fontSize="12" fill="#999">{formatValue(val, true)}</text> </g> ); });
            
            let refLine = null;
            if (refData.length > 0) { 
                const points = refData.map(d => { let val = 0; if (dataType === 'population') val = d.population; else if (dataType === 'gdp') val = d.gdp; else if (dataType === 'perCapita') val = Math.round(d.gdp / d.population); const y = getY(val); return `${getXByYear(d.year)},${y}`; }).join(' '); 
                const minYear = Math.min(...years); const maxYear = Math.max(...years);
                const visibleRefPoints = refData.filter(d => d.year >= minYear - 50 && d.year <= maxYear + 50);
                const labelPoint = visibleRefPoints.length > 0 ? visibleRefPoints[visibleRefPoints.length - 1] : null;
                refLine = ( <g className="opacity-50"> <polyline points={points} fill="none" stroke="#cbd5e1" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" strokeDasharray="4 4" /> {labelPoint && ( <text x={getXByYear(labelPoint.year)} y={getY(dataType === 'population' ? labelPoint.population : (dataType === 'gdp' ? labelPoint.gdp : labelPoint.gdp/labelPoint.population)) - 10} textAnchor="middle" fontSize="10" fill="#94a3b8" fontWeight="bold">USA</text> )} </g> ); 
            }
            
            const lines = nations.map(nation => { 
                if (!visibleNationIds.includes(nation.id)) return null;

                const nationStats = sortedData.filter(d => { if (d.nationId !== nation.id) return false; const info = getNationInfo(nation, d.year); return !info.isCollapsed && !info.isFuture; }).sort((a, b) => a.year - b.year); if (nationStats.length === 0) return null; 
                const points = nationStats.map(d => `${getX(d.year)},${getY(getValue(d))}`).join(' '); 
                
                return ( 
                    <g key={nation.id}> 
                        {/* ç·šæœ¬ä½“ */}
                        <polyline points={points} fill="none" stroke={nation.color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="opacity-70 hover:opacity-100 transition-opacity" /> 
                        
                        {/* ãƒ‡ãƒ¼ã‚¿ç‚¹ */}
                        {nationStats.map((d, i) => { 
                            const info = getNationInfo(nation, d.year);
                            
                            // â˜…ä¿®æ­£: ç‚¹ã®é–“å¼•ããƒ­ã‚¸ãƒƒã‚¯
                            const prev = nationStats[i - 1];
                            const next = nationStats[i + 1];
                            // å‰å¾Œã¨é€£ç¶šã—ã¦ã„ã‚‹ï¼ˆå·®ãŒ1å¹´ï¼‰å ´åˆã¯ã€ä¸­é–“ç‚¹ã¨ã¿ãªã—ã¦éè¡¨ç¤ºã«ã™ã‚‹
                            const isContinuousPrev = prev && (d.year - prev.year === 1);
                            const isContinuousNext = next && (next.year - d.year === 1);
                            const isIntermediate = isContinuousPrev && isContinuousNext;
                            
                            // ä¸­é–“ç‚¹ãªã‚‰éè¡¨ç¤º(opacity-0)ã€ç«¯ç‚¹ãªã‚‰è¡¨ç¤º
                            const dotClass = isIntermediate 
                                ? "opacity-0 group-hover/point:opacity-100 scale-75" 
                                : "opacity-100";

                            return ( 
                                <g key={d.id} className="group/point"> 
                                    {/* ãƒ’ãƒƒãƒˆã‚¨ãƒªã‚¢ (é€æ˜ãªå¤§ãã„å††) - ä¸­é–“ç‚¹ã§ã‚‚ãƒã‚¦ã‚¹ãŒåå¿œã™ã‚‹ã‚ˆã†ã« */}
                                    <circle cx={getX(d.year)} cy={getY(getValue(d))} r="6" fill="transparent" className="cursor-pointer" />
                                    
                                    {/* è¡¨ç¤ºç”¨ã®å†† */}
                                    <circle 
                                        cx={getX(d.year)} 
                                        cy={getY(getValue(d))} 
                                        r={isIntermediate ? 3 : 4} 
                                        fill="white" 
                                        stroke={info.color} 
                                        strokeWidth="2" 
                                        className={`pointer-events-none transition-all duration-200 ${dotClass}`} 
                                    /> 
                                    
                                    {/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— (ãƒ›ãƒãƒ¼æ™‚) */}
                                    <g className="opacity-0 group-hover/point:opacity-100 transition-opacity pointer-events-none z-50"> 
                                        <rect x={Math.min(Math.max(getX(d.year) - 70, 0), width - 140)} y={getY(getValue(d)) - 65} width="140" height="55" rx="4" fill="rgba(0,0,0,0.9)" /> 
                                        <text x={Math.min(Math.max(getX(d.year), 70), width - 70)} y={getY(getValue(d)) - 45} textAnchor="middle" fill="white" fontSize="11"> {d.year}å¹´ ({info.name}) </text> 
                                        <text x={Math.min(Math.max(getX(d.year), 70), width - 70)} y={getY(getValue(d)) - 25} textAnchor="middle" fill="white" fontSize="13" fontWeight="bold"> {formatValue(getValue(d), false)} </text> 
                                    </g> 
                                </g> 
                            ); 
                        })} 
                    </g> 
                ); 
            });

            return ( 
                <div className="bg-white p-4 rounded-lg shadow-lg border border-gray-200 mb-8"> 
                    <div className="flex flex-wrap items-center justify-between mb-4 border-b pb-2 gap-2"> 
                        <div className="flex items-center gap-2"> <div className="p-2 bg-gray-100 rounded-full text-gray-700"><Icon size={20} /></div> <h3 className="text-lg font-bold text-gray-800">{title}</h3> </div> 
                        <div className="flex items-center gap-4 text-xs"> <div className="flex items-center gap-2 text-gray-400"> <span className="w-4 h-0.5 bg-gray-300 border border-gray-300 border-dashed inline-block"></span> ã‚¢ãƒ¡ãƒªã‚« (å²å®Ÿå‚è€ƒ: è¥¿æš¦-{AD_OFFSET}å¹´) </div> <label className="flex items-center gap-1 cursor-pointer bg-gray-50 px-2 py-1 rounded border hover:bg-gray-100 transition-colors"> <input type="checkbox" checked={includeRefScale} onChange={(e) => setIncludeRefScale(e.target.checked)} className="rounded text-blue-600" /> <span>åŸºæº–ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ç¸®å°</span> </label> </div> 
                    </div> 
                    <div className="w-full overflow-hidden"> 
                        <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto bg-gray-50 rounded border border-gray-100"> {yGridLines} {refLine} {years.map((year, i) => { const showLabel = years.length <= 10 || i % Math.ceil(years.length / 10) === 0 || i === years.length - 1; if (!showLabel) return null; return (<text key={year} x={getX(year)} y={height - 15} textAnchor="middle" fontSize="12" fill="#555" fontWeight="bold">{year}</text>); })} {lines} </svg> 
                    </div> 
                    <div className="mt-4">
                        <div className="flex justify-between items-center mb-2 px-1">
                             <div className="text-xs font-bold text-gray-500 flex items-center gap-2">
                                <span>è¡¨ç¤ºå¯¾è±¡: {visibleNationIds.length}/{nations.length}ãƒµå›½</span>
                                <button onClick={toggleAll} className="text-blue-600 hover:underline bg-blue-50 px-2 py-0.5 rounded border border-blue-100 transition-colors">
                                    {visibleNationIds.length === nations.length ? 'ã™ã¹ã¦éš ã™' : 'ã™ã¹ã¦è¡¨ç¤º'}
                                </button>
                             </div>
                             <button onClick={() => setIsLegendExpanded(!isLegendExpanded)} className="text-xs text-gray-500 flex items-center gap-1 hover:bg-gray-100 px-2 py-1 rounded transition-colors">
                                {isLegendExpanded ? <><Icons.Minus size={12} /> æŠ˜ã‚ŠãŸãŸã‚€</> : <><Icons.Plus size={12} /> ã™ã¹ã¦è¦‹ã‚‹</>}
                             </button>
                        </div>
                        <div className={`flex flex-wrap gap-2 justify-center transition-all overflow-hidden ${isLegendExpanded ? 'max-h-full' : 'max-h-16'}`}> 
                            {nations.map(n => {
                                const isActive = visibleNationIds.includes(n.id);
                                return (
                                    <button key={n.id} onClick={() => toggleNation(n.id)} className={`flex items-center gap-1.5 text-xs font-bold px-2 py-1 rounded border transition-all select-none ${isActive ? 'bg-gray-50 text-gray-700 border-gray-300 shadow-sm' : 'bg-transparent text-gray-300 border-transparent hover:bg-gray-50'}`}>
                                        <div className={`w-3 h-3 rounded-full transition-opacity ${isActive ? '' : 'opacity-20 grayscale'}`} style={{backgroundColor: n.color}}></div>
                                        <span className={isActive ? '' : 'line-through decoration-gray-300'}>{n.name}</span>
                                    </button>
                                );
                            })} 
                        </div>
                    </div>
                </div> 
            );
        };

// --- GraphView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ã“ã“ãŒæŠœã‘ã¦ã„ã¾ã—ãŸ) ---
const GraphView = ({ setView, stats, nations }) => ( 
    <div className="space-y-6 animate-fade-in pb-20"> 
        <SectionHeader icon={Icons.TrendingUp} title="å›½å®¶çµ±è¨ˆãƒ‡ãƒ¼ã‚¿åˆ†æ" desc="ç™»éŒ²ã•ã‚ŒãŸå…¨çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã€æœŸé–“ã«åˆã‚ã›ã¦ç­‰é–“éš”ã§é…ç½®ãƒ»å¯è¦–åŒ–ã—ã¾ã™ã€‚" /> 
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6"> 
            <div className="h-full"><SimpleLineChart title="ç·äººå£æ¨ç§»" data={stats} nations={nations} getValue={(d) => d.population} formatValue={(v, isShort) => formatJapaneseNumber(v, 'äºº', isShort)} icon={Icons.Users} dataType="population" /></div> 
            <div className="h-full"><SimpleLineChart title="GDP (å›½å†…ç·ç”Ÿç”£) æ¨ç§»" data={stats} nations={nations} getValue={(d) => d.gdp} formatValue={(v, isShort) => formatJapaneseNumber(v, 'å††', isShort)} icon={Icons.BarChart2} dataType="gdp" /></div> 
            <div className="h-full"><SimpleLineChart title="ä¸€äººã‚ãŸã‚ŠGDP (è±Šã‹ã•) æ¨ç§»" data={stats} nations={nations} getValue={(d) => calculatePerCapita(d.gdp, d.population)} formatValue={(v, isShort) => formatJapaneseNumber(v, 'å††', isShort)} icon={Icons.DollarSign} dataType="perCapita" /></div> 
            <div className="bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg flex flex-col items-center justify-center text-gray-400 p-8 min-h-[300px]"><Icons.BarChart2 size={32} className="opacity-20 mb-2"/><span className="font-bold text-sm opacity-50">No Data</span></div> 
        </div> 
    </div> 
);

// --- NationOverviewView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (å¾©æ´»ãƒ»ä¿®æ­£ç‰ˆ) ---
const NationOverviewView = ({ setView, nations, setNations, targetNation }) => {
    const [selectedNation, setSelectedNation] = useState(null);

    useEffect(() => {
        if (targetNation) {
            const current = nations.find(n => n.id === targetNation.id);
            if (current) setSelectedNation(current);
        }
    }, [targetNation, nations]);

    const handleSave = (htmlContent) => {
        const updatedNation = { ...selectedNation, note: htmlContent };
        const newNations = nations.map(n => n.id === selectedNation.id ? updatedNation : n);
        setNations(newNations);
        setSelectedNation(updatedNation);
        alert('æ¦‚è¦ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    };

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">
            
            <SectionHeader icon={Icons.FileText} title="å›½å®¶æ¦‚è¦ç®¡ç†" desc="ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€å›½å®¶ã®è©³ç´°ãªè¨­å®šï¼ˆæ–‡åŒ–ã€åœ°ç†ã€æ­´å²è©³ç´°ãªã©ï¼‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚" />

            <div className="flex gap-6 items-start flex-grow">
                {/* å·¦å´ãƒªã‚¹ãƒˆ: Stickyé…ç½® + é«˜ã•æŒ‡å®š */}
                <div 
                    className="w-full md:w-80 flex-shrink-0 sticky top-4"
                    style={{ height: 'calc(100vh - 320px)', minHeight: '400px' }}
                >
                    <NationListPanel 
                        nations={nations} 
                        setNations={setNations} 
                        selectedNationId={selectedNation?.id} 
                        onSelect={setSelectedNation} 
                    />
                </div>

                {/* å³å´: ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ */}
                <div className="flex-grow w-full min-w-[300px]">
                    {selectedNation ? (
                        <QuillEditor 
                            key={selectedNation.id} 
                            initialContent={selectedNation.note} 
                            nationName={selectedNation.name}
                            nationFlag={selectedNation.flag}
                            onSave={handleSave} 
                        />
                    ) : (
                        <div className="w-full min-h-[600px] flex flex-col bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden justify-center items-center text-gray-400 bg-gray-50">
                            <Icons.FileText size={64} className="mb-4 opacity-20"/>
                            <p>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ç·¨é›†ã—ãŸã„å›½å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

// --- å›½å®¶èˆˆäº¡ç³»è­œå›³ãƒ“ãƒ¥ãƒ¼ (ã‚¹ãƒãƒ›å¯¾å¿œãƒ»ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ å®Ÿè£…ç‰ˆ) ---
const GenealogyView = ({ setView, nations, stats, entries, setSelectedEntry, uiScale, onOpenDetail}) => {
    // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆçŠ¶æ…‹
    const [zoom, setZoom] = useState(1.0);
    const [pan, setPan] = useState({ x: 0, y: 0 });
    const [isDragging, setIsDragging] = useState(false);
    const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
    
    // â˜…è¿½åŠ : ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ç”¨çŠ¶æ…‹
    const [isPinching, setIsPinching] = useState(false);
    const [pinchStartDist, setPinchStartDist] = useState(0);
    const [pinchStartZoom, setPinchStartZoom] = useState(1.0);

    // ã‚¹ãƒãƒ›ç”¨: è¨­å®šãƒ‘ãƒãƒ«ã®é–‹é–‰çŠ¶æ…‹
    const [isPanelOpen, setIsPanelOpen] = useState(true);

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
    const [yearHeight, setYearHeight] = useState(5);
    const [laneWidth, setLaneWidth] = useState(100);
    const [showMarkers, setShowMarkers] = useState(true);
    const [showConnections, setShowConnections] = useState(true);

// â˜…è¿½åŠ : ã‚³ãƒ³ãƒ†ãƒŠã®å‚ç…§ã‚’ä½œæˆ
    const containerRef = useRef(null);

    // --- ãƒ‡ãƒ¼ã‚¿è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
    const { nationBlocks, renderSegments, connections, minYear, maxYear, lanesCount, continentZones } = useMemo(() => {
        const blocks = []; 
        let gMin = 10000, gMax = -10000;
        nations.forEach(n => {
            const info = getNationInfo(n, 9999); 
            let start = info.nationStartYear || DEFAULT_YEAR;
            let end = info.nationEndYear || (new Date().getFullYear() + 50); 
            const nStats = stats.filter(s => s.nationId === n.id);
            if (nStats.length > 0) { const sMin = Math.min(...nStats.map(s => s.year)); if (sMin < start) start = sMin; }
            if (start < gMin) gMin = start; if (end > gMax) gMax = end;
            blocks.push({ ...n, start, end, lane: 0, location: n.location || 'unknown', rank: n.rank || 'minor_power' });
        });
        if (nations.length === 0) { gMin = DEFAULT_YEAR; gMax = DEFAULT_YEAR + 100; } else { gMin -= 10; gMax += 20; }

        const sortedLocKeys = Object.keys(LOCATIONS).sort((a, b) => LOCATIONS[a].order - LOCATIONS[b].order);
        let totalLanesOffset = 0;
        const continentZones = [];
        sortedLocKeys.forEach(locKey => {
            const locBlocks = blocks.filter(b => b.location === locKey);
            if (locBlocks.length === 0) return;
            locBlocks.sort((a, b) => {
                const rankA = NATION_RANKS[a.rank]?.order || 99;
                const rankB = NATION_RANKS[b.rank]?.order || 99;
                if (rankA !== rankB) return rankA - rankB;
                return a.start - b.start;
            });
            const lanes = [];
            locBlocks.forEach(block => {
                let assigned = false;
                for (let i = 0; i < lanes.length; i++) {
                    if (lanes[i] < block.start) { block.lane = totalLanesOffset + i; lanes[i] = block.end + 5; assigned = true; break; }
                }
                if (!assigned) { block.lane = totalLanesOffset + lanes.length; lanes.push(block.end + 5); }
            });
            continentZones.push({ key: locKey, label: LOCATIONS[locKey].label, color: LOCATIONS[locKey].color, startLane: totalLanesOffset, endLane: totalLanesOffset + lanes.length });
            totalLanesOffset += lanes.length + 1;
        });

        const segments = [];
        blocks.forEach(block => {
            const eras = (block.eras || []).sort((a, b) => a.startYear - b.startYear);
            const validEras = eras.filter(e => e.startYear >= block.start && e.startYear < block.end);
            let currentStart = block.start;
            let currentParams = block.params || {};
            let activeState = { name: block.name, flag: block.flag, color: block.color, params: currentParams };
            let activeType = 'foundation';

            validEras.forEach(era => {
                const nextParams = { ...currentParams, ...(era.params || {}) };
                const nextState = { name: era.name || block.name, flag: era.flag || block.flag, color: era.color || block.color, params: nextParams };
                if (era.startYear === currentStart) {
                    activeState = nextState; currentParams = nextParams; activeType = era.type;
                } else {
                    const prevGovColor = activeState.params?.ideology_gov?.color;
                    const nextGovColor = nextState.params?.ideology_gov?.color;
                    const isDifferent = nextState.name !== activeState.name || nextState.flag !== activeState.flag || nextState.color !== activeState.color || prevGovColor !== nextGovColor;
                    if (isDifferent) {
                        segments.push({ id: `${block.id}_${currentStart}`, nationId: block.id, lane: block.lane, start: currentStart, end: era.startYear, ...activeState, type: activeType, rank: block.rank });
                        currentStart = era.startYear; activeState = nextState; currentParams = nextParams; activeType = era.type;
                    } else {
                        activeType = era.type; currentParams = nextParams; activeState.params = nextParams;
                    }
                }
            });
            segments.push({ id: `${block.id}_last`, nationId: block.id, lane: block.lane, start: currentStart, end: block.end, ...activeState, type: activeType, rank: block.rank });
        });

        const conns = [];
        nations.forEach(n => {
            (n.eras || []).forEach(era => {
                if (!era.event) return;
                const targets = era.event.targetIds || (era.event.targetId ? [era.event.targetId] : []);
                targets.forEach(targetId => {
                    const targetBlock = blocks.find(b => b.id === targetId);
                    const selfBlock = blocks.find(b => b.id === n.id);
                    if (!targetBlock || !selfBlock) return;
                    const year = era.startYear; const type = era.event.type;
                    if (['independence', 'splinter'].includes(type)) conns.push({ from: targetBlock, to: selfBlock, year, type });
                    else if (['lose_independence', 'lose_splinter'].includes(type)) conns.push({ from: selfBlock, to: targetBlock, year, type: type.replace('lose_', '') });
                    else if (['annexed_by', 'merger', 'partitioned_by', 'dissolution'].includes(type)) conns.push({ from: selfBlock, to: targetBlock, year, type });
                    else if (['annexation', 'unification', 'partition'].includes(type)) { let mappedType = type; if (type === 'annexation') mappedType = 'annexed_by'; if (type === 'unification') mappedType = 'merger'; if (type === 'partition') mappedType = 'partitioned_by'; conns.push({ from: targetBlock, to: selfBlock, year, type: mappedType }); }
                    else if (['foundation_puppet', 'be_puppet', 'puppet'].includes(type)) conns.push({ from: targetBlock, to: selfBlock, year, type });
                });
            });
        });
        const uniqueConns = []; const connSet = new Set();
        conns.forEach(c => { const key = `${c.from.id}-${c.to.id}-${c.type}-${c.year}`; if (!connSet.has(key)) { connSet.add(key); uniqueConns.push(c); } });
        return { nationBlocks: blocks, renderSegments: segments, connections: uniqueConns, minYear: gMin, maxYear: gMax, lanesCount: totalLanesOffset, continentZones };
    }, [nations, stats]);

    const legendaryEvents = useMemo(() => {
        if (!entries) return [];
        return entries.filter(e => (e.importance || 2) >= 5).sort((a, b) => a.year - b.year);
    }, [entries]);

    // --- ãƒã‚¦ã‚¹æ“ä½œãƒãƒ³ãƒ‰ãƒ© ---
    const handleStartDrag = (clientX, clientY, target) => {
        if (target.closest('.control-panel') || target.tagName === 'BUTTON' || target.tagName === 'INPUT') return;
        setIsDragging(true);
        setDragStart({ x: clientX - pan.x, y: clientY - pan.y });
    };

    const handleDragMove = (clientX, clientY) => {
        if (!isDragging) return;
        setPan({ x: clientX - dragStart.x, y: clientY - dragStart.y });
    };

    // --- ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ (PC) ---
    const onMouseDown = (e) => {
        handleStartDrag(e.clientX, e.clientY, e.target);
        e.currentTarget.style.cursor = 'grabbing';
    };
    const onMouseMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        handleDragMove(e.clientX, e.clientY);
    };
    const onMouseUp = (e) => {
        setIsDragging(false);
        e.currentTarget.style.cursor = 'grab';
    };
// â˜…ä¿®æ­£: ãƒã‚¦ã‚¹ä½ç½®åŸºæº–ã®ã‚ºãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
    const handleWheel = (e) => {
        if (e.target.closest('.control-panel')) return;
        // ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ãï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        // e.preventDefault(); 

        const rect = containerRef.current.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // ã‚ºãƒ¼ãƒ å‰ã®ã€Œä¸–ç•Œåº§æ¨™ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸Šã®ä½ç½®ï¼‰ã€ã‚’è¨ˆç®—
        const worldX = (mouseX - pan.x) / zoom;
        const worldY = (mouseY - pan.y) / zoom;

        const scaleAmount = -e.deltaY * 0.001;
        const newZoom = Math.min(Math.max(0.1, zoom + scaleAmount), 3.0);

        // æ–°ã—ã„ã‚ºãƒ¼ãƒ å€ç‡ã§ã€åŒã˜ä¸–ç•Œåº§æ¨™ãŒãƒã‚¦ã‚¹ã®ä¸‹ã«æ¥ã‚‹ã‚ˆã†ã«Panï¼ˆä½ç½®ï¼‰ã‚’é€†ç®—
        const newPanX = mouseX - worldX * newZoom;
        const newPanY = mouseY - worldY * newZoom;

        setZoom(newZoom);
        setPan({ x: newPanX, y: newPanY });
    };

    // --- â˜…ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ (ã‚¹ãƒãƒ›: ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ å¯¾å¿œ) ---
    const getTouchDist = (touches) => {
        return Math.hypot(
            touches[0].clientX - touches[1].clientX,
            touches[0].clientY - touches[1].clientY
        );
    };

    const onTouchStart = (e) => {
        if (e.target.closest('.control-panel') || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;

        if (e.touches.length === 2) {
            // 2æœ¬æŒ‡: ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ é–‹å§‹
            e.preventDefault();
            setIsPinching(true);
            setIsDragging(false); // ãƒ‰ãƒ©ãƒƒã‚°ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            const dist = getTouchDist(e.touches);
            setPinchStartDist(dist);
            setPinchStartZoom(zoom);
        } else if (e.touches.length === 1) {
            // 1æœ¬æŒ‡: ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
            const touch = e.touches[0];
            handleStartDrag(touch.clientX, touch.clientY, e.target);
        }
    };

    const onTouchMove = (e) => {
        if (isPinching && e.touches.length === 2) {
            // 2æœ¬æŒ‡: ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ä¸­
            e.preventDefault();
            const dist = getTouchDist(e.touches);
            if (pinchStartDist > 0) {
                const scale = dist / pinchStartDist;
                // æ—¢å­˜ã®zoomå€¤ã«å¯¾ã—ã¦æ¯”ç‡ã‚’æ›ã‘ã‚‹
                const newZoom = Math.min(Math.max(0.1, pinchStartZoom * scale), 3.0);
                setZoom(newZoom);
            }
        } else if (isDragging && e.touches.length === 1) {
            // 1æœ¬æŒ‡: ãƒ‰ãƒ©ãƒƒã‚°ä¸­
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜»å®³ã—ãªã„ã‚ˆã† preventDefault ã¯æ¡ä»¶ä»˜ãã«ã™ã‚‹ã‹å¤–ã™
            // ã“ã“ã§ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ“ä½œæ„Ÿã‚’å„ªå…ˆã—ã€æ–œã‚ç§»å‹•ã‚‚è¨±å®¹ã™ã‚‹ãŸã‚preventDefaultã¯ã—ãªã„ï¼ˆã¾ãŸã¯CSSã§ touch-action: none ã‚’æŒ‡å®šï¼‰
            const touch = e.touches[0];
            handleDragMove(touch.clientX, touch.clientY);
        }
    };

    const onTouchEnd = () => {
        setIsDragging(false);
        setIsPinching(false);
    };

    // æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const getY = (year) => (year - minYear) * yearHeight;
    const getX = (lane) => lane * laneWidth + 100;
    const TOTAL_HEIGHT = (maxYear - minYear) * yearHeight + 100;
    const TOTAL_WIDTH = Math.max(1000, lanesCount * laneWidth + 200);

    return (
        <div 
            ref={containerRef} // â˜…è¿½åŠ : ã“ã“ã«refã‚’è¨­å®š
            className="h-full w-full bg-[#f0f2f5] overflow-hidden relative cursor-grab touch-none" // touch-noneå¿…é ˆ
            onMouseDown={onMouseDown}
            onMouseMove={onMouseMove}
            onMouseUp={onMouseUp}
            onMouseLeave={onMouseUp}
            onTouchStart={onTouchStart}
            onTouchMove={onTouchMove}
            onTouchEnd={onTouchEnd}
            onWheel={handleWheel}
        >
            {/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«é–‹é–‰ãƒœã‚¿ãƒ³ (ã‚¹ãƒãƒ›ã§ä¾¿åˆ©) */}
            <button 
                onClick={() => setIsPanelOpen(!isPanelOpen)} 
                className="absolute top-4 left-4 z-[60] bg-white p-2 rounded-lg shadow-md border border-gray-200 text-gray-600 md:hidden"
            >
                {isPanelOpen ? <Icons.X size={20}/> : <Icons.Settings size={20}/>}
            </button>

            {/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */}
            <div className={`control-panel absolute top-16 left-4 md:top-4 md:left-4 z-50 bg-white/95 backdrop-blur p-4 rounded-lg shadow-xl border border-gray-200 w-72 space-y-4 transition-all duration-300 origin-top-left ${isPanelOpen ? 'scale-100 opacity-100' : 'scale-0 opacity-0 md:scale-100 md:opacity-100 pointer-events-none md:pointer-events-auto'}`}>
                <div className="flex justify-between items-center border-b pb-2">
                    <h2 className="font-bold text-gray-800 flex items-center gap-2"><Icons.GitMerge size={18}/> èˆˆäº¡ç³»è­œå›³</h2>
                </div>
                <div className="flex items-center justify-between bg-blue-50 p-2 rounded border border-blue-100">
                    <span className="text-xs font-bold text-blue-800">VIEW ZOOM</span>
                    <div className="flex items-center gap-2">
                        <button onClick={() => setZoom(z => Math.max(0.1, z - 0.1))} className="w-6 h-6 bg-white rounded shadow text-blue-600 font-bold hover:bg-blue-100">-</button>
                        <span className="text-xs font-mono w-10 text-center">{Math.round(zoom * 100)}%</span>
                        <button onClick={() => setZoom(z => Math.min(3.0, z + 0.1))} className="w-6 h-6 bg-white rounded shadow text-blue-600 font-bold hover:bg-blue-100">+</button>
                    </div>
                </div>

                <div className="space-y-3">
                    <div>
                        <div className="flex justify-between text-xs text-gray-600 mb-1"><span>ç¸¦é–“éš” (å¹´)</span><span className="font-mono">{yearHeight}px</span></div>
                        <input type="range" min="1" max="20" step="0.5" value={yearHeight} onChange={e=>setYearHeight(parseFloat(e.target.value))} className="w-full h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                    </div>
                    <div>
                        <div className="flex justify-between text-xs text-gray-600 mb-1"><span>æ¨ªå¹… (å›½)</span><span className="font-mono">{laneWidth}px</span></div>
                        <input type="range" min="50" max="300" step="10" value={laneWidth} onChange={e=>setLaneWidth(parseInt(e.target.value))} className="w-full h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                    </div>
                </div>

                <div className="flex gap-2">
                    <button onClick={() => setShowMarkers(!showMarkers)} className={`flex-1 py-1 text-xs rounded border transition-colors ${showMarkers ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>ã‚¤ãƒ™ãƒ³ãƒˆ</button>
                    <button onClick={() => setShowConnections(!showConnections)} className={`flex-1 py-1 text-xs rounded border transition-colors ${showConnections ? 'bg-green-100 border-green-300 text-green-800' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>é–¢ä¿‚ç·š</button>
                </div>
                
                <div className="text-[10px] text-gray-400 pt-2 border-t">
                    ã‚¹ãƒ¯ã‚¤ãƒ—ã§ç§»å‹•ã€ãƒ”ãƒ³ãƒã§æ‹¡å¤§ç¸®å°ã€‚<br/>
                    ä¸Šã‹ã‚‰ä¸‹ã¸æ™‚é–“ãŒæµã‚Œã¾ã™ã€‚
                </div>
            </div>

            {/* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ */}
            <div 
                className="origin-top-left transition-transform duration-75 ease-out relative bg-white"
                style={{ 
                    transform: `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`, 
                    width: `${TOTAL_WIDTH}px`, 
                    height: `${TOTAL_HEIGHT}px`,
                    minWidth: '100%', minHeight: '100%'
                }}
            >
                {/* èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ */}
                {Array.from({ length: Math.max(0, Math.ceil((maxYear - minYear) / 10) + 1) }).map((_, i) => {
                    const year = minYear + (i * 10); const y = getY(year);
                    if (yearHeight < 2 && i % 5 !== 0) return null; if (yearHeight < 4 && i % 2 !== 0) return null;
                    return ( <div key={year} className="absolute w-full border-t border-gray-100 text-[10px] text-gray-300 pl-2 pointer-events-none flex items-center" style={{ top: y }}><span className="bg-white/80 pr-1">{year}</span></div> );
                })}

                {/* å¤§é™¸ã‚¾ãƒ¼ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                {continentZones.map((zone, i) => {
                    const startX = getX(zone.startLane) - (laneWidth / 2) + 5;
                    const endX = getX(zone.endLane) + (laneWidth / 2) - 5; 
                    const width = endX - startX;
                    return (
                        <React.Fragment key={zone.key}>
                            <div className="absolute top-0 text-center text-xs font-bold text-white py-1 shadow-sm opacity-90" style={{ left: startX, width: width, backgroundColor: zone.color, borderRadius: '0 0 4px 4px' }}>{zone.label}</div>
                            <div className="absolute top-0 bottom-0 pointer-events-none bg-gray-50/30" style={{ left: startX, width: width, borderLeft: '1px dashed #e5e7eb', borderRight: '1px dashed #e5e7eb' }} />
                        </React.Fragment>
                    );
                })}
                
                {/* ä¼èª¬ç´šã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ */}
                {showMarkers && legendaryEvents.map(e => {
                    const top = getY(e.year);
                    if (top < 0 || top > TOTAL_HEIGHT) return null;
                    const isMyth = (e.importance || 2) === 6;
                    return (
                        <div key={e.id} className="absolute left-4 z-30 group" style={{ top: top - 12 }}>
                            <div className={`w-6 h-6 ${isMyth ? 'bg-rose-600' : 'bg-yellow-500'} rounded-full border-2 border-white shadow-md flex items-center justify-center text-white text-xs font-bold ring-2 ${isMyth ? 'ring-rose-300' : 'ring-yellow-200'} group-hover:scale-110 transition-transform cursor-pointer relative z-40`} // â˜…ä¿®æ­£: handleOpenDetailã‚’çµŒç”±ã•ã›ã‚‹ã“ã¨ã§ã€Œç³»è­œå›³ã«æˆ»ã‚‹ã€ãŒå¯èƒ½ã«ãªã‚‹
onClick={(ev) => { 
    ev.stopPropagation(); 
    if(onOpenDetail) {
        onOpenDetail(e); 
    } else {
        setSelectedEntry(e); 
        setView('detail'); 
    }
}} title="è©³ç´°ã‚’è¡¨ç¤º">{isMyth ? 'âœ¦' : 'â˜…'}</div>
                            <div className="absolute left-8 top-0 bg-white/90 backdrop-blur border border-yellow-400 px-2 py-1 rounded shadow-sm text-xs font-bold text-gray-800 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none max-w-[200px] truncate z-50">{e.year}å¹´: {e.title}</div>
                            <div className="absolute left-3 top-3 border-t border-yellow-300 border-dashed opacity-0 group-hover:opacity-50 pointer-events-none z-30" style={{ width: `${TOTAL_WIDTH}px` }}></div>
                        </div>
                    );
                })}

                {/* å›½å®¶ãƒ–ãƒ­ãƒƒã‚¯ */}
                {renderSegments.map(seg => {
                    const top = getY(seg.start);
                    const height = Math.max(yearHeight * 2, getY(seg.end) - top);
                    const left = getX(seg.lane);
                    const isCollapsed = seg.end < 3000 && (seg.type === 'collapse' || seg.type === 'annexed_by' || seg.type === 'merger'); 
                    const isTiny = height < 30 || laneWidth < 60;
                    const govColor = seg.params?.ideology_gov?.color;
                    const bgColor = isCollapsed ? '#e5e7eb' : (govColor || '#ffffff'); 
                    
                    return (
                        <div key={seg.id} 
                            className="absolute rounded shadow-sm hover:z-20 hover:shadow-lg transition-all flex flex-col items-center justify-start overflow-hidden"
                            style={{
                                top: `${top}px`, left: `${left}px`, width: `${laneWidth - 10}px`, height: `${height}px`, 
                                backgroundColor: bgColor, borderColor: '#000000', borderWidth: isTiny ? '1px' : '2px', borderStyle: 'solid', 
                                color: isCollapsed ? '#6b7280' : '#000000', opacity: isCollapsed ? 0.7 : 1
                            }}
                            title={`${seg.name} (${seg.start} - ${seg.end < 3000 ? seg.end : '...'})`}
                        >
                            <div className="w-full flex flex-col items-center justify-start pt-1 pb-1 bg-inherit">
                                {!isTiny && seg.flag && <img src={seg.flag} className="w-6 h-4 object-cover mb-0.5 shadow-sm border border-black/20" />}
                                <span className="text-center leading-tight px-1 truncate w-full" style={{fontSize: isTiny ? '8px' : '10px', fontWeight: 'bold'}}>{seg.name}</span>
                                {!isTiny && <span className="text-[9px] font-mono mt-0.5 opacity-80">{seg.start}</span>}
                            </div>
                        </div>
                    );
                })}

                {/* æ¥ç¶šç·š */}
                {showConnections && (
                    <svg className="absolute inset-0 pointer-events-none z-10" width="100%" height="100%">
                        <defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af" /></marker></defs>
                        {connections.map((conn, i) => {
                            const x1 = getX(conn.from.lane) + (laneWidth / 2) - 5; const y1 = getY(conn.year);
                            const x2 = getX(conn.to.lane) + (laneWidth / 2) - 5; const y2 = getY(conn.year);
                            const curveY = Math.min(30, yearHeight * 10);
                            const path = `M ${x1} ${y1} C ${x1} ${y1 + curveY}, ${x2} ${y2 - curveY}, ${x2} ${y2}`;
                            let strokeColor = "#9ca3af"; let lineText = ""; let isIndependence = false;

                            if (['independence', 'splinter'].includes(conn.type)) { strokeColor = "#4ade80"; lineText = conn.type === 'splinter' ? "åˆ†è£‚" : "ç‹¬ç«‹"; isIndependence = true; }
                            else if (['annexation', 'merger', 'partitioned_by', 'dissolution', 'annexed_by'].includes(conn.type)) { 
                                strokeColor = "#f87171"; 
                                if (['annexation', 'annexed_by'].includes(conn.type)) lineText = "ä½µåˆ";
                                else if (['merger', 'unification'].includes(conn.type)) lineText = "çµ±åˆ";
                                else if (['partition', 'partitioned_by'].includes(conn.type)) lineText = "åˆ†å‰²";
                                else if (conn.type === 'dissolution') lineText = "è§£ä½“";
                                else lineText = "ä½µåˆ";
                                isIndependence = false;
                            }
                            else if (['foundation_puppet', 'be_puppet', 'puppet'].includes(conn.type)) {
                                strokeColor = "#a855f7"; lineText = "å‚€å„¡"; isIndependence = true;
                            }

                            const midX = (x1 + x2) / 2; const midY = (y1 + y2) / 2 + (isIndependence ? 10 : -10);
                            return (
                                <g key={i}>
                                    <path d={path} fill="none" stroke={strokeColor} strokeWidth={Math.max(1, yearHeight / 2)} markerEnd="url(#arrowhead)" opacity="0.8" />
                                    {yearHeight > 2 && (
                                        <g transform={`translate(${midX}, ${midY})`}>
                                            <rect x="-14" y="-7" width="28" height="14" rx="2" fill="white" stroke={strokeColor} strokeWidth="1" opacity="0.9" />
                                            <text x="0" y="4" textAnchor="middle" fontSize="10" fill={strokeColor} fontWeight="bold">{lineText}</text>
                                        </g>
                                    )}
                                </g> 
                            );
                        })}
                    </svg>
                )}
            </div>
        </div>
    );
};

const StatsDisplay = ({ year, stats, expandedStatsYears, setExpandedStatsYears, nations }) => {
    const yearStats = stats.filter(s => s.year === year); if (yearStats.length === 0) return null; const isExpanded = expandedStatsYears.includes(year);
    return ( <div className="relative my-4 z-10 w-full max-w-3xl mx-auto md:pl-16"> <div className="flex justify-start"> <button onClick={() => setExpandedStatsYears(prev => prev.includes(year) ? prev.filter(y => y !== year) : [...prev, year])} className={`flex items-center gap-2 px-3 py-2 rounded-full text-sm font-bold shadow-sm border transition-all ${isExpanded ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'}`}> <Icons.BarChart2 size={16} /> {year}å¹´ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ <span className="text-xs font-normal ml-1">({yearStats.length}ã‚«å›½)</span> <Icons.ChevronRight size={16} className={isExpanded ? 'rotate-90' : ''} /> </button> </div> {isExpanded && ( <div className="mt-2 bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden animate-fade-in"> <div className="overflow-x-auto"> <table className="w-full text-sm text-left whitespace-nowrap"> <thead className="bg-gray-50 text-xs uppercase text-gray-500"><tr><th className="px-4 py-2">å›½å®¶</th><th className="px-4 py-2 text-right">äººå£</th><th className="px-4 py-2 text-right">GDP (å††)</th><th className="px-4 py-2 text-right">ä¸€äººã‚ãŸã‚ŠGDP (å††)</th></tr></thead> <tbody> {yearStats.map(stat => { const n = nations.find(n => n.id === stat.nationId) || {name:'?',color:'#ccc'}; const info = getNationInfo(n, year); if (info.isCollapsed) return null; return ( <tr key={stat.id} className="border-b last:border-0 hover:bg-gray-50"> <td className="px-4 py-2 font-bold flex gap-2 items-center">{info.flag && <img src={info.flag} className="w-6 h-4 object-cover border border-gray-200" />}<div className="w-2.5 h-2.5 rounded-full" style={{backgroundColor: info.color}}></div>{info.name}</td> <td className="px-4 py-2 text-right font-mono text-gray-600">{formatJapaneseNumber(stat.population, 'äºº')}</td> <td className="px-4 py-2 text-right font-mono text-gray-600">{formatJapaneseNumber(stat.gdp, 'å††')}</td> <td className="px-4 py-2 text-right font-mono font-bold text-gray-800">{formatJapaneseNumber(calculatePerCapita(stat.gdp, stat.population), 'å††')}</td> </tr> ) })} </tbody> </table> </div> </div> )} </div> );
};

const EditForm = ({ entry, onSave, onCancel, nations }) => {
    const [formData, setFormData] = useState(entry); 
    const [tagInput, setTagInput] = useState(entry.tags ? entry.tags.join(', ') : ''); 
    const currentYear = parseInt(formData.year) || DEFAULT_YEAR;
    
    // å›½å®¶ãƒªã‚¹ãƒˆã®ã‚½ãƒ¼ãƒˆï¼ˆåœ°åŸŸé † > ãƒ©ãƒ³ã‚¯é †ï¼‰
    const sortedNations = useMemo(() => { 
        return [...nations].sort((a, b) => { 
            const locA = LOCATIONS[a.location || 'unknown']?.order || 99; 
            const locB = LOCATIONS[b.location || 'unknown']?.order || 99; 
            if (locA !== locB) return locA - locB; 
            const rankA = NATION_RANKS[a.rank || 'minor_power']?.order || 99; 
            const rankB = NATION_RANKS[b.rank || 'minor_power']?.order || 99; 
            return rankA - rankB; 
        }); 
    }, [nations]);

    // ã‚¿ã‚°è¿½åŠ ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const addNationTag = (nationName) => { 
        const currentTags = tagInput.split(',').map(t => t.trim()).filter(t => t !== ''); 
        if (!currentTags.includes(nationName)) { 
            const newTags = [...currentTags, nationName].join(', '); 
            setTagInput(newTags); 
        } 
    };

    return ( 
        <div className="bg-[#f0f2f5] min-h-screen pb-20">
            {/* â˜…ã“ã“ã«è¿½åŠ : ãƒ˜ãƒƒãƒ€ãƒ¼ã¨æˆ»ã‚‹ãƒœã‚¿ãƒ³ */}
            <div className="sticky top-0 bg-white/90 backdrop-blur-sm border-b border-gray-200 p-4 flex justify-between items-center z-50 shadow-sm">
                <div>
                    <button onClick={onCancel} className="flex flex-col items-center justify-center text-gray-500 hover:text-blue-600 hover:bg-blue-50 px-3 py-1 rounded-lg transition-all group">
                        <Icons.ArrowLeft size={20} className="mb-0.5 group-hover:-translate-x-1 transition-transform"/>
                        <span className="text-[9px] font-bold leading-none">æˆ»ã‚‹</span>
                    </button>
                </div>
                <h2 className="font-bold text-gray-700 flex items-center gap-2"><Icons.Edit2 size={18}/> è¨˜éŒ²ã®ç·¨é›†</h2>
                <div className="w-10"></div>{/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ç”¨ã®ãƒ€ãƒŸãƒ¼ç©ºç™½ */}
            </div>

            <div className="bg-white p-6 rounded-lg shadow-lg max-w-2xl mx-auto border-2 border-gray-800 mt-6"> 
                <div className="space-y-6"> 
                    
                    {/* æ™‚æœŸè¨­å®šã‚¨ãƒªã‚¢ */}
                    <div className="bg-gray-50 p-4 rounded border border-gray-200"> 
                        <div className="flex items-center gap-2 mb-2 text-sm font-bold text-gray-700">
                            <Icons.Calendar size={16} /><span>æ™‚æœŸè¨­å®š</span>
                        </div> 
                        <div className="grid grid-cols-3 gap-4"> 
                            <div>
                                <label className="block text-xs text-gray-500 mb-1">è‹±è¦‡æš¦ (å¹´)</label>
                                <input type="number" value={formData.year} onChange={e => setFormData({...formData, year: e.target.value})} className="w-full p-2 border rounded" placeholder="å¿…é ˆ" />
                            </div> 
                            <div>
                                <label className="block text-xs text-gray-500 mb-1">æœˆ (ä»»æ„)</label>
                                <select value={formData.month || ''} onChange={e => setFormData({...formData, month: e.target.value})} className="w-full p-2 border rounded">
                                    <option value="">-- ä¸æ˜ --</option>
                                    {Object.entries(CUSTOM_MONTHS).map(([num, name]) => <option key={num} value={num}>{name} ({num}æœˆ)</option>)}
                                </select>
                            </div> 
                            <div>
                                <label className="block text-xs text-gray-500 mb-1">æ—¥ (ä»»æ„)</label>
                                <input type="number" min="1" max="31" value={formData.day || ''} onChange={e => setFormData({...formData, day: e.target.value})} className="w-full p-2 border rounded" placeholder="--" />
                            </div> 
                        </div> 
                    </div> 
                    
                    {/* é‡è¦åº¦è¨­å®š */}
                    <div> 
                        <label className="block text-sm font-bold text-gray-700 mb-1">é‡è¦åº¦</label> 
                        <select value={formData.importance || 2} onChange={e => setFormData({...formData, importance: parseInt(e.target.value)})} className="w-full p-2 border-2 border-gray-300 rounded font-bold"> 
                            {Object.entries(importanceLevels).map(([level, info]) => <option key={level} value={level}>Lv.{level} {info.label}</option>)} 
                        </select> 
                    </div> 
                    
                    {/* ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãµã‚ŠãŒãª */}
                    <div className="space-y-2"> 
                        <div>
                            <label className="block text-xs text-gray-500">ãµã‚ŠãŒãª</label>
                            <input type="text" value={formData.reading || ''} onChange={e => setFormData({...formData, reading: e.target.value})} className="w-full p-1 border-b border-gray-300 outline-none text-sm" />
                        </div> 
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-2 border-2 border-gray-300 rounded text-lg font-bold" />
                        </div> 
                    </div> 
                    
                    {/* ã‚¿ã‚°è¨­å®š */}
                    <div> 
                        <label className="block text-sm font-bold text-gray-700 mb-1">ã‚¿ã‚°</label> 
                        <input type="text" value={tagInput} onChange={e => setTagInput(e.target.value)} className="w-full p-2 border border-gray-300 rounded" placeholder="æ”¿æ²», æˆ¦äº‰" /> 
                        <div className="mt-2"> 
                            <span className="text-xs text-gray-500 mr-2">å›½å®¶ã‚¿ã‚°ã‚’è¿½åŠ :</span> 
                            <div className="flex flex-wrap gap-1 mt-1 max-h-32 overflow-y-auto p-1 border rounded bg-gray-50"> 
                                <button onClick={() => addNationTag('ä¸–ç•Œ')} className="text-xs bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 text-indigo-700 px-2 py-1 rounded flex items-center gap-1">
                                    <Icons.Globe size={12} /> ä¸–ç•Œ
                                </button> 
                                {sortedNations.map(n => { 
                                    const info = getNationInfo(n, currentYear); 
                                    if (info.isCollapsed) return null; 
                                    const rankColor = NATION_RANKS[n.rank || 'minor_power']?.color || '#ccc'; 
                                    return ( 
                                        <button key={n.id} onClick={() => addNationTag(info.name)} className="text-xs bg-white hover:bg-gray-100 border px-2 py-1 rounded flex items-center gap-1" style={{borderColor: rankColor}}> 
                                            {info.flag && <img src={info.flag} className="w-4 h-3 object-cover border border-gray-200" />} 
                                            <span style={{color: rankColor, fontWeight: 'bold'}}>{info.name}</span> 
                                        </button> 
                                    ); 
                                })} 
                            </div> 
                        </div> 
                    </div> 
                    
                    {/* è©³ç´°è¨˜è¿° */}
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1">è©³ç´°è¨˜è¿°</label>
                        <textarea value={formData.content} onChange={e => setFormData({...formData, content: e.target.value})} className="w-full p-2 border-2 border-gray-300 rounded min-h-[200px]" />
                    </div> 
                    
                    {/* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
                    <div className="flex justify-end gap-4 pt-4 border-t"> 
                        <button onClick={onCancel} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button> 
                        <button onClick={() => {
                            const tagsArray = tagInput.split(',').map(t => t.trim()).filter(t => t !== ''); 
                            onSave({ ...formData, tags: tagsArray });
                        }} disabled={!formData.title} className="px-6 py-2 bg-gray-900 text-white rounded hover:bg-gray-800 flex items-center gap-2 font-bold shadow-lg">
                            <Icons.Save size={18} /> è¨˜éŒ²ã™ã‚‹
                        </button> 
                    </div> 
                </div> 
            </div> 
        </div>
    );
};

// --- DetailView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: Sans-serifå¯¾å¿œ) ---
const DetailView = ({ isAuthorized, entry, onEdit, onClose, onDelete, nations, backLabel }) => {
    // ãƒªãƒ³ã‚¯å‡¦ç†
    const handleLinkClick = (id) => {
        // åŒã˜ãƒšãƒ¼ã‚¸å†…ã§ã®é·ç§»ç­‰ã®å‡¦ç†ãŒã‚ã‚Œã°ã“ã“ã«
        console.log("Link to:", id);
    };

    const renderContent = () => {
        if (!entry.content) return <p className="text-gray-400 italic">è©³ç´°ãªè¨˜è¿°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>;
        
        // è‡ªå‹•ãƒªãƒ³ã‚¯ãªã©ã®å‡¦ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        let contentHtml = entry.content.replace(/\n/g, '<br/>');
        
        // â˜…ä¿®æ­£ç®‡æ‰€: font-serif ã‚’å‰Šé™¤ã—ã€font-sans ã‚’æ˜ç¤ºï¼ˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»»ã›ã‚‹ï¼‰
        return (
            <div 
                className="prose prose-lg max-w-none text-gray-800 leading-loose font-sans" // â† ã“ã“ã‚’å¤‰æ›´
                dangerouslySetInnerHTML={{ __html: contentHtml }} 
            />
        );
    };

    return (
        <div className="animate-fade-in pb-20">
            <div className="sticky top-0 bg-[#f0f2f5]/90 backdrop-blur z-10 py-4 mb-4 border-b border-gray-200 flex justify-between items-center">
                <button onClick={onClose} className="flex items-center gap-2 text-gray-600 hover:text-gray-900 font-bold transition-colors">
                    <div className="bg-white p-2 rounded-full shadow-sm"><Icons.ArrowLeft size={20}/></div>
                    <span>{backLabel || 'æˆ»ã‚‹'}</span>
                </button>
                {isAuthorized && (
                    <div className="flex gap-2">
                        <button onClick={() => onDelete(entry.id)} className="bg-white text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg font-bold shadow-sm border border-gray-200 flex items-center gap-2 transition-colors"><Icons.Trash2 size={18}/> å‰Šé™¤</button>
                        <button onClick={onEdit} className="bg-yellow-500 text-white hover:bg-yellow-600 px-4 py-2 rounded-lg font-bold shadow-md flex items-center gap-2 transition-colors"><Icons.Edit2 size={18}/> ç·¨é›†</button>
                    </div>
                )}
            </div>

            <div className="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200 min-h-[500px]">
                <div className="h-4 bg-yellow-500 w-full"></div>
                <div className="p-8 md:p-12">
                    <div className="flex flex-col md:flex-row justify-between items-start gap-4 mb-8 pb-6 border-b border-gray-100">
                        <div>
                            <div className="flex items-center gap-3 mb-2">
                                <span className="bg-gray-900 text-yellow-500 font-mono font-bold px-3 py-1 rounded text-lg shadow-sm">{entry.year}å¹´</span>
                                {entry.month && <span className="text-gray-500 font-bold">{entry.month}æœˆ{entry.day ? `${entry.day}æ—¥` : ''}</span>}
                            </div>
                            <h1 className="text-3xl md:text-4xl font-black text-gray-900 mb-2 leading-tight">{entry.title}</h1>
                            {entry.reading && <p className="text-gray-500 text-sm font-bold">{entry.reading}</p>}
                        </div>
                        <div className="flex flex-wrap gap-2 justify-end max-w-xs">
                            {entry.tags && entry.tags.map(tag => <NationTag key={tag} text={tag} nations={nations} year={entry.year} />)}
                        </div>
                    </div>

                    <div className="bg-white rounded-lg">
                        {renderContent()}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- StatsInputModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: é«˜ã•åˆ¶é™ãƒ»å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ) ---
const StatsInputModal = ({ showStatsInput, setShowStatsInput, nations, stats, setStats }) => {
    const [year, setYear] = useState(DEFAULT_YEAR);
    const [inputData, setInputData] = useState({});

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰
    useEffect(() => {
        const existingStats = stats.filter(s => s.year === parseInt(year));
        const map = {};
        existingStats.forEach(s => {
            map[s.nationId] = { population: s.population, gdp: s.gdp };
        });
        setInputData(map);
    }, [year, stats]);

    if (!showStatsInput) return null;

    const handleInputChange = (nationId, field, value) => {
        setInputData(prev => ({
            ...prev,
            [nationId]: { ...prev[nationId], [field]: value }
        }));
    };

    const saveStats = () => {
        // æ—¢å­˜ã®åŒå¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ä¸Šæ›¸ãä¿å­˜ã™ã‚‹ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const newStats = [...stats.filter(s => s.year !== parseInt(year))];
        Object.entries(inputData).forEach(([nationId, data]) => {
            if (data && (data.population || data.gdp)) {
                newStats.push({
                    id: `stats_${year}_${nationId}`,
                    year: parseInt(year),
                    nationId,
                    population: parseFloat(data.population) || 0,
                    gdp: parseFloat(data.gdp) || 0
                });
            }
        });
        setStats(newStats);
        setShowStatsInput(false);
    };

    return (
        // z-indexã‚’å¤§ããã—ã¦ã€ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ãƒ˜ãƒƒãƒ€ãƒ¼(z-50)ã‚ˆã‚Šä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 sm:p-6">
            {/* max-h-[90vh] ã§ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«åˆ¶é™ã—ã€flex-colã§ç¸¦ä¸¦ã³ã«ã™ã‚‹ */}
            <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl flex flex-col max-h-[90vh] animate-fade-in overflow-hidden">
                
                {/* --- ãƒ˜ãƒƒãƒ€ãƒ¼ (å›ºå®š) --- */}
                <div className="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0 bg-white">
                    <h2 className="text-xl font-bold flex items-center gap-2 text-gray-800">
                        <Icons.BarChart2 size={24} className="text-blue-600"/> çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¨˜éŒ²
                    </h2>
                    <button onClick={() => setShowStatsInput(false)} className="text-gray-400 hover:text-gray-600 p-1 rounded transition-colors">
                        <Icons.X size={24} />
                    </button>
                </div>

                {/* --- å¹´è¨­å®šã‚¨ãƒªã‚¢ (å›ºå®š) --- */}
                <div className="p-4 bg-gray-50 border-b border-gray-200 flex-shrink-0">
                    <div className="flex items-center gap-4">
                        <label className="font-bold text-gray-700">å¯¾è±¡å¹´:</label>
                        <div className="relative">
                            <input 
                                type="number" 
                                value={year} 
                                onChange={e => setYear(e.target.value)} 
                                className="pl-3 pr-10 py-2 border border-gray-300 rounded-lg w-32 font-bold text-lg shadow-sm focus:ring-2 focus:ring-blue-500 outline-none" 
                            />
                            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">å¹´</span>
                        </div>
                    </div>
                </div>

                {/* --- ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ (ã“ã“ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹) --- */}
                <div className="overflow-y-auto flex-grow custom-scrollbar bg-white">
                    <table className="w-full text-sm text-left whitespace-nowrap">
                        {/* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’stickyã«ã—ã¦è¿½å¾“ã•ã›ã‚‹ */}
                        <thead className="text-xs uppercase bg-gray-100 text-gray-600 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th className="px-4 py-3 font-bold border-b border-gray-200">å›½å®¶ (ç¾åœ¨ã®åç§°)</th>
                                <th className="px-4 py-3 font-bold border-b border-gray-200 w-40">äººå£ (äºº)</th>
                                <th className="px-4 py-3 font-bold border-b border-gray-200 w-48">GDP (å††)</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {nations.map(n => {
                                const info = getNationInfo(n, year);
                                // æ»…äº¡ã—ãŸå›½ã‚‚ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã§ãã‚‹ã‚ˆã†è¡¨ç¤ºã¯æ®‹ã™ãŒã€è–„ãã™ã‚‹ãªã©ã®å‡¦ç†ã¯ãŠå¥½ã¿ã§
                                const isDimmed = info.isCollapsed || info.isFuture;
                                
                                return (
                                    <tr key={n.id} className={`hover:bg-blue-50/50 transition-colors ${isDimmed ? 'opacity-60 bg-gray-50' : ''}`}>
                                        <td className="px-4 py-3 font-bold flex gap-3 items-center">
                                            {info.flag ? (
                                                <img src={info.flag} className="w-8 h-5 object-cover border border-gray-200 shadow-sm" />
                                            ) : (
                                                <div className="w-8 h-5 bg-gray-200 border border-gray-300"></div>
                                            )}
                                            <div className="flex flex-col">
                                                <span className="text-gray-800">{info.name}</span>
                                                {isDimmed && <span className="text-[10px] text-gray-400 font-normal">{info.isFuture ? '(æœªæˆç«‹)' : '(æ»…äº¡ãƒ»å¤‰é·æ¸ˆ)'}</span>}
                                            </div>
                                        </td>
                                        <td className="px-4 py-3">
                                            <input 
                                                type="number" 
                                                placeholder="0"
                                                value={inputData[n.id]?.population || ''} 
                                                onChange={e => handleInputChange(n.id, 'population', e.target.value)} 
                                                className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-right font-mono" 
                                            />
                                        </td>
                                        <td className="px-4 py-3">
                                            <input 
                                                type="number" 
                                                placeholder="0"
                                                value={inputData[n.id]?.gdp || ''} 
                                                onChange={e => handleInputChange(n.id, 'gdp', e.target.value)} 
                                                className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-right font-mono" 
                                            />
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>

                {/* --- ãƒ•ãƒƒã‚¿ãƒ¼ (å›ºå®š) --- */}
                <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-end flex-shrink-0">
                    <button onClick={saveStats} className="bg-blue-900 text-white px-8 py-2.5 rounded-lg font-bold shadow-md hover:bg-blue-800 transition-transform active:scale-95 flex items-center gap-2">
                        <Icons.Save size={18} /> ä¿å­˜ã—ã¦é–‰ã˜ã‚‹
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- LevelInfoModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ) ---
const LevelInfoModal = ({ isOpen, onClose }) => {
    if (!isOpen) return null;
    
    // ãƒ©ãƒ³ã‚¯å®šç¾© (ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒãƒƒãƒ”ãƒ³ã‚°)
    const ranks = [
        { range: '~7', label: 'ä¸€èˆ¬å¸‚æ°‘', ruby: '', color: 'text-gray-500', bg: 'bg-gray-100', icon: Icons.User, desc: 'éæˆ¦é—˜å“¡ã€‚æ­¦å™¨ã‚’æŒã£ãŸã“ã¨ãŒãªã„äººã€…ã€‚' },
        { range: '8~14', label: 'é§†ã‘å‡ºã—', ruby: '', color: 'text-stone-600', bg: 'bg-stone-100', icon: Icons.Dagger, desc: 'åŸºç¤çš„ãªæ­¦è£…ã‚’æ•´ãˆã€å®Ÿæˆ¦ã®ç©ºæ°—ã«è§¦ã‚Œå§‹ã‚ãŸæ®µéšã€‚è¨“ç·´ä¸­ã®å¾“å’ã€ã‚ã‚‹ã„ã¯è¡—ã®ã‚´ãƒ­ãƒ„ã‚­ãªã©ã€‚ä¸€èˆ¬äººç›¸æ‰‹ãªã‚‰åœ§å€’ã§ãã‚‹ãŒã€æ­£è¦å…µã®æ”¾ã¤æ®ºæ°—ã«ã¯ã¾ã è¶³ãŒã™ãã‚€ãƒ¬ãƒ™ãƒ«ã€‚ã“ã®ä¸–ç•Œã®äººé–“ã®å¹³å‡ã€‚' },
        { range: '15~24', label: 'æ­£è¦å…µ', ruby: '', color: 'text-blue-700', bg: 'bg-blue-100', icon: Icons.Shield, desc: 'ä¸€äººå‰ã®æˆ¦åŠ›ã€‚åŸºç¤è¨“ç·´ã‚’çµ‚ãˆã€çµ„ç¹”çš„ãªæˆ¦é—˜ãŒã§ãã‚‹çŠ¶æ…‹ã€‚' },
        { range: '25~39', label: 'ç²¾é‹­', ruby: 'ã‚¨ãƒªãƒ¼ãƒˆ', color: 'text-cyan-700', bg: 'bg-cyan-100', icon: Icons.Crosshair, desc: 'æ­£è¦å…µã®ä¸­ã‹ã‚‰é¸æŠœã•ã‚ŒãŸã€ç‰¹æ®Šå·¥ä½œã‚„è¦äººè­¦è­·ã‚’æ‹…ã†å®ŸåŠ›è€…ã€‚æ­£ç¢ºç„¡æ¯”ãªé€£æºæ”»æ’ƒã§å¯¾è±¡ã‚’ç¢ºå®Ÿã«æ’é™¤ã™ã‚‹ã€‚ä¸€èˆ¬å…µã«ã¨ã£ã¦ã¯é›²ã®ä¸Šã®å­˜åœ¨ã§ã‚ã‚Šã€ç¾å ´ã®å°éšŠé•·ã‚¯ãƒ©ã‚¹ã€‚' },
        { range: '40~49', label: 'æ­´æˆ¦ã®å¤å¼·è€…', ruby: 'ãƒ™ãƒ†ãƒ©ãƒ³', color: 'text-teal-700', bg: 'bg-teal-100', icon: Icons.Award, desc: 'æ•°ã€…ã®ä¿®ç¾…å ´ã‚’ããã‚ŠæŠœã‘ã¦ããŸç”Ÿå­˜è€…ã€‚ä¸€èˆ¬å…µã§ã¯æ­¯ãŒç«‹ãŸãªã„ã€‚' },
        { range: '50~59', label: 'æ­¦èŠ¸ã®é”äºº', ruby: 'ãƒã‚¹ã‚¿ãƒ¼', color: 'text-emerald-700', bg: 'bg-emerald-100', icon: Icons.Eye, desc: 'ç”Ÿæ¶¯ã‚’ã‹ã‘ã¦ä¸€ã¤ã®æŠ€è¡“ã‚’æ¥µé™ã¾ã§ç ”ãæ¾„ã¾ã›ãŸæ±‚é“è€…ã€‚å¤§è¦æ¨¡ãªç ´å£Šé­”æ³•ãªã©ã¯ä½¿ãˆãªã„å ´åˆã‚‚ã‚ã‚‹ãŒã€å¯¾äººæˆ¦é—˜ã®é–“åˆã„ã‚„æŠ€è¡“ã«ãŠã„ã¦ã¯ã€Œå¤å¼·è€…ã€ã™ã‚‰èµ¤å­ã®ã‚ˆã†ã«ã‚ã—ã‚‰ã†ã€‚' },
        { range: '60~69', label: 'ä¸€é¨å½“åƒã®çŒ›è€…', ruby: 'ã‚¨ãƒ¼ã‚¹', color: 'text-orange-700', bg: 'bg-orange-100', icon: Icons.Swords, desc: 'æˆ¦å ´ã®æ”¯é…è€…ã€‚å˜ç‹¬ã§æˆ¦æ³ã‚’ã²ã£ãã‚Šè¿”ã›ã‚‹å®ŸåŠ›è€…ã€‚å…µå£«1000äººã«åŒ¹æ•µã™ã‚‹ã¨è¨€ã‚ã‚Œã‚‹ã€å€‹ã®æ­¦åŠ›ã®åˆ°é”ç‚¹ã€‚' },
        { range: '70~79', label: 'æ•‘å›½ã®è‹±é›„', ruby: 'ãƒ’ãƒ¼ãƒ­ãƒ¼', color: 'text-red-700', bg: 'bg-red-100', icon: Icons.Zap, desc: 'ãã®åã‚’çŸ¥ã‚‰ã¬è€…ã¯ã„ãªã„ã€åŸéŠè©©äººã®ç‰©èªã®ä¸»å½¹ãŸã¡ã€‚å˜ç‹¬ã§ã®æˆ¦é—˜èƒ½åŠ›ã«åŠ ãˆã€æˆ¦å ´ã«ç«‹ã¤ã ã‘ã§å‘³æ–¹ã®å…¨èƒ½åŠ›ã‚’åº•ä¸Šã’ã—ã€æ•—è‰²æ¿ƒåšãªæˆ¦æ³ã™ã‚‰è¦†ã™ã€Œå¸Œæœ›ã€ãã®ã‚‚ã®ã€‚' },
        { range: '80~89', label: 'å›½ã‚’èƒŒè² ã†æœ€é«˜æˆ¦åŠ›', ruby: 'ã‚¹ãƒšãƒªã‚ªãƒ«', color: 'text-purple-700', bg: 'bg-purple-100', icon: Icons.Castle, desc: 'ã€Œã‚ã®äººãŒå‹•ããªã‚‰æˆ¦äº‰ã«ãªã‚‹ã€ã¨ä»–å›½ãŒè­¦æˆ’ã™ã‚‹ãƒ¬ãƒ™ãƒ«ã€‚å¤§åˆ—å¼·ã®å°†è»ã€å®®å»·é­”å°å¸«ç­†é ­ãªã©ã€å›½å®¶ã®å­˜äº¡ã«é–¢ã‚ã‚‹åŠ›ã€‚' },
        { range: '90~99', label: 'è¶…è¶Šè€…', ruby: 'ãƒˆãƒ©ãƒ³ã‚»ãƒ³ãƒ‡ãƒ³ãƒˆ', color: 'text-fuchsia-700', bg: 'bg-fuchsia-100', icon: Icons.Sun, desc: 'äººã®èº«ã§ã‚ã‚ŠãªãŒã‚‰ã€ç”Ÿç‰©ã¨ã—ã¦ã®é™ç•Œã‚’å®Œå…¨ã«é€¸è„±ã—ã¦ã—ã¾ã£ãŸç‰¹ç•°ç‚¹ã€‚ã‚‚ã¯ã‚„å›½ã‚„çµ„ç¹”ã®åˆ¶å¾¡ã‚’å—ã‘ä»˜ã‘ãšã€ãã®æ°—ã«ãªã‚Œã°å˜ç‹¬ã§åœ°å›³ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã™ã‚‰å¯èƒ½ãªã€æ­©ãå¤§ç½å®³ã€‚' },
        { range: '100~', label: 'ç¥ç¦ã‚’å—ã‘ãŸè€…', ruby: 'ã‚½ãƒ´ãƒªãƒ³', color: 'text-yellow-700', bg: 'bg-yellow-100', icon: Icons.Crown, desc: 'æ™‚ä»£ã‚„å›½å¢ƒã‚’è¶…ãˆã¦èªã‚Šç¶™ãŒã‚Œã‚‹å­˜åœ¨ã€‚å­ä¾›ãŸã¡ãŒæ†§ã‚Œã€ç¥è©±ã«åå‰ãŒåˆ»ã¾ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã€‚æ‚ªã¨ã—ã¦ã‚‚å–„ã¨ã—ã¦ã‚‚ã€‚' },
    ];

    return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[150] p-4 animate-fade-in" onClick={onClose}>
            <div className="bg-white rounded-lg shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden" onClick={e => e.stopPropagation()}>
                <div className="bg-indigo-900 text-white p-4 flex justify-between items-center shrink-0">
                    <h3 className="font-bold text-lg flex items-center gap-2"><Icons.Activity size={20} className="text-yellow-400"/> é­‚ä½æ·±åº¦ (ãƒ¬ãƒ™ãƒ«) ã«ã¤ã„ã¦</h3>
                    <button onClick={onClose}><Icons.X size={20}/></button>
                </div>
                <div className="p-6 text-sm text-gray-700 leading-relaxed overflow-y-auto custom-scrollbar">
                    <p className="mb-4">
                        <span className="font-bold text-indigo-900">ãƒ¬ãƒ™ãƒ« (Lv)</span> ã¨ã¯ã€ã™ã¹ã¦ã®ç”Ÿå‘½ä½“ã®<span className="font-bold">ã€Œé­‚ã®æ ¼ã€</span>ã‚’åŒä¸€ã®å°ºåº¦ã§è¨ˆã‚‹çµ¶å¯¾æŒ‡æ¨™ã§ã™ã€‚
                        ãƒ¬ãƒ™ãƒ«ãŒé«˜ã‘ã‚Œã°é«˜ã„ã»ã©ã€é­”æ³•ãªã©ã®è¶…å¸¸çš„ãªåŠ›ãŒå¼·åŒ–ã•ã‚Œã€ä¸–ç•Œã¸ã®å¹²æ¸‰åŠ›ãŒå¢—å¤§ã—ã¾ã™ã€‚
                    </p>
                    
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 className="font-bold text-xs text-gray-500 border-b pb-1 mb-3">éšæ¢¯ç›®å®‰</h4>
                        <div className="grid grid-cols-[50px_32px_1fr] gap-x-3 gap-y-6 items-start">
                            {ranks.map((rank, idx) => (
                                <React.Fragment key={idx}>
                                    <span className={`font-mono font-bold text-right mt-1.5 ${rank.color.replace('700','500')}`}>{rank.range}</span>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center shadow-sm border border-white ring-1 ring-opacity-20 ring-black mt-0.5 ${rank.bg} ${rank.color}`}>
                                        <rank.icon size={16} />
                                    </div>
                                    <div>
                                        <span className={`font-bold text-base ${rank.color}`}>
                                            {rank.ruby ? <ruby>{rank.label}<rt>{rank.ruby}</rt></ruby> : rank.label}
                                        </span>
                                        <p className="text-xs text-gray-500 mt-1 leading-relaxed">{rank.desc}</p>
                                    </div>
                                </React.Fragment>
                            ))}
                        </div>
                    </div>
                    <p className="text-xs text-gray-400 text-right mt-2">â€»Lvå·®ãŒ20é–‹ãã¨ã€ä¸‹ä½ã®æ”»æ’ƒã¯ä¸Šä½ã«æ®†ã©é€šç”¨ã—ãªããªã‚‹ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚</p>
                </div>
            </div>
        </div>
    );
};

// --- KeySelectionModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (æ–°è¦: é‡è¦äººç‰©/çµ„ç¹”ã®é¸æŠãƒ»ä¸¦ã³æ›¿ãˆ) ---
const KeySelectionModal = ({ isOpen, onClose, title, candidates, selectedIds, onSave }) => {
    const [currentSelectedIds, setCurrentSelectedIds] = useState([]);

    useEffect(() => {
        if (isOpen) setCurrentSelectedIds(selectedIds || []);
    }, [isOpen, selectedIds]);

    if (!isOpen) return null;

    const handleToggle = (id) => {
        if (currentSelectedIds.includes(id)) {
            setCurrentSelectedIds(prev => prev.filter(pid => pid !== id));
        } else {
            setCurrentSelectedIds(prev => [...prev, id]);
        }
    };

    const moveUp = (index) => {
        if (index === 0) return;
        const newList = [...currentSelectedIds];
        [newList[index - 1], newList[index]] = [newList[index], newList[index - 1]];
        setCurrentSelectedIds(newList);
    };

    const moveDown = (index) => {
        if (index === currentSelectedIds.length - 1) return;
        const newList = [...currentSelectedIds];
        [newList[index + 1], newList[index]] = [newList[index], newList[index + 1]];
        setCurrentSelectedIds(newList);
    };

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[80vh] animate-fade-in overflow-hidden">
                <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 className="font-bold text-gray-800">{title}ã®è¨­å®š</h3>
                    <button onClick={onClose}><Icons.X size={20} className="text-gray-400 hover:text-gray-600"/></button>
                </div>
                <div className="flex-grow overflow-hidden flex p-4 gap-4">
                    {/* å·¦ï¼šå€™è£œãƒªã‚¹ãƒˆ */}
                    <div className="w-1/2 flex flex-col">
                        <span className="text-xs font-bold text-gray-500 mb-2">é–¢é€£ãƒªã‚¹ãƒˆ (é¸æŠã—ã¦è¿½åŠ )</span>
                        <div className="flex-grow border rounded bg-gray-50 overflow-y-auto p-2 space-y-1">
                            {candidates.map(c => {
                                const isSelected = currentSelectedIds.includes(c.id);
                                return (
                                    <div key={c.id} onClick={() => !isSelected && handleToggle(c.id)} 
                                         className={`p-2 rounded text-sm flex items-center gap-2 cursor-pointer border ${isSelected ? 'bg-gray-100 text-gray-400 border-gray-200 cursor-default' : 'bg-white hover:bg-blue-50 border-gray-200 shadow-sm'}`}>
                                        {isSelected ? <div className="w-4 h-4 border-2 border-gray-300 rounded bg-gray-300 flex items-center justify-center"><Icons.X size={10} className="text-white"/></div> : <div className="w-4 h-4 border-2 border-gray-400 rounded"></div>}
                                        <span className="truncate">{c.name}</span>
                                    </div>
                                );
                            })}
                            {candidates.length === 0 && <div className="text-xs text-gray-400 text-center py-4">å€™è£œãŒã‚ã‚Šã¾ã›ã‚“</div>}
                        </div>
                    </div>
                    {/* ã‚¢ã‚¤ã‚³ãƒ³ */}
                    <div className="flex flex-col justify-center items-center text-gray-400">
                        <Icons.ChevronRight size={24}/>
                    </div>
                    {/* å³ï¼šé¸æŠæ¸ˆã¿ï¼ˆä¸¦ã³æ›¿ãˆï¼‰ */}
                    <div className="w-1/2 flex flex-col">
                        <span className="text-xs font-bold text-blue-600 mb-2">é‡è¦é …ç›® (é †åºå¤‰æ›´å¯)</span>
                        <div className="flex-grow border-2 border-blue-100 rounded bg-white overflow-y-auto p-2 space-y-1">
                            {currentSelectedIds.map((id, idx) => {
                                const item = candidates.find(c => c.id === id) || { name: 'ä¸æ˜ãªãƒ‡ãƒ¼ã‚¿', id };
                                return (
                                    <div key={id} className="p-2 rounded text-sm flex items-center justify-between bg-blue-50 border border-blue-200 shadow-sm group">
                                        <span className="truncate font-bold text-blue-900">{idx + 1}. {item.name}</span>
                                        <div className="flex items-center gap-1 opacity-60 group-hover:opacity-100">
                                            <button onClick={() => moveUp(idx)} disabled={idx === 0} className="p-1 hover:bg-blue-200 rounded disabled:opacity-30"><Icons.ChevronDown size={12} className="rotate-180"/></button>
                                            <button onClick={() => moveDown(idx)} disabled={idx === currentSelectedIds.length - 1} className="p-1 hover:bg-blue-200 rounded disabled:opacity-30"><Icons.ChevronDown size={12}/></button>
                                            <button onClick={() => handleToggle(id)} className="p-1 hover:bg-red-200 text-red-500 rounded ml-1"><Icons.X size={12}/></button>
                                        </div>
                                    </div>
                                );
                            })}
                            {currentSelectedIds.length === 0 && <div className="text-xs text-gray-400 text-center py-4">é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>}
                        </div>
                    </div>
                </div>
                <div className="p-4 border-t bg-gray-50 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-200 rounded text-sm font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onClick={() => onSave(currentSelectedIds)} className="px-6 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 text-sm font-bold flex items-center gap-2"><Icons.Save size={16}/> ä¿å­˜</button>
                </div>
            </div>
        </div>
    );
};

// --- ItemDetailModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: ãƒ˜ãƒƒãƒ€ãƒ¼ã«Lvè¡¨ç¤ºè¿½åŠ ) ---
const ItemDetailModal = ({ item, type, onClose, parseRuby }) => {
    if (!item) return null;

    const isChar = type === 'char';
    const imageSrc = isChar ? item.portrait : item.logo;
    const DefaultIcon = isChar ? Icons.User : Icons.Briefcase;
    const raceInfo = isChar ? RACES.find(r => r.label === item.race) : null;
    const labelColor = raceInfo?.color || '#9ca3af';
    
    const period = isChar 
        ? `${item.birthYear || '?'} - ${item.deathYear || '?'}`
        : `${item.activeStart || '?'} - ${item.activeEnd || '...'}`;

    return (
        <div className="fixed inset-0 z-[120] bg-black/70 backdrop-blur-sm overflow-y-auto" onClick={onClose}>
            <div className="min-h-screen flex items-center justify-center p-4 sm:p-6">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl h-auto relative p-8 animate-fade-in" onClick={e => e.stopPropagation()}>
                    
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10">
                        <Icons.X size={20} />
                    </button>

                    <div className="flex flex-col">
                        <div className="flex flex-col sm:flex-row items-center sm:items-end gap-6 mb-8 border-b border-gray-100 pb-6">
                            <div className="w-32 h-32 rounded-2xl bg-gray-50 p-1 shadow-lg border border-gray-200 shrink-0 overflow-hidden">
                                {imageSrc ? (
                                    <img src={imageSrc} className="w-full h-full object-cover rounded-xl" />
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center text-gray-300">
                                        <DefaultIcon size={48} />
                                    </div>
                                )}
                            </div>
                            <div className="flex-grow text-center sm:text-left">
                                <div className="flex flex-wrap justify-center sm:justify-start items-center gap-2 mb-2">
                                    <span className="px-2.5 py-0.5 rounded text-[11px] font-bold text-white shadow-sm tracking-wide" style={{backgroundColor: labelColor}}>
                                        {isChar ? item.race : (ORG_TYPES.find(t=>t.key===item.type)?.label || 'çµ„ç¹”')}
                                    </span>
                                    {isChar && raceInfo?.ruby && (
                                        <span className="text-[10px] text-gray-500 font-bold bg-gray-100 px-2 py-0.5 rounded border border-gray-200">
                                            {raceInfo.ruby}
                                        </span>
                                    )}
                                    {/* â˜…è¿½åŠ : Lvè¡¨ç¤º */}
                                    {isChar && item.level && (
                                        <span className="text-[11px] font-mono font-bold text-white bg-indigo-500 px-2 py-0.5 rounded shadow-sm">
                                            Lv.{item.level}
                                        </span>
                                    )}
                                    <span className="text-xs font-mono font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200">
                                        <span className="opacity-50 mr-1">TIME:</span>{period}
                                    </span>
                                </div>
                                <h2 className="text-3xl sm:text-4xl font-black leading-tight tracking-tight text-gray-900">
                                    {item.name}
                                </h2>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-2 space-y-4">
                                <h4 className="text-xs font-bold text-gray-400 uppercase flex items-center gap-2 pb-1 border-b border-gray-100">
                                    <Icons.FileText size={14} className="text-yellow-500"/> æ¦‚è¦ãƒ»è©³ç´°
                                </h4>
                                <div className="text-base leading-loose text-gray-700 ql-editor font-serif" style={{padding:0}}>
                                    {item.note ? (
                                        <div dangerouslySetInnerHTML={{ __html: parseRuby(item.note) }} />
                                    ) : (
                                        <p className="text-gray-400 text-sm italic p-4 border border-dashed rounded bg-gray-50 text-center">è©³ç´°ãªè¨˜è¿°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                                    )}
                                </div>
                            </div>

                            <div className="lg:col-span-1">
                                <div className="bg-gray-50 rounded-xl p-5 border border-gray-100 h-full">
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-4 flex items-center gap-2">
                                        {isChar ? <><Icons.Briefcase size={14} className="text-blue-500"/> æ‰€å±ãƒ»é–¢é€£çµ„ç¹”</> : <><Icons.User size={14} className="text-blue-500"/> ä¸»è¦äººç‰©ãƒ»æ§‹æˆå“¡</>}
                                    </h4>
                                    <div className="space-y-2">
                                        {(isChar ? item.affiliations : item.keyPeople)?.length > 0 ? (
                                            (isChar ? item.affiliations : item.keyPeople).map((aff, idx) => {
                                                const name = typeof aff === 'string' ? aff : aff.name;
                                                const role = typeof aff === 'object' && aff.role ? aff.role : '';
                                                return (
                                                    <div key={idx} className="flex items-center justify-between p-2 bg-white border border-gray-200 rounded-lg shadow-sm">
                                                        <span className="font-bold text-sm text-gray-800 truncate pr-2">{name}</span>
                                                        {role && <span className="text-[10px] font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200 shrink-0">{role}</span>}
                                                    </div>
                                                );
                                            })
                                        ) : (
                                            <p className="text-xs text-gray-400 text-center py-2">ç™»éŒ²ãªã—</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};



// --- UserManagementView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ã) ---
const UserManagementView = ({ setView, allUsers, onChangeRole }) => {
    // ä¸¦ã³æ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯: å½¹å‰²é † (Admin > Writer > Guest > Pending > Rejected) -> ç™»éŒ²æ—¥é †
    const sortedUsers = useMemo(() => {
        const rolePriority = { 'admin': 1, 'writer': 2, 'guest': 3, 'pending': 4, 'rejected': 5 };
        return [...allUsers].sort((a, b) => {
            // 1. å½¹å‰²ã§ä¸¦ã³æ›¿ãˆ
            const priorityA = rolePriority[a.role] || 99;
            const priorityB = rolePriority[b.role] || 99;
            if (priorityA !== priorityB) return priorityA - priorityB;
            
            // 2. ç™»éŒ²æ—¥é † (appliedAt)
            const dateA = a.appliedAt ? new Date(a.appliedAt).getTime() : 0;
            const dateB = b.appliedAt ? new Date(b.appliedAt).getTime() : 0;
            return dateA - dateB;
        });
    }, [allUsers]);

    const getRoleLabel = (role) => {
        switch(role) {
            case 'admin': return { text: 'ç®¡ç†è€…', bg: 'bg-gray-800 text-yellow-400 border-gray-700' };
            case 'writer': return { text: 'åŸ·ç­†è€…', bg: 'bg-blue-600 text-white border-blue-700' };
            case 'guest': return { text: 'ã‚²ã‚¹ãƒˆ', bg: 'bg-green-100 text-green-800 border-green-200' };
            case 'pending': return { text: 'ç”³è«‹ä¸­', bg: 'bg-yellow-100 text-yellow-800 border-yellow-200 animate-pulse' };
            default: return { text: 'åœæ­¢ä¸­', bg: 'bg-gray-100 text-gray-400 border-gray-200' };
        }
    };

    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 animate-fade-in pb-20">
            <SectionHeader icon={Icons.Users} title="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†" desc="ç™»éŒ²æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä¸€è¦§ã§ã™ã€‚å½¹å‰²ã®å¤‰æ›´ã‚„æ¨©é™ã®ç®¡ç†ã‚’è¡Œãˆã¾ã™ã€‚" />
            
            <div className="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <span className="font-bold text-gray-700">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ ({allUsers.length})</span>
                    <span className="text-xs text-gray-400">è¡¨ç¤ºé †: ç®¡ç†è€… &gt; åŸ·ç­†è€… &gt; ã‚²ã‚¹ãƒˆ (ç™»éŒ²é †)</span>
                </div>
                
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-gray-100 text-gray-500 font-bold border-b border-gray-200">
                            <tr>
                                <th className="p-4 w-64">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                <th className="p-4 w-32">ç¾åœ¨ã®æ¨©é™</th>
                                <th className="p-4">æ¨©é™ã®å¤‰æ›´ãƒ»æ“ä½œ</th>
                                <th className="p-4 text-right w-40">ç™»éŒ²æ—¥</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {sortedUsers.map(user => {
                                const roleStyle = getRoleLabel(user.role);
                                // â˜…è¿½åŠ : ç‰¹æ¨©ç®¡ç†è€…ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                                const isSuperAdmin = user.email === "anohitodayoanohito@gmail.com";

                                return (
                                    <tr key={user.id} className="hover:bg-gray-50 transition-colors group">
                                        <td className="p-4">
                                            {/* ... (ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºéƒ¨åˆ†ã¯ãã®ã¾ã¾) ... */}
                                            <div className="flex items-center gap-3">
                                                {user.photoURL ? (
                                                    <img src={user.photoURL} className="w-10 h-10 rounded-full border border-gray-200 shadow-sm" />
                                                ) : (
                                                    <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-400"><Icons.User size={20}/></div>
                                                )}
                                                <div>
                                                    <div className="font-bold text-gray-800">
                                                        {user.displayName || 'åç§°æœªè¨­å®š'}
                                                        {/* ç‰¹æ¨©ç®¡ç†è€…ãƒãƒ¼ã‚¯ã‚’ã¤ã‘ã‚‹ */}
                                                        {isSuperAdmin && <span className="ml-2 text-[10px] bg-black text-yellow-400 px-1.5 py-0.5 rounded border border-yellow-600">OWNER</span>}
                                                    </div>
                                                    <div className="text-xs text-gray-500 font-mono">{user.email}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="p-4">
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold border ${roleStyle.bg} inline-block text-center min-w-[80px]`}>
                                                {roleStyle.text}
                                            </span>
                                        </td>
                                        <td className="p-4">
                                            <div className="flex flex-wrap gap-2 opacity-100 sm:opacity-40 group-hover:opacity-100 transition-opacity">
                                                {/* â˜…ä¿®æ­£: isSuperAdmin ã®å ´åˆã¯å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’ disabled ã«ã™ã‚‹ */}
                                                <button onClick={() => onChangeRole(user.id, 'admin')} disabled={user.role === 'admin' || isSuperAdmin} className={`px-2 py-1 text-xs rounded border ${user.role === 'admin' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-600 hover:bg-gray-800 hover:text-yellow-400 border-gray-300'}`}>ç®¡ç†è€…</button>
                                                <button onClick={() => onChangeRole(user.id, 'writer')} disabled={user.role === 'writer' || isSuperAdmin} className={`px-2 py-1 text-xs rounded border ${user.role === 'writer' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-600 hover:bg-blue-600 hover:text-white border-gray-300'}`}>åŸ·ç­†è€…</button>
                                                <button onClick={() => onChangeRole(user.id, 'guest')} disabled={user.role === 'guest' || isSuperAdmin} className={`px-2 py-1 text-xs rounded border ${user.role === 'guest' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-600 hover:bg-green-600 hover:text-white border-gray-300'}`}>ã‚²ã‚¹ãƒˆ</button>
                                                {!isSuperAdmin && <button onClick={() => onChangeRole(user.id, 'reject')} className="px-2 py-1 text-xs rounded border bg-white text-red-400 hover:bg-red-50 hover:text-red-600 border-red-100 ml-auto">åœæ­¢</button>}
                                            </div>
                                        </td>
                                        <td className="p-4 text-right text-xs text-gray-400 font-mono">
                                            {user.appliedAt ? new Date(user.appliedAt).toLocaleDateString() : '-'}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};

// --- GlossaryView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: ãƒ­ã‚¸ãƒƒã‚¯è£œå®Œæ¸ˆã¿) ---
const GlossaryView = ({ setView, nations, entries, characters, organizations, glossaryData, setGlossaryData, isAuthorized }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [filterTypes, setFilterTypes] = useState(['all']);
    const [selectedItem, setSelectedItem] = useState(null);
    const [history, setHistory] = useState([]);

    // --- 1. è‡ªå‹•ã‚¿ã‚°ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
    const getAutoTags = (item) => {
        const tags = [];
        if (item.type === 'nation') {
            tags.push('å›½å®¶');
            if (item.original.location) tags.push(LOCATIONS[item.original.location]?.label || 'ä¸æ˜');
            if (item.original.rank) tags.push(NATION_RANKS[item.original.rank]?.label || 'ä¸æ˜');
        } else if (item.type === 'event') {
            tags.push('å‡ºæ¥äº‹');
            tags.push(`${item.original.year}å¹´`);
            if (item.original.tags) tags.push(...item.original.tags);
        } else if (item.type === 'char') {
            tags.push('äººç‰©');
            if (item.original.race) tags.push(item.original.race);
            if (item.original.affiliations) {
                item.original.affiliations.forEach(a => tags.push(typeof a === 'string' ? a : a.name));
            }
        } else if (item.type === 'org') {
            tags.push('çµ„ç¹”');
            const typeLabel = ORG_TYPES.find(t => t.key === item.original.type)?.label;
            if (typeLabel) tags.push(typeLabel);
        } else {
            tags.push('ç”¨èª');
        }
        return Array.from(new Set(tags)); // é‡è¤‡æ’é™¤
    };

    // --- 2. å…¨ã‚¢ã‚¤ãƒ†ãƒ ã®çµ±åˆãƒªã‚¹ãƒˆç”Ÿæˆ ---
    const allItems = useMemo(() => {
        let list = [];

        // å›½å®¶
        nations.forEach(n => {
            list.push({
                id: n.id, type: 'nation', name: n.name, label: 'å›½å®¶',
                color: 'bg-indigo-100 text-indigo-700', image: n.flag, original: n,
                sub: LOCATIONS[n.location]?.label
            });
        });
        // å‡ºæ¥äº‹
        entries.forEach(e => {
            list.push({
                id: e.id, type: 'event', name: e.title, label: 'å‡ºæ¥äº‹',
                color: 'bg-green-100 text-green-700', image: null, original: e,
                sub: `${e.year}å¹´`
            });
        });
        // äººç‰©
        characters.forEach(c => {
            list.push({
                id: c.id, type: 'char', name: c.name, label: 'äººç‰©',
                color: 'bg-blue-100 text-blue-700', image: c.portrait, original: c,
                sub: c.race
            });
        });
        // çµ„ç¹”
        organizations.forEach(o => {
            list.push({
                id: o.id, type: 'org', name: o.name, label: 'çµ„ç¹”',
                color: 'bg-orange-100 text-orange-700', image: o.logo, original: o,
                sub: ORG_TYPES.find(t => t.key === o.type)?.label
            });
        });
        // æ‰‹å‹•ç™»éŒ²ç”¨èª (glossaryData.terms)
        if (glossaryData && glossaryData.terms) {
            glossaryData.terms.forEach(t => {
                list.push({
                    id: t.id, type: 'term', name: t.name, label: 'ç”¨èª',
                    color: 'bg-gray-100 text-gray-600', image: null, original: t,
                    sub: 'ä¸€èˆ¬ç”¨èª'
                });
            });
        }

        return list.sort((a, b) => a.name.localeCompare(b.name));
    }, [nations, entries, characters, organizations, glossaryData]);

    // --- 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
    const toggleFilter = (type) => {
        if (type === 'all') {
            setFilterTypes(['all']);
        } else {
            let newTypes = filterTypes.includes('all') ? [] : [...filterTypes];
            if (newTypes.includes(type)) {
                newTypes = newTypes.filter(t => t !== type);
            } else {
                newTypes.push(type);
            }
            if (newTypes.length === 0) newTypes = ['all'];
            setFilterTypes(newTypes);
        }
    };

    const filteredItems = useMemo(() => {
        let res = allItems;
        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
        if (!filterTypes.includes('all')) {
            res = res.filter(item => filterTypes.includes(item.type));
        }
        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
        if (searchTerm) {
            const lower = searchTerm.toLowerCase();
            res = res.filter(item => {
                // åå‰ä¸€è‡´
                if (item.name.toLowerCase().includes(lower)) return true;
                
                // ã‚¿ã‚°ä¸€è‡´
                const savedTags = glossaryData?.tags?.[item.id] || [];
                const autoTags = getAutoTags(item);
                const allTags = [...savedTags, ...autoTags];
                if (allTags.some(t => t.toLowerCase().includes(lower))) return true;

                // ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä¸€è‡´
                const aliases = glossaryData?.aliases?.[item.id] || [];
                if (aliases.some(a => a.toLowerCase().includes(lower))) return true;

                return false;
            });
        }
        return res;
    }, [allItems, filterTypes, searchTerm, glossaryData]);

    // --- 4. æ“ä½œãƒãƒ³ãƒ‰ãƒ© ---
    
    // è©³ç´°ã‚’é–‹ã
    const openDetail = (item) => {
        if (selectedItem) {
            setHistory([...history, selectedItem]);
        }
        setSelectedItem(item);
        // ç”»é¢ãƒˆãƒƒãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ï¼ˆåå‰ã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã—ã¦é–‹ãï¼‰
    const handleLinkClick = (name) => {
        const target = allItems.find(i => i.name === name);
        if (target) openDetail(target);
        else alert(`ã€Œ${name}ã€ã®ãƒšãƒ¼ã‚¸ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
    };

    // æˆ»ã‚‹
    const handleBack = () => {
        if (history.length > 0) {
            const prev = history[history.length - 1];
            setHistory(history.slice(0, -1));
            setSelectedItem(prev);
        } else {
            setSelectedItem(null);
        }
    };

    // å±¥æ­´ã‚¸ãƒ£ãƒ³ãƒ—
    const handleJumpHistory = (index) => {
        const target = history[index];
        setHistory(history.slice(0, index));
        setSelectedItem(target);
    };

    // æ–°è¦ç”¨èªè¿½åŠ  (ReferenceErrorã®åŸå› ã ã£ãŸç®‡æ‰€)
    const handleAddTerm = () => {
        const name = prompt("ç”¨èªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if (!name) return;
        
        const newTerm = {
            id: `term_${Date.now()}`,
            name: name,
            desc: '',
            note: ''
        };
        
        // glossaryDataã‚’æ›´æ–°
        const newTerms = [...(glossaryData.terms || []), newTerm];
        const newData = { ...glossaryData, terms: newTerms };
        setGlossaryData(newData);
        
        // è¿½åŠ ã—ãŸç”¨èªã‚’å³åº§ã«é–‹ã
        // allItemsã¯useMemoã§å†è¨ˆç®—ã•ã‚Œã‚‹ãŸã‚ã€å°‘ã—é…å»¶ã•ã›ã¦é–‹ãã‹ã€æ“¬ä¼¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§é–‹ã
        setTimeout(() => {
            const itemObj = {
                id: newTerm.id, type: 'term', name: newTerm.name, label: 'ç”¨èª',
                color: 'bg-gray-100 text-gray-600', image: null, original: newTerm,
                sub: 'ä¸€èˆ¬ç”¨èª'
            };
            openDetail(itemObj);
        }, 100);
    };

    // ç”¨èªå‰Šé™¤
    const handleDeleteTerm = (id) => {
        if (!window.confirm("ã“ã®ç”¨èªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        
        const newTerms = (glossaryData.terms || []).filter(t => t.id !== id);
        // é–¢é€£ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸Šæ›¸ãè¨­å®šã‚„ã‚¿ã‚°ï¼‰ã‚‚æ¶ˆã™å ´åˆã¯ã“ã“ã§è¡Œã†ãŒã€ä»Šå›ã¯æ®‹ã—ã¦ãŠã„ã¦ã‚‚å®³ã¯ãªã„ãŸã‚Termsã®ã¿æ›´æ–°
        setGlossaryData({ ...glossaryData, terms: newTerms });
        
        if (selectedItem && selectedItem.id === id) {
            handleBack();
        }
    };

    // ç”¨èªãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆä¸Šæ›¸ããƒ»ã‚¿ã‚°ãƒ»ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
    const handleSaveTermData = (id, content, tags, aliases) => {
        const overrides = { ...(glossaryData.overrides || {}) };
        if (content !== undefined) overrides[id] = content;
        
        const tagData = { ...(glossaryData.tags || {}) };
        if (tags !== undefined) tagData[id] = tags;

        const aliasData = { ...(glossaryData.aliases || {}) };
        if (aliases !== undefined) aliasData[id] = aliases;

        const newData = { ...glossaryData, overrides, tags: tagData, aliases: aliasData };
        setGlossaryData(newData);
    };

    // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
    if (selectedItem) {
        return (
            <GlossaryDetail 
                item={selectedItem} 
                history={history} 
                onBack={handleBack} 
                onJumpHistory={handleJumpHistory}
                onLinkClick={handleLinkClick}
                allItems={allItems}
                glossaryData={glossaryData}
                onSaveTermData={handleSaveTermData}
                onDeleteTerm={handleDeleteTerm}
                isAuthorized={isAuthorized}
                getAutoTags={getAutoTags}
            />
        );
    }
    
    return (
        <div className="space-y-6 animate-fade-in pb-20">
            <SectionHeader icon={Icons.BookOpen} title="ç”¨èªé›†ãƒ»ç™¾ç§‘äº‹å…¸" desc="ä¸–ç•Œã«å­˜åœ¨ã™ã‚‹å›½å®¶ã€äººç‰©ã€å‡ºæ¥äº‹ã€ç”¨èªã‚’ç¶²ç¾…ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚" />
            
            <div className="flex flex-col md:flex-row gap-4 bg-white p-4 rounded-lg shadow border border-gray-200 sticky top-0 z-20">
                <div className="relative flex-grow">
                    <Icons.Search className="absolute left-3 top-2.5 text-gray-400" size={20} />
                    <input type="text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (ã‚¿ã‚°ãƒ»åˆ¥åå«ã‚€)..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none" />
                </div>
                <div className="flex gap-2 overflow-x-auto pb-1 md:pb-0 custom-scrollbar">
                    {[{ k: 'all', l: 'ã™ã¹ã¦' }, { k: 'nation', l: 'å›½å®¶' }, { k: 'event', l: 'å‡ºæ¥äº‹' }, { k: 'char', l: 'äººç‰©' }, { k: 'org', l: 'çµ„ç¹”' }, { k: 'term', l: 'ç”¨èª' }].map(f => {
                        const isActive = filterTypes.includes(f.k);
                        return (
                            <button key={f.k} onClick={() => toggleFilter(f.k)} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-colors border ${isActive ? 'bg-gray-800 text-white border-gray-800 shadow-inner' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-100'}`}>
                                {isActive && f.k !== 'all' ? <span className="mr-1 text-yellow-400">âœ”</span> : null}{f.l}
                            </button>
                        );
                    })}
                </div>
                {isAuthorized && <button onClick={handleAddTerm} className="px-4 py-2 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 flex items-center gap-2 whitespace-nowrap shadow"><Icons.Plus size={18}/> ç”¨èªç™»éŒ²</button>}
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filteredItems.map(item => {
                    const savedTags = glossaryData.tags?.[item.id] || [];
                    const autoTags = getAutoTags(item);
                    const displayTags = savedTags.length > 0 ? savedTags : autoTags;
                    
                    return (
                        <div key={`${item.type}_${item.id}`} onClick={() => openDetail(item)} className="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-blue-300 transition-all cursor-pointer group flex items-center p-3 gap-3 h-24 overflow-hidden relative">
                            <div className="w-16 h-16 bg-gray-100 rounded-md border border-gray-200 flex-shrink-0 flex items-center justify-center overflow-hidden relative">
                                {item.image ? <img src={item.image} className="w-full h-full object-cover" /> : <div className="opacity-30"><Icons.BookOpen size={24} /></div>}
                                <div className={`absolute top-0 left-0 text-[9px] font-bold px-1.5 py-0.5 rounded-br-md text-white shadow-sm z-10 ${item.color.replace('bg-', 'bg-').replace('text-', '').split(' ')[0].replace('100', '500')}`}>{item.label}</div>
                            </div>
                            <div className="flex-grow min-w-0 flex flex-col justify-center h-full">
                                <div className="flex justify-between items-start"><h3 className="font-bold text-gray-800 leading-tight truncate pr-2 group-hover:text-blue-600 transition-colors">{item.name}</h3>{item.sub && <span className="text-[10px] text-gray-400 font-mono bg-gray-50 px-1 rounded flex-shrink-0">{item.sub}</span>}</div>
                                <div className="mt-2 flex flex-wrap gap-1 h-5 overflow-hidden">{displayTags.slice(0, 3).map((tag, i) => <span key={i} className="text-[9px] bg-gray-50 text-gray-500 px-1.5 py-0.5 rounded border border-gray-100 whitespace-nowrap">{tag}</span>)}{displayTags.length === 0 && <span className="text-[9px] text-gray-300 italic">ã‚¿ã‚°ãªã—</span>}{displayTags.length > 3 && <span className="text-[9px] text-gray-400">...</span>}</div>
                            </div>
                            <div className="absolute right-2 opacity-0 group-hover:opacity-100 transition-opacity text-blue-400"><Icons.ChevronRight size={16} /></div>
                        </div>
                    );
                })}
                {filteredItems.length === 0 && <div className="col-span-full text-center py-20 text-gray-400">è©²å½“ã™ã‚‹ç”¨èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>}
            </div>
        </div>
    );
};

// --- DisambiguationModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (æ–°è¦: ãƒªãƒ³ã‚¯å…ˆé¸æŠ) ---
const DisambiguationModal = ({ isOpen, onClose, keyword, candidates, onSelect }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
            <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden border border-gray-200" onClick={e => e.stopPropagation()}>
                <div className="bg-blue-900 text-white p-4 flex justify-between items-center">
                    <div>
                        <div className="text-xs text-blue-200 font-bold mb-1">Disambiguation</div>
                        <h3 className="font-bold text-lg">ã€Œ{keyword}ã€ã®å€™è£œ</h3>
                    </div>
                    <button onClick={onClose}><Icons.X size={20}/></button>
                </div>
                <div className="p-2 max-h-[60vh] overflow-y-auto custom-scrollbar">
                    <p className="text-xs text-gray-500 p-2">è¤‡æ•°ã®é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ç§»å‹•å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                    <div className="space-y-1">
                        {candidates.map((item, idx) => (
                            <button 
                                key={`${item.type}_${item.id}_${idx}`} 
                                onClick={() => onSelect(item.name)}
                                className="w-full text-left p-3 hover:bg-blue-50 rounded-lg transition-colors flex items-center gap-3 border border-transparent hover:border-blue-100 group"
                            >
                                <div className="w-10 h-10 rounded bg-gray-100 shrink-0 overflow-hidden border border-gray-200">
                                    {item.image ? <img src={item.image} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center opacity-30"><Icons.Link size={20}/></div>}
                                </div>
                                <div>
                                    <div className="font-bold text-gray-800 group-hover:text-blue-700 flex items-center gap-2">
                                        {item.name}
                                        <span className={`text-[9px] px-1.5 py-0.5 rounded text-white ${item.color.split(' ')[0].replace('100', '500')}`}>
                                            {item.label}
                                        </span>
                                    </div>
                                    <div className="text-xs text-gray-500 mt-0.5 truncate max-w-[200px]">
                                        {item.sub || 'è©³ç´°ãªã—'}
                                    </div>
                                </div>
                                <Icons.ChevronRight size={16} className="ml-auto text-gray-300 group-hover:text-blue-400"/>
                            </button>
                        ))}
                    </div>
                </div>
                <div className="p-3 bg-gray-50 border-t text-right">
                    <button onClick={onClose} className="text-sm text-gray-500 hover:text-gray-700 font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    );
};

// --- GlossaryDetail ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: ãƒ‘ãƒ³ããšè£…é£¾ãƒ»ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ»æ›–æ˜§ã•å›é¿å¯¾å¿œ) ---
const GlossaryDetail = ({ item, history, onBack, onJumpHistory, onLinkClick, allItems, glossaryData, onSaveTermData, onDeleteTerm, isAuthorized, getAutoTags }) => {
    const [isEditing, setIsEditing] = useState(false);
    
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    const overrideDesc = glossaryData?.overrides?.[item.id];
    const savedTags = glossaryData?.tags?.[item.id];
    const savedAliases = glossaryData?.aliases?.[item.id] || []; // â˜…è¿½åŠ : ã‚¨ã‚¤ãƒªã‚¢ã‚¹
    const autoTags = useMemo(() => getAutoTags(item), [item, getAutoTags]);
    const displayTags = savedTags && savedTags.length > 0 ? savedTags : autoTags;
    
    // ç·¨é›†ç”¨State
    const [tagInput, setTagInput] = useState('');
    const [aliasInput, setAliasInput] = useState(''); // â˜…è¿½åŠ : ã‚¨ã‚¤ãƒªã‚¢ã‚¹å…¥åŠ›

    // æ›–æ˜§ã•å›é¿ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨State
    const [disambigInfo, setDisambigInfo] = useState({ isOpen: false, keyword: '', candidates: [] });

    useEffect(() => { 
        if (isEditing) {
            setTagInput(displayTags.join(', '));
            setAliasInput(savedAliases.join(', '));
        }
    }, [isEditing, displayTags, savedAliases]);

    const getOriginalDesc = () => {
        const o = item.original;
        if (item.type === 'nation') return o.note;
        if (item.type === 'event') return o.content;
        if (item.type === 'char') return o.note;
        if (item.type === 'org') return o.note;
        if (item.type === 'term') return o.desc;
        return '';
    };

    const displayContent = overrideDesc || getOriginalDesc() || '<p class="text-gray-400 italic">è¨˜è¿°ãªã—</p>';

    // â˜…é‡è¦: è‡ªå‹•ãƒªãƒ³ã‚¯ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (ã‚¨ã‚¤ãƒªã‚¢ã‚¹å¯¾å¿œ & æ›–æ˜§ã•å›é¿IDåŸ‹ã‚è¾¼ã¿)
    const renderContent = () => {
        // 1. å…¨ã‚¢ã‚¤ãƒ†ãƒ ã®ã€Œåå‰ã€ã¨ã€Œã‚¨ã‚¤ãƒªã‚¢ã‚¹ã€ã‚’ãƒãƒƒãƒ—åŒ–ã™ã‚‹
        // map[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰] = [item1, item2, ...]
        const keywordMap = {};
        allItems.forEach(i => {
            // è‡ªåˆ†è‡ªèº«ã¸ã®ãƒªãƒ³ã‚¯ã¯é™¤å¤–
            if (i.id === item.id) return;

            // åå‰
            if (i.name && i.name.length > 1) {
                if (!keywordMap[i.name]) keywordMap[i.name] = [];
                keywordMap[i.name].push(i);
            }
            // ã‚¨ã‚¤ãƒªã‚¢ã‚¹
            const aliases = glossaryData?.aliases?.[i.id] || [];
            aliases.forEach(alias => {
                if (alias && alias.length > 1) {
                    if (!keywordMap[alias]) keywordMap[alias] = [];
                    keywordMap[alias].push(i);
                }
            });
        });

        // 2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ–‡å­—æ•°é †ï¼ˆé•·ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
        const sortedKeywords = Object.keys(keywordMap).sort((a, b) => b.length - a.length);

        // 3. ãƒªãƒ³ã‚¯ç½®æ›å‡¦ç†
        const tags = [];
        // HTMLã‚¿ã‚°ã‚’ä¿è­·ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã ã‘ç½®æ›
        let tempHtml = displayContent.replace(/<[^>]+>/g, (match) => { tags.push(match); return `__TAG_${tags.length - 1}__`; });

        sortedKeywords.forEach(keyword => {
            // æ—¢ã«ãƒªãƒ³ã‚¯åŒ–ã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã‚’é¿ã‘ã‚‹ãŸã‚ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ã ãŒã€
            // ã“ã“ã§ã¯å˜ç´”ã«æ­£è¦è¡¨ç¾ã§ç½®æ›ã€‚é•·ã„é †ã«ã‚„ã‚Œã°ã€Œè‹±é›„å¤§æˆ¦ã€ãŒã€Œè‹±é›„ã€ã‚ˆã‚Šå…ˆã«ç½®æ›ã•ã‚Œã‚‹ã€‚
            // è¤‡æ•°ã®å€™è£œãŒã‚ã‚‹å ´åˆã¯ data-ids ã«ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§IDã‚’å…¥ã‚Œã‚‹
            const candidates = keywordMap[keyword];
            // é‡è¤‡æ’é™¤
            const uniqueCandidates = Array.from(new Set(candidates.map(c => c.id))).map(id => candidates.find(c => c.id === id));
            
            if (uniqueCandidates.length === 0) return;

            const idsString = uniqueCandidates.map(c => c.id).join(','); // "nation_123,char_456"
            
            // æ­£è¦è¡¨ç¾ã§ç½®æ› (å¢ƒç•Œãƒã‚§ãƒƒã‚¯ãªã—ã ã¨éƒ¨åˆ†ä¸€è‡´ã—ã™ãã‚‹ã®ã§æ³¨æ„ã ãŒã€æ—¥æœ¬èªã¯å˜èªå¢ƒç•ŒãŒæ›–æ˜§)
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã« replaceAll çš„ãªæŒ™å‹•ã«ã™ã‚‹
            // â€»æ³¨æ„: ã™ã§ã«ç½®æ›ã•ã‚ŒãŸ <span>...</span> ã®ä¸­èº«ã‚’å†ç½®æ›ã—ãªã„å·¥å¤«ãŒå¿…è¦
            // ç°¡æ˜“çš„ã« "ã¾ã ã‚¿ã‚°ã§ã¯ãªã„" éƒ¨åˆ†ã ã‘å¯¾è±¡ã«ã™ã‚‹ã®ã¯é›£ã—ã„ã®ã§ã€
            // ä»Šå›ã¯ __LOCK_n__ æ–¹å¼ã§ç½®æ›æ¸ˆã¿ç®‡æ‰€ã‚’ä¿è­·ã™ã‚‹
            
            const regex = new RegExp(`(${keyword})`, 'g');
            // ä¸€åº¦ãƒãƒƒãƒã—ãŸã‚‰ä¿è­·ã™ã‚‹
            tempHtml = tempHtml.replace(regex, (match) => {
                 tags.push(`<span class="glossary-link text-blue-600 hover:underline cursor-pointer font-bold relative group/link" data-term="${match}" data-ids="${idsString}">${match}<span class="text-[9px] text-blue-400 align-top ml-0.5 opacity-50 group-hover/link:opacity-100">â†—</span></span>`);
                 return `__TAG_${tags.length - 1}__`;
            });
        });

        // 4. ã‚¿ã‚°ã‚’å¾©å…ƒ
        // å†å¸°çš„ã«å¾©å…ƒãŒå¿…è¦ï¼ˆãƒã‚¹ãƒˆã¯ã—ã¦ã„ãªã„å‰æã ãŒã€ä¿è­·ã—ãŸãƒªãƒ³ã‚¯è‡ªä½“ãŒTAGã«ãªã£ã¦ã„ã‚‹ãŸã‚ï¼‰
        // å˜ç´”ãªãƒ«ãƒ¼ãƒ—ã§ã¯é †åºä¾å­˜ãŒã‚ã‚‹ãŸã‚ã€æ­£è¦è¡¨ç¾ã§è¦‹ã¤ã‹ã‚‰ãªããªã‚‹ã¾ã§æˆ»ã™ã®ãŒå®‰å…¨
        // ã—ã‹ã—ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«é€†é †ã§æˆ»ã™ã‚ã‘ã«ã‚‚ã„ã‹ãªã„ã®ã§ã€æ–‡å­—åˆ—ç½®æ›ãƒ«ãƒ¼ãƒ—
        let finalHtml = tempHtml;
        // å˜ç´”ãªç½®æ›ã ã¨å…¥ã‚Œå­ã§å£Šã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€ä»Šå›ã¯TAGã®ä¸­èº«ã«TAGå‚ç…§ã¯å«ã¾ã‚Œãªã„ä»•æ§˜ã§å®Ÿè£…
        // ãŸã ã—ã€ä¸Šè¨˜ãƒ­ã‚¸ãƒƒã‚¯ã ã¨ keywordç½®æ›ã§ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚°ã‚‚ __TAG__ ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€
        // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ã‚¿ã‚°ã¨æ–°ã—ãç”Ÿæˆã—ãŸã‚¿ã‚°ãŒæ··åœ¨ã—ã¦ã„ã‚‹ã€‚
        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é †ã«ç½®æ›ã™ã‚Œã°OKã€‚
        
        // __TAG_0__, __TAG_1__ ... ã‚’é †ç•ªã«æˆ»ã™
        // String.replaceã¯ä¸€åº¦ã—ã‹ç½®æ›ã—ãªã„ã®ã§ã€ãƒ«ãƒ¼ãƒ—ã§å‡¦ç†
        // ãŸã ã—ã€ã‚¿ã‚°ã®ä¸­ã«ã‚¿ã‚°ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã¯ãªã„ï¼ˆHTMLæ§‹é€ ä¸Šï¼‰ã®ã§ã€
        // æ•°å­—ãŒå¤§ãã„é †ã«æˆ»ã™å¿…è¦ã¯ãªã„ãŒã€å‚ç…§æ•´åˆæ€§ã®ãŸã‚ replace(/__TAG_(\d+)__/g) ã‚’ä½¿ã†
        
        // å†å¸°çš„ãªå¾©å…ƒãŒå¿…è¦ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç½®æ›ãŒé‡ãªã£ãŸå ´åˆï¼‰ã€‚
        // ä»Šå›ã®å®Ÿè£…ã§ã¯ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç½®æ›æ™‚ã«å³åº§ã«__TAG__åŒ–ã€ã—ã¦ã„ã‚‹ãŸã‚ã€
        // ã€Œè‹±é›„å¤§æˆ¦ã€ãŒç½®æ›â†’TAGåŒ– ã•ã‚ŒãŸã‚ã¨ã€ã€Œè‹±é›„ã€ã¯TAGå†…ã®æ–‡å­—åˆ—ã«ã¯ãƒãƒƒãƒã—ãªã„ã®ã§å®‰å…¨ã€‚
        
        finalHtml = finalHtml.replace(/__TAG_(\d+)__/g, (_, index) => tags[index]);
        // ã‚‚ã—TAGã®ä¸­ã«TAGãŒå…¥ã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆãƒã‚°ï¼‰ãŒã‚ã£ãŸå ´åˆã®ãŸã‚ã«ã€æ•°å›å›ã™æ‰‹ã‚‚ã‚ã‚‹ãŒä¸€æ—¦1å›ã§ã€‚
        
        return (
            <div 
                className="prose prose-lg max-w-none text-gray-800 leading-loose font-sans" 
                dangerouslySetInnerHTML={{ __html: finalHtml }} 
                onClick={(e) => {
                    const target = e.target.closest('.glossary-link');
                    if (target) {
                        e.stopPropagation();
                        const ids = target.getAttribute('data-ids').split(',');
                        const keyword = target.getAttribute('data-term');
                        
                        // IDã‹ã‚‰å®Ÿéš›ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                        const candidates = ids.map(id => allItems.find(i => i.id === id)).filter(x => x);

                        if (candidates.length === 1) {
                            // å€™è£œãŒ1ã¤ãªã‚‰å³é·ç§»
                            onLinkClick(candidates[0].name);
                        } else if (candidates.length > 1) {
                            // å€™è£œãŒè¤‡æ•°ã®å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                            setDisambigInfo({
                                isOpen: true,
                                keyword: keyword,
                                candidates: candidates
                            });
                        }
                    } 
                }} 
            />
        );
    };

    const renderSpecificInfo = () => {
        const o = item.original;
        if(item.type === 'nation') return <div className="text-sm text-gray-500 mb-4 bg-gray-50 p-2 rounded border border-gray-100 flex gap-4"><span>ğŸ“ {LOCATIONS[o.location]?.label}</span><span style={{color:NATION_RANKS[o.rank]?.color}}>ğŸ´ {NATION_RANKS[o.rank]?.label}</span></div>;
        if(item.type === 'event') return <div className="text-sm text-gray-500 mb-4 bg-gray-50 p-2 rounded border border-gray-100 flex gap-4"><span className="font-mono font-bold text-green-700">ğŸ“… {o.year}å¹´</span><span>Lv.{o.importance}</span></div>;
        if(item.type === 'char') return <div className="text-sm text-gray-500 mb-4 bg-gray-50 p-2 rounded border border-gray-100 flex gap-4"><span>ğŸ§¬ {o.race}</span><span className="font-mono text-blue-700">Lv.{o.level}</span></div>;
        if(item.type === 'org') return <div className="text-sm text-gray-500 mb-4 bg-gray-50 p-2 rounded border border-gray-100 flex gap-4"><span>ğŸ¢ {ORG_TYPES.find(t=>t.key===o.type)?.label}</span></div>;
        return null;
    };

    return (
        <div className="animate-fade-in pb-20">
            <DisambiguationModal 
                isOpen={disambigInfo.isOpen}
                onClose={() => setDisambigInfo({ ...disambigInfo, isOpen: false })}
                keyword={disambigInfo.keyword}
                candidates={disambigInfo.candidates}
                onSelect={(targetName) => {
                    setDisambigInfo({ ...disambigInfo, isOpen: false });
                    onLinkClick(targetName);
                }}
            />

            {/* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆï¼ˆãƒªãƒƒãƒç‰ˆï¼‰ */}
            <div className="sticky top-0 bg-white/95 backdrop-blur z-30 border-b shadow-sm mb-6 px-4 py-3 flex items-center gap-2 overflow-x-auto custom-scrollbar">
                <button onClick={onBack} className="flex items-center gap-1 text-gray-500 hover:bg-gray-100 px-3 py-1.5 rounded-full transition-colors text-xs font-bold shrink-0">
                    <Icons.ArrowLeft size={14}/> æˆ»ã‚‹
                </button>
                
                <div className="flex items-center text-xs font-bold text-gray-600">
                    {history.map((hItem, idx) => (
                        <div key={idx} className="flex items-center group">
                            <button 
                                onClick={() => onJumpHistory(idx)} 
                                className="relative px-3 py-1.5 bg-gray-100 hover:bg-blue-100 hover:text-blue-700 transition-all clip-path-chevron mx-[-5px] pl-5 first:pl-3 first:mx-0 z-10 hover:z-20 shadow-sm border-r border-white/50"
                                style={{ clipPath: 'polygon(0 0, calc(100% - 8px) 0, 100% 50%, calc(100% - 8px) 100%, 0 100%)' }}
                            >
                                <span className="max-w-[80px] md:max-w-[150px] truncate inline-block align-middle">{hItem.name}</span>
                            </button>
                        </div>
                    ))}
                    {history.length > 0 && <div className="w-4"></div>}
                    <div className="relative px-4 py-1.5 bg-yellow-400 text-yellow-900 shadow-md z-20"
                         style={{ clipPath: 'polygon(0 0, calc(100% - 8px) 0, 100% 50%, calc(100% - 8px) 100%, 0 100%)', marginLeft: history.length > 0 ? '-12px' : '0' }}
                    >
                        <span className="max-w-[150px] truncate inline-block align-middle">{item.name}</span>
                    </div>
                </div>
            </div>

            <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden relative max-w-4xl mx-auto">
                <div className="h-48 w-full bg-gray-800 relative overflow-hidden">
                    {item.image ? <img src={item.image} className="w-full h-full object-cover opacity-60 blur-sm scale-105"/> : <div className="opacity-10 w-full h-full flex items-center justify-center"><Icons.BookOpen size={64} color="white"/></div>}
                    <div className="absolute inset-0 bg-gradient-to-t from-white via-transparent to-transparent"></div>
                    <div className="absolute bottom-0 left-0 p-6 w-full flex justify-between items-end">
                        <div>
                            <span className={`inline-block px-2 py-0.5 rounded text-xs font-bold mb-2 shadow-sm border border-white/50 ${item.color}`}>{item.label}</span>
                            <h1 className="text-4xl md:text-5xl font-black text-gray-900 leading-none drop-shadow-sm" style={{textShadow: '2px 2px 0 #fff'}}>{item.name}</h1>
                        </div>
                        <div className="flex gap-2 mb-1">
                            {item.type === 'term' && isAuthorized && <button onClick={() => onDeleteTerm(item.id)} className="bg-white/80 hover:bg-red-100 text-red-500 p-2 rounded-full shadow border border-red-200 transition-colors" title="å‰Šé™¤"><Icons.Trash2 size={18}/></button>}
                            {isAuthorized && !isEditing && <button onClick={() => setIsEditing(true)} className="bg-white/80 hover:bg-blue-50 text-blue-600 p-2 rounded-full shadow border border-blue-200 transition-colors" title="ç·¨é›†"><Icons.Edit2 size={18}/></button>}
                        </div>
                    </div>
                </div>

                <div className="p-8">
                    {!isEditing && (
                        <div className="flex flex-col gap-2 mb-6">
                            {/* ã‚¿ã‚°è¡¨ç¤º */}
                            <div className="flex flex-wrap gap-2">
                                {displayTags.map((tag, i) => (
                                    <span key={i} className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-md border border-gray-200 flex items-center gap-1">
                                        <Icons.Tag size={10}/> {tag}
                                    </span>
                                ))}
                            </div>
                            {/* ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¡¨ç¤º */}
                            {savedAliases.length > 0 && (
                                <div className="text-xs text-gray-400 flex flex-wrap gap-2 items-center">
                                    <Icons.RefreshCw size={10} />
                                    <span>åˆ¥å/ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ:</span>
                                    {savedAliases.map((alias, i) => (
                                        <span key={i} className="bg-gray-50 px-1.5 rounded border border-gray-100">{alias}</span>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {renderSpecificInfo()}

                    {isEditing ? (
                        <div className="animate-fade-in space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-gray-50 p-4 rounded border border-gray-200">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">é–¢é€£ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                                    <div className="flex items-center gap-2">
                                        <Icons.Tag size={16} className="text-gray-400"/>
                                        <input type="text" value={tagInput} onChange={(e) => setTagInput(e.target.value)} className="w-full p-2 border rounded text-sm" placeholder="ä¾‹: æˆ¦äº‰, é­”æ³•"/>
                                    </div>
                                </div>
                                {/* â˜…è¿½åŠ : ã‚¨ã‚¤ãƒªã‚¢ã‚¹å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */}
                                <div className="bg-blue-50 p-4 rounded border border-blue-100">
                                    <label className="block text-xs font-bold text-blue-500 mb-1">åˆ¥åãƒ»ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                                    <div className="flex items-center gap-2">
                                        <Icons.RefreshCw size={16} className="text-blue-400"/>
                                        <input type="text" value={aliasInput} onChange={(e) => setAliasInput(e.target.value)} className="w-full p-2 border rounded text-sm" placeholder="ä¾‹: è‹±é›„æˆ¦äº‰, Hero War"/>
                                    </div>
                                    <p className="text-[10px] text-blue-400 mt-1">â€»ã“ã®è¨€è‘‰ãŒè¨˜äº‹å†…ã«å‡ºç¾ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ã“ã®ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã«ãªã‚Šã¾ã™ã€‚</p>
                                </div>
                            </div>

                            <QuillEditor 
                                initialContent={displayContent} 
                                onSave={(content) => {
                                    const newTags = tagInput.split(/,|ã€/).map(t => t.trim()).filter(t => t !== '');
                                    const newAliases = aliasInput.split(/,|ã€/).map(t => t.trim()).filter(t => t !== '');
                                    onSaveTermData(item.id, content, newTags, newAliases);
                                    setIsEditing(false);
                                }}
                                nationName={item.name}
                            />
                            <div className="text-right">
                                <button onClick={() => setIsEditing(false)} className="text-gray-500 hover:text-gray-700 mr-4">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </div>
                    ) : (
                        <div className="relative min-h-[200px]">
                            {renderContent()}
                            {!overrideDesc && (
                                <div className="mt-8 pt-4 border-t border-gray-100 text-right">
                                    <span className="text-xs text-gray-400 mr-2">â€»ã“ã‚Œã¯å…ƒãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™</span>
                                    {isAuthorized && <button onClick={() => setIsEditing(true)} className="text-xs text-blue-500 hover:underline">è¿½è¨˜ãƒ»ç·¨é›†ã™ã‚‹</button>}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

// --- NationProfileView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ä¿®æ­£ç‰ˆ: æ¨©é™ãƒã‚§ãƒƒã‚¯è¿½åŠ ) ---
const NationProfileView = ({ isAuthorized, setView, nation: initialNation, nations, entries, stats, characters, organizations, onEditEntry, onEditNation, onEditStats, onEditOverview, updateNation }) => {
    const [activeTab, setActiveTab] = useState('overview');
    const [isKeyCharModalOpen, setIsKeyCharModalOpen] = useState(false);
    const [isKeyOrgModalOpen, setIsKeyOrgModalOpen] = useState(false);
    const [viewingItem, setViewingItem] = useState(null);

    const nation = useMemo(() => nations.find(n => n.id === initialNation.id) || initialNation, [nations, initialNation]);

    useEffect(() => {
        if (document.getElementById('quill-custom-styles')) return;
        const style = document.createElement('style');
        style.id = 'quill-custom-styles';
        style.innerHTML = `
            .ql-font-gothic { font-family: 'Yu Gothic', 'YuGothic', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; }
            .ql-font-mincho { font-family: 'Yu Mincho', 'YuMincho', 'Hiragino Mincho ProN', 'HGS Mincho E', 'MS PMincho', serif; }
            .ql-font-serif { font-family: 'Times New Roman', 'YuMincho', serif; }
            .ql-font-sans-serif { font-family: Arial, Helvetica, sans-serif; }
            .ql-font-monospace { font-family: 'Courier New', Courier, monospace; }
        `;
        document.head.appendChild(style);
    }, []);

    if (!nation) return null;

    const { relatedEntries, relatedChars, relatedOrgs, sortedEras } = useMemo(() => {
        const targetNames = new Set([nation.name]);
        const targetEraIds = new Set();
        if (nation.eras) {
            nation.eras.forEach((era, idx) => {
                if (era.name) targetNames.add(era.name);
                targetEraIds.add(`${nation.id}_era_${idx}`);
            });
        }
        const rEntries = entries.filter(e => e.tags && e.tags.some(tag => targetNames.has(tag))).sort((a, b) => a.year - b.year);
        const rChars = characters.filter(c => c.affiliations && c.affiliations.some(aff => targetNames.has(typeof aff === 'string' ? aff : aff.name)));
        const rOrgs = organizations.filter(o => o.affiliationId === nation.id || targetEraIds.has(o.affiliationId));

        return { 
            relatedEntries: rEntries, 
            relatedChars: rChars, 
            relatedOrgs: rOrgs,
            sortedEras: (nation.eras || []).sort((a, b) => a.startYear - b.startYear)
        };
    }, [entries, characters, organizations, nation]);

    const relatedStats = useMemo(() => stats.filter(s => s.nationId === nation.id).sort((a, b) => a.year - b.year), [stats, nation]);
    const powerStructureData = useMemo(() => { const raw = nation.powerStructure; if (!raw) return []; return Array.isArray(raw) ? raw : [raw]; }, [nation]);

    const handleSaveKeyChars = (ids) => { updateNation({ ...nation, keyCharacterIds: ids }); setIsKeyCharModalOpen(false); };
    const handleSaveKeyOrgs = (ids) => { updateNation({ ...nation, keyOrganizationIds: ids }); setIsKeyOrgModalOpen(false); };

    const textOutlineStyle = { textShadow: '2px 2px 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff, 2px 0 0 #fff, -2px 0 0 #fff, 0 2px 0 #fff, 0 -2px 0 #fff' };
    const parseRuby = (html) => html ? html.replace(/\[(.*?)\|(.*?)\]/g, '<ruby>$1<rt>$2</rt></ruby>') : '';

    const treeCss = `
        .tf-tree { display: flex; text-align: center; }
        .tf-tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; padding-inline-start: 0; margin: 0; }
        .tf-tree li { list-style-type: none; position: relative; padding: 20px 5px 0 5px; display: flex; flex-direction: column; align-items: center; }
        .tf-tree li::before, .tf-tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #ccc; width: 50%; height: 20px; }
        .tf-tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tf-tree li:only-child::after, .tf-tree li:only-child::before { display: none; }
        .tf-tree li:only-child { padding-top: 0; }
        .tf-tree li:first-child::before { border: 0 none; }
        .tf-tree li:last-child::after { border: 0 none; }
        .tf-tree li:last-child::before { border-right: 1px solid #ccc; border-radius: 0 5px 0 0; }
        .tf-tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tf-tree ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #ccc; width: 0; height: 20px; }
    `;

    const renderReadOnlyTree = (node) => {
        let linkedData = null; let imageSrc = null; let DefaultIcon = Icons.User;
        if (node.linkType === 'org' && node.linkId) { linkedData = organizations.find(o => o.id === node.linkId); imageSrc = linkedData?.logo; DefaultIcon = Icons.Briefcase; } 
        else if (node.linkType === 'char' && node.linkId) { linkedData = characters.find(c => c.id === node.linkId); imageSrc = linkedData?.portrait; DefaultIcon = Icons.User; }

        return (
            <li key={node.id}>
                 <div className="flex flex-col items-center bg-white border border-gray-300 rounded shadow-sm min-w-[140px] max-w-[180px] overflow-hidden hover:shadow-md transition-shadow z-10 relative">
                    <div className="w-full h-12 bg-gray-50 flex items-center justify-center border-b border-gray-200 relative overflow-hidden">
                         {imageSrc ? <img src={imageSrc} className="w-full h-full object-cover" /> : <DefaultIcon className="text-gray-300" />}
                         {node.linkType && <div className={`absolute top-0 left-0 p-0.5 text-white text-[8px] ${node.linkType === 'org' ? 'bg-blue-500' : 'bg-green-500'}`}>{node.linkType === 'org' ? <Icons.Briefcase size={8}/> : <Icons.User size={8}/>}</div>}
                    </div>
                    <div className="p-2 text-center w-full">
                        <div className="font-bold text-sm text-gray-800 leading-tight mb-0.5">{node.name}</div>
                        {node.title && <div className="text-[10px] text-gray-500 mb-1">{node.title}</div>}
                        {linkedData ? ( <div className="text-[10px] bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded truncate mx-auto border border-blue-100 cursor-pointer hover:bg-blue-100 transition-colors" onClick={(e) => { e.stopPropagation(); setViewingItem({item: linkedData, type: node.linkType}); }}>{linkedData.name}</div> ) : ( <div className="text-[9px] text-gray-300">-</div> )}
                    </div>
                 </div>
                 {node.children && node.children.length > 0 && <ul>{node.children.map(child => renderReadOnlyTree(child))}</ul>}
            </li>
        );
    };

    const SidebarKeyList = ({ title, icon: Icon, items, allItems, onEdit, type, onItemClick }) => (
        <div className="bg-white p-6 rounded-lg shadow border border-gray-200 relative group/sidebar">
            <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-gray-500 text-xs uppercase flex items-center gap-2"><Icon size={16}/> {title}</h3>
                {isAuthorized && <button onClick={onEdit} className="text-xs bg-gray-100 text-gray-600 border border-gray-200 px-2 py-1 rounded hover:bg-gray-200 flex items-center gap-1 transition-colors"><Icons.Edit2 size={12} /> ç·¨é›†</button>}
            </div>
            <div className="space-y-3">
                {items && items.length > 0 ? items.map(id => {
                    const item = allItems.find(i => i.id === id); if (!item) return null;
                    let role = '';
                    if (type === 'char') { const aff = item.affiliations?.find(a => (typeof a === 'string' ? a : a.name) === nation.name) || item.affiliations?.[0]; role = (typeof aff === 'object' && aff.role) ? aff.role : ''; }
                    const rank = type === 'char' ? getLevelRank(item.level) : null;
                    return (
                        <div key={id} onClick={() => onItemClick(item, type)} className="flex items-center gap-3 p-2 rounded border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-md cursor-pointer transition-all">
                            <div className="w-10 h-10 rounded-full bg-gray-200 border border-gray-300 overflow-hidden flex-shrink-0">{(type === 'char' ? item.portrait : item.logo) ? <img src={type === 'char' ? item.portrait : item.logo} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-400"><Icon size={16}/></div>}</div>
                            <div className="overflow-hidden">
                                <div className="font-bold text-sm text-gray-800 truncate">{item.name}</div>
                                {role && <div className="text-xs text-blue-600 font-bold">{role}</div>}
                                <div className="flex flex-wrap items-center gap-1 mt-0.5">
                                    {!role && type === 'org' && item.type && <span className="text-xs text-gray-400">{ORG_TYPES.find(t=>t.key===item.type)?.label}</span>}
                                    {type === 'char' && item.level && rank ? ( <span className={`inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded text-[10px] font-bold border ${rank.bg} ${rank.color} ${rank.border}`}><rank.icon size={10} /> <span className="font-mono">Lv.{item.level}</span></span> ) : ( type === 'char' && item.level && <span className="font-mono font-bold text-indigo-400 text-xs">Lv.{item.level}</span> )}
                                </div>
                            </div>
                        </div>
                    );
                }) : ( <div className="text-center py-4 border-2 border-dashed border-gray-100 rounded"><p className="text-xs text-gray-400 mb-2">è¨­å®šãªã—</p>{isAuthorized && <button onClick={onEdit} className="text-xs text-blue-500 hover:underline">é¸æŠ</button>}</div> )}
            </div>
        </div>
    );

    return (
        <div className="space-y-6 animate-fade-in pb-20">
            <KeySelectionModal isOpen={isKeyCharModalOpen} onClose={() => setIsKeyCharModalOpen(false)} title="é‡è¦äººç‰©" candidates={relatedChars} selectedIds={nation.keyCharacterIds} onSave={handleSaveKeyChars} />
            <KeySelectionModal isOpen={isKeyOrgModalOpen} onClose={() => setIsKeyOrgModalOpen(false)} title="ä¸»è¦çµ„ç¹”" candidates={relatedOrgs} selectedIds={nation.keyOrganizationIds} onSave={handleSaveKeyOrgs} />
            <ItemDetailModal item={viewingItem?.item} type={viewingItem?.type} onClose={() => setViewingItem(null)} parseRuby={parseRuby} />

            <div className="flex items-center gap-4">
                <button onClick={() => setView('nation_list')} className="flex items-center gap-2 px-4 py-2 bg-white text-gray-700 font-bold rounded-lg shadow hover:bg-gray-50 transition-colors border border-gray-200">
                    <Icons.ArrowLeft size={20} /> ä¸€è¦§ã¸æˆ»ã‚‹
                </button>
            </div>

            <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden relative">
                <div className="h-32 w-full relative overflow-hidden" style={{ backgroundColor: nation.color || '#1f2937' }}>{nation.flag && <img src={nation.flag} className="w-full h-full object-cover opacity-30 blur-xl scale-110" />}<div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div></div>
                <div className="px-8 pb-0 relative flex flex-col md:flex-row items-end gap-6 -mt-16">
                    <div className="w-40 h-28 bg-white p-1 shadow-xl border-4 border-white flex-shrink-0 rounded-sm relative z-10">{nation.flag ? <img src={nation.flag} className="w-full h-full object-cover border border-gray-200" /> : <div className="w-full h-full bg-gray-100 flex items-center justify-center text-gray-400 text-xs font-bold">No Image</div>}</div>
                    <div className="flex-grow mb-4 relative z-10">
                        <div className="flex items-center justify-between">
                            <div>
                                <div className="flex items-center gap-2 mb-2"><span className="bg-yellow-100 border border-yellow-300 text-yellow-800 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">{LOCATIONS[nation.location || 'unknown']?.label}</span><span className="bg-gray-100 border border-gray-300 text-gray-600 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">{NATION_RANKS[nation.rank || 'minor_power']?.label}</span></div>
                                <h1 className="text-4xl font-black tracking-tight text-gray-900 leading-none mb-2" style={textOutlineStyle}>{nation.name}</h1>
                                <div className="flex gap-3 text-xs font-mono text-gray-500"><span className="bg-white/80 px-1.5 py-0.5 rounded border border-gray-200 backdrop-blur-sm">ID: {nation.id}</span></div>
                            </div>
                            {isAuthorized && <button onClick={onEditNation} className="mb-2 mr-2 bg-white/90 hover:bg-white text-gray-700 border border-gray-300 shadow-sm px-3 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-all"><Icons.Settings size={16} /> <span className="hidden sm:inline">å›½å®¶è¨­å®šã‚’ç·¨é›†</span></button>}
                        </div>
                    </div>
                </div>

                <div className="flex px-8 pt-4 border-t border-gray-100 bg-gray-50/50 gap-1 overflow-x-auto">
                    {[ {id: 'overview', icon: Icons.FileText, label: 'æ¦‚è¦ãƒ»å¤‰é·'}, {id: 'characters', icon: Icons.User, label: 'é–¢é€£äººç‰©', badge: relatedChars.length}, {id: 'organizations', icon: Icons.Briefcase, label: 'é–¢é€£çµ„ç¹”', badge: relatedOrgs.length}, {id: 'structure', icon: Icons.Structure, label: 'çµ±æ²»æ©Ÿæ§‹'}, {id: 'stats', icon: Icons.Activity, label: 'çµ±è¨ˆãƒ‡ãƒ¼ã‚¿'}, {id: 'timeline', icon: Icons.List, label: 'é–¢é€£å¹´è¡¨', badge: relatedEntries.length} ].map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-6 py-3 text-sm font-bold border-b-4 transition-colors whitespace-nowrap flex items-center gap-2 ${activeTab === tab.id ? 'border-yellow-500 text-gray-900 bg-yellow-50/50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'}`}>
                            <tab.icon size={18} /> {tab.label}
                            {tab.badge > 0 && <span className="bg-gray-200 text-gray-600 text-[10px] px-1.5 rounded-full">{tab.badge}</span>}
                        </button>
                    ))}
                </div>
            </div>

            <div className="animate-fade-in">
                {activeTab === 'overview' && (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white p-8 rounded-lg shadow border border-gray-200 min-h-[300px] relative">
                                <div className="flex justify-between items-center border-b pb-3 mb-4"><h3 className="font-bold text-gray-800 text-lg flex items-center gap-2"><Icons.BookOpen size={20} className="text-yellow-600"/> å›½å®¶æ¦‚è¦</h3>{isAuthorized && <button onClick={onEditOverview} className="bg-yellow-100 text-yellow-800 border border-yellow-300 px-3 py-1.5 rounded font-bold text-xs flex items-center gap-1 hover:bg-yellow-200 transition-colors shadow-sm"><Icons.Edit2 size={14} /> æ¦‚è¦ã‚’ç·¨é›†</button>}</div>
                                {nation.note ? <div className="text-base leading-loose text-gray-800 font-serif ql-editor" style={{ padding: 0, overflow: 'visible' }} dangerouslySetInnerHTML={{ __html: parseRuby(nation.note) }} /> : <div className="text-center py-10"><p className="text-gray-400 italic font-serif mb-4">è¨˜è¿°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>{isAuthorized && <button onClick={onEditOverview} className="text-blue-600 hover:underline text-sm">ç·¨é›†ã—ã¦è¿½åŠ ã™ã‚‹</button>}</div>}
                            </div>
                        </div>
                        <div className="lg:col-span-1 space-y-6">
                            <SidebarKeyList title="é‡è¦äººç‰©" icon={Icons.User} items={nation.keyCharacterIds} allItems={characters} onEdit={() => setIsKeyCharModalOpen(true)} type="char" onItemClick={(item, type) => setViewingItem({item, type})} />
                            <SidebarKeyList title="ä¸»è¦çµ„ç¹”" icon={Icons.Briefcase} items={nation.keyOrganizationIds} allItems={organizations} onEdit={() => setIsKeyOrgModalOpen(true)} type="org" onItemClick={(item, type) => setViewingItem({item, type})} />
                            <div className="bg-white p-6 rounded-lg shadow border border-gray-200">
                                <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-gray-500 text-xs uppercase flex items-center gap-2"><Icons.History size={16}/> æ­´å²çš„å¤‰é·</h3>{isAuthorized && <button onClick={onEditNation} className="text-xs bg-gray-100 text-gray-600 border border-gray-200 px-2 py-1 rounded hover:bg-gray-200 flex items-center gap-1"><Icons.Settings size={12} /> å¤‰é·ã‚’ç·¨é›†</button>}</div>
                                <div className="relative border-l-2 border-gray-200 ml-3 space-y-8 py-2">
                                    {sortedEras.map((era, idx) => {
                                        const isCollapse = era.type === 'collapse'; let eventBadge = null; const eventType = era.event?.type;
                                        if (eventType && eventType !== 'none') {
                                            const eventDef = ERA_EVENT_TYPES[eventType];
                                            if (eventDef) {
                                                const targetIds = era.event.targetIds || (era.event.targetId ? [era.event.targetId] : []);
                                                const targetNames = targetIds.map(tid => { const n = nations.find(nav => nav.id === tid); return n ? n.name : ''; }).filter(n => n).join('ãƒ»');
                                                let labelText = eventDef.label; let badgeClass = "bg-gray-100 text-gray-600 border-gray-200";
                                                if (['annexed_by', 'merger'].includes(eventType)) { labelText = targetNames ? `${targetNames}ã«ä½µåˆ` : "ä»–å›½ã«ä½µåˆ"; badgeClass = "bg-red-50 text-red-600 border-red-100"; } else if (eventType === 'partitioned_by') { labelText = targetNames ? `${targetNames}ã«ã‚ˆã‚Šåˆ†å‰²` : "åˆ†å‰²çµ±æ²»ã•ã‚Œã‚‹"; badgeClass = "bg-red-50 text-red-600 border-red-100"; } else if (['independence', 'splinter'].includes(eventType)) { labelText = targetNames ? `${targetNames}ã‚ˆã‚Š${eventDef.label}` : eventDef.label; badgeClass = "bg-indigo-50 text-indigo-700 border-indigo-100"; } else if (eventType === 'foundation') { labelText = "å»ºå›½ãƒ»æˆç«‹"; badgeClass = "bg-green-50 text-green-700 border-green-100"; } else if (eventType === 'foundation_puppet') { labelText = targetNames ? `${targetNames}ã®å‚€å„¡ã¨ã—ã¦æˆç«‹` : "å‚€å„¡å›½ã¨ã—ã¦æˆç«‹"; badgeClass = "bg-purple-50 text-purple-700 border-purple-100"; } else if (eventType === 'regime_change') { labelText = "æ”¿ä½“å¤‰æ›´"; badgeClass = "bg-blue-50 text-blue-700 border-blue-100"; } else if (eventType === 'be_puppet') { labelText = targetNames ? `${targetNames}ã®å‚€å„¡ã«ãªã‚‹` : "å‚€å„¡åŒ–ã•ã‚Œã‚‹"; badgeClass = "bg-purple-50 text-purple-700 border-purple-100"; }
                                                eventBadge = ( <span className={`inline-flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded border ${badgeClass} mt-1 w-fit`}> {eventDef.icon} {labelText} </span> );
                                            }
                                        }
                                        return ( <div key={idx} className="relative pl-6"> <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 border-white shadow-sm ${isCollapse ? 'bg-gray-400' : 'bg-blue-500'}`}></div> <div className="flex flex-col"> <span className="text-xs font-mono font-bold text-gray-500 mb-1 block">{era.startYear}å¹´</span> <span className={`font-bold text-base ${isCollapse ? 'text-gray-500 line-through' : 'text-gray-800'}`}>{era.name}</span> {eventBadge} {era.params && Object.keys(era.params).length > 0 && ( <div className="mt-3 space-y-2"> {NATION_PARAMS.map(p => { const val = era.params[p.key]; if (!val || !val.name) return null; return ( <div key={p.key} className="text-xs flex flex-col bg-gray-50 p-2 rounded border border-gray-100"> <span className="text-[9px] font-bold text-gray-400 mb-0.5">{p.label}</span> <div className="flex items-center gap-2"> <div className="w-2 h-2 rounded-full flex-shrink-0" style={{backgroundColor: val.color || p.defaultColor}}></div> <span className="font-bold text-gray-800">{val.name}</span> </div> </div> ); })} </div> )} </div> </div> );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {activeTab === 'characters' && (
                    <div className="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h3 className="font-bold text-lg text-gray-800 mb-6 flex items-center gap-2"><Icons.User size={20} className="text-blue-600"/> é–¢é€£äººç‰©ä¸€è¦§ ({relatedChars.length})</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {relatedChars.sort((a, b) => { const aKey = nation.keyCharacterIds?.includes(a.id) ? 1 : 0; const bKey = nation.keyCharacterIds?.includes(b.id) ? 1 : 0; return bKey - aKey; }).map(char => {
                                const isKey = nation.keyCharacterIds?.includes(char.id); const aff = char.affiliations?.find(a => (typeof a === 'string' ? a : a.name) === nation.name) || char.affiliations?.[0]; const role = (typeof aff === 'object' && aff.role) ? aff.role : ''; const rank = getLevelRank(char.level);
                                return ( <div key={char.id} onClick={() => setViewingItem({item: char, type: 'char'})} className={`p-4 rounded-lg border flex items-start gap-4 cursor-pointer transition-all ${isKey ? 'bg-blue-50 border-blue-200 hover:shadow-md' : 'bg-white border-gray-100 hover:bg-gray-50 hover:shadow-sm'}`}> <div className="w-16 h-16 rounded-full bg-gray-200 border-2 border-white shadow overflow-hidden flex-shrink-0"> {char.portrait ? <img src={char.portrait} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-400"><Icons.User size={24}/></div>} </div> <div className="flex-grow overflow-hidden"> <div className="flex items-center gap-2"> <h4 className="font-bold text-lg text-gray-900 truncate">{char.name}</h4> {isKey && <span className="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200 font-bold flex-shrink-0">é‡è¦</span>} </div> <div className="text-sm text-gray-600 font-bold mb-1">{role || 'æ‰€å±'}</div> <div className="text-xs text-gray-500 flex items-center gap-2 mb-2"> <span className="px-1.5 py-0.5 rounded bg-gray-100 text-gray-600">{char.race}</span> {char.level && rank ? ( <span className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-bold border ${rank.bg} ${rank.color} ${rank.border}`}><rank.icon size={10} /> <span className="font-mono">Lv.{char.level}</span></span> ) : ( char.level && <span className="font-mono font-bold text-indigo-400">Lv.{char.level}</span> )} <span>{char.birthYear || '?'} - {char.deathYear || '?'}</span> </div> {char.note && <div className="text-xs text-gray-500 line-clamp-2 border-t border-gray-100 pt-2 mt-1">{char.note.replace(/<[^>]+>/g, '')}</div>} </div> </div> );
                            })}
                            {relatedChars.length === 0 && <p className="text-gray-400 italic col-span-2">é–¢é€£ã™ã‚‹äººç‰©ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>}
                        </div>
                    </div>
                )}

                {activeTab === 'organizations' && (
                    <div className="bg-white rounded-lg shadow border border-gray-200 p-6">
                        <h3 className="font-bold text-lg text-gray-800 mb-6 flex items-center gap-2"><Icons.Briefcase size={20} className="text-blue-600"/> é–¢é€£çµ„ç¹”ä¸€è¦§ ({relatedOrgs.length})</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {relatedOrgs.sort((a, b) => { const aKey = nation.keyOrganizationIds?.includes(a.id) ? 1 : 0; const bKey = nation.keyOrganizationIds?.includes(b.id) ? 1 : 0; return bKey - aKey; }).map(org => {
                                const isKey = nation.keyOrganizationIds?.includes(org.id); const typeInfo = ORG_TYPES.find(t => t.key === org.type);
                                return ( <div key={org.id} onClick={() => setViewingItem({item: org, type: 'org'})} className={`p-4 rounded-lg border flex items-start gap-4 cursor-pointer transition-all ${isKey ? 'bg-blue-50 border-blue-200 hover:shadow-md' : 'bg-white border-gray-100 hover:bg-gray-50 hover:shadow-sm'}`}> <div className="w-16 h-16 rounded bg-white border border-gray-200 flex items-center justify-center overflow-hidden flex-shrink-0 p-1"> {org.logo ? <img src={org.logo} className="w-full h-full object-contain"/> : <span className="text-2xl">{typeInfo?.icon}</span>} </div> <div className="flex-grow overflow-hidden"> <div className="flex items-center gap-2"> <h4 className="font-bold text-lg text-gray-900 truncate">{org.name}</h4> {isKey && <span className="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-200 font-bold flex-shrink-0">ä¸»è¦</span>} </div> <div className="text-xs text-gray-500 mb-2">{typeInfo?.label}</div> <p className="text-xs text-gray-600 line-clamp-2">{org.note || 'æ¦‚è¦ãªã—'}</p> </div> </div> );
                            })}
                            {relatedOrgs.length === 0 && <p className="text-gray-400 italic col-span-2">é–¢é€£ã™ã‚‹çµ„ç¹”ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>}
                        </div>
                    </div>
                )}

                {activeTab === 'structure' && (
                    <div className="bg-white rounded-lg shadow border border-gray-200 p-8 min-h-[400px]">
                        <style>{treeCss}</style>
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><Icons.Structure size={24} className="text-purple-600"/> çµ±æ²»æ©Ÿæ§‹ãƒ»æ¨©åŠ›æ§‹é€ å›³</h3>
                            {isAuthorized && <button onClick={() => { setView('power_structure'); }} className="bg-purple-100 text-purple-800 border border-purple-300 px-4 py-2 rounded font-bold text-sm flex items-center gap-2 hover:bg-purple-200 transition-colors shadow-sm"><Icons.Edit2 size={16} /> æ§‹é€ ã‚’ç·¨é›†</button>}
                        </div>
                        <div className="w-full overflow-x-auto pb-8 custom-scrollbar bg-[#f9fafb] rounded border border-gray-100 p-8">
                            {powerStructureData.length > 0 ? ( <div className="flex gap-16 justify-center min-w-max"> {powerStructureData.map((rootNode, index) => ( <div key={index} className="tf-tree"> <ul>{renderReadOnlyTree(rootNode)}</ul> </div> ))} </div> ) : ( <div className="text-center py-20 text-gray-400"> <Icons.Structure size={48} className="mx-auto mb-4 opacity-20"/> <p>æ¨©åŠ›æ§‹é€ å›³ãŒæœªä½œæˆã§ã™ã€‚</p> <p className="text-sm">ã€Œæ§‹é€ ã‚’ç·¨é›†ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚</p> </div> )}
                        </div>
                    </div>
                )}

                {activeTab === 'stats' && (
                    <div className="space-y-6">
                        <div className="flex justify-end">{isAuthorized && <button onClick={onEditStats} className="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-800 flex items-center gap-2 transition-colors"><Icons.BarChart2 size={18} /> çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ãƒ»ä¿®æ­£</button>}</div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white p-6 rounded-lg shadow border border-gray-200"><SimpleLineChart title="ç·äººå£æ¨ç§»" data={relatedStats} nations={[nation]} getValue={(d) => d.population} formatValue={(v, isShort) => formatJapaneseNumber(v, 'äºº', isShort)} icon={Icons.Users} dataType="population" /></div>
                            <div className="bg-white p-6 rounded-lg shadow border border-gray-200"><SimpleLineChart title="GDPæ¨ç§»" data={relatedStats} nations={[nation]} getValue={(d) => d.gdp} formatValue={(v, isShort) => formatJapaneseNumber(v, 'å††', isShort)} icon={Icons.BarChart2} dataType="gdp" /></div>
                        </div>
                    </div>
                )}

                {activeTab === 'timeline' && (
                    <div className="bg-white p-8 rounded-lg shadow border border-gray-200 min-h-[400px]">
                        <div className="flex items-center justify-between mb-6 border-b pb-4"><h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><Icons.List size={24} className="text-green-600"/> é–¢é€£å¹´è¡¨</h3><span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">{relatedEntries.length} ä»¶ã®è¨˜éŒ²</span></div>
                        <div className="space-y-0">
                            {relatedEntries.map((entry, idx) => (
                                <div key={entry.id} className="flex gap-6 p-4 hover:bg-gray-50 transition-all group border-b border-gray-100 last:border-0 relative">
                                    <div className="flex-shrink-0 w-28 pt-1 text-right"><div className="font-mono font-bold text-lg text-gray-700">{entry.year}å¹´</div><div className="text-xs text-gray-400">{entry.month ? entry.month + 'æœˆ' : ''}{entry.day ? entry.day + 'æ—¥' : ''}</div></div>
                                    <div className="flex-grow relative pl-6 border-l-2 border-gray-200 group-hover:border-green-300 transition-colors"><div className={`absolute -left-[7px] top-2 w-3 h-3 rounded-full border-2 border-white shadow-sm ${importanceLevels[entry.importance||2].bg.replace('bg-', 'bg-').replace('-50', '-400')}`}></div><h4 className="font-bold text-lg text-gray-900 mb-1">{entry.title}</h4><p className="text-sm text-gray-600 leading-relaxed">{entry.content}</p></div>
                                    {isAuthorized && <div className="absolute right-4 top-4 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => onEditEntry(entry)} className="p-2 bg-white text-gray-400 hover:text-blue-600 border border-gray-200 rounded-lg shadow-sm"><Icons.Edit2 size={16} /></button></div>}
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// --- MainMenu ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (æœ€æ–°ç‰ˆ) ---
const MainMenu = ({ 
    setView, handleCreateNew, handleExport, fileInputRef, convertFileInputRef, 
    currentUser, isAuthorized, handleLogin, handleLogout, userRole,
    // è¿½åŠ : ãƒ‡ãƒ¼ã‚¿ã¨å‘ŠçŸ¥æ©Ÿèƒ½ç”¨ãƒ—ãƒ­ãƒƒãƒ—ã‚¹
    entries = [], nations = [], characters = [], organizations = [], 
    announcements = "", onSaveAnnouncements 
}) => {
    
    // å‘ŠçŸ¥ç·¨é›†ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
    const [isEditingAnnounce, setIsEditingAnnounce] = React.useState(false);
    const [announceText, setAnnounceText] = React.useState(announcements);

    React.useEffect(() => { setAnnounceText(announcements); }, [announcements]);

    const handleSaveAnnounce = () => {
        if(onSaveAnnouncements) onSaveAnnouncements(announceText);
        setIsEditingAnnounce(false);
    };

    // æœ€è¿‘ä½œæˆã•ã‚ŒãŸé …ç›®ã‚’æŠ½å‡º (IDãŒã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚ã‚‹ã“ã¨ã‚’åˆ©ç”¨ã—ã¦é™é †ã‚½ãƒ¼ãƒˆ)
    const recentItems = React.useMemo(() => {
        const all = [
            ...entries.map(e => ({ ...e, dataType: 'history', label: 'æ­´å²', icon: Icons.History, id: e.id || '0' })),
            ...nations.map(n => ({ ...n, dataType: 'nation', label: 'å›½å®¶', icon: Icons.Globe, id: n.id || '0' })),
            ...characters.map(c => ({ ...c, dataType: 'char', label: 'äººç‰©', icon: Icons.User, id: c.id || '0' })),
            ...organizations.map(o => ({ ...o, dataType: 'org', label: 'çµ„ç¹”', icon: Icons.Briefcase, id: o.id || '0' }))
        ];
        // ID(æ–‡å­—åˆ—)ã‚’æ•°å€¤å¤‰æ›ã—ã¦æ¯”è¼ƒã€‚å¤‰æ›ã§ããªã„å ´åˆã¯0æ‰±ã„
        return all.sort((a, b) => (parseInt(b.id) || 0) - (parseInt(a.id) || 0)).slice(0, 6);
    }, [entries, nations, characters, organizations]);

    // æ¨©é™ãŒãªã„å ´åˆã®ç„¡åŠ¹åŒ–ã‚¹ã‚¿ã‚¤ãƒ«
    const disabledClass = !isAuthorized ? "opacity-40 grayscale pointer-events-none select-none" : "";

    const MenuBtn = ({ onClick, icon: Icon, label, subLabel, color, className="" }) => (
        <button onClick={onClick} className={`group relative flex flex-col items-center justify-center p-4 bg-white border-2 border-gray-200 rounded-xl shadow-sm hover:shadow-lg hover:border-yellow-400 hover:-translate-y-1 transition-all duration-200 h-32 w-full ${className}`}>
            <div className={`p-3 rounded-full mb-2 transition-colors ${color || 'bg-gray-100 text-gray-500 group-hover:bg-yellow-100 group-hover:text-yellow-700'}`}>
                <Icon size={28} />
            </div>
            <span className="font-bold text-gray-700 group-hover:text-gray-900">{label}</span>
            {subLabel && <span className="text-[10px] text-gray-400 mt-1">{subLabel}</span>}
        </button>
    );

    const ActionBtn = ({ onClick, icon: Icon, label, className = "" }) => (
        <button onClick={onClick} className={`flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors shadow-sm ${className}`}>
            <Icon size={16}/> {label}
        </button>
    );

    return (
        <div className="min-h-screen bg-[#f0f2f5] flex flex-col items-center justify-center p-6 animate-fade-in">
            {/* ã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´ */}
            <div className="text-center mb-8 scale-110">
                <div className="inline-flex items-center justify-center p-4 bg-[#1a1a1a] rounded-2xl shadow-2xl mb-4 ring-4 ring-yellow-500/20">
                    <Icons.BookOpen size={48} className="text-yellow-500" />
                </div>
                <h1 className="text-4xl font-black text-gray-800 tracking-[0.2em] mb-2" style={{textShadow: '2px 2px 0px white'}}>è‹±è¦‡æ­´ä»£è¨˜</h1>
                <p className="text-xs font-mono text-gray-400 tracking-[0.5em] uppercase">ãƒ˜ãƒ«ãƒ¡ãƒã‚¢ã®å¤§åœ° è¨­å®šé›†</p>
            </div>

            <div className="w-full max-w-6xl space-y-6">
                
                {/* ä¸Šéƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤ */}
                <div className="flex flex-wrap justify-center gap-4 items-center mb-4">
                    {!currentUser ? (
                        <ActionBtn onClick={handleLogin} icon={Icons.Users} label="ãƒ­ã‚°ã‚¤ãƒ³" className="bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100" />
                    ) : (
                        <div className="flex items-center gap-3">
                            <div className="flex flex-col items-end">
                                {userRole === 'pending' ? <span className="text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded border border-yellow-200 animate-pulse">æ‰¿èªå¾…ã¡</span> : 
                                 isAuthorized ? <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">ç·¨é›†å¯èƒ½</span> : 
                                 <span className="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200">ã‚²ã‚¹ãƒˆ</span>}
                                <span className="text-[10px] text-gray-400 mt-0.5">{currentUser.displayName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</span>
                            </div>
                            <ActionBtn onClick={handleLogout} icon={Icons.X} label="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" className="bg-gray-100 text-gray-600 hover:bg-gray-200" />
                        </div>
                    )}
                    <div className="h-8 w-px bg-gray-300 mx-2 hidden sm:block"></div>
                    <ActionBtn onClick={() => setView('help')} icon={Icons.HelpCircle} label="ä½¿ã„æ–¹ (Help)" />
                </div>

                {/* MANAGE ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                <div className={`bg-gray-50/50 p-6 rounded-2xl border border-dashed border-gray-300 relative transition-all ${disabledClass}`}>
                    {!isAuthorized && (
                        <div className="absolute inset-0 z-10 flex items-center justify-center">
                            <div className="bg-white/80 backdrop-blur-sm px-6 py-3 rounded-full border border-gray-200 shadow-sm font-bold text-gray-500 flex items-center gap-2">
                                <Icons.Lock size={16}/> ç·¨é›†æ©Ÿèƒ½ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™
                            </div>
                        </div>
                    )}
                    <div className="flex items-center gap-3 mb-4">
                        <span className="bg-yellow-500 text-white text-xs font-bold px-3 py-1 rounded-full tracking-widest">MANAGE</span>
                        <span className="text-sm text-gray-500 font-bold">æƒ…å ±ã®ç·¨é›†ãƒ»è¨˜éŒ²</span>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <button onClick={handleCreateNew} className="group relative flex flex-col items-center justify-center p-4 bg-yellow-500 border-2 border-yellow-600 rounded-xl shadow-md hover:shadow-xl hover:bg-yellow-400 hover:-translate-y-1 transition-all duration-200 h-32 w-full text-white">
                            <div className="p-3 rounded-full mb-2 bg-yellow-700/20"><Icons.Edit2 size={28} /></div>
                            <span className="font-black tracking-wider">æ­´å²ã‚’åˆ»ã‚€</span><span className="text-[10px] opacity-80 mt-1">å¹´è¡¨ã«è¿½åŠ </span>
                        </button>
                        <MenuBtn onClick={() => setView('settings')} icon={Icons.Globe} label="å›½å®¶ç·¨æˆ" subLabel="åŸºæœ¬è¨­å®šãƒ»å¤‰é·" />
                        <MenuBtn onClick={() => setView('characters')} icon={Icons.User} label="äººç‰©ç®¡ç†" subLabel="é‡è¦äººç‰©" />
                        <MenuBtn onClick={() => setView('organizations')} icon={Icons.Briefcase} label="çµ„ç¹”ç®¡ç†" subLabel="ã‚®ãƒ«ãƒ‰ãƒ»çµç¤¾" />
                        <MenuBtn onClick={() => setView('statsEdit')} icon={Icons.BarChart2} label="çµ±è¨ˆç·¨é›†" subLabel="äººå£ãƒ»GDP" />
                        <MenuBtn onClick={() => setView('power_structure')} icon={Icons.Structure} label="æ¨©åŠ›æ§‹é€ " subLabel="çµ„ç¹”å›³" />
                    </div>
                </div>

                {/* VIEW ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (1è¡Œã«çµ±ä¸€) */}
                <div className="bg-gray-50/50 p-6 rounded-2xl border border-dashed border-gray-300">
                    <div className="flex items-center gap-3 mb-4">
                        <span className="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full tracking-widest">VIEW</span>
                        <span className="text-sm text-gray-500 font-bold">æƒ…å ±ã®é–²è¦§ãƒ»åˆ†æ</span>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <button onClick={() => setView('timeline')} className="group relative flex flex-col items-center justify-center p-4 bg-blue-600 border-2 border-blue-700 rounded-xl shadow-md hover:shadow-xl hover:bg-blue-500 hover:-translate-y-1 transition-all duration-200 h-32 w-full text-white">
                            <div className="p-3 rounded-full mb-2 bg-blue-800/30"><Icons.History size={28} /></div>
                            <span className="font-black tracking-wider">å¹´è¡¨é–²è¦§</span><span className="text-[10px] opacity-80 mt-1">å…¨æ­´å²ã‚’ç¢ºèª</span>
                        </button>
                        
                        <MenuBtn onClick={() => setView('nation_list')} icon={Icons.LayoutGrid} label="å›½å®¶ä¸€è¦§" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                        <MenuBtn onClick={() => setView('genealogy')} icon={Icons.GitMerge} label="èˆˆäº¡ç³»è­œå›³" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                        <MenuBtn onClick={() => setView('graph')} icon={Icons.Activity} label="çµ±è¨ˆã‚°ãƒ©ãƒ•" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                        <MenuBtn onClick={() => setView('table')} icon={Icons.List} label="ä½“åˆ¶ä¸€è¦§è¡¨" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                        <MenuBtn onClick={() => setView('glossary')} icon={Icons.BookOpen} label="ç”¨èªé›†" subLabel="ç™¾ç§‘äº‹å…¸" color="text-blue-500 bg-blue-50 group-hover:bg-blue-100 group-hover:text-blue-600"/>
                    </div>
                </div>

                {/* æ–°è¦è¿½åŠ : ä¸‹éƒ¨ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 pt-2">
                    
                    {/* å·¦å´: æœ€è¿‘ä½œæˆã•ã‚ŒãŸè¨­å®š */}
                    <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-5 overflow-hidden relative">
                        <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-gray-400 to-gray-200"></div>
                        <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2 pb-2 border-b border-gray-100">
                            <Icons.Clock size={20} className="text-gray-400"/> æœ€è¿‘è¿½åŠ ã•ã‚ŒãŸé …ç›®
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {recentItems.length > 0 ? recentItems.map((item, idx) => (
                                <div key={idx} className="flex items-center gap-3 p-2 rounded-lg bg-gray-50 border border-gray-100 hover:bg-white hover:shadow-md hover:border-blue-200 transition-all cursor-default group">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${item.dataType === 'nation' ? 'bg-indigo-100 text-indigo-600' : item.dataType === 'char' ? 'bg-blue-100 text-blue-600' : item.dataType === 'org' ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'}`}>
                                        <item.icon size={14} />
                                    </div>
                                    <div className="overflow-hidden">
                                        <div className="text-xs font-bold text-gray-400 flex items-center gap-1">
                                            {item.label} <span className="opacity-50">#{typeof item.id === 'string' ? item.id.slice(-4) : item.id}</span>
                                        </div>
                                        <div className="font-bold text-gray-800 text-sm truncate group-hover:text-blue-700">
                                            {item.title || item.name}
                                        </div>
                                    </div>
                                    {/* æ–°ç€ãƒãƒƒã‚¸ (æœ€æ–°2ä»¶ã®ã¿) */}
                                    {idx < 2 && <span className="ml-auto text-[9px] bg-red-500 text-white px-1.5 py-0.5 rounded animate-pulse">NEW</span>}
                                </div>
                            )) : (
                                <div className="col-span-2 text-center text-gray-400 text-xs py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            )}
                        </div>
                    </div>

                    {/* å³å´: å‘ŠçŸ¥ãƒœãƒ¼ãƒ‰ */}
                    <div className="bg-yellow-50/50 rounded-xl shadow-sm border border-yellow-200 p-5 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-24 h-24 bg-yellow-200/20 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
                        <div className="flex justify-between items-start mb-4 border-b border-yellow-100 pb-2">
                            <h3 className="font-bold text-yellow-800 flex items-center gap-2">
                                <Icons.Info size={20} /> é‹å–¶ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›
                            </h3>
                            {isAuthorized && !isEditingAnnounce && (
                                <button onClick={() => setIsEditingAnnounce(true)} className="text-yellow-600 hover:bg-yellow-100 p-1.5 rounded transition-colors" title="ç·¨é›†">
                                    <Icons.Edit2 size={16} />
                                </button>
                            )}
                        </div>

                        {isEditingAnnounce ? (
                            <div className="animate-fade-in">
                                <textarea 
                                    value={announceText} 
                                    onChange={(e) => setAnnounceText(e.target.value)} 
                                    className="w-full h-32 p-2 border border-yellow-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400 mb-2 bg-white"
                                    placeholder="å‘ŠçŸ¥å†…å®¹ã‚’å…¥åŠ›..."
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setIsEditingAnnounce(false)} className="px-3 py-1 text-xs text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={handleSaveAnnounce} className="px-3 py-1 text-xs bg-yellow-500 text-white font-bold rounded shadow hover:bg-yellow-600">ä¿å­˜</button>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white/60 p-3 rounded-lg border border-yellow-100 min-h-[100px] text-sm text-gray-700 leading-relaxed whitespace-pre-wrap font-medium relative z-10">
                                {announceText || <span className="text-gray-400 italic">ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</span>}
                            </div>
                        )}
                        <div className="mt-4 text-center">
                            <span className="text-[10px] text-yellow-600/50 font-mono">SYSTEM NOTICE BOARD</span>
                        </div>
                    </div>
                </div>

            </div>
            
            <div className="mt-12 text-center text-gray-400 text-xs font-mono">
                <p>by HELMENEA PROJECT</p>
            </div>
        </div>
    );
};

// --- ãƒ‡ãƒ¼ã‚¿åˆ†å‰²ä¿å­˜ç”¨ã®å®šæ•°ã¨é–¢æ•° ---
const CHUNK_SIZE = 800000; // Firestoreã®åˆ¶é™å¯¾ç­– (ç´„1MB)
const chunkString = (str, length) => {
    const size = Math.ceil(str.length / length);
    const r = Array(size);
    let offset = 0;
    for (let i = 0; i < size; i++) {
        r[i] = str.substr(offset, length);
        offset += length;
    }
    return r;
};

// --- ProgressToast ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ãƒ‡ãƒ¼ã‚¿é€šä¿¡çŠ¶æ³ã®è¡¨ç¤º) ---
const ProgressToast = ({ tasks }) => {
    const activeKeys = Object.keys(tasks);
    if (activeKeys.length === 0) return null;

    return (
        <div className="fixed bottom-4 right-4 z-[200] space-y-2 pointer-events-none">
            {activeKeys.map(key => {
                const task = tasks[key];
                const percent = task.total ? Math.round((task.current / task.total) * 100) : 0;
                return (
                    <div key={key} className="bg-gray-900 text-white px-4 py-3 rounded shadow-lg flex items-center gap-3 animate-fade-in min-w-[200px]">
                        <div className="w-4 h-4 border-2 border-t-transparent border-white rounded-full animate-spin"></div>
                        <div className="flex-grow">
                            <div className="text-xs font-bold mb-1">{task.label}</div>
                            <div className="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden">
                                <div className="bg-green-500 h-full transition-all duration-300" style={{ width: `${percent}%` }}></div>
                            </div>
                        </div>
                        <span className="text-xs font-mono">{percent}%</span>
                    </div>
                );
            })}
        </div>
    );
};

// --- TimelineView ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ç­‰é–“éš”ãƒ»é †åºãƒ™ãƒ¼ã‚¹ç‰ˆ) ---
const TimelineView = ({ 
    entries, 
    nations, 
    stats, 
    onSelectEntry,
    onEditEntry,
    isAuthorized
}) => {
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
    const [searchTerm, setSearchTerm] = useState('');
    const [filterTags, setFilterTags] = useState([]);
    const [filterImportance, setFilterImportance] = useState([]);
    const [showFilters, setShowFilters] = useState(false);
    
    const [showStats, setShowStats] = useState(false);
    const [expandedStatsYears, setExpandedStatsYears] = useState([]);

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
    const filteredItems = useMemo(() => {
        let filteredEntries = entries;
        if (searchTerm) {
            const lowerTerm = searchTerm.toLowerCase();
            filteredEntries = filteredEntries.filter(e => 
                e.title.toLowerCase().includes(lowerTerm) || 
                (e.reading && e.reading.toLowerCase().includes(lowerTerm)) || 
                (e.content && e.content.toLowerCase().includes(lowerTerm)) || 
                e.year.toString().includes(lowerTerm)
            );
        }
        if (filterTags.length > 0) {
            filteredEntries = filteredEntries.filter(e => e.tags && filterTags.every(tag => e.tags.includes(tag)));
        }
        if (filterImportance.length > 0) {
            filteredEntries = filteredEntries.filter(e => filterImportance.includes(e.importance || 2));
        }

        const items = [];
        // ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
        filteredEntries.forEach(entry => {
            items.push({ type: 'entry', year: entry.year, month: entry.month || 0, day: entry.day || 0, data: entry });
        });

        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¿½åŠ 
        if (showStats) {
            const statsYears = [...new Set(stats.map(s => s.year))];
            statsYears.forEach(year => {
                if (searchTerm && !year.toString().includes(searchTerm)) return;
                items.push({ type: 'stats_marker', year: year, month: -1, day: -1, id: `stats_marker_${year}` });
            });
        }

        return items.sort((a, b) => {
            if (a.year !== b.year) return a.year - b.year;
            if (a.month !== b.month) return a.month - b.month;
            return a.day - b.day;
        });
    }, [entries, stats, searchTerm, filterTags, filterImportance, showStats]);

    const allTags = useMemo(() => { 
        const tags = new Set(); 
        entries.forEach(e => e.tags?.forEach(t => tags.add(t))); 
        return Array.from(tags).sort(); 
    }, [entries]);

    // --- â˜…å¤‰æ›´: ç­‰é–“éš”é…ç½®ã®ãƒŸãƒ‹å¹´è¡¨ ---
    const MiniTimeline = ({ items }) => {
        const events = items.filter(i => i.type === 'entry');
        if (events.length === 0) return null;

        // ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«
        const getMarkerStyle = (level) => {
            const lv = parseInt(level) || 2;
            if (lv >= 6) return { color: "text-rose-500", bg: "bg-rose-500", size: 16, icon: Icons.Sun, z: 10 }; 
            if (lv === 5) return { color: "text-yellow-500", bg: "bg-yellow-500", size: 14, icon: Icons.Star, z: 8 }; 
            if (lv === 4) return { color: "text-purple-500", bg: "bg-purple-500", size: 10, icon: Icons.Circle, z: 6 }; 
            if (lv === 3) return { color: "text-blue-500", bg: "bg-blue-500", size: 8, icon: Icons.Circle, z: 4 }; 
            return { color: "text-gray-400", bg: "bg-gray-300", size: 6, icon: Icons.Circle, z: 1 }; 
        };

        return (
            <div className="bg-white border-b border-gray-200 p-2 mb-4 shadow-sm sticky top-0 z-30 overflow-hidden">
                <div className="overflow-x-auto custom-scrollbar pb-2">
                    {/* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ã§æ¨ªä¸¦ã³ã«ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */}
                    <div className="relative h-24 w-max min-w-full px-4 mt-6 flex items-end">
                        
                        {/* ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆãƒãƒ¼ã‚«ãƒ¼ã®å¾Œã‚ã‚’é€šã‚‹ç·šï¼‰ */}
                        <div className="absolute left-0 right-0 h-0.5 bg-gray-300 rounded-full" style={{ bottom: '24px' }}></div>
                        
                        {events.map((item, idx) => {
                            const ev = item.data;
                            const style = getMarkerStyle(ev.importance);
                            const Icon = style.icon;
                            
                            // æ®µé•ã„è¨ˆç®—ï¼ˆ5æ®µéšï¼‰
                            const stagger = idx % 5; 
                            const titleBottom = 34 + (stagger * 14); // ç·š(24px) + ãƒãƒ¼ã‚«ãƒ¼ä¸Š(10px) + ãšã‚‰ã—

                            // ã‚¿ã‚¤ãƒˆãƒ«çœç•¥
                            let shortTitle = ev.title;
                            if (shortTitle.length > 10) shortTitle = shortTitle.slice(0, 9) + '...';

                            return (
                                // w-14 (56px) ã®å›ºå®šå¹…ã‚’æŒã¤ãƒœãƒƒã‚¯ã‚¹ã‚’ä¸¦ã¹ã‚‹
                                <div 
                                    key={ev.id}
                                    className="relative flex flex-col items-center justify-end w-12 shrink-0 group cursor-pointer hover:z-50 transition-all"
                                    style={{ height: '100%' }}
                                    onClick={() => document.getElementById(`event-${ev.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' })}
                                >
                                    {/* ã‚¿ã‚¤ãƒˆãƒ« (é»’æ–‡å­— & é«˜ã•ãšã‚‰ã—) */}
                                    <div 
                                        className="absolute whitespace-nowrap text-[9px] font-bold text-gray-900 opacity-80 group-hover:opacity-100 group-hover:scale-110 group-hover:font-black transition-all"
                                        style={{ bottom: `${titleBottom}px` }}
                                    >
                                        {shortTitle}
                                    </div>

                                    {/* ã‚³ãƒã‚¯ã‚¿ç·š */}
                                    <div 
                                        className="absolute w-px bg-gray-300 group-hover:bg-gray-400"
                                        style={{ bottom: '24px', height: `${titleBottom - 24}px` }}
                                    ></div>
                                    
                                    {/* ãƒãƒ¼ã‚«ãƒ¼ (ç·šã®ä¸Šã«é…ç½®) */}
                                    <div 
                                        className={`absolute rounded-full bg-white ${style.color} shadow-sm group-hover:scale-150 transition-transform z-10 flex items-center justify-center`}
                                        style={{ bottom: '16px' }} // ç·š(24px)ã®ä¸­å¿ƒã«åˆã‚ã›ã‚‹èª¿æ•´
                                    >
                                        <Icon size={style.size} fill={style.z >= 8 ? "currentColor" : "none"} />
                                    </div>

                                    {/* å¹´å· (ç·šã®ä¸‹ã«é…ç½®) */}
                                    <div className="absolute bottom-0 text-[9px] font-mono text-gray-400 group-hover:text-blue-600 font-bold">
                                        {ev.year}
                                    </div>
                                    
                                    {/* ãƒ›ãƒãƒ¼æ™‚ã®è©³ç´°ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */}
                                    <div className="absolute bottom-full mb-2 hidden group-hover:block bg-gray-900 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-50 shadow-xl border border-gray-700 left-1/2 transform -translate-x-1/2">
                                        <span className="font-mono text-yellow-400 mr-1">{ev.year}å¹´:</span>
                                        {ev.title}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        );
    };

    let entryCounter = 0;

    // --- ãƒ¡ã‚¤ãƒ³æç”» ---
    return (
        <div className="animate-fade-in h-full flex flex-col">
            {/* Controls */}
            <div className="bg-white border-b border-gray-200 p-4 shadow-sm flex flex-col gap-4 z-40">
                <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                    {/* æ¤œç´¢ãƒãƒ¼ & ãƒ•ã‚£ãƒ«ã‚¿ */}
                    <div className="relative flex-grow w-full md:w-auto flex gap-2">
                        <div className="relative flex-grow">
                            <Icons.Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={16} />
                            <input 
                                type="text" 
                                placeholder="æ¤œç´¢..." 
                                className="pl-9 pr-4 py-2 bg-gray-100 border-transparent focus:bg-white focus:border-yellow-500 border rounded-full text-sm w-full transition-all"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <button 
                            onClick={() => setShowFilters(!showFilters)} 
                            className={`p-2 rounded-full transition-colors flex items-center gap-1 font-bold shrink-0 ${(showFilters || filterTags.length > 0 || filterImportance.length > 0) ? 'bg-yellow-500 text-white shadow' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
                        >
                            <Icons.Filter size={18} />
                        </button>
                    </div>

                    {/* çµ±è¨ˆè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */}
                    <label className="flex items-center gap-2 cursor-pointer bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors select-none shrink-0">
                        <input 
                            type="checkbox" 
                            checked={showStats}
                            onChange={(e) => setShowStats(e.target.checked)}
                            className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300 cursor-pointer"
                        />
                        <span className="text-xs font-bold text-gray-600">
                            çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                        </span>
                    </label>
                </div>

                {/* è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒãƒ« */}
                {showFilters && (
                    <div className="pt-2 border-t border-dashed border-gray-200 animate-fade-in">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-xs font-bold text-gray-400">FILTER OPTIONS</span>
                            <button onClick={() => {setFilterTags([]); setFilterImportance([]);}} className="text-xs text-blue-600 hover:underline">ã‚¯ãƒªã‚¢</button>
                        </div>
                        <div className="space-y-3">
                            <div>
                                <span className="text-[10px] font-bold text-gray-500 block mb-1">é‡è¦åº¦:</span>
                                <div className="flex flex-wrap gap-2">
                                    {Object.entries(importanceLevels).map(([level, info]) => (
                                        <button key={level} onClick={() => setFilterImportance(prev => prev.includes(parseInt(level)) ? prev.filter(l => l !== parseInt(level)) : [...prev, parseInt(level)])} className={`px-2 py-1 rounded text-[10px] border transition-all ${filterImportance.includes(parseInt(level)) ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200'}`}>{info.label}</button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <span className="text-[10px] font-bold text-gray-500 block mb-1">ã‚¿ã‚°:</span>
                                <div className="flex flex-wrap gap-1 max-h-24 overflow-y-auto custom-scrollbar">
                                    {allTags.map(tag => (
                                        <button key={tag} onClick={() => setFilterTags(prev => prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag])} className={`px-2 py-0.5 rounded-full text-[10px] border transition-all ${filterTags.includes(tag) ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-gray-50 text-gray-500 border-gray-200'}`}>#{tag}</button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>

            {/* ãƒŸãƒ‹æ•°ç›´ç·š (é †åºãƒ™ãƒ¼ã‚¹) */}
            <MiniTimeline items={filteredItems} />

            {/* Main Timeline List */}
            <div className="flex-grow p-4 relative min-h-[600px] pb-20">
                {/* ä¸­å¤®ã®ç·š */}
                <div className="absolute left-8 md:left-1/2 top-0 bottom-0 w-1.5 bg-gradient-to-b from-gray-800 via-gray-600 to-transparent transform -translate-x-1/2 rounded-full opacity-80 pointer-events-none"></div>

                <div className="space-y-12">
                    {filteredItems.map((item) => {
                        // çµ±è¨ˆãƒãƒ¼ã‚«ãƒ¼ã®å ´åˆ
                        if (item.type === 'stats_marker') {
                            const hasEntryInSameYear = filteredItems.some(i => i.type === 'entry' && i.year === item.year);
                            return ( 
                                <div key={item.id} className="relative z-10">
                                    {!hasEntryInSameYear && (
                                        <>
                                            <div className="absolute left-1/2 transform -translate-x-1/2 top-4 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></div>
                                            <div className="absolute left-1/2 transform -translate-x-1/2 top-8 bg-gray-100 text-gray-500 text-xs font-bold px-2 py-1 rounded shadow-sm border border-gray-200">{item.year}å¹´</div>
                                        </>
                                    )}
                                    <StatsDisplay year={item.year} stats={stats} expandedStatsYears={expandedStatsYears} setExpandedStatsYears={setExpandedStatsYears} nations={nations} />
                                </div> 
                            );
                        }

                        // é€šå¸¸ã®ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
                        const entry = item.data;
                        const level = entry.importance || 2;
                        const style = importanceLevels[level];
                        const isRight = entryCounter % 2 !== 0;
                        entryCounter++;

                        let dotStyle = 'w-4 h-4 bg-gray-800 ring-4 ring-gray-200';
                        if (level === 6) { dotStyle = 'w-8 h-8 bg-rose-600 ring-4 ring-rose-200 shadow-xl'; } 
                        else if (level === 5) { dotStyle = 'w-6 h-6 bg-yellow-500 ring-4 ring-yellow-200'; } 
                        else if (level === 4) { dotStyle = 'w-5 h-5 bg-purple-600 ring-4 ring-purple-200'; }

                        return (
                            <div key={entry.id} id={`event-${entry.id}`} className={`relative flex flex-col md:flex-row items-center ${isRight ? 'md:flex-row-reverse' : ''}`}>
                                {/* ä¸­å¤®ã®æ—¥ä»˜ãƒãƒ¼ã‚«ãƒ¼ */}
                                <div className="absolute left-8 md:left-1/2 transform -translate-x-1/2 z-10 flex flex-col items-center group/date">
                                    <div className={`${dotStyle} rounded-full shadow-lg mb-2 transition-all`}></div>
                                    <div className={`bg-[#1a1a1a] text-xs font-bold px-2 py-1 rounded shadow-sm whitespace-nowrap border flex flex-col items-center ${level === 6 ? 'border-rose-500 text-rose-400' : 'border-gray-700 text-yellow-500'}`}>
                                        <span>{entry.year}å¹´</span>
                                        {entry.month && <span className="text-[10px] text-gray-300 font-normal mt-0.5">{CUSTOM_MONTHS[entry.month]}({entry.month}æœˆ){entry.day ? ` ${entry.day}æ—¥` : ''}</span>}
                                    </div>
                                </div>

                                {/* æ¨ªç·š */}
                                <div className={`hidden md:block absolute w-[calc(50%-2rem)] border-t-2 ${level >= 4 ? 'border-yellow-500' : 'border-gray-300'} border-dashed ${isRight ? 'left-8' : 'right-8'}`}></div>
                                <div className="hidden md:block w-1/2"></div>

                                {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚«ãƒ¼ãƒ‰ */}
                                <div className={`w-full md:w-1/2 pl-16 md:pl-0 p-2 transition-all duration-300 ease-out hover:z-10 ${style.scale} ${isRight ? 'md:pr-12 md:pl-8' : 'md:pl-12 md:pr-8'}`}>
                                    <div 
                                        onClick={() => onSelectEntry(entry)} 
                                        className={`relative cursor-pointer overflow-hidden rounded-lg shadow-md ${style.bg} border-l-4 ${style.color} hover:shadow-xl hover:-translate-y-1 transition-all p-5`}
                                    >
                                        <div className="mb-2">
                                            {entry.reading && <p className="text-xs text-gray-500 mb-0.5 leading-none">{entry.reading}</p>}
                                            <h3 className={`font-bold text-gray-900 leading-tight ${level >= 4 ? 'text-2xl' : 'text-lg'}`}>{entry.title}</h3>
                                        </div>
                                        <p className="text-gray-600 text-sm line-clamp-3 mb-3">{entry.content || '...'}</p>
                                        <div className="flex flex-wrap gap-1">
                                            {entry.tags?.map(tag => <NationTag key={tag} text={tag} nations={nations} year={entry.year} />)}
                                        </div>
                                        
                                        {isAuthorized && (
                                            <div className="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={(e) => { e.stopPropagation(); onEditEntry(entry); }} className="p-1.5 bg-white text-gray-400 hover:text-blue-600 border border-gray-200 rounded-lg shadow-sm">
                                                    <Icons.Edit2 size={14} />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        );
                    })}

                    {filteredItems.length === 0 && (
                        <div className="text-center py-32">
                            <Icons.Inbox size={48} className="mx-auto mb-4 opacity-20 text-gray-400" />
                            <p className="text-gray-500 font-serif text-lg">è¡¨ç¤ºã™ã‚‹é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

// --- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ ã‚³ãƒ¼ãƒ‰ (Step 1) â–¼â–¼â–¼ ---

// ãƒ­ã‚°è¨˜éŒ²ãƒ˜ãƒ«ãƒ‘ãƒ¼
const logActivity = async (action, detail, currentUser) => {
    try {
        db.collection('audit_logs').add({
            timestamp: new Date().toISOString(),
            uid: currentUser ? currentUser.uid : 'guest',
            userName: currentUser ? (currentUser.displayName || 'åç„¡ã—') : 'ã‚²ã‚¹ãƒˆ',
            action: action,
            detail: detail
        });
    } catch (e) { console.error("Log error", e); }
};

// ç®¡ç†è€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢
const AdminConsoleView = ({ setView, allUsers, activeUserCount }) => {
    const [logs, setLogs] = useState([]);
    useEffect(() => {
        return db.collection('audit_logs').orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
            setLogs(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
    }, []);
    return (
        <div className="min-h-[calc(100vh-120px)] flex flex-col gap-4 pb-20 animate-fade-in">
            <SectionHeader icon={Icons.Terminal} title="ç®¡ç†è€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«" desc="ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£çŠ¶æ³" />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-white p-6 rounded shadow border-l-4 border-green-500">
                    <div className="text-sm text-gray-500 font-bold">ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–äººæ•° (5åˆ†ä»¥å†…)</div>
                    <div className="text-3xl font-black text-green-600">{activeUserCount} <span className="text-sm text-gray-400">users</span></div>
                </div>
                <div className="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                    <div className="text-sm text-gray-500 font-bold">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·æ•°</div>
                    <div className="text-3xl font-black text-blue-600">{allUsers.length} <span className="text-sm text-gray-400">accounts</span></div>
                </div>
            </div>
            <div className="bg-white rounded shadow overflow-hidden flex-grow flex flex-col max-h-[60vh]">
                <div className="p-3 bg-gray-800 text-white font-bold text-sm"><Icons.List size={14} className="inline mr-2"/>æ“ä½œãƒ­ã‚°</div>
                <div className="overflow-y-auto custom-scrollbar flex-grow bg-gray-50 p-2 space-y-2">
                    {logs.map(log => (
                        <div key={log.id} className="text-xs bg-white p-2 border rounded flex gap-2 items-center">
                            <span className="text-gray-400 font-mono">{new Date(log.timestamp).toLocaleString()}</span>
                            <span className="font-bold text-blue-600 w-24 truncate">{log.userName}</span>
                            <span className="font-bold bg-gray-100 px-1 rounded">{log.action}</span>
                            <span className="text-gray-600 truncate flex-grow">{log.detail}</span>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// â˜…ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
function ChatWidget({ user, db, userRole, glossary, onTermClick }) { 
    const [isOpen, setIsOpen] = React.useState(false);
    const [messages, setMessages] = React.useState([]);
    const [inputText, setInputText] = React.useState("");
    const [inputName, setInputName] = React.useState(user ? (user.displayName || 'åç„¡ã—') : 'ã‚²ã‚¹ãƒˆ');
    
    // æ–°æ©Ÿèƒ½ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
    const [selectedIcon, setSelectedIcon] = React.useState('Star');
    const [selectedShape, setSelectedShape] = React.useState('std');
    const [showIconPicker, setShowIconPicker] = React.useState(false);

    const BUBBLE_SHAPES = {
        'std': { name: 'æ¨™æº–', class: 'rounded-2xl rounded-tl-none' },
        'box': { name: 'å››è§’', class: 'rounded-sm' },
        'round': { name: 'å††å½¢', class: 'rounded-3xl px-6' },
        'sharp': { name: 'é‹­è§’', class: 'rounded-lg rounded-bl-none rounded-tr-none' }
    };

    const canCustomize = ['admin', 'writer', 'super_admin'].includes(userRole);

    // --- ç”¨èªé›†ãƒªãƒ³ã‚¯ç”Ÿæˆé–¢æ•° ---
    const renderTextWithLinks = (text) => {
        if (!glossary || !text) return text;
        // ç”¨èªé›†ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã«åˆã‚ã›ã¦èª¿æ•´ï¼ˆå˜ç´”ãªã‚­ãƒ¼ãƒãƒƒãƒãƒ³ã‚°ã®å ´åˆï¼‰
        const terms = Object.keys(glossary).filter(k => k !== 'terms' && k !== 'overrides' && k !== 'tags').sort((a, b) => b.length - a.length);
        if (terms.length === 0) return text;

        const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const pattern = new RegExp(`(${terms.map(escapeRegExp).join('|')})`, 'g');
        const parts = text.split(pattern);
        
        return parts.map((part, index) => {
            if (glossary[part]) {
                return (
                    <span key={index} className="text-blue-600 cursor-pointer hover:underline font-bold"
                        title={glossary[part].desc || "ã‚¯ãƒªãƒƒã‚¯ã§ç”¨èªé›†ã¸"}
                        onClick={(e) => { e.stopPropagation(); if (onTermClick) onTermClick(part); }}
                    >
                        {part}
                    </span>
                );
            }
            return part;
        });
    };

    // --- Firestoreã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾— ---
    React.useEffect(() => {
        if (!isOpen) return;
        const q = db.collection('chat_messages').orderBy('timestamp', 'asc').limit(50);
        const unsubscribe = q.onSnapshot(snapshot => {
            const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMessages(msgs);
            setTimeout(() => {
                const div = document.getElementById('chat-messages-area');
                if(div) div.scrollTop = div.scrollHeight;
            }, 100);
        }, error => console.error("Chat Error:", error));
        return () => unsubscribe();
    }, [isOpen, db]);

    // --- é€ä¿¡å‡¦ç† ---
    const handleSend = async () => {
        if (!inputText.trim()) return;
        let idLabel = "(ã‚²ã‚¹ãƒˆ)";
        if (user && user.email && canCustomize) {
            const secretId = user.email.substring(0, 3).toUpperCase();
            idLabel = `ID:${secretId}`;
        }

        const payload = {
            text: inputText, name: inputName, uid: user ? user.uid : 'guest',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            icon: selectedIcon, userLabel: idLabel,
            bubbleShape: canCustomize ? selectedShape : 'std'
        };

        try {
            await db.collection('chat_messages').add(payload);
            setInputText(""); setShowIconPicker(false);
        } catch (e) { alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message); }
    };

    const formatDate = (ts) => {
        if (!ts) return '';
        const date = ts.toDate ? ts.toDate() : new Date(ts);
        return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    };

    return (
        <div className="fixed bottom-4 right-4 z-50 flex flex-col items-end">
            {isOpen && (
                <div className="bg-white border border-gray-300 shadow-2xl rounded-lg w-80 mb-4 flex flex-col overflow-hidden animate-fade-in-up" style={{height: '500px'}}>
                    <div className="bg-gray-800 text-white p-3 font-bold flex justify-between items-center shadow">
                        <span>ğŸ’¬ é›‘è«‡ãƒ»è­°è«–ãƒãƒ£ãƒƒãƒˆ</span>
                        <button onClick={() => setIsOpen(false)} className="text-gray-400 hover:text-white">âœ•</button>
                    </div>

                    <div id="chat-messages-area" className="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4">
                        {messages.map(msg => {
                            const isMe = user && msg.uid === user.uid; // â˜…ã“ã“ã§ isMe ã‚’å®šç¾©
                            const shapeClass = BUBBLE_SHAPES[msg.bubbleShape || 'std'].class;
                            const IconComponent = Icons[msg.icon] || Icons['Star'];

                            return (
                                <div key={msg.id} className={`flex gap-2 ${isMe ? 'flex-row-reverse' : 'flex-row'}`}>
                                    {/* â˜…ä¿®æ­£: isOwn ã§ã¯ãªã isMe ã‚’ä½¿ç”¨ */}
                                    <div className={`p-2 rounded-full h-fit ${isMe ? 'bg-indigo-100 text-indigo-600' : 'bg-gray-100 text-gray-600'}`}>
                                        <IconComponent size={20} />
                                    </div>
                                    <div className={`max-w-[75%] flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                        <div className="flex items-baseline gap-2 mb-1">
                                            <span className="text-xs font-bold text-gray-700">{msg.name}</span>
                                            <span className="text-[10px] text-gray-400 font-mono bg-gray-100 px-1 rounded">{msg.userLabel || '(ã‚²ã‚¹ãƒˆ)'}</span>
                                        </div>
                                        <div className={`py-2 px-3 text-sm shadow-sm border ${isMe ? 'bg-blue-100 border-blue-200 text-blue-900' : 'bg-white border-gray-200 text-gray-800'} ${shapeClass}`}>
                                            {renderTextWithLinks(msg.text)}
                                        </div>
                                        <span className="text-[10px] text-gray-400 mt-1">{formatDate(msg.timestamp)}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div className="p-3 bg-white border-t border-gray-200 relative">
                        {showIconPicker && (
                            <div className="absolute bottom-full left-0 w-full bg-white border border-gray-300 shadow-lg p-2 grid grid-cols-6 gap-2 max-h-40 overflow-y-auto z-10 rounded-t-lg">
                                {/* â˜…ä¿®æ­£: Object.keysIcons -> Object.keys(Icons) */}
                                {Object.keys(Icons).slice(0, 30).map(key => {
                                    const PickerIcon = Icons[key];
                                    return (
                                        <button key={key} onClick={() => { setSelectedIcon(key); setShowIconPicker(false); }}
                                            className={`p-1 rounded hover:bg-gray-100 flex items-center justify-center ${selectedIcon === key ? 'bg-blue-100 ring-2 ring-blue-400' : ''}`} title={key}>
                                            {/* â˜…ä¿®æ­£: CONSTã§ã¯ãªãã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ */}
                                            <PickerIcon size={20} className="text-gray-600"/>
                                        </button>
                                    );
                                })}
                            </div>
                        )}

                        <div className="flex flex-col gap-2">
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowIconPicker(!showIconPicker)} className="w-8 h-8 border border-gray-300 rounded flex items-center justify-center hover:bg-gray-50 text-gray-600" title="ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´">
                                    {/* â˜…ä¿®æ­£: é¸æŠä¸­ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º */}
                                    {React.createElement(Icons[selectedIcon] || Icons['Star'], { size: 20 })}
                                </button>
                                <input type="text" className="flex-1 border border-gray-300 rounded px-2 py-1 text-xs" placeholder="åå‰" value={inputName} onChange={(e) => setInputName(e.target.value)} />
                            </div>

                            {canCustomize && (
                                <div className="flex gap-1 overflow-x-auto pb-1">
                                    {Object.keys(BUBBLE_SHAPES).map(key => (
                                        <button key={key} onClick={() => setSelectedShape(key)} className={`text-[10px] px-2 py-0.5 rounded border ${selectedShape === key ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-100 text-gray-600 border-gray-200'}`}>
                                            {BUBBLE_SHAPES[key].name}
                                        </button>
                                    ))}
                                </div>
                            )}

                            <div className="flex gap-2">
                                <input type="text" className="flex-1 border border-gray-300 rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} />
                                <button onClick={handleSend} className="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 transition-colors flex items-center justify-center">
                                    {/* â˜…ä¿®æ­£: é€ä¿¡ã‚¢ã‚¤ã‚³ãƒ³ */}
                                    <Icons.Send size={16} />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
            <button onClick={() => setIsOpen(!isOpen)} className="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-105 flex items-center justify-center">
                <span className="text-2xl">ğŸ’¬</span>
            </button>
        </div>
    );
}

// --- TimelineWiki (Main App) - ä¿®æ­£å®Œå…¨ç‰ˆ ---
function TimelineWiki() {
    // --- State Definitions ---
    const [entries, setEntries] = React.useState([]);
    const [nations, setNations] = React.useState([]);
    const [stats, setStats] = React.useState([]);
    const [characters, setCharacters] = React.useState([]);
    const [organizations, setOrganizations] = React.useState([]);
    const [glossaryData, setGlossaryData] = React.useState({ terms: [], overrides: {}, tags: {} });
    
    // å‘ŠçŸ¥ãƒ‡ãƒ¼ã‚¿
    const [announcements, setAnnouncements] = React.useState("");

    // UI State
    const [view, setView] = React.useState('menu');
    const [uiScale, setUiScale] = React.useState(100);
    
    // Selection & Edit
    const [selectedEntry, setSelectedEntry] = React.useState(null);
    const [selectedProfileNation, setSelectedProfileNation] = React.useState(null);
    const [isEditing, setIsEditing] = React.useState(false);
    const [editingNation, setEditingNation] = React.useState(null);
    const [targetNation, setTargetNation] = React.useState(null);
    const [showStatsInput, setShowStatsInput] = React.useState(false);

    // User & Auth
    const [currentUser, setCurrentUser] = React.useState(null);
    const [userRole, setUserRole] = React.useState('guest'); 
    const [allUsers, setAllUsers] = React.useState([]); // ç®¡ç†è€…ç”¨
    const [activeUserCount, setActiveUserCount] = React.useState(0);
    
    // History & Tasks
    const [lastView, setLastView] = React.useState('timeline'); 
    const [activeTasks, setActiveTasks] = React.useState({});
    
    // Refs
    const isRemoteUpdate = React.useRef(0);
    const fileInputRef = React.useRef(null);
    const convertFileInputRef = React.useRef(null);

    const ADMIN_EMAIL = 'anohitodayoanohito@gmail.com'; // ç®¡ç†è€…ãƒ¡ã‚¢ãƒ‰
    const canEdit = userRole === 'admin' || userRole === 'writer' || (currentUser && currentUser.email === ADMIN_EMAIL);
    const isAdmin = userRole === 'admin' || (currentUser && currentUser.email === ADMIN_EMAIL);
    
    const disabledClass = !canEdit ? "opacity-30 grayscale pointer-events-none select-none" : "";

    // --- Helper Functions ---
    const updateTask = (key, data) => {
        setActiveTasks(prev => {
            if (!data) { const next = { ...prev }; delete next[key]; return next; }
            return { ...prev, [key]: data };
        });
    };

    // --- Effects: Load Data ---
    React.useEffect(() => {
        const unsubscribers = [];
        const categories = [
            { key: 'entries', label: 'å¹´è¡¨ãƒ‡ãƒ¼ã‚¿', setter: setEntries },
            { key: 'nations', label: 'å›½å®¶ãƒ‡ãƒ¼ã‚¿', setter: setNations },
            { key: 'stats', label: 'çµ±è¨ˆãƒ‡ãƒ¼ã‚¿', setter: setStats },
            { key: 'characters', label: 'äººç‰©å›³é‘‘', setter: setCharacters },
            { key: 'organizations', label: 'çµ„ç¹”å›³é‘‘', setter: setOrganizations },
            { key: 'glossary', label: 'ç”¨èªé›†ãƒ‡ãƒ¼ã‚¿', setter: setGlossaryData }
        ];

        categories.forEach(({ key, label, setter }) => {
            const unsub = db.collection("wiki_data").doc(`meta_${key}`)
                .onSnapshot(async (doc) => {
                    if (!doc.exists || doc.metadata.hasPendingWrites) return;
                    const meta = doc.data();
                    const totalChunks = meta.totalChunks || 0;
                    isRemoteUpdate.current++;
                    updateTask(key, { label: `å—ä¿¡ä¸­: ${label}`, current: 0, total: totalChunks });
                    try {
                        const promises = [];
                        for (let i = 0; i < totalChunks; i++) {
                            promises.push(db.collection("wiki_data").doc(`data_${key}_${i}`).get());
                        }
                        const snapshots = await Promise.all(promises);
                        let combinedJson = "";
                        snapshots.forEach(snap => { if (snap.exists) combinedJson += snap.data().content; });
                        if (combinedJson) {
                            const data = JSON.parse(combinedJson);
                            setter(data);
                        }
                    } catch (error) { console.error(`${label} load error:`, error); } 
                    finally { setTimeout(() => { updateTask(key, null); isRemoteUpdate.current = Math.max(0, isRemoteUpdate.current - 1); }, 1000); }
                });
            unsubscribers.push(unsub);
        });

        // Config Sync
        unsubscribers.push(db.collection("wiki_data").doc("db_config").onSnapshot(d => {
            if(d.exists && !d.metadata.hasPendingWrites) { 
                isRemoteUpdate.current++;
                if (d.data().uiScale) setUiScale(d.data().uiScale);
                setTimeout(() => { isRemoteUpdate.current = Math.max(0, isRemoteUpdate.current - 1); }, 500);
            }
        }));

        // å‘ŠçŸ¥ãƒ‡ãƒ¼ã‚¿ Sync
        unsubscribers.push(db.collection("wiki_data").doc("system").onSnapshot(d => {
            if (d.exists) {
                const data = d.data();
                if (data.announcements !== undefined) setAnnouncements(data.announcements);
            }
        }));

        return () => unsubscribers.forEach(u => u());
    }, []);

    // --- Effects: Auth & Admin ---
    React.useEffect(() => {
        const unsub = auth.onAuthStateChanged(async (u) => {
            setCurrentUser(u);
            if (u) {
                if (u.email === ADMIN_EMAIL) {
                    setUserRole('admin');
                    db.collection('users').doc(u.uid).set({ email: u.email, role: 'admin', lastSeen: new Date().toISOString() }, { merge: true });
                } else {
                    const doc = await db.collection('users').doc(u.uid).get();
                    if (doc.exists) setUserRole(doc.data().role || 'guest');
                    else {
                        await db.collection('users').doc(u.uid).set({ email: u.email, role: 'pending', createdAt: new Date() });
                        setUserRole('pending');
                    }
                }
            } else {
                setUserRole('guest');
            }
        });
        return () => unsub();
    }, []);

    // â˜…è¿½åŠ : ç®¡ç†è€…ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
    React.useEffect(() => {
        if (!isAdmin) return;
        const unsub = db.collection('users').onSnapshot(snap => {
            const users = snap.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
            setAllUsers(users);
        }, err => console.error("Users load error:", err));
        return () => unsub();
    }, [isAdmin]);

    // --- Active User Count ---
    React.useEffect(() => {
        const sid = sessionStorage.getItem('sid') || Math.random().toString(36);
        sessionStorage.setItem('sid', sid);
        const beat = () => db.collection('active_sessions').doc(currentUser ? currentUser.uid : sid).set({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            type: currentUser ? 'user' : 'guest'
        }, { merge: true });
        const timer = setInterval(beat, 60000);
        beat();
        return db.collection('active_sessions').where('lastSeen', '>', new Date(Date.now() - 5 * 60 * 1000)).onSnapshot(s => setActiveUserCount(s.size));
    }, [currentUser]);

    // --- Actions ---

    // â˜…è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãƒ»æ¨©é™å¤‰æ›´é–¢æ•°
    const handleApproveUser = async (uid, newRole) => {
        if (!isAdmin) return;
        try {
            await db.collection('users').doc(uid).update({ role: newRole });
            // â€»onSnapshotã§è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ãŸã‚stateã®æ‰‹å‹•æ›´æ–°ã¯ä¸è¦
        } catch (error) {
            alert("æ¨©é™æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + error.message);
        }
    };

    // â˜…è¿½åŠ : ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç”³è«‹ï¼ˆå†ç”³è«‹ãªã©ï¼‰
    const handleApplyAccount = async () => {
        if (!currentUser) return;
        try {
            await db.collection('users').doc(currentUser.uid).set({
                email: currentUser.email,
                role: 'pending',
                appliedAt: new Date().toISOString()
            }, { merge: true });
            alert("ç·¨é›†æ¨©é™ã‚’ç”³è«‹ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚");
        } catch (e) {
            alert("ç”³è«‹ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
    };

    // å‘ŠçŸ¥ä¿å­˜
    const saveAnnouncements = (text) => {
        if (!canEdit) return;
        setAnnouncements(text);
        db.collection("wiki_data").doc("system").set({ announcements: text }, { merge: true })
            .catch(e => alert("å‘ŠçŸ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message));
    };

    // ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜
    const CHUNK_SIZE = 800000;
    const chunkString = (str, len) => {
        const size = Math.ceil(str.length / len);
        const r = Array(size);
        let offset = 0;
        for (let i = 0; i < size; i++) { r[i] = str.substr(offset, len); offset += len; }
        return r;
    };

    const saveToCloud = async (newData = {}) => {
        if (!canEdit || isRemoteUpdate.current > 0) return;
        const currentData = {
            entries: newData.entries || entries,
            nations: newData.nations || nations,
            stats: newData.stats || stats,
            characters: newData.characters || characters,
            organizations: newData.organizations || organizations,
            glossary: newData.glossary || glossaryData,
            uiScale: newData.uiScale || uiScale,
        };

        const saveCategory = async (key, label, dataObj) => {
            if (!dataObj) return;
            updateTask(key, { label: `ä¿å­˜ä¸­: ${label}`, current: 0, total: 100 });
            try {
                const jsonStr = JSON.stringify(dataObj);
                const chunks = chunkString(jsonStr, CHUNK_SIZE);
                const batch = db.batch();
                batch.set(db.collection("wiki_data").doc(`meta_${key}`), { totalChunks: chunks.length, totalSize: jsonStr.length, lastUpdated: new Date().toISOString() });
                chunks.forEach((chunk, i) => batch.set(db.collection("wiki_data").doc(`data_${key}_${i}`), { content: chunk, index: i }));
                await batch.commit();
            } catch (e) { console.error(e); } 
            finally { updateTask(key, null); }
        };

        const promises = [];
        if(newData.entries) promises.push(saveCategory('entries', 'å¹´è¡¨', currentData.entries));
        if(newData.nations) promises.push(saveCategory('nations', 'å›½å®¶', currentData.nations));
        if(newData.stats) promises.push(saveCategory('stats', 'çµ±è¨ˆ', currentData.stats));
        if(newData.characters) promises.push(saveCategory('characters', 'äººç‰©', currentData.characters));
        if(newData.organizations) promises.push(saveCategory('organizations', 'çµ„ç¹”', currentData.organizations));
        if(newData.glossary) promises.push(saveCategory('glossary', 'ç”¨èªé›†', currentData.glossary));
        if(newData.uiScale) db.collection("wiki_data").doc("db_config").set({ uiScale: currentData.uiScale }, { merge: true });
        
        await Promise.all(promises);
    };

    // Auto Save
    React.useEffect(() => {
        if (!canEdit || isRemoteUpdate.current > 0) return;
        const timer = setTimeout(() => {
            if (entries.length > 0) saveToCloud();
        }, 1000);
        return () => clearTimeout(timer);
    }, [entries, nations, stats, characters, organizations, glossaryData, uiScale]);

    // Navigation & Auth Handlers
    const handleLogin = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (e) { alert(e.message); } };
    const handleLogout = async () => { await auth.signOut(); setView('menu'); };
    const handleCreateNew = () => { if(!canEdit) return; setSelectedEntry({ id: Date.now().toString(), title: '', year: 2000 }); setIsEditing(true); setView('edit'); };
    const handleExport = () => { /* Export logic */ };
    
    // Zoom Controls
    const zoomIn = () => setUiScale(p => Math.min(200, p + 10));
    const zoomOut = () => setUiScale(p => Math.max(30, p - 10));
    const zoomReset = () => setUiScale(100);

    const handleEditEntryTransition = (entry, sourceView = 'timeline') => {
        setSelectedEntry(entry); setLastView(sourceView); setIsEditing(true); setView('edit');
    };
    const handleOpenDetail = (entry) => {
        setSelectedEntry(entry); setLastView(view); setView('detail');
    };

    return (
        <>
            <ChatWidget user={currentUser} db={db} userRole={userRole} glossary={glossaryData} onTermClick={(term) => setView('glossary')} />
            <input type="file" ref={fileInputRef} className="hidden" accept=".json" disabled={!canEdit} />
            <input type="file" ref={convertFileInputRef} className="hidden" accept=".json" disabled={!canEdit} />
            <StatsInputModal showStatsInput={showStatsInput} setShowStatsInput={setShowStatsInput} nations={nations} stats={stats} setStats={setStats} />
            <ProgressToast tasks={activeTasks} />

            {view === 'menu' ? (
                <MainMenu 
                    setView={setView} 
                    handleCreateNew={handleCreateNew} 
                    handleExport={handleExport} 
                    fileInputRef={fileInputRef} 
                    convertFileInputRef={convertFileInputRef} 
                    currentUser={currentUser} 
                    isAuthorized={canEdit} 
                    handleLogin={handleLogin} 
                    handleLogout={handleLogout} 
                    userRole={userRole}
                    entries={entries}
                    nations={nations}
                    characters={characters}
                    organizations={organizations}
                    announcements={announcements}
                    onSaveAnnouncements={saveAnnouncements}
                />
            ) : (
                <div className="min-h-screen bg-[#f0f2f5] font-sans text-gray-800 flex flex-col h-screen overflow-hidden">
                    {/* Header */}
                    <header className="bg-[#1a1a1a] text-white p-2 shadow-lg shrink-0 z-50 border-b-4 border-yellow-600">
                        <div className="max-w-7xl mx-auto flex justify-between items-center overflow-x-auto custom-scrollbar pb-1 gap-4">
                            {/* å·¦å´ */}
                            <div className="flex items-center gap-4 shrink-0">
                                <button onClick={() => setView('menu')} className="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition-colors border border-gray-600">
                                    <Icons.ArrowLeft size={16} /> MENU
                                </button>
                                <div className="h-8 w-px bg-gray-700 hidden sm:block"></div>
                                <div className="flex items-center gap-2 cursor-pointer group hidden sm:flex" onClick={() => {setView('timeline'); setSelectedEntry(null);}}>
                                    <div className="bg-yellow-600 p-1.5 rounded-md text-black shrink-0"><Icons.BookOpen size={18} /></div>
                                    <div><h1 className="text-base font-bold tracking-widest group-hover:text-yellow-500 transition-colors leading-none">è‹±è¦‡æ­´ä»£è¨˜</h1></div>
                                </div>
                            </div>

                            {/* å³å´: ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */}
                            <div className="flex items-center gap-3 shrink-0">
                                {/* ZOOM */}
                                <div className="flex flex-col items-center gap-0.5">
                                    <span className="text-[8px] text-gray-500 font-bold uppercase tracking-widest">ZOOM</span>
                                    <div className="flex items-center bg-gray-800 rounded-lg border border-gray-700 h-9">
                                        <button onClick={zoomOut} className="px-2 h-full hover:bg-gray-700 rounded-l text-gray-400 hover:text-white transition-colors"><Icons.Minus size={14}/></button>
                                        <button onClick={zoomReset} className="text-[10px] font-mono font-bold w-8 text-center text-yellow-500 hover:text-white h-full flex items-center justify-center">{uiScale}%</button>
                                        <button onClick={zoomIn} className="px-2 h-full hover:bg-gray-700 rounded-r text-gray-400 hover:text-white transition-colors"><Icons.Plus size={14}/></button>
                                    </div>
                                </div>

                                {/* MANAGE */}
                                <div className={`flex flex-col items-center gap-0.5 ${disabledClass}`}>
                                    <span className="text-[8px] text-yellow-600/80 font-bold uppercase tracking-widest">MANAGE</span>
                                    <div className="flex items-center bg-gray-800/80 p-1 rounded-xl border border-gray-700 gap-1">
                                        {[ 
                                            { id: 'edit', label: 'æ­´å²è¨˜éŒ²', icon: Icons.Edit2, onClick: handleCreateNew, active: view === 'edit' }, 
                                            { id: 'settings', label: 'å›½å®¶ç·¨æˆ', icon: Icons.Globe, onClick: () => setView('settings'), active: view === 'settings' }, 
                                            { id: 'characters', label: 'äººç‰©ç®¡ç†', icon: Icons.User, onClick: () => setView('characters'), active: view === 'characters' }, 
                                            { id: 'organizations', label: 'çµ„ç¹”ç®¡ç†', icon: Icons.Briefcase, onClick: () => setView('organizations'), active: view === 'organizations' }, 
                                            { id: 'statsEdit', label: 'çµ±è¨ˆç·¨é›†', icon: Icons.BarChart2, onClick: () => setView('statsEdit'), active: view === 'statsEdit' }, 
                                            { id: 'power_structure', label: 'æ¨©åŠ›æ§‹é€ ', icon: Icons.Structure, onClick: () => setView('power_structure'), active: view === 'power_structure' } 
                                        ].map(btn => ( 
                                            <button key={btn.id} onClick={btn.onClick} className={`flex flex-col items-center justify-center w-12 h-10 rounded-lg transition-all duration-200 group relative ${btn.active ? 'bg-yellow-600 text-black shadow-inner' : 'bg-transparent text-gray-400 hover:bg-gray-700 hover:text-white'}`} title={btn.label}> 
                                                <btn.icon size={16} className="mb-0.5" /> <span className="text-[8px] font-bold leading-none scale-90 origin-top whitespace-nowrap">{btn.label}</span> 
                                            </button> 
                                        ))}
                                    </div>
                                </div>

                                {/* VIEW */}
                                <div className="flex flex-col items-center gap-0.5">
                                    <span className="text-[8px] text-blue-400/60 font-bold uppercase tracking-widest">VIEW</span>
                                    <div className="flex items-center bg-gray-800/80 p-1 rounded-xl border border-gray-700 gap-1">
                                        {[ 
                                            { id: 'timeline', label: 'å¹´è¡¨é–²è¦§', icon: Icons.History, onClick: () => setView('timeline'), active: view === 'timeline' }, 
                                            { id: 'nation_list', label: 'å›½å®¶ä¸€è¦§', icon: Icons.LayoutGrid, onClick: () => setView('nation_list'), active: view === 'nation_list' || view === 'nation_profile' }, 
                                            { id: 'genealogy', label: 'èˆˆäº¡ç³»è­œ', icon: Icons.GitMerge, onClick: () => setView('genealogy'), active: view === 'genealogy' }, 
                                            { id: 'graph', label: 'çµ±è¨ˆã‚°ãƒ©ãƒ•', icon: Icons.Activity, onClick: () => setView('graph'), active: view === 'graph' }, 
                                            { id: 'table', label: 'ä½“åˆ¶ä¸€è¦§', icon: Icons.List, onClick: () => setView('table'), active: view === 'table' }, 
                                            { id: 'glossary', label: 'ç”¨èªé›†', icon: Icons.BookOpen, onClick: () => setView('glossary'), active: view === 'glossary' } 
                                        ].map(btn => ( 
                                            <button key={btn.id} onClick={btn.onClick} className={`flex flex-col items-center justify-center w-12 h-10 rounded-lg transition-all duration-200 group relative ${btn.active ? 'bg-yellow-600 text-black shadow-inner' : 'bg-transparent text-gray-400 hover:bg-gray-700 hover:text-white'}`} title={btn.label}> 
                                                <btn.icon size={16} className="mb-0.5" /> <span className="text-[8px] font-bold leading-none scale-90 origin-top whitespace-nowrap">{btn.label}</span> 
                                            </button> 
                                        ))}
                                    </div>
                                </div>
                                
                                {/* USER / DATA */}
                                <div className="flex items-center gap-3 pl-2 border-l border-gray-700 ml-1">
                                    <div className="flex flex-col items-center gap-0.5">
                                        <span className="text-[8px] text-gray-500 font-bold uppercase tracking-widest">DATA</span>
                                        <div className="flex items-center gap-1">
                                            <button onClick={() => setView('help')} className={`w-8 h-9 flex items-center justify-center rounded transition-colors ${view === 'help' ? 'bg-yellow-600 text-black' : 'text-gray-400 hover:text-white hover:bg-gray-700'}`} title="ãƒ˜ãƒ«ãƒ—"><Icons.HelpCircle size={18} /></button>
                                        </div>
                                    </div>

                                    <div className="flex flex-col items-center gap-0.5">
                                        <span className="text-[8px] text-gray-500 font-bold uppercase tracking-widest">USER</span>
                                        {currentUser ? (
                                            <div className="flex items-center gap-2 h-9">
                                                {isAdmin && <button onClick={() => setView('user_management')} className="w-8 h-8 flex items-center justify-center bg-gray-700 text-yellow-400 rounded hover:bg-gray-600" title="ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†"><Icons.Users size={16} /></button>}
                                                {isAdmin && (<button onClick={() => setView('admin_console')} className="w-8 h-8 flex items-center justify-center bg-gray-700 text-green-400 rounded hover:bg-gray-600 border border-gray-600" title="ç®¡ç†è€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«"><Icons.Terminal size={16} /></button>)}
                                                <button onClick={handleLogout} className={`flex items-center justify-center w-8 h-8 rounded-full transition-colors border-2 ${canEdit ? 'border-green-600' : 'border-gray-600'} overflow-hidden`}>{currentUser.photoURL ? <img src={currentUser.photoURL} className="w-full h-full object-cover" /> : <Icons.User size={16} className="text-gray-300"/>}</button>
                                            </div>
                                        ) : ( <button onClick={handleLogin} className="h-9 bg-blue-600 hover:bg-blue-500 text-white px-3 rounded font-bold text-xs flex items-center gap-1 transition-colors"><Icons.Users size={14}/> Login</button> )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="flex-grow overflow-auto bg-[#f0f2f5] relative w-full h-full">
                        <main className={(view === 'power_structure' || view === 'genealogy') ? "w-full h-full p-0 overflow-hidden" : "max-w-5xl mx-auto p-4 origin-top-left"} 
                              style={(view === 'power_structure' || view === 'genealogy') ? {} : { zoom: uiScale / 100 }}>
                             
                             {view === 'settings' ? (canEdit ? <SettingsView setView={setView} nations={nations} setNations={setNations} targetNation={targetNation} setTargetNation={setTargetNation} /> : <div className="p-10 text-center font-bold text-gray-500">æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>) : 
                             view === 'nation_overview' ? (canEdit ? <NationOverviewView setView={setView} nations={nations} setNations={setNations} targetNation={targetNation} /> : <div className="p-10 text-center font-bold text-gray-500">æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>) : 
                             view === 'characters' ? (canEdit ? <CharacterManager setView={setView} nations={nations} characters={characters} setCharacters={setCharacters} organizations={organizations} setOrganizations={setOrganizations} /> : <div className="p-10 text-center font-bold text-gray-500">æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>) : 
                             view === 'organizations' ? (canEdit ? <OrganizationManager setView={setView} nations={nations} organizations={organizations} setOrganizations={setOrganizations} characters={characters} setCharacters={setCharacters} /> : <div className="p-10 text-center font-bold text-gray-500">æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>) : 
                             view === 'statsEdit' ? (canEdit ? <StatsEditView setView={setView} nations={nations} stats={stats} setStats={setStats} /> : <div className="p-10 text-center font-bold text-gray-500">æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>) : 
                             view === 'power_structure' ? (canEdit ? <PowerStructureView setView={setView} nations={nations} setNations={setNations} organizations={organizations} characters={characters} /> : <div className="p-10 text-center font-bold text-gray-500">æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>) :                             
                             view === 'user_management' && isAdmin ? <UserManagementView setView={setView} allUsers={allUsers} onChangeRole={handleApproveUser} /> : 
                             view === 'graph' ? <GraphView setView={setView} stats={stats} nations={nations} /> : 
                             view === 'genealogy' ? <GenealogyView setView={setView} nations={nations} stats={stats} entries={entries} setSelectedEntry={setSelectedEntry} uiScale={uiScale} onOpenDetail={handleOpenDetail} /> : 
                             view === 'table' ? <NationTableView isAuthorized={canEdit} setView={setView} nations={nations} stats={stats} onEditNation={(n) => { setTargetNation(n); setView('settings'); }} onAddNation={() => { setTargetNation(null); setView('settings'); }}/> : 
                             view === 'nation_list' ? <NationListView setView={setView} nations={nations} onSelectNation={(n) => { setSelectedProfileNation(n); setView('nation_profile'); }} /> : 
                             view === 'glossary' ? <GlossaryView setView={setView} nations={nations} entries={entries} characters={characters} organizations={organizations} glossaryData={glossaryData} setGlossaryData={setGlossaryData} isAuthorized={canEdit} /> :
                             view === 'nation_profile' && selectedProfileNation ? <NationProfileView isAuthorized={canEdit} nation={selectedProfileNation} entries={entries} stats={stats} nations={nations} characters={characters} organizations={organizations} onClose={() => { setView('nation_list'); setSelectedProfileNation(null); }} onEdit={() => { setEditingNation(selectedProfileNation); setView('settings'); }} onEditEntry={handleEditEntryTransition} onEditNation={() => { setTargetNation(selectedProfileNation); setView('settings'); }} onEditStats={() => { setTargetNation(selectedProfileNation); setView('statsEdit'); }} onEditOverview={() => { setTargetNation(selectedProfileNation); setView('nation_overview'); }} updateNation={(updated) => { const newNations = nations.map(n => n.id === updated.id ? updated : n); setNations(newNations); saveToCloud({ nations: newNations }); setSelectedProfileNation(updated); }} onOpenDetail={handleOpenDetail} /> :
                             view === 'edit' && selectedEntry ? <EditForm entry={selectedEntry} nations={nations} onSave={(newData) => { const newEntries = [...entries]; const idx = newEntries.findIndex(e => e.id === newData.id); if (idx >= 0) newEntries[idx] = newData; else newEntries.push(newData); setEntries(newEntries); saveToCloud({ entries: newEntries }); setIsEditing(false); if(lastView === 'nation_profile') { setView('nation_profile'); } else { setView('timeline'); setSelectedEntry(null); } }} onCancel={() => { setIsEditing(false); if (lastView === 'detail') { setView('detail'); } else if (lastView === 'nation_profile') { setView('nation_profile'); setSelectedEntry(null); } else { setView('timeline'); setSelectedEntry(null); } }} /> :
                             view === 'help' ? <HelpView setView={setView} /> : 
                             view === 'timeline' ? (<TimelineView entries={entries} nations={nations} stats={stats} onSelectEntry={(entry) => { setSelectedEntry(entry); setView('detail'); }} onEditEntry={(entry) => handleEditEntryTransition(entry, 'timeline')} isAuthorized={canEdit}/>) : 
                             view === 'admin_console' && isAdmin ? <AdminConsoleView setView={setView} allUsers={allUsers} activeUserCount={activeUserCount} /> :
                             view === 'detail' && selectedEntry ? (<DetailView isAuthorized={canEdit} entry={selectedEntry} onEdit={() => { setIsEditing(true); setView('edit'); }} onClose={() => { setView(lastView); setSelectedEntry(null); }} onDelete={(id) => { if(window.confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { const newEntries = entries.filter(e => e.id !== id); setEntries(newEntries); saveToCloud({ entries: newEntries }); setView('timeline'); setSelectedEntry(null); } }} nations={nations} backLabel={lastView === 'timeline' ? 'å¹´è¡¨ã«æˆ»ã‚‹' : lastView === 'genealogy' ? 'ç³»è­œå›³ã«æˆ»ã‚‹' : lastView === 'nation_profile' ? 'å›½å®¶ã«æˆ»ã‚‹' : 'æˆ»ã‚‹'}/>
                            ) : null
                        }
                        </main>
                    </div>
                </div>
            )}
        </>
    );
}

        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«çœŸã£ç™½ã«ãªã‚‹ã®ã‚’é˜²ãã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error("Uncaught error:", error, errorInfo);
                this.setState({ errorInfo: error.toString() });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full border border-red-200">
                                <h1 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2">
                                    <span className="text-3xl">âš ï¸</span> ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
                                </h1>
                                <p className="text-gray-600 mb-4 font-bold">
                                    ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é‹å–¶ã«å ±å‘Šã—ã¦ãã ã•ã„
                                </p>
                                <div className="bg-gray-50 p-4 rounded text-xs font-mono text-red-500 overflow-auto max-h-32 mb-6 border">
                                    {this.state.errorInfo}
                                </div>
                                <button 
                                    onClick={() => window.location.reload()} 
                                    className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors shadow"
                                >
                                    ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                                </button>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æç”»
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <TimelineWiki />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
